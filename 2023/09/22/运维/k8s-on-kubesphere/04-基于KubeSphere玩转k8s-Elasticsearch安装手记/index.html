<!DOCTYPE html>
<html lang="zh-CN">
    <!-- title -->


    

<!-- keywords -->



<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="author" content="Arcticsea">
    <meta name="renderer" content="webkit">
    <meta name="copyright" content="Arcticsea">
    
        <meta name="keywords" content="hexo,hexo-theme,hexo-blog">
    
    <meta name="description" content="ctf teclo blog">
    <meta name="description" content="基于 KubeSphere 玩转 k8s-ElasticSearch 安装手记大家好，我是老 Z！  本系列文档是我在云原生技术领域的学习和运维实践的手记，用输出倒逼输入是一种高效的学习方法，能够快速积累经验和提高技术，只有把学到的知识写出来并能够让其他人理解，才能说明真正掌握了这项知识。 如果你喜欢本文，请分享给你的小伙伴！  本系列文档内容涵盖 (但不限于) 以下技术领域：   KubeSph">
<meta property="og:type" content="article">
<meta property="og:title" content="k8s-ElasticSearch 安装手记">
<meta property="og:url" content="https://lhhxs.github.io/2023/09/22/%E8%BF%90%E7%BB%B4/k8s-on-kubesphere/04-%E5%9F%BA%E4%BA%8EKubeSphere%E7%8E%A9%E8%BD%ACk8s-Elasticsearch%E5%AE%89%E8%A3%85%E6%89%8B%E8%AE%B0/index.html">
<meta property="og:site_name" content="北极海的博客空间">
<meta property="og:description" content="基于 KubeSphere 玩转 k8s-ElasticSearch 安装手记大家好，我是老 Z！  本系列文档是我在云原生技术领域的学习和运维实践的手记，用输出倒逼输入是一种高效的学习方法，能够快速积累经验和提高技术，只有把学到的知识写出来并能够让其他人理解，才能说明真正掌握了这项知识。 如果你喜欢本文，请分享给你的小伙伴！  本系列文档内容涵盖 (但不限于) 以下技术领域：   KubeSph">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://znotes-1258881081.cos.ap-beijing.myqcloud.com/k8s-on-kubesphere/esxi-scsi.png">
<meta property="og:image" content="https://znotes-1258881081.cos.ap-beijing.myqcloud.com/k8s-on-kubesphere/kubesphere-clusters-components-logging.png">
<meta property="og:image" content="https://znotes-1258881081.cos.ap-beijing.myqcloud.com/k8s-on-kubesphere/kubesphere-clusters-components-logging-2.png">
<meta property="og:image" content="https://znotes-1258881081.cos.ap-beijing.myqcloud.com/k8s-on-kubesphere/kubesphere-crd-output.png">
<meta property="og:image" content="https://znotes-1258881081.cos.ap-beijing.myqcloud.com/k8s-on-kubesphere/kubesphere-crd-output-1.png">
<meta property="og:image" content="https://znotes-1258881081.cos.ap-beijing.myqcloud.com/k8s-on-kubesphere/kubesphere-crd-output-es-1.png">
<meta property="og:image" content="https://znotes-1258881081.cos.ap-beijing.myqcloud.com/k8s-on-kubesphere/elasticsearch-error-1.png">
<meta property="og:image" content="https://znotes-1258881081.cos.ap-beijing.myqcloud.com/k8s-on-kubesphere/image-20220420095405948.png">
<meta property="og:image" content="https://znotes-1258881081.cos.ap-beijing.myqcloud.com/k8s-on-kubesphere/image-20220420111124760.png">
<meta property="og:image" content="https://znotes-1258881081.cos.ap-beijing.myqcloud.com/k8s-on-kubesphere/image-20220420111152382.png">
<meta property="og:image" content="https://znotes-1258881081.cos.ap-beijing.myqcloud.com/k8s-on-kubesphere/kubesphere-daemonsets-flunet-bit.png">
<meta property="og:image" content="https://znotes-1258881081.cos.ap-beijing.myqcloud.com/k8s-on-kubesphere/kubesphere-daemonsets-flunet-bit-1.png">
<meta property="og:image" content="https://znotes-1258881081.cos.ap-beijing.myqcloud.com/k8s-on-kubesphere/elasticsearch-error-2.png">
<meta property="og:image" content="https://znotes-1258881081.cos.ap-beijing.myqcloud.com/k8s-on-kubesphere/image-20220420173658602.png">
<meta property="og:image" content="https://znotes-1258881081.cos.ap-beijing.myqcloud.com/k8s-on-kubesphere/image-20220420173919350.png">
<meta property="og:image" content="https://znotes-1258881081.cos.ap-beijing.myqcloud.com/k8s-on-kubesphere/image-20220422085824266.png">
<meta property="og:image" content="https://znotes-1258881081.cos.ap-beijing.myqcloud.com/k8s-on-kubesphere/kubesphere-daemonsets-flunet-bit-2.png">
<meta property="og:image" content="https://znotes-1258881081.cos.ap-beijing.myqcloud.com/k8s-on-kubesphere/kubesphere-daemonsets-flunet-bit-3.png">
<meta property="og:image" content="https://znotes-1258881081.cos.ap-beijing.myqcloud.com/k8s-on-kubesphere/kubesphere-daemonsets-flunet-bit-4-0619543.png">
<meta property="og:image" content="https://znotes-1258881081.cos.ap-beijing.myqcloud.com/k8s-on-kubesphere/kubesphere-daemonsets-flunet-bit-5.png">
<meta property="og:image" content="https://znotes-1258881081.cos.ap-beijing.myqcloud.com/k8s-on-kubesphere/kubesphere-daemonsets-flunet-bit-6.png">
<meta property="og:image" content="https://znotes-1258881081.cos.ap-beijing.myqcloud.com/k8s-on-kubesphere/kubesphere-daemonsets-flunet-bit-7.png">
<meta property="og:image" content="https://znotes-1258881081.cos.ap-beijing.myqcloud.com/k8s-on-kubesphere/kubesphere-daemonsets-flunet-bit-8.png">
<meta property="og:image" content="https://znotes-1258881081.cos.ap-beijing.myqcloud.com/k8s-on-kubesphere/kubesphere-crd-delete-1.png">
<meta property="og:image" content="https://znotes-1258881081.cos.ap-beijing.myqcloud.com/k8s-on-kubesphere/kubesphere-crd-delete-2.png">
<meta property="og:image" content="https://znotes-1258881081.cos.ap-beijing.myqcloud.com/k8s-on-kubesphere/kubesphere-crd-delete-3.png">
<meta property="og:image" content="https://znotes-1258881081.cos.ap-beijing.myqcloud.com/k8s-on-kubesphere/kubesphere-crd-delete-4.png">
<meta property="og:image" content="https://znotes-1258881081.cos.ap-beijing.myqcloud.com/k8s-on-kubesphere/kubesphere-crd-delete-5.png">
<meta property="og:image" content="https://znotes-1258881081.cos.ap-beijing.myqcloud.com/k8s-on-kubesphere/kubesphere-crd-delete-6.png">
<meta property="og:image" content="https://znotes-1258881081.cos.ap-beijing.myqcloud.com/k8s-on-kubesphere/kubesphere-toolbox.png">
<meta property="og:image" content="https://znotes-1258881081.cos.ap-beijing.myqcloud.com/k8s-on-kubesphere/kubesphere-toolbox-analysis-tools-container.png">
<meta property="og:image" content="https://znotes-1258881081.cos.ap-beijing.myqcloud.com/k8s-on-kubesphere/kubesphere-toolbox-analysis-tools-audit.png">
<meta property="og:image" content="https://znotes-1258881081.cos.ap-beijing.myqcloud.com/k8s-on-kubesphere/kubesphere-toolbox-analysis-tools-event.png">
<meta property="og:image" content="https://znotes-1258881081.cos.ap-beijing.myqcloud.com/k8s-on-kubesphere/image-20220422235234281.png">
<meta property="og:image" content="https://znotes-1258881081.cos.ap-beijing.myqcloud.com/k8s-on-kubesphere/image-20220423001514866.png">
<meta property="og:image" content="https://znotes-1258881081.cos.ap-beijing.myqcloud.com/k8s-on-kubesphere/kubesphere-ks-apiserver-2.png">
<meta property="og:image" content="https://znotes-1258881081.cos.ap-beijing.myqcloud.com/k8s-on-kubesphere/kubesphere-ks-apiserver-0.png">
<meta property="og:image" content="https://znotes-1258881081.cos.ap-beijing.myqcloud.com/k8s-on-kubesphere/kubesphere-ks-apiserver-1.png">
<meta property="og:image" content="https://znotes-1258881081.cos.ap-beijing.myqcloud.com/k8s-on-kubesphere/kubesphere-toolbox-analysis-tools-containe-1.png">
<meta property="og:image" content="https://znotes-1258881081.cos.ap-beijing.myqcloud.com/k8s-on-kubesphere/kubesphere-toolbox-analysis-tools-container-2.png">
<meta property="og:image" content="https://znotes-1258881081.cos.ap-beijing.myqcloud.com/k8s-on-kubesphere/kubesphere-toolbox-analysis-tools-event-1.png">
<meta property="og:image" content="https://znotes-1258881081.cos.ap-beijing.myqcloud.com/k8s-on-kubesphere/kubesphere-toolbox-analysis-tools-audit-1.png">
<meta property="og:image" content="https://znotes-1258881081.cos.ap-beijing.myqcloud.com/k8s-on-kubesphere/image-20220428110517048.png">
<meta property="og:image" content="https://znotes-1258881081.cos.ap-beijing.myqcloud.com/k8s-on-kubesphere/image-20220428110847858.png">
<meta property="article:published_time" content="2023-09-22T01:38:09.188Z">
<meta property="article:modified_time" content="2023-09-22T01:42:26.663Z">
<meta property="article:author" content="Arcticsea">
<meta property="article:tag" content="k8s">
<meta property="article:tag" content="kubesphere">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://znotes-1258881081.cos.ap-beijing.myqcloud.com/k8s-on-kubesphere/esxi-scsi.png">
    <meta http-equiv="Cache-control" content="no-cache">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <link rel="icon" href="/assets/favicon.ico">
    
    <title>k8s-ElasticSearch 安装手记 · arcticsea的博客空间</title>
    <!-- /*! loadCSS. [c]2017 Filament Group, Inc. MIT License */
/* This file is meant as a standalone workflow for
- testing support for link[rel=preload]
- enabling async CSS loading in browsers that do not support rel=preload
- applying rel preload css once loaded, whether supported or not.
*/ -->
<script>
    (function (w) {
        'use strict'
        // rel=preload support test
        if (!w.loadCSS) {
            w.loadCSS = function () {}
        }
        // define on the loadCSS obj
        var rp = (loadCSS.relpreload = {})
        // rel=preload feature support test
        // runs once and returns a function for compat purposes
        rp.support = (function () {
            var ret
            try {
                ret = w.document.createElement('link').relList.supports('preload')
            } catch (e) {
                ret = false
            }
            return function () {
                return ret
            }
        })()

        // if preload isn't supported, get an asynchronous load by using a non-matching media attribute
        // then change that media back to its intended value on load
        rp.bindMediaToggle = function (link) {
            // remember existing media attr for ultimate state, or default to 'all'
            var finalMedia = link.media || 'all'

            function enableStylesheet() {
                link.media = finalMedia
            }

            // bind load handlers to enable media
            if (link.addEventListener) {
                link.addEventListener('load', enableStylesheet)
            } else if (link.attachEvent) {
                link.attachEvent('onload', enableStylesheet)
            }

            // Set rel and non-applicable media type to start an async request
            // note: timeout allows this to happen async to let rendering continue in IE
            setTimeout(function () {
                link.rel = 'stylesheet'
                link.media = 'only x'
            })
            // also enable media after 3 seconds,
            // which will catch very old browsers (android 2.x, old firefox) that don't support onload on link
            setTimeout(enableStylesheet, 3000)
        }

        // loop through link elements in DOM
        rp.poly = function () {
            // double check this to prevent external calls from running
            if (rp.support()) {
                return
            }
            var links = w.document.getElementsByTagName('link')
            for (var i = 0; i < links.length; i++) {
                var link = links[i]
                // qualify links to those with rel=preload and as=style attrs
                if (
                    link.rel === 'preload' &&
                    link.getAttribute('as') === 'style' &&
                    !link.getAttribute('data-loadcss')
                ) {
                    // prevent rerunning on link
                    link.setAttribute('data-loadcss', true)
                    // bind listeners to toggle media back
                    rp.bindMediaToggle(link)
                }
            }
        }

        // if unsupported, run the polyfill
        if (!rp.support()) {
            // run once at least
            rp.poly()

            // rerun poly on an interval until onload
            var run = w.setInterval(rp.poly, 500)
            if (w.addEventListener) {
                w.addEventListener('load', function () {
                    rp.poly()
                    w.clearInterval(run)
                })
            } else if (w.attachEvent) {
                w.attachEvent('onload', function () {
                    rp.poly()
                    w.clearInterval(run)
                })
            }
        }

        // commonjs
        if (typeof exports !== 'undefined') {
            exports.loadCSS = loadCSS
        } else {
            w.loadCSS = loadCSS
        }
    })(typeof global !== 'undefined' ? global : this)
</script>

    <style type="text/css">
    @font-face {
        font-family: 'Oswald-Regular';
        src: url("/font/Oswald-Regular.ttf");
    }

    body {
        margin: 0;
    }

    header,
    footer,
    .back-top,
    .sidebar,
    .container,
    .site-intro-meta,
    .toc-wrapper {
        display: none;
    }

    .site-intro {
        position: relative;
        z-index: 3;
        width: 100%;
        /* height: 50vh; */
        overflow: hidden;
    }

    .site-intro-placeholder {
        position: absolute;
        z-index: -2;
        top: 0;
        left: 0;
        width: calc(100% + 300px);
        height: 100%;
        background: repeating-linear-gradient(-45deg, #444 0, #444 80px, #333 80px, #333 160px);
        background-position: center center;
        transform: translate3d(-226px, 0, 0);
        animation: gradient-move 2.5s ease-out 0s infinite;
    }

    @keyframes gradient-move {
        0% {
            transform: translate3d(-226px, 0, 0);
        }
        100% {
            transform: translate3d(0, 0, 0);
        }
    }
</style>

    <link rel="preload" href="/css/style.css?v=20211217" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <link rel="preload" href="/css/dark.css?v=20211217" as="style">
    <link rel="stylesheet" href="/css/dark.css">
    <link rel="stylesheet" href="/css/mobile.css?v=20211217" media="(max-width: 960px)">
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" as="script">
    <link rel="preload" href="/scripts/main.js?v=20211217" as="script">
    <link rel="preload" href="/scripts/dark.js?v=20211217" as="script">
    <link rel="preload" href="/font/Oswald-Regular.ttf" as="font" crossorigin>
    <link rel="preload" href="https://at.alicdn.com/t/font_327081_1dta1rlogw17zaor.woff" as="font" crossorigin>
    <!-- algolia -->
    
    <!-- 百度统计  -->
    
    <!-- 谷歌统计  -->
    
<meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="北极海的博客空间" type="application/atom+xml">
</head>

    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script type="text/javascript">
        if (typeof window.$ == undefined) {
            console.warn('jquery load from jsdelivr failed, will load local script')
            document.write('<script src="/lib/jquery.min.js" />')
        }
    </script>
    
        <body class="post-body">
    
        <!-- header -->
        <header class="header header-mobile">
    <!-- top read progress line -->
    <div class="header-element">
        <div class="read-progress"></div>
    </div>
    <!-- sidebar menu button -->
    <div class="header-element">
        
            <div class="header-sidebar-menu">
        
            
                <div style="padding-left: 1px;">&#xe775;</div>
            
        </div>
    </div>
    <!-- header actions -->
    <div class="header-actions">
        <!-- theme mode switch button -->
        <span class="header-theme-btn header-element">
            <i class="fas fa-adjust"></i>
        </span>
        <!-- back to home page text -->
        <span class="home-link header-element">
            <a href=/>arcticsea's blog zone</a>
        </span>
    </div>
    <!-- toggle banner for post layout -->
    
        
            <div class="banner">
        
            <div class="blog-title header-element">
                <a href="/">arcticsea&#39;s blog zone</a>
            </div>
            <div class="post-title header-element">
                <a href="#" class="post-name">k8s-ElasticSearch 安装手记</a>
            </div>
        </div>
    
</header>

        <!-- fixed footer -->
        <footer class="footer-fixed">
    <!-- back to top button -->
    <div class="footer-fixed-element">
        
            <div class="back-top back-top-hidden">
        
        
            <div>&#xe639;</div>
        
        </div>
    </div>
</footer>

        <!-- wrapper -->
        <div class="wrapper">
            <div class="site-intro" style="







    height:50vh;

">
    
    <!-- 主页  -->
    
        
    <!-- 404页  -->
            
    <div class="site-intro-placeholder"></div>
    <div class="site-intro-img" style="background-image: url(/intro/post-bg.jpg)"></div>
    <div class="site-intro-meta">
        <!-- 标题  -->
        <h1 class="intro-title">
            <!-- 主页  -->
            
                k8s-ElasticSearch 安装手记
            <!-- 404 -->
            
        </h1>
        <!-- 副标题 -->
        <p class="intro-subtitle">
            <!-- 主页副标题  -->
            
                
            <!-- 404 -->
            
        </p>
        <!-- 文章页 meta -->
        
            <div class="post-intros">
                <!-- 文章页标签  -->
                
                    <div class= post-intro-tags >
    
    
        <a class="post-tag" href="javascript:void(0);" data-tags="k8s">k8s</a>
    
        <a class="post-tag" href="javascript:void(0);" data-tags="kubesphere">kubesphere</a>
    
</div>

                
                
                    <div class="post-intro-read">
                        <span>字数统计: <span class="post-count word-count">33.2k</span>阅读时长: <span class="post-count reading-time">186 min</span></span>
                    </div>
                
                <div class="post-intro-meta">
                    <!-- 撰写日期 -->
                    <span class="iconfont-archer post-intro-calander">&#xe676;</span>
                    <span class="post-intro-time">2023/09/22</span>
                    <!-- busuanzi -->
                    
                        <span id="busuanzi_container_page_pv" class="busuanzi-pv">
                            <span class="iconfont-archer post-intro-busuanzi">&#xe602;</span>
                            <span id="busuanzi_value_page_pv"></span>
                        </span>
                    
                    <!-- 文章分享 -->
                    <span class="share-wrapper">
                        <span class="iconfont-archer share-icon">&#xe71d;</span>
                        <span class="share-text">Share</span>
                        <ul class="share-list">
                            <li class="iconfont-archer share-qr" data-type="qr">&#xe75b;
                                <div class="share-qrcode"></div>
                            </li>
                            <li class="iconfont-archer" data-type="weibo">&#xe619;</li>
                            <li class="iconfont-archer" data-type="qzone">&#xe62e;</li>
                            <li class="iconfont-archer" data-type="twitter">&#xe634;</li>
                            <li class="iconfont-archer" data-type="facebook">&#xe67a;</li>
                        </ul>
                    </span>
                </div>
            </div>
        
    </div>
</div>

            <script>
  // get user agent
  function getBrowserVersions() {
    var u = window.navigator.userAgent
    return {
      userAgent: u,
      trident: u.indexOf('Trident') > -1, //IE内核
      presto: u.indexOf('Presto') > -1, //opera内核
      webKit: u.indexOf('AppleWebKit') > -1, //苹果、谷歌内核
      gecko: u.indexOf('Gecko') > -1 && u.indexOf('KHTML') == -1, //火狐内核
      mobile: !!u.match(/AppleWebKit.*Mobile.*/), //是否为移动终端
      ios: !!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/), //ios终端
      android: u.indexOf('Android') > -1 || u.indexOf('Linux') > -1, //android终端或者uc浏览器
      iPhone: u.indexOf('iPhone') > -1 || u.indexOf('Mac') > -1, //是否为iPhone或者安卓QQ浏览器
      iPad: u.indexOf('iPad') > -1, //是否为iPad
      webApp: u.indexOf('Safari') == -1, //是否为web应用程序，没有头部与底部
      weixin: u.indexOf('MicroMessenger') == -1, //是否为微信浏览器
      uc: u.indexOf('UCBrowser') > -1, //是否为android下的UC浏览器
    }
  }
  var browser = {
    versions: getBrowserVersions(),
  }
  console.log('userAgent: ' + browser.versions.userAgent)

  // callback
  function fontLoaded() {
    console.log('font loaded')
    if (document.getElementsByClassName('site-intro-meta')) {
      document
        .getElementsByClassName('intro-title')[0]
        .classList.add('intro-fade-in')
      document
        .getElementsByClassName('intro-subtitle')[0]
        .classList.add('intro-fade-in')
      var postIntros = document.getElementsByClassName('post-intros')[0]
      if (postIntros) {
        postIntros.classList.add('post-fade-in')
      }
    }
  }

  // UC不支持跨域，所以直接显示
  function asyncCb() {
    if (browser.versions.uc) {
      console.log('UCBrowser')
      fontLoaded()
    } else {
      WebFont.load({
        custom: {
          families: ['Oswald-Regular'],
        },
        loading: function () {
          // 所有字体开始加载
          // console.log('font loading');
        },
        active: function () {
          // 所有字体已渲染
          fontLoaded()
        },
        inactive: function () {
          // 字体预加载失败，无效字体或浏览器不支持加载
          console.log('inactive: timeout')
          fontLoaded()
        },
        timeout: 5000, // Set the timeout to two seconds
      })
    }
  }

  function asyncErr() {
    console.warn('script load from CDN failed, will load local script')
  }

  // load webfont-loader async, and add callback function
  function async(u, cb, err) {
    var d = document,
      t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0]
    o.src = u
    if (cb) {
      o.addEventListener(
        'load',
        function (e) {
          cb(null, e)
        },
        false
      )
    }
    if (err) {
      o.addEventListener(
        'error',
        function (e) {
          err(null, e)
        },
        false
      )
    }
    s.parentNode.insertBefore(o, s)
  }

  var asyncLoadWithFallBack = function (arr, success, reject) {
    var currReject = function () {
      reject()
      arr.shift()
      if (arr.length) async(arr[0], success, currReject)
    }

    async(arr[0], success, currReject)
  }

  asyncLoadWithFallBack(
    [
      'https://cdn.jsdelivr.net/npm/webfontloader@1.6.28/webfontloader.min.js',
      'https://cdn.bootcss.com/webfont/1.6.28/webfontloader.js',
      "/lib/webfontloader.min.js",
    ],
    asyncCb,
    asyncErr
  )
</script>

            <img class="loading" src="/assets/loading.svg" style="display: block; margin: 6rem auto 0 auto; width: 6rem; height: 6rem;" />
            <div class="container container-unloaded">
                <main class="main post-page">
    <article class="article-entry">
        <h1 id="基于-KubeSphere-玩转-k8s-ElasticSearch-安装手记"><a href="#基于-KubeSphere-玩转-k8s-ElasticSearch-安装手记" class="headerlink" title="基于 KubeSphere 玩转 k8s-ElasticSearch 安装手记"></a>基于 KubeSphere 玩转 k8s-ElasticSearch 安装手记</h1><p><strong>大家好，我是老 Z！</strong></p>
<blockquote>
<p>本系列文档是我在云原生技术领域的学习和运维实践的手记，<strong>用输出倒逼输入</strong>是一种高效的学习方法，能够快速积累经验和提高技术，只有把学到的知识写出来并能够让其他人理解，才能说明真正掌握了这项知识。</p>
<p>如果你喜欢本文，请分享给你的小伙伴！</p>
</blockquote>
<p><strong>本系列文档内容涵盖 (但不限于) 以下技术领域：</strong></p>
<blockquote>
<ul>
<li><p><strong>KubeSphere</strong></p>
</li>
<li><p><strong>Kubernetes</strong></p>
</li>
<li><p><strong>Ansible</strong></p>
</li>
<li><p><strong>自动化运维</strong></p>
</li>
<li><p><strong>CNCF 技术栈</strong></p>
</li>
</ul>
</blockquote>
<h2 id="1-本文简介"><a href="#1-本文简介" class="headerlink" title="1. 本文简介"></a>1. 本文简介</h2><p>本文接着上篇 <strong>&lt;&lt; 基于 KubeSphere 玩转 k8s-KubeSphere 初始化手记 &gt;&gt;</strong> ，继续玩转 KubeSphere、玩转 k8s。本文会介绍 KubeSphere 启用可插拔组件日志系统的安装和配置过程，由于采用了 Kubernetes 集群外部的 ElasticSearch 集群作为日志收集系统，因此，本文还会涉及 ElasticSearch 安装配置的实践。为了让大家不仅能掌握 ElasticSearch 手工安装部署的技能，同时也能 Get 到如何将手工安装部署文档转化成 Ansible 的 Playbooks，因此本文同时介绍了纯手工安装配置 ElasticSearch 和利用 Ansible 自动化安装配置 ElasticSearch。</p>
<blockquote>
<p><strong>本文知识量</strong></p>
</blockquote>
<ul>
<li>阅读时长：60 分</li>
<li>行：4000+</li>
<li>单词：25000+</li>
<li>字符：220000+</li>
<li>图片：50 张</li>
</ul>
<blockquote>
<p><strong>本文知识点</strong></p>
</blockquote>
<ul>
<li>定级：<strong>入门级</strong></li>
<li>ElasticSearch-手工安装配置</li>
<li>ElasticSearch-Ansible 自动安装配置</li>
<li>ElasticSearch-启用 http 认证配置</li>
<li>KubeSphere 启用可插拔日志组件</li>
<li>KubeSphere 对接外部不开启认证的 ElasticSearch</li>
<li>KubeSphere 对接外部开启认证的 ElasticSearch</li>
<li>Ansible 常用操作</li>
<li>Ansible Playbook编写</li>
</ul>
<blockquote>
<p><strong>演示服务器配置</strong></p>
</blockquote>
<table>
<thead>
<tr>
<th align="center">主机名</th>
<th align="center">IP</th>
<th align="center">CPU</th>
<th align="center">内存</th>
<th align="center">系统盘</th>
<th align="center">数据盘</th>
<th align="center">用途</th>
</tr>
</thead>
<tbody><tr>
<td align="center">zdeops-master</td>
<td align="center">192.168.9.9</td>
<td align="center">2</td>
<td align="center">4</td>
<td align="center">40</td>
<td align="center">200</td>
<td align="center">Ansible 运维控制节点</td>
</tr>
<tr>
<td align="center">ks-k8s-master-0</td>
<td align="center">192.168.9.91</td>
<td align="center">8</td>
<td align="center">32</td>
<td align="center">40</td>
<td align="center">200</td>
<td align="center">KubeSphere&#x2F;k8s-master&#x2F;k8s-worker</td>
</tr>
<tr>
<td align="center">ks-k8s-master-1</td>
<td align="center">192.168.9.92</td>
<td align="center">8</td>
<td align="center">32</td>
<td align="center">40</td>
<td align="center">200</td>
<td align="center">KubeSphere&#x2F;k8s-master&#x2F;k8s-worker</td>
</tr>
<tr>
<td align="center">ks-k8s-master-2</td>
<td align="center">192.168.9.93</td>
<td align="center">8</td>
<td align="center">32</td>
<td align="center">40</td>
<td align="center">200</td>
<td align="center">KubeSphere&#x2F;k8s-master&#x2F;k8s-worker</td>
</tr>
<tr>
<td align="center">glusterfs-node-0</td>
<td align="center">192.168.9.95</td>
<td align="center">4</td>
<td align="center">8</td>
<td align="center">40</td>
<td align="center">200+100</td>
<td align="center">GlusterFS&#x2F;ElasticSearch</td>
</tr>
<tr>
<td align="center">glusterfs-node-1</td>
<td align="center">192.168.9.96</td>
<td align="center">4</td>
<td align="center">8</td>
<td align="center">40</td>
<td align="center">200+100</td>
<td align="center">GlusterFS&#x2F;ElasticSearch</td>
</tr>
<tr>
<td align="center">glusterfs-node-2</td>
<td align="center">192.168.9.97</td>
<td align="center">4</td>
<td align="center">8</td>
<td align="center">40</td>
<td align="center">200+100</td>
<td align="center">GlusterFS&#x2F;ElasticSearch</td>
</tr>
</tbody></table>
<h2 id="2-Ansible-配置"><a href="#2-Ansible-配置" class="headerlink" title="2. Ansible 配置"></a>2. Ansible 配置</h2><h3 id="01-增加-hosts-配置"><a href="#01-增加-hosts-配置" class="headerlink" title="01. 增加 hosts 配置"></a>01. 增加 hosts 配置</h3><p><strong>本系列文档中演示用的 ElasticSearch 和 GlusterFS 服务器复用，有条件的用户可以分开部署，注意调整 hosts 配置。</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># hosts文件配置</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 主要增加glusterfs</span></span><br><span class="line">[<span class="string">k8s</span>]</span><br><span class="line"><span class="string">ks-k8s-master-0</span> <span class="string">ansible_ssh_host=192.168.9.91</span>  <span class="string">host_name=ks-k8s-master-0</span></span><br><span class="line"><span class="string">ks-k8s-master-1</span> <span class="string">ansible_ssh_host=192.168.9.92</span>  <span class="string">host_name=ks-k8s-master-1</span></span><br><span class="line"><span class="string">ks-k8s-master-2</span> <span class="string">ansible_ssh_host=192.168.9.93</span>  <span class="string">host_name=ks-k8s-master-2</span></span><br><span class="line"></span><br><span class="line">[<span class="string">glusterfs</span>]</span><br><span class="line"><span class="string">glusterfs-node-0</span> <span class="string">ansible_ssh_host=192.168.9.95</span> <span class="string">host_name=glusterfs-node-0</span></span><br><span class="line"><span class="string">glusterfs-node-1</span> <span class="string">ansible_ssh_host=192.168.9.96</span> <span class="string">host_name=glusterfs-node-1</span></span><br><span class="line"><span class="string">glusterfs-node-2</span> <span class="string">ansible_ssh_host=192.168.9.97</span> <span class="string">host_name=glusterfs-node-2</span></span><br><span class="line"></span><br><span class="line">[<span class="string">es</span>]</span><br><span class="line"><span class="string">es-node-0</span> <span class="string">ansible_ssh_host=192.168.9.95</span> <span class="string">host_name=es-node-0</span></span><br><span class="line"><span class="string">es-node-1</span> <span class="string">ansible_ssh_host=192.168.9.96</span> <span class="string">host_name=es-node-1</span></span><br><span class="line"><span class="string">es-node-2</span> <span class="string">ansible_ssh_host=192.168.9.97</span> <span class="string">host_name=es-node-2</span></span><br><span class="line"></span><br><span class="line">[<span class="string">servers:children</span>]</span><br><span class="line"><span class="string">k8s</span></span><br><span class="line"><span class="string">glusterfs</span></span><br><span class="line"><span class="string">es</span></span><br><span class="line"></span><br><span class="line">[<span class="string">servers:vars</span>]</span><br><span class="line"><span class="string">ansible_connection=paramiko</span></span><br><span class="line"><span class="string">ansible_ssh_user=root</span></span><br><span class="line"><span class="string">ansible_ssh_pass=password</span></span><br></pre></td></tr></table></figure>

<h2 id="3-ElasticSearch-安装配置"><a href="#3-ElasticSearch-安装配置" class="headerlink" title="3. ElasticSearch 安装配置"></a>3. ElasticSearch 安装配置</h2><h3 id="01-初始化配置"><a href="#01-初始化配置" class="headerlink" title="01. 初始化配置"></a>01. 初始化配置</h3><blockquote>
<p><strong>01-检测服务器连通性</strong></p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">利用 ansible 检测服务器的连通性</span></span><br><span class="line">[root@zdevops-master /]# cd /data/ansible/ansible-zdevops/inventories/dev/</span><br><span class="line">[root@zdevops-master dev]# source /opt/ansible2.8/bin/activate</span><br><span class="line">(ansible2.8) [root@zdevops-master dev]# ansible -m ping es </span><br><span class="line">/opt/ansible2.8/lib/python2.7/site-packages/ansible/parsing/vault/__init__.py:44: CryptographyDeprecationWarning: Python 2 is no longer supported by the Python core team. Support for it is now deprecated in cryptography, and will be removed in the next release.</span><br><span class="line">  from cryptography.exceptions import InvalidSignature</span><br><span class="line">es-node-1 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: false, </span><br><span class="line">    &quot;ping&quot;: &quot;pong&quot;</span><br><span class="line">&#125;</span><br><span class="line">es-node-2 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: false, </span><br><span class="line">    &quot;ping&quot;: &quot;pong&quot;</span><br><span class="line">&#125;</span><br><span class="line">es-node-0 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: false, </span><br><span class="line">    &quot;ping&quot;: &quot;pong&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>02-初始化服务器配置</strong></p>
</blockquote>
<p><strong>由于是复用的服务器，在 GlusterFS 安装配置时已经配置，因此本文忽略，实际中可根据需要执行以下命令</strong>。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">利用ansible-playbook初始化服务器配置</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">(ansible2.8) [root@zdevops-master dev]<span class="comment"># ansible-playbook -l es ../../playbooks/init-base.yaml</span></span></span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>03-挂载数据盘</strong></p>
</blockquote>
<p><strong>本文新增一块硬盘 &#x2F;dev&#x2F;sdc, 格式化后挂载点为 &#x2F;data，作为 ElasticSearch 的数据存储目录，实际中请注意修改 ansible-playbook 的变量配置</strong>。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">由于是采用的虚拟机，在虚拟化上挂载磁盘后，先检查一下磁盘是否被操作系统识别</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">利用 ansible 查看磁盘列表</span></span><br><span class="line"></span><br><span class="line">(ansible2.8) [root@zdevops-master dev]# ansible es -m shell -a &#x27;fdisk -l&#x27;</span><br><span class="line">/opt/ansible2.8/lib/python2.7/site-packages/ansible/parsing/vault/__init__.py:44: CryptographyDeprecationWarning: Python 2 is no longer supported by the Python core team. Support for it is now deprecated in cryptography, and will be removed in the next release.</span><br><span class="line">  from cryptography.exceptions import InvalidSignature</span><br><span class="line">es-node-1 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line"></span><br><span class="line">Disk /dev/sda: 42.9 GB, 42949672960 bytes, 83886080 sectors</span><br><span class="line">Units = sectors of 1 * 512 = 512 bytes</span><br><span class="line">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class="line">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br><span class="line">Disk label type: dos</span><br><span class="line">Disk identifier: 0x00019df2</span><br><span class="line"></span><br><span class="line">   Device Boot      Start         End      Blocks   Id  System</span><br><span class="line">/dev/sda1   *        2048     2099199     1048576   83  Linux</span><br><span class="line">/dev/sda2         2099200    83886079    40893440   8e  Linux LVM</span><br><span class="line"></span><br><span class="line">Disk /dev/sdb: 214.7 GB, 214748364800 bytes, 419430400 sectors</span><br><span class="line">Units = sectors of 1 * 512 = 512 bytes</span><br><span class="line">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class="line">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Disk /dev/mapper/centos-root: 39.7 GB, 39720058880 bytes, 77578240 sectors</span><br><span class="line">Units = sectors of 1 * 512 = 512 bytes</span><br><span class="line">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class="line">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Disk /dev/mapper/centos-swap: 2147 MB, 2147483648 bytes, 4194304 sectors</span><br><span class="line">Units = sectors of 1 * 512 = 512 bytes</span><br><span class="line">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class="line">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br><span class="line"></span><br><span class="line">es-node-0 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line"></span><br><span class="line">Disk /dev/sdb: 214.7 GB, 214748364800 bytes, 419430400 sectors</span><br><span class="line">Units = sectors of 1 * 512 = 512 bytes</span><br><span class="line">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class="line">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Disk /dev/sda: 42.9 GB, 42949672960 bytes, 83886080 sectors</span><br><span class="line">Units = sectors of 1 * 512 = 512 bytes</span><br><span class="line">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class="line">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br><span class="line">Disk label type: dos</span><br><span class="line">Disk identifier: 0x00019df2</span><br><span class="line"></span><br><span class="line">   Device Boot      Start         End      Blocks   Id  System</span><br><span class="line">/dev/sda1   *        2048     2099199     1048576   83  Linux</span><br><span class="line">/dev/sda2         2099200    83886079    40893440   8e  Linux LVM</span><br><span class="line"></span><br><span class="line">Disk /dev/mapper/centos-root: 39.7 GB, 39720058880 bytes, 77578240 sectors</span><br><span class="line">Units = sectors of 1 * 512 = 512 bytes</span><br><span class="line">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class="line">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Disk /dev/mapper/centos-swap: 2147 MB, 2147483648 bytes, 4194304 sectors</span><br><span class="line">Units = sectors of 1 * 512 = 512 bytes</span><br><span class="line">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class="line">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br><span class="line"></span><br><span class="line">es-node-2 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line"></span><br><span class="line">Disk /dev/sda: 42.9 GB, 42949672960 bytes, 83886080 sectors</span><br><span class="line">Units = sectors of 1 * 512 = 512 bytes</span><br><span class="line">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class="line">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br><span class="line">Disk label type: dos</span><br><span class="line">Disk identifier: 0x00019df2</span><br><span class="line"></span><br><span class="line">   Device Boot      Start         End      Blocks   Id  System</span><br><span class="line">/dev/sda1   *        2048     2099199     1048576   83  Linux</span><br><span class="line">/dev/sda2         2099200    83886079    40893440   8e  Linux LVM</span><br><span class="line"></span><br><span class="line">Disk /dev/sdb: 214.7 GB, 214748364800 bytes, 419430400 sectors</span><br><span class="line">Units = sectors of 1 * 512 = 512 bytes</span><br><span class="line">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class="line">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Disk /dev/mapper/centos-root: 39.7 GB, 39720058880 bytes, 77578240 sectors</span><br><span class="line">Units = sectors of 1 * 512 = 512 bytes</span><br><span class="line">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class="line">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Disk /dev/mapper/centos-swap: 2147 MB, 2147483648 bytes, 4194304 sectors</span><br><span class="line">Units = sectors of 1 * 512 = 512 bytes</span><br><span class="line">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class="line">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">上面的执行结果，发现并没有识别新磁盘</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">利用scsi的机制，触发磁盘扫描，识别新磁盘</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">先查看现有的scsi磁盘信息</span></span><br><span class="line"></span><br><span class="line">(ansible2.8) [root@zdevops-master dev]# ansible es -m shell -a &#x27;cat /proc/scsi/scsi&#x27;</span><br><span class="line">/opt/ansible2.8/lib/python2.7/site-packages/ansible/parsing/vault/__init__.py:44: CryptographyDeprecationWarning: Python 2 is no longer supported by the Python core team. Support for it is now deprecated in cryptography, and will be removed in the next release.</span><br><span class="line">  from cryptography.exceptions import InvalidSignature</span><br><span class="line">es-node-1 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">Attached devices:</span><br><span class="line">Host: scsi0 Channel: 00 Id: 00 Lun: 00</span><br><span class="line">  Vendor: NECVMWar Model: VMware IDE CDR00 Rev: 1.00</span><br><span class="line">  Type:   CD-ROM                           ANSI  SCSI revision: 05</span><br><span class="line">Host: scsi2 Channel: 00 Id: 00 Lun: 00</span><br><span class="line">  Vendor: VMware   Model: Virtual disk     Rev: 1.0 </span><br><span class="line">  Type:   Direct-Access                    ANSI  SCSI revision: 02</span><br><span class="line">Host: scsi2 Channel: 00 Id: 01 Lun: 00</span><br><span class="line">  Vendor: VMware   Model: Virtual disk     Rev: 1.0 </span><br><span class="line">  Type:   Direct-Access                    ANSI  SCSI revision: 02</span><br><span class="line"></span><br><span class="line">es-node-0 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">Attached devices:</span><br><span class="line">Host: scsi0 Channel: 00 Id: 00 Lun: 00</span><br><span class="line">  Vendor: NECVMWar Model: VMware IDE CDR00 Rev: 1.00</span><br><span class="line">  Type:   CD-ROM                           ANSI  SCSI revision: 05</span><br><span class="line">Host: scsi2 Channel: 00 Id: 00 Lun: 00</span><br><span class="line">  Vendor: VMware   Model: Virtual disk     Rev: 1.0 </span><br><span class="line">  Type:   Direct-Access                    ANSI  SCSI revision: 02</span><br><span class="line">Host: scsi2 Channel: 00 Id: 01 Lun: 00</span><br><span class="line">  Vendor: VMware   Model: Virtual disk     Rev: 1.0 </span><br><span class="line">  Type:   Direct-Access                    ANSI  SCSI revision: 02</span><br><span class="line"></span><br><span class="line">es-node-2 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">Attached devices:</span><br><span class="line">Host: scsi0 Channel: 00 Id: 00 Lun: 00</span><br><span class="line">  Vendor: VMware   Model: Virtual disk     Rev: 1.0 </span><br><span class="line">  Type:   Direct-Access                    ANSI  SCSI revision: 02</span><br><span class="line">Host: scsi0 Channel: 00 Id: 01 Lun: 00</span><br><span class="line">  Vendor: VMware   Model: Virtual disk     Rev: 1.0 </span><br><span class="line">  Type:   Direct-Access                    ANSI  SCSI revision: 02</span><br><span class="line">Host: scsi1 Channel: 00 Id: 00 Lun: 00</span><br><span class="line">  Vendor: NECVMWar Model: VMware IDE CDR00 Rev: 1.00</span><br><span class="line">  Type:   CD-ROM                           ANSI  SCSI revision: 05</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">手动添加新磁盘，这里重点注意一下，es-node-2的scsi的顺序跟其他两个节点不一样，需要单独执行</span></span><br><span class="line">(ansible2.8) [root@zdevops-master dev]# ansible es-node-2 -m shell -a &quot;echo &#x27;scsi add-single-device 0 0 2 0&#x27; &gt;/proc/scsi/scsi&quot;</span><br><span class="line">/opt/ansible2.8/lib/python2.7/site-packages/ansible/parsing/vault/__init__.py:44: CryptographyDeprecationWarning: Python 2 is no longer supported by the Python core team. Support for it is now deprecated in cryptography, and will be removed in the next release.</span><br><span class="line">  from cryptography.exceptions import InvalidSignature</span><br><span class="line">es-node-2 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line"></span><br><span class="line">(ansible2.8) [root@zdevops-master dev]# ansible es-node-0,es-node-1 -m shell -a &quot;echo &#x27;scsi add-single-device 2 0 2 0&#x27; &gt;/proc/scsi/scsi&quot;</span><br><span class="line">/opt/ansible2.8/lib/python2.7/site-packages/ansible/parsing/vault/__init__.py:44: CryptographyDeprecationWarning: Python 2 is no longer supported by the Python core team. Support for it is now deprecated in cryptography, and will be removed in the next release.</span><br><span class="line">  from cryptography.exceptions import InvalidSignature</span><br><span class="line">es-node-1 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">es-node-0 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看新磁盘是否添加</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看scsi信息</span></span><br><span class="line">(ansible2.8) [root@zdevops-master dev]# ansible es -m shell -a &#x27;cat /proc/scsi/scsi&#x27;</span><br><span class="line">/opt/ansible2.8/lib/python2.7/site-packages/ansible/parsing/vault/__init__.py:44: CryptographyDeprecationWarning: Python 2 is no longer supported by the Python core team. Support for it is now deprecated in cryptography, and will be removed in the next release.</span><br><span class="line">  from cryptography.exceptions import InvalidSignature</span><br><span class="line">es-node-1 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">Attached devices:</span><br><span class="line">Host: scsi0 Channel: 00 Id: 00 Lun: 00</span><br><span class="line">  Vendor: NECVMWar Model: VMware IDE CDR00 Rev: 1.00</span><br><span class="line">  Type:   CD-ROM                           ANSI  SCSI revision: 05</span><br><span class="line">Host: scsi2 Channel: 00 Id: 00 Lun: 00</span><br><span class="line">  Vendor: VMware   Model: Virtual disk     Rev: 1.0 </span><br><span class="line">  Type:   Direct-Access                    ANSI  SCSI revision: 02</span><br><span class="line">Host: scsi2 Channel: 00 Id: 01 Lun: 00</span><br><span class="line">  Vendor: VMware   Model: Virtual disk     Rev: 1.0 </span><br><span class="line">  Type:   Direct-Access                    ANSI  SCSI revision: 02</span><br><span class="line">Host: scsi2 Channel: 00 Id: 02 Lun: 00</span><br><span class="line">  Vendor: VMware   Model: Virtual disk     Rev: 1.0 </span><br><span class="line">  Type:   Direct-Access                    ANSI  SCSI revision: 02</span><br><span class="line"></span><br><span class="line">es-node-2 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">Attached devices:</span><br><span class="line">Host: scsi0 Channel: 00 Id: 00 Lun: 00</span><br><span class="line">  Vendor: VMware   Model: Virtual disk     Rev: 1.0 </span><br><span class="line">  Type:   Direct-Access                    ANSI  SCSI revision: 02</span><br><span class="line">Host: scsi0 Channel: 00 Id: 01 Lun: 00</span><br><span class="line">  Vendor: VMware   Model: Virtual disk     Rev: 1.0 </span><br><span class="line">  Type:   Direct-Access                    ANSI  SCSI revision: 02</span><br><span class="line">Host: scsi1 Channel: 00 Id: 00 Lun: 00</span><br><span class="line">  Vendor: NECVMWar Model: VMware IDE CDR00 Rev: 1.00</span><br><span class="line">  Type:   CD-ROM                           ANSI  SCSI revision: 05</span><br><span class="line">Host: scsi0 Channel: 00 Id: 02 Lun: 00</span><br><span class="line">  Vendor: VMware   Model: Virtual disk     Rev: 1.0 </span><br><span class="line">  Type:   Direct-Access                    ANSI  SCSI revision: 02</span><br><span class="line"></span><br><span class="line">es-node-0 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">Attached devices:</span><br><span class="line">Host: scsi0 Channel: 00 Id: 00 Lun: 00</span><br><span class="line">  Vendor: NECVMWar Model: VMware IDE CDR00 Rev: 1.00</span><br><span class="line">  Type:   CD-ROM                           ANSI  SCSI revision: 05</span><br><span class="line">Host: scsi2 Channel: 00 Id: 00 Lun: 00</span><br><span class="line">  Vendor: VMware   Model: Virtual disk     Rev: 1.0 </span><br><span class="line">  Type:   Direct-Access                    ANSI  SCSI revision: 02</span><br><span class="line">Host: scsi2 Channel: 00 Id: 01 Lun: 00</span><br><span class="line">  Vendor: VMware   Model: Virtual disk     Rev: 1.0 </span><br><span class="line">  Type:   Direct-Access                    ANSI  SCSI revision: 02</span><br><span class="line">Host: scsi2 Channel: 00 Id: 02 Lun: 00</span><br><span class="line">  Vendor: VMware   Model: Virtual disk     Rev: 1.0 </span><br><span class="line">  Type:   Direct-Access                    ANSI  SCSI revision: 02</span><br><span class="line"><span class="meta prompt_">  </span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看fdisk信息</span></span><br><span class="line">(ansible2.8) [root@zdevops-master dev]# ansible es -m shell -a &#x27;fdisk -l&#x27;</span><br><span class="line">/opt/ansible2.8/lib/python2.7/site-packages/ansible/parsing/vault/__init__.py:44: CryptographyDeprecationWarning: Python 2 is no longer supported by the Python core team. Support for it is now deprecated in cryptography, and will be removed in the next release.</span><br><span class="line">  from cryptography.exceptions import InvalidSignature</span><br><span class="line">es-node-1 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line"></span><br><span class="line">Disk /dev/sda: 42.9 GB, 42949672960 bytes, 83886080 sectors</span><br><span class="line">Units = sectors of 1 * 512 = 512 bytes</span><br><span class="line">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class="line">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br><span class="line">Disk label type: dos</span><br><span class="line">Disk identifier: 0x00019df2</span><br><span class="line"></span><br><span class="line">   Device Boot      Start         End      Blocks   Id  System</span><br><span class="line">/dev/sda1   *        2048     2099199     1048576   83  Linux</span><br><span class="line">/dev/sda2         2099200    83886079    40893440   8e  Linux LVM</span><br><span class="line"></span><br><span class="line">Disk /dev/sdb: 214.7 GB, 214748364800 bytes, 419430400 sectors</span><br><span class="line">Units = sectors of 1 * 512 = 512 bytes</span><br><span class="line">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class="line">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Disk /dev/mapper/centos-root: 39.7 GB, 39720058880 bytes, 77578240 sectors</span><br><span class="line">Units = sectors of 1 * 512 = 512 bytes</span><br><span class="line">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class="line">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Disk /dev/mapper/centos-swap: 2147 MB, 2147483648 bytes, 4194304 sectors</span><br><span class="line">Units = sectors of 1 * 512 = 512 bytes</span><br><span class="line">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class="line">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Disk /dev/sdc: 107.4 GB, 107374182400 bytes, 209715200 sectors</span><br><span class="line">Units = sectors of 1 * 512 = 512 bytes</span><br><span class="line">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class="line">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br><span class="line"></span><br><span class="line">es-node-0 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line"></span><br><span class="line">Disk /dev/sdb: 214.7 GB, 214748364800 bytes, 419430400 sectors</span><br><span class="line">Units = sectors of 1 * 512 = 512 bytes</span><br><span class="line">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class="line">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Disk /dev/sda: 42.9 GB, 42949672960 bytes, 83886080 sectors</span><br><span class="line">Units = sectors of 1 * 512 = 512 bytes</span><br><span class="line">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class="line">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br><span class="line">Disk label type: dos</span><br><span class="line">Disk identifier: 0x00019df2</span><br><span class="line"></span><br><span class="line">   Device Boot      Start         End      Blocks   Id  System</span><br><span class="line">/dev/sda1   *        2048     2099199     1048576   83  Linux</span><br><span class="line">/dev/sda2         2099200    83886079    40893440   8e  Linux LVM</span><br><span class="line"></span><br><span class="line">Disk /dev/mapper/centos-root: 39.7 GB, 39720058880 bytes, 77578240 sectors</span><br><span class="line">Units = sectors of 1 * 512 = 512 bytes</span><br><span class="line">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class="line">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Disk /dev/mapper/centos-swap: 2147 MB, 2147483648 bytes, 4194304 sectors</span><br><span class="line">Units = sectors of 1 * 512 = 512 bytes</span><br><span class="line">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class="line">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Disk /dev/sdc: 107.4 GB, 107374182400 bytes, 209715200 sectors</span><br><span class="line">Units = sectors of 1 * 512 = 512 bytes</span><br><span class="line">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class="line">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br><span class="line"></span><br><span class="line">es-node-2 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line"></span><br><span class="line">Disk /dev/sda: 42.9 GB, 42949672960 bytes, 83886080 sectors</span><br><span class="line">Units = sectors of 1 * 512 = 512 bytes</span><br><span class="line">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class="line">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br><span class="line">Disk label type: dos</span><br><span class="line">Disk identifier: 0x00019df2</span><br><span class="line"></span><br><span class="line">   Device Boot      Start         End      Blocks   Id  System</span><br><span class="line">/dev/sda1   *        2048     2099199     1048576   83  Linux</span><br><span class="line">/dev/sda2         2099200    83886079    40893440   8e  Linux LVM</span><br><span class="line"></span><br><span class="line">Disk /dev/sdb: 214.7 GB, 214748364800 bytes, 419430400 sectors</span><br><span class="line">Units = sectors of 1 * 512 = 512 bytes</span><br><span class="line">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class="line">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Disk /dev/mapper/centos-root: 39.7 GB, 39720058880 bytes, 77578240 sectors</span><br><span class="line">Units = sectors of 1 * 512 = 512 bytes</span><br><span class="line">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class="line">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Disk /dev/mapper/centos-swap: 2147 MB, 2147483648 bytes, 4194304 sectors</span><br><span class="line">Units = sectors of 1 * 512 = 512 bytes</span><br><span class="line">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class="line">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Disk /dev/sdc: 107.4 GB, 107374182400 bytes, 209715200 sectors</span><br><span class="line">Units = sectors of 1 * 512 = 512 bytes</span><br><span class="line">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class="line">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">利用ansible-playbook格式化数据盘</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">重点注意，一定要加-l参数指定es主机 利用-e参数替换默认的playbook的盘符和挂载点</span></span><br><span class="line"></span><br><span class="line">(ansible2.8) [root@zdevops-master dev]# ansible-playbook -l es -e data_disk=sdc -e data_disk_path=&quot;/data&quot; ../../playbooks/init-disk.yaml</span><br><span class="line">/opt/ansible2.8/lib/python2.7/site-packages/ansible/parsing/vault/__init__.py:44: CryptographyDeprecationWarning: Python 2 is no longer supported by the Python core team. Support for it is now deprecated in cryptography, and will be removed in the next release.</span><br><span class="line">  from cryptography.exceptions import InvalidSignature</span><br><span class="line"></span><br><span class="line">PLAY [初始化磁盘.] *************************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [01-数据磁盘分区.] *********************************************************************************************</span><br><span class="line">changed: [es-node-1]</span><br><span class="line">changed: [es-node-2]</span><br><span class="line">changed: [es-node-0]</span><br><span class="line"></span><br><span class="line">TASK [02-格式化数据磁盘.] ********************************************************************************************</span><br><span class="line">changed: [es-node-0]</span><br><span class="line">changed: [es-node-1]</span><br><span class="line">changed: [es-node-2]</span><br><span class="line"></span><br><span class="line">TASK [03-挂载数据盘.] **********************************************************************************************</span><br><span class="line">changed: [es-node-0]</span><br><span class="line">changed: [es-node-1]</span><br><span class="line">changed: [es-node-2]</span><br><span class="line"></span><br><span class="line">PLAY RECAP ****************************************************************************************************</span><br><span class="line">es-node-0                  : ok=3    changed=3    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class="line">es-node-1                  : ok=3    changed=3    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class="line">es-node-2                  : ok=3    changed=3    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li><strong>扩展说明-虚拟化上磁盘插槽详情</strong></li>
<li><img src="https://znotes-1258881081.cos.ap-beijing.myqcloud.com/k8s-on-kubesphere/esxi-scsi.png" alt="esxi-scsi"></li>
</ul>
<blockquote>
<p><strong>04-验证数据盘的挂载</strong></p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">利用 ansible 验证数据盘是否格式化并挂载</span></span><br><span class="line">(ansible2.8) [root@zdevops-master dev]# ansible es -m shell -a &#x27;df -h&#x27;</span><br><span class="line">/opt/ansible2.8/lib/python2.7/site-packages/ansible/parsing/vault/__init__.py:44: CryptographyDeprecationWarning: Python 2 is no longer supported by the Python core team. Support for it is now deprecated in cryptography, and will be removed in the next release.</span><br><span class="line">  from cryptography.exceptions import InvalidSignature</span><br><span class="line">es-node-1 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">Filesystem               Size  Used Avail Use% Mounted on</span><br><span class="line">devtmpfs                 2.0G     0  2.0G   0% /dev</span><br><span class="line">tmpfs                    2.0G     0  2.0G   0% /dev/shm</span><br><span class="line">tmpfs                    2.0G   73M  1.9G   4% /run</span><br><span class="line">tmpfs                    2.0G     0  2.0G   0% /sys/fs/cgroup</span><br><span class="line">/dev/mapper/centos-root   37G  1.6G   36G   5% /</span><br><span class="line">/dev/sda1               1014M  168M  847M  17% /boot</span><br><span class="line">tmpfs                    396M     0  396M   0% /run/user/0</span><br><span class="line">/dev/sdc1                100G   33M  100G   1% /data</span><br><span class="line"></span><br><span class="line">es-node-2 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">Filesystem               Size  Used Avail Use% Mounted on</span><br><span class="line">devtmpfs                 2.0G     0  2.0G   0% /dev</span><br><span class="line">tmpfs                    2.0G     0  2.0G   0% /dev/shm</span><br><span class="line">tmpfs                    2.0G   89M  1.9G   5% /run</span><br><span class="line">tmpfs                    2.0G     0  2.0G   0% /sys/fs/cgroup</span><br><span class="line">/dev/mapper/centos-root   37G  1.6G   36G   5% /</span><br><span class="line">/dev/sda1               1014M  168M  847M  17% /boot</span><br><span class="line">/dev/sdc1                100G   33M  100G   1% /data</span><br><span class="line">tmpfs                    396M     0  396M   0% /run/user/0</span><br><span class="line"></span><br><span class="line">es-node-0 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">Filesystem               Size  Used Avail Use% Mounted on</span><br><span class="line">devtmpfs                 2.0G     0  2.0G   0% /dev</span><br><span class="line">tmpfs                    2.0G     0  2.0G   0% /dev/shm</span><br><span class="line">tmpfs                    2.0G  215M  1.8G  11% /run</span><br><span class="line">tmpfs                    2.0G     0  2.0G   0% /sys/fs/cgroup</span><br><span class="line">/dev/mapper/centos-root   37G  1.7G   36G   5% /</span><br><span class="line">/dev/sda1               1014M  168M  847M  17% /boot</span><br><span class="line">tmpfs                    396M     0  396M   0% /run/user/0</span><br><span class="line">/dev/sdc1                100G   33M  100G   1% /data</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">利用 ansible 验证数据盘是否配置自动挂载</span></span><br><span class="line">(ansible2.8) [root@zdevops-master dev]# ansible es -m shell -a &#x27;tail -1  /etc/fstab&#x27;</span><br><span class="line">/opt/ansible2.8/lib/python2.7/site-packages/ansible/parsing/vault/__init__.py:44: CryptographyDeprecationWarning: Python 2 is no longer supported by the Python core team. Support for it is now deprecated in cryptography, and will be removed in the next release.</span><br><span class="line">  from cryptography.exceptions import InvalidSignature</span><br><span class="line">es-node-1 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">/dev/sdc1 /data xfs defaults 0 0</span><br><span class="line"></span><br><span class="line">es-node-2 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">/dev/sdc1 /data xfs defaults 0 0</span><br><span class="line"></span><br><span class="line">es-node-0 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">/dev/sdc1 /data xfs defaults 0 0</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="02-ElasticSearch-安装配置-手工安装配置"><a href="#02-ElasticSearch-安装配置-手工安装配置" class="headerlink" title="02. ElasticSearch 安装配置-手工安装配置"></a>02. ElasticSearch 安装配置-手工安装配置</h3><p><strong>以下配置如无特殊说明，所有节点都要执行</strong></p>
<blockquote>
<p><strong>01-配置 yum 源</strong></p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@es-node-0 ~]# vi /etc/yum.repos.d/elasticsearch.repo</span><br><span class="line"></span><br><span class="line">[elasticsearch]</span><br><span class="line">baseurl=https://artifacts.elastic.co/packages/7.x/yum</span><br><span class="line">gpgkey=https://artifacts.elastic.co/GPG-KEY-elasticsearch</span><br><span class="line">gpgcheck=1</span><br><span class="line">enable=1</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>02-安装 ElasticSearch</strong></p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@es-node-0 ~]# yum install  elasticsearch -y</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>03-创建 elasticsearch 配置文件</strong></p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">先备份初始的配置文件(运维必备习惯)</span></span><br><span class="line">[root@es-node-0 ~]# cp /etc/elasticsearch/elasticsearch.yml /etc/elasticsearch/elasticsearch.yml.bak</span><br><span class="line"></span><br><span class="line">[root@es-node-0 ~]# vi /etc/elasticsearch/elasticsearch.yml</span><br><span class="line"></span><br><span class="line">cluster.name: es-lstack</span><br><span class="line">node.name: es</span><br><span class="line">node.master: true</span><br><span class="line">path.data: /data01/elasticsearch/data</span><br><span class="line">path.logs: /data01/elasticsearch/logs</span><br><span class="line">network.host: 192.168.9.95		#注意修改每个节点对应的的ip地址</span><br><span class="line">http.port: 9200</span><br><span class="line">discovery.seed_hosts: [&quot;192.168.9.95&quot;,&quot;192.168.9.96&quot;,&quot;192.168.9.97&quot;]		#集群的每个节点地址</span><br><span class="line">cluster.initial_master_nodes: [&quot;es-node-0&quot;, &quot;es-node-1&quot;, &quot;es-node-2&quot;]		#集群的每个节点名称</span><br><span class="line"></span><br><span class="line">xpack.security.enabled: true</span><br><span class="line">xpack.security.transport.ssl.enabled: true</span><br><span class="line">xpack.security.transport.ssl.keystore.path: cert/es-node-0.p12	#证书路径</span><br><span class="line">xpack.security.transport.ssl.truststore.path: cert/es-node-0.p12	#证书路径</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>04-创建 elasticsearch 数据文件目录</strong></p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@es-node-0 ~]# mkdir -p /data01/elasticsearch</span><br><span class="line">[root@es-node-0 ~]# chown -R elasticsearch.elasticsearch /data01/elasticsearch</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">证书目录</span></span><br><span class="line">[root@es-node-0 ~]# mkdir -p /etc/elasticsearch/cert/</span><br><span class="line">[root@es-node-0 ~]# chown -R elasticsearch.elasticsearch /etc/elasticsearch/cert/</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>05-生成 instances 文件用来配置证书-开启认证可选配置 (在节点 1 中执行)</strong></p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在节点1中执行</span></span><br><span class="line">[root@es-node-0 ~]# vi /etc/elasticsearch/elasticsearch-instances.yml</span><br><span class="line"></span><br><span class="line">instances:</span><br><span class="line">  - name: &quot;es-node-0&quot;  #注意修改每个节点的ip地址</span><br><span class="line">    ip: </span><br><span class="line">      - &quot;192.168.2.163&quot;</span><br><span class="line">  - name: &quot;es-node-1&quot;</span><br><span class="line">    ip:</span><br><span class="line">      - &quot;192.168.2.124&quot;</span><br><span class="line">  - name: &quot;es-node-2&quot;</span><br><span class="line">    ip:</span><br><span class="line">      - &quot;192.168.2.141&quot;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>06-生成证书-开启认证可选配置 (在节点 1 中执行)</strong></p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@es-node-0 ~]# /usr/share/elasticsearch/bin/elasticsearch-certutil cert --silent --in /etc/elasticsearch/elasticsearch-instances.yml --out /etc/elasticsearch/elasticsearch-instances.zip --pass VD41fXmOvp5hGlPc  #这是密码（在接下来是需要使用的）</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">解压证书压缩包</span></span><br><span class="line">[root@es-node-0 ~]# cd  /etc/elasticsearch/</span><br><span class="line">[root@es-node-0 ~]# unzip elasticsearch-instances.zip</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">将证书放到本机指定目录</span></span><br><span class="line"></span><br><span class="line">[root@es-node-0 ~]# cp es-node-0/es-node-0.p12 /etc/elasticsearch/cert/</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">复制证书到其他的机器上</span></span><br><span class="line">[root@es-node-0 ~]# scp -r es-node-1/es-node-1.p12 root@192.168.9.96:/etc/elasticsearch/cert/</span><br><span class="line">[root@es-node-0 ~]# scp -r es-node-2/es-node-2.p12 root@192.168.9.97:/etc/elasticsearch/cert/</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>07-配置 keystore-开启认证可选配置</strong></p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">生成 keystore 文件</span></span><br><span class="line">[root@es-node-0 ~]# /usr/share/elasticsearch/bin/elasticsearch-keystore create</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">添加配置项到 keystore 文件</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">下面两个命令，均需要输入生成证书命令中使用的的密码</span></span><br><span class="line">[root@es-node-0 ~]# /usr/share/elasticsearch/bin/elasticsearch-keystore add xpack.security.transport.ssl.keystore.secure_password</span><br><span class="line">[root@es-node-0 ~]# /usr/share/elasticsearch/bin/elasticsearch-keystore add xpack.security.transport.ssl.truststore.secure_password</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建用户</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">-r指定权限 superuser 超级权限</span></span><br><span class="line">[root@es-node-0 ~]# /usr/share/elasticsearch/bin/elasticsearch-users useradd lstack -p P@88w0rd -r superuser   </span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>08-启动并设置开机自动启动 elasticsearch 服务</strong></p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@es-node-0 ~]# systemctl enable elasticsearch &amp;&amp; systemctl start  elasticsearch</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>09-测试访问</strong></p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ElasticSearch 不开启认证</span></span><br><span class="line">(ansible2.8) [root@zdevops-master dev]#  curl 192.168.9.95:9200/_cat/nodes?</span><br><span class="line">192.168.9.97 49 69 6 0.03 0.29 0.21 cdfhilmrstw * es-node-2</span><br><span class="line">192.168.9.95 26 73 3 0.04 0.13 0.14 cdfhilmrstw - es-node-0</span><br><span class="line">192.168.9.96 37 66 4 0.01 0.10 0.11 cdfhilmrstw - es-node-1</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ElasticSearch 开启认证</span></span><br><span class="line">(ansible2.8) [root@zdevops-master dev]#  curl -ulstack:&#x27;P@88w0rd&#x27; 192.168.9.95:9200/_cat/nodes?</span><br><span class="line">192.168.9.97 49 69 6 0.03 0.29 0.21 cdfhilmrstw * es-node-2</span><br><span class="line">192.168.9.95 26 73 3 0.04 0.13 0.14 cdfhilmrstw - es-node-0</span><br><span class="line">192.168.9.96 37 66 4 0.01 0.10 0.11 cdfhilmrstw - es-node-1</span><br></pre></td></tr></table></figure>

<h3 id="03-ElasticSearch-安装配置-Ansible-自动安装配置"><a href="#03-ElasticSearch-安装配置-Ansible-自动安装配置" class="headerlink" title="03. ElasticSearch 安装配置-Ansible 自动安装配置"></a>03. ElasticSearch 安装配置-Ansible 自动安装配置</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">利用 ansible-playbook 自动化安装配置 ElasticSearch</span></span><br><span class="line">(ansible2.8) [root@zdevops-master dev]# ansible-playbook ../../playbooks/deploy-elasticsearch.yaml </span><br><span class="line">/opt/ansible2.8/lib/python2.7/site-packages/ansible/parsing/vault/__init__.py:44: CryptographyDeprecationWarning: Python 2 is no longer supported by the Python core team. Support for it is now deprecated in cryptography, and will be removed in the next release.</span><br><span class="line">  from cryptography.exceptions import InvalidSignature</span><br><span class="line"></span><br><span class="line">PLAY [安装配置ElasticSearch.] *************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [01-配置yum源-配置elasticsearch软件源.] **************************************************************************</span><br><span class="line">changed: [es-node-1]</span><br><span class="line">changed: [es-node-0]</span><br><span class="line">changed: [es-node-2]</span><br><span class="line"></span><br><span class="line">TASK [02-安装elasticsearch.] ************************************************************************************</span><br><span class="line">changed: [es-node-2]</span><br><span class="line">changed: [es-node-1]</span><br><span class="line">changed: [es-node-0]</span><br><span class="line"></span><br><span class="line">TASK [03-创建elasticsearch配置文件.] ********************************************************************************</span><br><span class="line">changed: [es-node-0]</span><br><span class="line">changed: [es-node-2]</span><br><span class="line">changed: [es-node-1]</span><br><span class="line"></span><br><span class="line">TASK [04-创建elasticsearch数据文件目录.] ******************************************************************************</span><br><span class="line">changed: [es-node-1]</span><br><span class="line">changed: [es-node-0]</span><br><span class="line">changed: [es-node-2]</span><br><span class="line"></span><br><span class="line">PLAY [安装配置ElasticSearch SSL认证.] *******************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [01-生成ElasticSearch Instance文件用来配置ssl证书.] ****************************************************************</span><br><span class="line">changed: [es-node-0]</span><br><span class="line"></span><br><span class="line">TASK [02-生成证书.] ***********************************************************************************************</span><br><span class="line">changed: [es-node-0]</span><br><span class="line"></span><br><span class="line">TASK [03-安装基本工具包.] ********************************************************************************************</span><br><span class="line">ok: [es-node-0] =&gt; (item=[u&#x27;unzip&#x27;])</span><br><span class="line"></span><br><span class="line">TASK [04-解压cert文件.] *******************************************************************************************</span><br><span class="line">changed: [es-node-0]</span><br><span class="line"></span><br><span class="line">TASK [05-从服务器获取cert配置文件.] *************************************************************************************</span><br><span class="line">changed: [es-node-0] =&gt; (item=es-node-0)</span><br><span class="line">changed: [es-node-0] =&gt; (item=es-node-1)</span><br><span class="line">changed: [es-node-0] =&gt; (item=es-node-2)</span><br><span class="line"></span><br><span class="line">PLAY [认证配置.] **************************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [01-创建elasticsearch cert目录.] *****************************************************************************</span><br><span class="line">changed: [es-node-0]</span><br><span class="line">changed: [es-node-2]</span><br><span class="line">changed: [es-node-1]</span><br><span class="line"></span><br><span class="line">TASK [02-同步cert文件.] *******************************************************************************************</span><br><span class="line">changed: [es-node-0]</span><br><span class="line">changed: [es-node-1]</span><br><span class="line">changed: [es-node-2]</span><br><span class="line"></span><br><span class="line">TASK [03-生成keystore文件.] ***************************************************************************************</span><br><span class="line">ok: [es-node-0]</span><br><span class="line">ok: [es-node-1]</span><br><span class="line">ok: [es-node-2]</span><br><span class="line"></span><br><span class="line">TASK [04-添加配置项到keystore文件.] ***********************************************************************************</span><br><span class="line">changed: [es-node-1]</span><br><span class="line">changed: [es-node-0]</span><br><span class="line">changed: [es-node-2]</span><br><span class="line"></span><br><span class="line">TASK [05-创建用户并指定superuser权限.] *********************************************************************************</span><br><span class="line">changed: [es-node-1]</span><br><span class="line">changed: [es-node-0]</span><br><span class="line">changed: [es-node-2]</span><br><span class="line"></span><br><span class="line">PLAY [终极配置.] **************************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [01-启动并设置开机自动启动elasticsearch服务.] *************************************************************************</span><br><span class="line">changed: [es-node-1]</span><br><span class="line">changed: [es-node-0]</span><br><span class="line">changed: [es-node-2]</span><br><span class="line"></span><br><span class="line">PLAY RECAP ****************************************************************************************************</span><br><span class="line">es-node-0                  : ok=15   changed=13   unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class="line">es-node-1                  : ok=10   changed=9    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class="line">es-node-2                  : ok=10   changed=9    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="04-ElasticSearch-常用运维命令"><a href="#04-ElasticSearch-常用运维命令" class="headerlink" title="04. ElasticSearch 常用运维命令"></a>04. ElasticSearch 常用运维命令</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看服务状态</span></span><br><span class="line">systemctl status elasticsearch.service</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动服务</span></span><br><span class="line">systemctl start elasticsearch.service</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">停止服务</span></span><br><span class="line">systemctl stop elasticsearch.service</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看简略的服务日志</span></span><br><span class="line">journalctl -u elasticsearch.service</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看详细的服务日志</span></span><br><span class="line">/data/elasticsearch/logs</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看gc日志</span></span><br><span class="line">/var/log/elasticsearch</span><br></pre></td></tr></table></figure>

<h3 id="05-ElasticSearch-调优"><a href="#05-ElasticSearch-调优" class="headerlink" title="05. ElasticSearch 调优"></a>05. ElasticSearch 调优</h3><p><strong>暂未调优，后续再补</strong></p>
<h2 id="4-KubeSphere-配置"><a href="#4-KubeSphere-配置" class="headerlink" title="4. KubeSphere 配置"></a>4. KubeSphere 配置</h2><p>本文后面的内容是一篇略显冗余的长文，之所以出现这个情况，是因为我自己配置疏忽导致的，具体疏忽在哪里下面到了具体环节的时候有重点标注。为了保留故事的完整性我后面就将错就错了，给大家展示了我排查故障、发现错误、改正错误的全流程。</p>
<h3 id="01-开启-KubeSphere-日志系统可插拔组件"><a href="#01-开启-KubeSphere-日志系统可插拔组件" class="headerlink" title="01. 开启 KubeSphere 日志系统可插拔组件"></a>01. 开启 KubeSphere 日志系统可插拔组件</h3><ol>
<li><p>编辑 <strong>CRD</strong> 中的 <strong>ks-installer</strong> 的 YAML 配置文件。</p>
<ul>
<li><p>在 YAML 文件中，搜索 <strong>logging,auditing,events</strong>，并将 <strong>enabled</strong> 的 <strong>false</strong> 改为 <strong>true</strong>。</p>
</li>
<li><p>&#96;&#96;&#96;yaml<br>logging:<br>  containerruntime: docker<br>  enabled: true<br>  logsidecar:<br>enabled: true<br>replicas: 2<br>events:<br>  enabled: true</p>
<p>auditing:<br>  enabled: true</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- 在 YAML 文件中，搜索 **es**，将 **enabled** 的 **false** 改为 **true**。并修改外部的 es 服务器的信息。</span><br><span class="line"></span><br><span class="line">- ```yaml</span><br><span class="line">  es:</span><br><span class="line">    basicAuth:</span><br><span class="line">      enabled: true</span><br><span class="line">      password: &#x27;P@88w0rd&#x27;</span><br><span class="line">      username: &#x27;lstack&#x27;</span><br><span class="line">    elkPrefix: logstash</span><br><span class="line">    externalElasticsearchHost: &#x27;192.168.9.65&#x27;</span><br><span class="line">    externalElasticsearchPort: &#x27;9200&#x27;</span><br><span class="line">    logMaxAge: 7</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>所有配置完成后，点击右下角的确定，保存配置。</p>
</li>
<li><p>在 kubectl 中执行以下命令检查安装过程</p>
<ul>
<li>&#96;&#96;&#96;shell<br>kubectl logs -n kubesphere-system $(kubectl get pod -n kubesphere-system -l app&#x3D;ks-install -o jsonpath&#x3D;’{.items[0].metadata.name}’) -f<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- 看到如下状态，说明安装成功。</span><br><span class="line"></span><br><span class="line">- ```yaml</span><br><span class="line">  TASK [ks-core/prepare : KubeSphere | Generating kubeconfig-admin] **************</span><br><span class="line">  skipping: [localhost]</span><br><span class="line">  </span><br><span class="line">  PLAY RECAP *********************************************************************</span><br><span class="line">  localhost                  : ok=26   changed=14   unreachable=0    failed=0    skipped=12   rescued=0    ignored=0</span><br><span class="line">  </span><br><span class="line">  Start installing monitoring</span><br><span class="line">  Start installing multicluster</span><br><span class="line">  Start installing openpitrix</span><br><span class="line">  Start installing network</span><br><span class="line">  Start installing alerting</span><br><span class="line">  Start installing auditing</span><br><span class="line">  Start installing devops</span><br><span class="line">  Start installing events</span><br><span class="line">  Start installing logging</span><br><span class="line">  **************************************************</span><br><span class="line">  Waiting for all tasks to be completed ...</span><br><span class="line">  task alerting status is successful  (1/9)</span><br><span class="line">  task network status is successful  (2/9)</span><br><span class="line">  task multicluster status is successful  (3/9)</span><br><span class="line">  task openpitrix status is successful  (4/9)</span><br><span class="line">  task auditing status is successful  (5/9)</span><br><span class="line">  task logging status is successful  (6/9)</span><br><span class="line">  task events status is successful  (7/9)</span><br><span class="line">  task devops status is successful  (8/9)</span><br><span class="line">  task monitoring status is successful  (9/9)</span><br><span class="line">  **************************************************</span><br><span class="line">  Collecting installation results ...</span><br><span class="line">  #####################################################</span><br><span class="line">  ###              Welcome to KubeSphere!           ###</span><br><span class="line">  #####################################################</span><br><span class="line">  </span><br><span class="line">  Console: http://192.168.9.91:30880</span><br><span class="line">  Account: admin</span><br><span class="line">  Password: P@88w0rd</span><br><span class="line">  </span><br><span class="line">  NOTES：</span><br><span class="line">    1. After you log into the console, please check the</span><br><span class="line">       monitoring status of service components in</span><br><span class="line">       &quot;Cluster Management&quot;. If any service is not</span><br><span class="line">       ready, please wait patiently until all components</span><br><span class="line">       are up and running.</span><br><span class="line">    2. Please change the default password after login.</span><br><span class="line">  </span><br><span class="line">  #####################################################</span><br><span class="line">  https://kubesphere.io             2022-04-15 11:54:50</span><br><span class="line">  #####################################################</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>验证安装结果。</p>
<blockquote>
<p><strong>01-日志系统组件</strong></p>
</blockquote>
<ul>
<li><p>登录控制台，<strong>平台管理</strong>-&gt;<strong>集群管理</strong>-&gt;<strong>系统组件</strong>，检查是否 <strong>日志</strong> 标签页中的所有组件都处于<strong>健康</strong>状态。如果是，表明组件安装成功。</p>
</li>
<li><p><img src="https://znotes-1258881081.cos.ap-beijing.myqcloud.com/k8s-on-kubesphere/kubesphere-clusters-components-logging.png" alt="kubesphere-clusters-components-logging"></p>
</li>
<li><p>点击右下角的<strong>工具箱</strong>按钮，多出几个分析工具的菜单</p>
</li>
<li><p><img src="https://znotes-1258881081.cos.ap-beijing.myqcloud.com/k8s-on-kubesphere/kubesphere-clusters-components-logging-2.png" alt="kubesphere-clusters-components-logging-2"></p>
</li>
<li><p>在 kubectl 工具中查看。</p>
</li>
<li><pre><code class="shell">/ # kubectl get pod -n kubesphere-logging-system
NAME                                            READY   STATUS    RESTARTS   AGE
fluent-bit-j5rvq                                1/1     Running   0          136m
fluent-bit-tqrqs                                1/1     Running   0          136m
fluent-bit-wv5hn                                1/1     Running   0          136m
fluentbit-operator-745bf5559f-lgq9p             1/1     Running   0          137m
ks-events-exporter-59d48f6777-ncgpc             2/2     Running   0          133m
ks-events-operator-5944645757-kqt65             1/1     Running   0          134m
ks-events-ruler-575669b4-lnpxc                  2/2     Running   0          133m
ks-events-ruler-575669b4-mh2fn                  2/2     Running   0          133m
kube-auditing-operator-84857bf967-kg7bs         1/1     Running   0          135m
kube-auditing-webhook-deploy-64cfb8c9f8-c65cb   1/1     Running   0          134m
kube-auditing-webhook-deploy-64cfb8c9f8-j8w5d   1/1     Running   0          134m
logsidecar-injector-deploy-5fb6fdc6dd-fv8vg     2/2     Running   0          134m
logsidecar-injector-deploy-5fb6fdc6dd-fxsbf     2/2     Running   0          134m
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&gt; **02-问题说明**</span><br><span class="line"></span><br><span class="line">- 上面的验证，表面上看日志系统是配置成功了，但是实际上还是存在问题的，接下来我们继续深入验证。</span><br><span class="line"></span><br><span class="line">- 点击**工具箱**中的**容器日志查询**，会出现如下报错，说明我们的 es 对接并没有成功。</span><br><span class="line"></span><br><span class="line">- ![kubesphere-logging-error-1](https://znotes-1258881081.cos.ap-beijing.myqcloud.com/k8s-on-kubesphere/kubesphere-logging-error-1.png)</span><br><span class="line"></span><br><span class="line">- 执行以下命令查看 Output 的配置，发现几个重要参数并没有变成我们想要的结果</span><br><span class="line"></span><br><span class="line">- ```shell</span><br><span class="line">  / # kubectl get output -n kubesphere-logging-system es -o yaml</span><br><span class="line">  apiVersion: logging.kubesphere.io/v1alpha2</span><br><span class="line">  kind: Output</span><br><span class="line">  metadata:</span><br><span class="line">    annotations:</span><br><span class="line">      kubectl.kubernetes.io/last-applied-configuration: |</span><br><span class="line">        &#123;&quot;apiVersion&quot;:&quot;logging.kubesphere.io/v1alpha2&quot;,&quot;kind&quot;:&quot;Output&quot;,&quot;metadata&quot;:&#123;&quot;annotations&quot;:&#123;&#125;,&quot;labels&quot;:&#123;&quot;logging.kubesphere.io/component&quot;:&quot;logging&quot;,&quot;logging.kubesphere.io/enabled&quot;:&quot;true&quot;&#125;,&quot;name&quot;:&quot;es&quot;,&quot;namespace&quot;:&quot;kubesphere-logging-system&quot;&#125;,&quot;spec&quot;:&#123;&quot;es&quot;:&#123;&quot;generateID&quot;:true,&quot;host&quot;:&quot;elasticsearch-logging-data.kubesphere-logging-system.svc&quot;,&quot;logstashFormat&quot;:true,&quot;logstashPrefix&quot;:&quot;ks-logstash-log&quot;,&quot;port&quot;:9200,&quot;timeKey&quot;:&quot;@timestamp&quot;&#125;,&quot;matchRegex&quot;:&quot;(?:kube|service)\\.(.*)&quot;&#125;&#125;</span><br><span class="line">    creationTimestamp: &quot;2022-04-15T03:51:11Z&quot;</span><br><span class="line">    generation: 1</span><br><span class="line">    labels:</span><br><span class="line">      logging.kubesphere.io/component: logging</span><br><span class="line">      logging.kubesphere.io/enabled: &quot;true&quot;</span><br><span class="line">    name: es</span><br><span class="line">    namespace: kubesphere-logging-system</span><br><span class="line">    resourceVersion: &quot;1503226&quot;</span><br><span class="line">    uid: 1a60036f-9ad0-4a3c-bab1-e077102a2724</span><br><span class="line">  spec:</span><br><span class="line">    es:</span><br><span class="line">      generateID: true</span><br><span class="line">      host: elasticsearch-logging-data.kubesphere-logging-system.svc</span><br><span class="line">      logstashFormat: true</span><br><span class="line">      logstashPrefix: ks-logstash-log</span><br><span class="line">      port: 9200</span><br><span class="line">      timeKey: &#x27;@timestamp&#x27;</span><br><span class="line">    matchRegex: (?:kube|service)\.(.*)</span><br></pre></td></tr></table></figure>
</code></pre>
</li>
<li><p>也可以在 KubeSphere 控制台中查看 Output 的配置。</p>
</li>
<li><p>登录控制台，在<strong>集群管理</strong>-&gt;<strong>CRD</strong> 中 , 搜索 output。</p>
</li>
<li><p><img src="https://znotes-1258881081.cos.ap-beijing.myqcloud.com/k8s-on-kubesphere/kubesphere-crd-output.png" alt="kubesphere-crd-output"></p>
</li>
<li><p>点击 <strong>Output</strong>，进入 Output 详情页，会发现有 <strong>es</strong>、<strong>es-auditing</strong>、<strong>es-events</strong> 三种资源。</p>
</li>
<li><p><img src="https://znotes-1258881081.cos.ap-beijing.myqcloud.com/k8s-on-kubesphere/kubesphere-crd-output-1.png" alt="kubesphere-crd-output-1"></p>
</li>
<li><p>编辑 <strong>es</strong> 的 YAML 配置（点击右侧的三个竖点的图标，会弹出编辑 YAML 的选项），可以看到配置文件跟我们命令行输出的结果一致。</p>
</li>
<li><p><img src="https://znotes-1258881081.cos.ap-beijing.myqcloud.com/k8s-on-kubesphere/kubesphere-crd-output-es-1.png" alt="kubesphere-crd-output-es-1"></p>
</li>
<li><p>查看 fluent-bit 容器。</p>
</li>
<li><p>&#96;&#96;&#96;shell<br>&#x2F; # kubectl get pods -n kubesphere-logging-system<br>NAME                                            READY   STATUS    RESTARTS   AGE<br>fluent-bit-j5rvq                                1&#x2F;1     Running   0          3h34m<br>fluent-bit-vv8pb                                1&#x2F;1     Running   0          103s<br>fluent-bit-wv5hn                                1&#x2F;1     Running   0          3h34m<br>fluentbit-operator-745bf5559f-lgq9p             1&#x2F;1     Running   0          3h36m<br>ks-events-exporter-59d48f6777-ncgpc             2&#x2F;2     Running   0          3h32m<br>ks-events-operator-5944645757-kqt65             1&#x2F;1     Running   0          3h32m<br>ks-events-ruler-575669b4-lnpxc                  2&#x2F;2     Running   0          3h32m<br>ks-events-ruler-575669b4-mh2fn                  2&#x2F;2     Running   0          3h32m<br>kube-auditing-operator-84857bf967-kg7bs         1&#x2F;1     Running   0          3h33m<br>kube-auditing-webhook-deploy-64cfb8c9f8-c65cb   1&#x2F;1     Running   0          3h32m<br>kube-auditing-webhook-deploy-64cfb8c9f8-j8w5d   1&#x2F;1     Running   0          3h32m<br>logsidecar-injector-deploy-5fb6fdc6dd-fv8vg     2&#x2F;2     Running   0          3h32m<br>logsidecar-injector-deploy-5fb6fdc6dd-fxsbf     2&#x2F;2     Running   0          3h32m</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- 查看 pod 的 log，也会发现大量的错误日志。</span><br><span class="line"></span><br><span class="line">- ```yaml</span><br><span class="line">  / # kubectl logs  fluent-bit-j5rvq -n kubesphere-logging-system </span><br><span class="line">  </span><br><span class="line">  ...</span><br><span class="line">   [2022/04/15 07:25:47] [ warn] [net] getaddrinfo(host=&#x27;elasticsearch-logging-data.kubesphere-logging-system.svc&#x27;, err=4): Domain name not found</span><br><span class="line">  </span><br><span class="line">   [2022/04/15 07:25:47] [ warn] [engine] failed to flush chunk &#x27;12-1650007543.816834850.flb&#x27;, retry in 6 seconds: task_id=2, input=tail.2 &gt; output=es.0 (out_id=0)</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ol>
<h3 id="02-外部-ElasticSearch-配置失败的解决过程"><a href="#02-外部-ElasticSearch-配置失败的解决过程" class="headerlink" title="02. 外部 ElasticSearch 配置失败的解决过程"></a>02. 外部 ElasticSearch 配置失败的解决过程</h3><p>下面我们想办法解决上面配置异常的问题。</p>
<ol>
<li><p>查找官方论坛，关键词使用<strong>外部 es</strong> 找到了以下一篇看着比较接近的文档，打开来看看。</p>
<ul>
<li><blockquote>
<p><a target="_blank" rel="noopener" href="https://kubesphere.com.cn/forum/d/6455-321es">3.2.1 版本日志系统对接外部 ES 无法正常收集日志</a></p>
</blockquote>
</li>
<li><p><img src="https://znotes-1258881081.cos.ap-beijing.myqcloud.com/k8s-on-kubesphere/elasticsearch-error-1.png" alt="elasticsearch-error-1"></p>
</li>
<li><p>看了一遍文档，现象跟我的一摸一样，文档中也提到了解决方案，貌似提问的人按着配置文档配置成功了，那我们去看看文档中的解决方案</p>
</li>
<li><p><img src="https://znotes-1258881081.cos.ap-beijing.myqcloud.com/k8s-on-kubesphere/image-20220420095405948.png" alt="image-20220420095405948"></p>
</li>
<li><p>跳转到<a target="_blank" rel="noopener" href="https://kubesphere.io/zh/docs/faq/observability/logging/#%E5%A6%82%E4%BD%95%E5%B0%86%E6%97%A5%E5%BF%97%E5%AD%98%E5%82%A8%E6%94%B9%E4%B8%BA%E5%A4%96%E9%83%A8-elasticsearch-%E5%B9%B6%E5%85%B3%E9%97%AD%E5%86%85%E9%83%A8-elasticsearch">第一个参考链接</a>。</p>
</li>
<li><p>第一个参考链接里，有一节<strong>如何将日志存储改为外部 Elasticsearch 并关闭内部 Elasticsearch</strong>, 看了一遍就是介绍如何开启外部 es 的配置，跟我们之前在界面上编辑 <strong>ClusterConfiguration</strong> 是一样的。</p>
</li>
<li><p>但是第一个他这一步介绍了手工重新执行 <strong>ks-installer</strong> 的方法，我就假设我界面修改了配置，但是 <strong>ks-installer</strong> 没重新执行（实际上肯定已经执行了），我在手工执行一次。</p>
</li>
<li><pre><code class="shell">[root@ks-k8s-master-0 ~]# kubectl rollout restart deploy -n kubesphere-system ks-installer
deployment.apps/ks-installer restarted

[root@ks-k8s-master-0 ~]# kubectl rollout status deploy -n kubesphere-system ks-installer
deployment &quot;ks-installer&quot; successfully rolled out
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">  </span><br><span class="line">- 然后发现并没有什么改变，问题依旧。</span><br><span class="line"></span><br><span class="line">- 跳转到[第二个参考链接](https://github.com/wenchajun/ks-installer/blob/master/roles/ks-logging/templates/custom-output-elasticsearch-logging.yaml.j2)，这里是告诉我们手工修改的配置方式，暂时先不考虑，总感觉很多人遇到了，肯定有更好的方案，我们继续看论坛帖子。</span><br><span class="line"></span><br><span class="line">- 然后我在刚才的搜索结果中找到了[外部 es 无法正常收集日志](https://kubesphere.com.cn/forum/d/6590-es/3)，这篇文档的最后那兄弟说参考[github 的文档](https://github.com/kubesphere/kubesphere/issues/4640)解决了问题，那我们去试试 .</span><br><span class="line"></span><br><span class="line">- ![image-20220420103039813](https://znotes-1258881081.cos.ap-beijing.myqcloud.com/k8s-on-kubesphere/image-20220420103039813.png)</span><br><span class="line"></span><br><span class="line">- 该解决方案中也是修改配置文件，但是有一点，需要删掉配置文件中原来的 es 相关的 status 配置后，再次重新执行 ks-installer</span><br><span class="line"></span><br><span class="line">- ![image-20220420103344968](https://znotes-1258881081.cos.ap-beijing.myqcloud.com/k8s-on-kubesphere/image-20220420103344968.png)</span><br><span class="line"></span><br><span class="line">- 既然有这一段话 那么我们去看看我们实际环境的配置 , 但是我们的环境中并没有 es 的配置，因为我们最早的时候就没有启用内置的 es 服务。</span><br><span class="line"></span><br><span class="line">- ```shell</span><br><span class="line">  [root@ks-k8s-master-0 ~]# kubectl edit cc -n kubesphere-system ks-installer</span><br><span class="line">  </span><br><span class="line">  events:</span><br><span class="line">    enabledTime: 2022-04-15T16:22:59CST</span><br><span class="line">    status: enabled</span><br><span class="line">  fluentbit:</span><br><span class="line">    enabledTime: 2022-04-15T16:19:46CST</span><br><span class="line">    status: enabled</span><br><span class="line">  logging:</span><br><span class="line">    enabledTime: 2022-04-15T16:22:59CST</span><br><span class="line">    status: enabled</span><br></pre></td></tr></table></figure>
</code></pre>
</li>
<li><p>但是啊，本着宁杀错的原则，那我们删了这几段试试看看，重新执行 <strong>ks-installer</strong>，看看效果。</p>
</li>
<li><p>执行下面的命令，查看安装过程，确实开始了重新配置的过程（过程没截图 , 截取了几个相近的配置过程）</p>
</li>
<li><pre><code class="shell">[root@ks-k8s-master-0 ~]# kubectl logs -n kubesphere-system $(kubectl get pod -n kubesphere-system -l app=ks-install -o jsonpath=&#39;&#123;.items[0].metadata.name&#125;&#39;) -f

...

TASK [common : KubeSphere | Deleting elasticsearch] ****************************
skipping: [localhost]

TASK [common : KubeSphere | Waiting for seconds] *******************************
skipping: [localhost]

TASK [common : KubeSphere | Deploying elasticsearch-logging] *******************
skipping: [localhost]

TASK [common : KubeSphere | Importing es status] *******************************
skipping: [localhost]

TASK [common : KubeSphere | Deploying elasticsearch-logging-curator] ***********
changed: [localhost]

TASK [common : KubeSphere | Getting fluentbit installation files] **************
changed: [localhost]

TASK [common : KubeSphere | Creating custom manifests] *************************
changed: [localhost] =&gt; (item=&#123;&#39;path&#39;: &#39;fluentbit&#39;, &#39;file&#39;: &#39;custom-fluentbit-fluentBit.yaml&#39;&#125;)
changed: [localhost] =&gt; (item=&#123;&#39;path&#39;: &#39;init&#39;, &#39;file&#39;: &#39;custom-fluentbit-operator-deployment.yaml&#39;&#125;)

TASK [common : KubeSphere | Preparing fluentbit operator setup] ****************
changed: [localhost]

TASK [common : KubeSphere | Deploying new fluentbit operator] ******************
changed: [localhost]

TASK [common : KubeSphere | Importing fluentbit status] ************************
changed: [localhost]

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- 等到彻底执行完成后，我发现我又失望了，问题依旧 , 看了一眼 Output 的配置，没啥变化。</span><br><span class="line"></span><br><span class="line">- ```shell</span><br><span class="line">  [root@ks-k8s-master-0 ~]#  kubectl get output -n kubesphere-logging-system es -oyaml</span><br><span class="line">  apiVersion: logging.kubesphere.io/v1alpha2</span><br><span class="line">  kind: Output</span><br><span class="line">  metadata:</span><br><span class="line">    annotations:</span><br><span class="line">      kubectl.kubernetes.io/last-applied-configuration: |</span><br><span class="line">        &#123;&quot;apiVersion&quot;:&quot;logging.kubesphere.io/v1alpha2&quot;,&quot;kind&quot;:&quot;Output&quot;,&quot;metadata&quot;:&#123;&quot;annotations&quot;:&#123;&#125;,&quot;labels&quot;:&#123;&quot;logging.kubesphere.io/component&quot;:&quot;logging&quot;,&quot;logging.kubesphere.io/enabled&quot;:&quot;true&quot;&#125;,&quot;name&quot;:&quot;es&quot;,&quot;namespace&quot;:&quot;kubesphere-logging-system&quot;&#125;,&quot;spec&quot;:&#123;&quot;es&quot;:&#123;&quot;generateID&quot;:true,&quot;host&quot;:&quot;elasticsearch-logging-data.kubesphere-logging-system.svc&quot;,&quot;logstashFormat&quot;:true,&quot;logstashPrefix&quot;:&quot;ks-logstash-log&quot;,&quot;port&quot;:9200,&quot;timeKey&quot;:&quot;@timestamp&quot;&#125;,&quot;matchRegex&quot;:&quot;(?:kube|service)\\.(.*)&quot;&#125;&#125;</span><br><span class="line">    creationTimestamp: &quot;2022-04-15T03:51:11Z&quot;</span><br><span class="line">    generation: 1</span><br><span class="line">    labels:</span><br><span class="line">      logging.kubesphere.io/component: logging</span><br><span class="line">      logging.kubesphere.io/enabled: &quot;true&quot;</span><br><span class="line">    name: es</span><br><span class="line">    namespace: kubesphere-logging-system</span><br><span class="line">    resourceVersion: &quot;1503226&quot;</span><br><span class="line">    uid: 1a60036f-9ad0-4a3c-bab1-e077102a2724</span><br><span class="line">  spec:</span><br><span class="line">    es:</span><br><span class="line">      generateID: true</span><br><span class="line">      host: elasticsearch-logging-data.kubesphere-logging-system.svc</span><br><span class="line">      logstashFormat: true</span><br><span class="line">      logstashPrefix: ks-logstash-log</span><br><span class="line">      port: 9200</span><br><span class="line">      timeKey: &#x27;@timestamp&#x27;</span><br><span class="line">    matchRegex: (?:kube|service)\.(.*)</span><br></pre></td></tr></table></figure>
</code></pre>
</li>
<li><p>看来上面提到的方法，应该可能只适用于<strong>原来开启过内置 es，后来又想换到外部 es 的场景</strong>。</p>
</li>
<li><p>那我们继续回来看<a target="_blank" rel="noopener" href="https://kubesphere.com.cn/forum/d/6590-es/3">外部 es 无法正常收集日志</a>这篇文档，里面还提到了一个参考链接<a target="_blank" rel="noopener" href="https://kubesphere.com.cn/forum/d/2450-kuspheredial-tcp-lookup-http-on-109601053-no-such-host/4">在使用 kusphere 的操作审计功能时，总有弹窗提示：dial tcp: lookup http on 10.96.0.10:53: no such host</a>.</p>
</li>
<li><p><img src="https://znotes-1258881081.cos.ap-beijing.myqcloud.com/k8s-on-kubesphere/image-20220420111124760.png" alt="image-20220420111124760"></p>
</li>
<li><p>该文档中的描述跟我们的现象类似，但不完全相同，文中提到的问题可以通过修改 <strong>ConfigMap</strong> 来解决，文章最后那哥们也说解决成功了。</p>
</li>
<li><p><img src="https://znotes-1258881081.cos.ap-beijing.myqcloud.com/k8s-on-kubesphere/image-20220420111152382.png" alt="image-20220420111152382"></p>
</li>
<li><p>我们看看我们对应的 ConfigMap 配置。</p>
</li>
<li><pre><code class="shell">[root@ks-k8s-master-0 ~]# kubectl get configmap kubesphere-config -n kubesphere-system -o yaml
apiVersion: v1
data:
  kubesphere.yaml: |
    authentication:
      authenticateRateLimiterMaxTries: 10
      authenticateRateLimiterDuration: 10m0s
      loginHistoryRetentionPeriod: 168h
      maximumClockSkew: 10s
      multipleLogin: True
      kubectlImage: kubesphere/kubectl:v1.21.0
      jwtSecret: &quot;1xh3ldfKpJSzSmFCbi2HXXbw5dn4o4kv&quot;
      oauthOptions:
        clients:
        - name: kubesphere
          secret: kubesphere
          redirectURIs:
          - &#39;*&#39;

    ldap:
      host: openldap.kubesphere-system.svc:389
      managerDN: cn=admin,dc=kubesphere,dc=io
      managerPassword: admin
      userSearchBase: ou=Users,dc=kubesphere,dc=io
      groupSearchBase: ou=Groups,dc=kubesphere,dc=io

    redis:
      host: redis.kubesphere-system.svc
      port: 6379
      password: KUBESPHERE_REDIS_PASSWORD
      db: 0

    s3:
      endpoint: http://minio.kubesphere-system.svc:9000
      region: us-east-1
      disableSSL: True
      forcePathStyle: True
      accessKeyID: openpitrixminioaccesskey
      secretAccessKey: openpitrixminiosecretkey
      bucket: s2i-binaries

    network:
      ippoolType: none
    devops:
      host: http://devops-jenkins.kubesphere-devops-system.svc/
      username: admin
      password: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJlbWFpbCI6ImFkbWluQGt1YmVzcGhlcmUuaW8iLCJ1c2VybmFtZSI6ImFkbWluIiwidG9rZW5fdHlwZSI6InN0YXRpY190b2tlbiJ9.DVnt9FY7UNu2Mvshh_46UMKhZG7_X7NPC-ClQ68ynB0
      maxConnections: 100
      endpoint: http://devops-apiserver.kubesphere-devops-system:9090
    openpitrix:
      s3:
        endpoint: http://minio.kubesphere-system.svc:9000
        region: us-east-1
        disableSSL: True
        forcePathStyle: True
        accessKeyID: openpitrixminioaccesskey
        secretAccessKey: openpitrixminiosecretkey
        bucket: app-store
    monitoring:
      endpoint: http://prometheus-operated.kubesphere-monitoring-system.svc:9090
      enableGPUMonitoring: false
    gpu:
      kinds:
      - resourceName: nvidia.com/gpu
        resourceType: GPU
        default: True
    notification:
      endpoint: http://notification-manager-svc.kubesphere-monitoring-system.svc:19093
    logging:
      host: http://elasticsearch-logging-data.kubesphere-logging-system.svc:9200
      basicAuth: True
      username: &quot;lstack&quot;
      password: &quot;P@88w0rd&quot;
      indexPrefix: ks-logstash-log
    events:
      host: http://elasticsearch-logging-data.kubesphere-logging-system.svc:9200
      basicAuth: True
      username: &quot;lstack&quot;
      password: &quot;P@88w0rd&quot;
      indexPrefix: ks-logstash-events
    auditing:
      enable: true
      webhookURL: https://kube-auditing-webhook-svc.kubesphere-logging-system.svc:6443/audit/webhook/event
      host: http://elasticsearch-logging-data.kubesphere-logging-system.svc:9200
      basicAuth: True
      username: &quot;lstack&quot;
      password: &quot;P@88w0rd&quot;
      indexPrefix: ks-logstash-auditing

    alerting:
      prometheusEndpoint: http://prometheus-operated.kubesphere-monitoring-system.svc:9090
      thanosRulerEndpoint: http://thanos-ruler-operated.kubesphere-monitoring-system.svc:10902
      thanosRuleResourceLabels: thanosruler=thanos-ruler,role=thanos-alerting-rules

    gateway:
      watchesPath: /var/helm-charts/watches.yaml
      repository: kubesphere/nginx-ingress-controller
      tag: v0.48.1
      namespace: kubesphere-controls-system
kind: ConfigMap
metadata:
  annotations:
    kubectl.kubernetes.io/last-applied-configuration: |
      &#123;&quot;apiVersion&quot;:&quot;v1&quot;,&quot;data&quot;:&#123;&quot;kubesphere.yaml&quot;:&quot;authentication:\n  authenticateRateLimiterMaxTries: 10\n  authenticateRateLimiterDuration: 10m0s\n  loginHistoryRetentionPeriod: 168h\n  maximumClockSkew: 10s\n  multipleLogin: True\n  kubectlImage: kubesphere/kubectl:v1.21.0\n  jwtSecret: \&quot;1xh3ldfKpJSzSmFCbi2HXXbw5dn4o4kv\&quot;\n  oauthOptions:\n    clients:\n    - name: kubesphere\n      secret: kubesphere\n      redirectURIs:\n      - &#39;*&#39;\n\nldap:\n  host: openldap.kubesphere-system.svc:389\n  managerDN: cn=admin,dc=kubesphere,dc=io\n  managerPassword: admin\n  userSearchBase: ou=Users,dc=kubesphere,dc=io\n  groupSearchBase: ou=Groups,dc=kubesphere,dc=io\n\nredis:\n  host: redis.kubesphere-system.svc\n  port: 6379\n  password: KUBESPHERE_REDIS_PASSWORD\n  db: 0\n\n\ns3:\n  endpoint: http://minio.kubesphere-system.svc:9000\n  region: us-east-1\n  disableSSL: True\n  forcePathStyle: True\n  accessKeyID: openpitrixminioaccesskey\n  secretAccessKey: openpitrixminiosecretkey\n  bucket: s2i-binaries\n\nnetwork:\n  ippoolType: none\ndevops:\n  host: http://devops-jenkins.kubesphere-devops-system.svc/\n  username: admin\n  password: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJlbWFpbCI6ImFkbWluQGt1YmVzcGhlcmUuaW8iLCJ1c2VybmFtZSI6ImFkbWluIiwidG9rZW5fdHlwZSI6InN0YXRpY190b2tlbiJ9.DVnt9FY7UNu2Mvshh_46UMKhZG7_X7NPC-ClQ68ynB0\n  maxConnections: 100\n  endpoint: http://devops-apiserver.kubesphere-devops-system:9090\nopenpitrix:\n  s3:\n    endpoint: http://minio.kubesphere-system.svc:9000\n    region: us-east-1\n    disableSSL: True\n    forcePathStyle: True\n    accessKeyID: openpitrixminioaccesskey\n    secretAccessKey: openpitrixminiosecretkey\n    bucket: app-store\nmonitoring:\n  endpoint: http://prometheus-operated.kubesphere-monitoring-system.svc:9090\n  enableGPUMonitoring: false\ngpu:\n  kinds:\n  - resourceName: nvidia.com/gpu\n    resourceType: GPU\n    default: True\nnotification:\n  endpoint: http://notification-manager-svc.kubesphere-monitoring-system.svc:19093\nlogging:\n  host: http://elasticsearch-logging-data.kubesphere-logging-system.svc:9200\n  basicAuth: True\n  username: \&quot;lstack\&quot;\n  password: \&quot;P@88w0rd\&quot;\n  indexPrefix: ks-logstash-log\nevents:\n  host: http://elasticsearch-logging-data.kubesphere-logging-system.svc:9200\n  basicAuth: True\n  username: \&quot;lstack\&quot;\n  password: \&quot;P@88w0rd\&quot;\n  indexPrefix: ks-logstash-events\nauditing:\n  enable: true\n  webhookURL: https://kube-auditing-webhook-svc.kubesphere-logging-system.svc:6443/audit/webhook/event\n  host: http://elasticsearch-logging-data.kubesphere-logging-system.svc:9200\n  basicAuth: True\n  username: \&quot;lstack\&quot;\n  password: \&quot;P@88w0rd\&quot;\n  indexPrefix: ks-logstash-auditing\n\nalerting:\n  prometheusEndpoint: http://prometheus-operated.kubesphere-monitoring-system.svc:9090\n  thanosRulerEndpoint: http://thanos-ruler-operated.kubesphere-monitoring-system.svc:10902\n  thanosRuleResourceLabels: thanosruler=thanos-ruler,role=thanos-alerting-rules\n\n\ngateway:\n  watchesPath: /var/helm-charts/watches.yaml\n  repository: kubesphere/nginx-ingress-controller\n  tag: v0.48.1\n  namespace: kubesphere-controls-system\n&quot;&#125;,&quot;kind&quot;:&quot;ConfigMap&quot;,&quot;metadata&quot;:&#123;&quot;annotations&quot;:&#123;&#125;,&quot;name&quot;:&quot;kubesphere-config&quot;,&quot;namespace&quot;:&quot;kubesphere-system&quot;&#125;&#125;
  creationTimestamp: &quot;2022-04-09T14:42:47Z&quot;
  name: kubesphere-config
  namespace: kubesphere-system
  resourceVersion: &quot;1557079&quot;
  uid: 2d45c34b-bc9d-43bd-a3d3-37b294393531
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">   - 我们发现几个相关配置的 host 地址确实是错的跟我们之前发现的一样，而且这里并没有明确的 es 配置。对于技术细节了解不深的我，直觉告诉我这个方向应该是错的，暂时不选。</span><br><span class="line"></span><br><span class="line">   - 排查到此时，我的心里已经烦躁不安了，搞了两个小时的我此时不想再找下去了，直接放出最后一招，去改 [Output](https://github.com/kubesphere/ks-installer/blob/master/roles/ks-logging/templates/custom-output-elasticsearch-logging.yaml.j2) 文件看看(我们前文介绍的论坛中一个帖子提到的)。</span><br><span class="line"></span><br><span class="line">2. 问题排查第二环节，修改 Output 文件。</span><br><span class="line"></span><br><span class="line">   - 先看看参考模板 **custom-output-elasticsearch-logging.yaml.j2** 的样子。</span><br><span class="line"></span><br><span class="line">   - ```yaml</span><br><span class="line">     apiVersion: logging.kubesphere.io/v1alpha2</span><br><span class="line">     kind: Output</span><br><span class="line">     metadata:</span><br><span class="line">       name: es</span><br><span class="line">       namespace: kubesphere-logging-system</span><br><span class="line">       labels:</span><br><span class="line">         logging.kubesphere.io/enabled: &quot;true&quot;</span><br><span class="line">         logging.kubesphere.io/component: &quot;logging&quot;</span><br><span class="line">     spec:</span><br><span class="line">       matchRegex: (?:kube|service)\.(.*)</span><br><span class="line">       es:</span><br><span class="line">         host: &quot;&#123;% if common.es.externalElasticsearchHost is defined and common.es.externalElasticsearchHost != &quot;&quot; %&#125;&#123;&#123; common.es.externalElasticsearchHost &#125;&#125;&#123;% else %&#125;elasticsearch-logging-data.kubesphere-logging-system.svc&#123;% endif %&#125;&quot;</span><br><span class="line">         port: &#123;% if common.es.externalElasticsearchPort is defined and common.es.externalElasticsearchPort != &quot;&quot; %&#125;&#123;&#123; common.es.externalElasticsearchPort &#125;&#125;&#123;% else %&#125;9200&#123;% endif %&#125;</span><br><span class="line">     </span><br><span class="line">     &#123;% if common.es.basicAuth is defined and common.es.basicAuth.enabled is defined and common.es.basicAuth.enabled %&#125;</span><br><span class="line">     &#123;% if common.es.basicAuth.username is defined and common.es.basicAuth.username != &quot;&quot; %&#125;</span><br><span class="line">         httpUser:</span><br><span class="line">           valueFrom:</span><br><span class="line">             secretKeyRef:</span><br><span class="line">               key: &quot;username&quot;</span><br><span class="line">               name: &quot;elasticsearch-credentials&quot;</span><br><span class="line">     &#123;% endif %&#125;</span><br><span class="line">     &#123;% if common.es.basicAuth.password is defined and common.es.basicAuth.password != &quot;&quot; %&#125;</span><br><span class="line">         httpPassword:</span><br><span class="line">           valueFrom:</span><br><span class="line">             secretKeyRef:</span><br><span class="line">               key: &quot;password&quot;</span><br><span class="line">               name: &quot;elasticsearch-credentials&quot;</span><br><span class="line">     &#123;% endif %&#125;</span><br><span class="line">     &#123;% endif %&#125;</span><br><span class="line">         generateID: true</span><br><span class="line">         logstashPrefix: &quot;ks-&#123;&#123; common.es.elkPrefix &#125;&#125;-log&quot;</span><br><span class="line">         logstashFormat: true</span><br><span class="line">         timeKey: &quot;@timestamp&quot;</span><br><span class="line">     &#123;% if common.es.externalElasticsearchProtocol is defined and common.es.externalElasticsearchProtocol == &quot;https&quot; %&#125;</span><br><span class="line">         tls:</span><br><span class="line">           verify: false</span><br><span class="line">     &#123;% endif %&#125;</span><br></pre></td></tr></table></figure>
</code></pre>
</li>
<li><p>小伙伴们你们看懂了么，好在我有 Ansible 的使用经验，之前也写过 Jinja2 的语法，否则暴脾气的我，又要拍桌子了。没看懂的也没关系，暂时先放着，我会在本文对应的直播视频中给大家讲解具体含义。</p>
</li>
<li><p>再来贴一次我们线上的配置。</p>
</li>
<li><pre><code class="shell">[root@ks-k8s-master-0 ~]# kubectl get outputs -n kubesphere-logging-system es -o yaml
apiVersion: logging.kubesphere.io/v1alpha2
kind: Output
metadata:
  annotations:
    kubectl.kubernetes.io/last-applied-configuration: |
      &#123;&quot;apiVersion&quot;:&quot;logging.kubesphere.io/v1alpha2&quot;,&quot;kind&quot;:&quot;Output&quot;,&quot;metadata&quot;:&#123;&quot;annotations&quot;:&#123;&#125;,&quot;labels&quot;:&#123;&quot;logging.kubesphere.io/component&quot;:&quot;logging&quot;,&quot;logging.kubesphere.io/enabled&quot;:&quot;true&quot;&#125;,&quot;name&quot;:&quot;es&quot;,&quot;namespace&quot;:&quot;kubesphere-logging-system&quot;&#125;,&quot;spec&quot;:&#123;&quot;es&quot;:&#123;&quot;generateID&quot;:true,&quot;host&quot;:&quot;elasticsearch-logging-data.kubesphere-logging-system.svc&quot;,&quot;logstashFormat&quot;:true,&quot;logstashPrefix&quot;:&quot;ks-logstash-log&quot;,&quot;port&quot;:9200,&quot;timeKey&quot;:&quot;@timestamp&quot;&#125;,&quot;matchRegex&quot;:&quot;(?:kube|service)\\.(.*)&quot;&#125;&#125;
  creationTimestamp: &quot;2022-04-15T03:51:11Z&quot;
  generation: 1
  labels:
    logging.kubesphere.io/component: logging
    logging.kubesphere.io/enabled: &quot;true&quot;
  name: es
  namespace: kubesphere-logging-system
  resourceVersion: &quot;1503226&quot;
  uid: 1a60036f-9ad0-4a3c-bab1-e077102a2724
spec:
  es:
    generateID: true
    host: elasticsearch-logging-data.kubesphere-logging-system.svc
    logstashFormat: true
    logstashPrefix: ks-logstash-log
    port: 9200
    timeKey: &#39;@timestamp&#39;
  matchRegex: (?:kube|service)\.(.*)
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- 通过分析模板，发现如果开启认证的话，需要调用 **elasticsearch-credentials** 这个 secrets，所以我们先检查一下，这个 secret 是否存在。</span><br><span class="line"></span><br><span class="line">- ```shell</span><br><span class="line">  [root@ks-k8s-master-0 ~]# kubectl get secrets elasticsearch-credentials -n kubesphere-logging-system </span><br><span class="line">  NAME                        TYPE                       DATA   AGE</span><br><span class="line">  elasticsearch-credentials   kubernetes.io/basic-auth   2      4d21h</span><br><span class="line">  [root@ks-k8s-master-0 ~]# kubectl get secrets elasticsearch-credentials -n kubesphere-logging-system -o yaml</span><br><span class="line">  apiVersion: v1</span><br><span class="line">  data:</span><br><span class="line">    password: UEA4OHcwcmQ=</span><br><span class="line">    username: bHN0YWNr</span><br><span class="line">  kind: Secret</span><br><span class="line">  metadata:</span><br><span class="line">    creationTimestamp: &quot;2022-04-15T05:56:51Z&quot;</span><br><span class="line">    name: elasticsearch-credentials</span><br><span class="line">    namespace: kubesphere-logging-system</span><br><span class="line">    resourceVersion: &quot;1528520&quot;</span><br><span class="line">    uid: d918b1e0-4562-490b-bed7-d1dce702589a</span><br><span class="line">  type: kubernetes.io/basic-auth</span><br></pre></td></tr></table></figure>
</code></pre>
</li>
<li><p>确认 secrets 存在，接下来我先把 Outpt 配置文件输出一份备份下来，然后再去修改配置文件。</p>
</li>
<li><pre><code class="shell">[root@ks-k8s-master-0 ~]# kubectl get outputs -n kubesphere-logging-system es -o yaml &gt; es.output.yaml
[root@ks-k8s-master-0 ~]# kubectl edit outputs -n kubesphere-logging-system es
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- 修改后的内容如下：</span><br><span class="line"></span><br><span class="line">- ```yaml</span><br><span class="line">  apiVersion: logging.kubesphere.io/v1alpha2</span><br><span class="line">  kind: Output</span><br><span class="line">  metadata:</span><br><span class="line">    annotations:</span><br><span class="line">      kubectl.kubernetes.io/last-applied-configuration: |</span><br><span class="line">        &#123;&quot;apiVersion&quot;:&quot;logging.kubesphere.io/v1alpha2&quot;,&quot;kind&quot;:&quot;Output&quot;,&quot;metadata&quot;:&#123;&quot;annotations&quot;:&#123;&#125;,&quot;labels&quot;:&#123;&quot;logging.kubesphere.io/component&quot;:&quot;logging&quot;,&quot;logging.kubesphere.io/enabled&quot;:&quot;true&quot;&#125;,&quot;name&quot;:&quot;es&quot;,&quot;namespace&quot;:&quot;kubesphere-logging-system&quot;&#125;,&quot;spec&quot;:&#123;&quot;es&quot;:&#123;&quot;generateID&quot;:true,&quot;host&quot;:&quot;elasticsearch-logging-data.kubesphere-logging-system.svc&quot;,&quot;logstashFormat&quot;:true,&quot;logstashPrefix&quot;:&quot;ks-logstash-log&quot;,&quot;port&quot;:9200,&quot;timeKey&quot;:&quot;@timestamp&quot;&#125;,&quot;matchRegex&quot;:&quot;(?:kube|service)\\.(.*)&quot;&#125;&#125;</span><br><span class="line">    creationTimestamp: &quot;2022-04-15T03:51:11Z&quot;</span><br><span class="line">    generation: 1</span><br><span class="line">    labels:</span><br><span class="line">      logging.kubesphere.io/component: logging</span><br><span class="line">      logging.kubesphere.io/enabled: &quot;true&quot;</span><br><span class="line">    name: es</span><br><span class="line">    namespace: kubesphere-logging-system</span><br><span class="line">    resourceVersion: &quot;1503226&quot;</span><br><span class="line">    uid: 1a60036f-9ad0-4a3c-bab1-e077102a2724</span><br><span class="line">  spec:</span><br><span class="line">    es:</span><br><span class="line">      generateID: true</span><br><span class="line">      host: 192.168.9.95</span><br><span class="line">      port: 9200</span><br><span class="line">      httpUser:</span><br><span class="line">        valueFrom:</span><br><span class="line">          secretKeyRef:</span><br><span class="line">            key: &quot;username&quot;</span><br><span class="line">            name: &quot;elasticsearch-credentials&quot;</span><br><span class="line">      httpPassword:</span><br><span class="line">        valueFrom:</span><br><span class="line">          secretKeyRef:</span><br><span class="line">            key: &quot;password&quot;</span><br><span class="line">            name: &quot;elasticsearch-credentials&quot;</span><br><span class="line">      logstashFormat: true</span><br><span class="line">      logstashPrefix: ks-logstash-log</span><br><span class="line">      tls:</span><br><span class="line">        verify: false</span><br><span class="line">      timeKey: &#x27;@timestamp&#x27;</span><br><span class="line">    matchRegex: (?:kube|service)\.(.*)</span><br></pre></td></tr></table></figure>
</code></pre>
</li>
<li><p>配置文件改造完成后，保存退出</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@ks-k8s-master-0 ~]# kubectl edit outputs -n kubesphere-logging-system es</span><br><span class="line">output.logging.kubesphere.io/es edited</span><br></pre></td></tr></table></figure>
</li>
<li><p>再次查看 es 的 Output 的资源配置 , 发现已经有变化了</p>
<blockquote>
<p><strong>重点说明 : 本文写到最后的时候我发现我这步就做错了 , 配置文件我不应该加下面的参数，不加的话到这步为止就都 ok 了不会再有后面的内容了，为了故事的完整性就继续按错的写了！！！</strong></p>
<p>tls:<br>  verify: false</p>
</blockquote>
</li>
<li><pre><code class="shell">[root@ks-k8s-master-0 ~]# kubectl get outputs -n kubesphere-logging-system es -o yaml
apiVersion: logging.kubesphere.io/v1alpha2
kind: Output
metadata:
  annotations:
    kubectl.kubernetes.io/last-applied-configuration: |
      &#123;&quot;apiVersion&quot;:&quot;logging.kubesphere.io/v1alpha2&quot;,&quot;kind&quot;:&quot;Output&quot;,&quot;metadata&quot;:&#123;&quot;annotations&quot;:&#123;&#125;,&quot;labels&quot;:&#123;&quot;logging.kubesphere.io/component&quot;:&quot;logging&quot;,&quot;logging.kubesphere.io/enabled&quot;:&quot;true&quot;&#125;,&quot;name&quot;:&quot;es&quot;,&quot;namespace&quot;:&quot;kubesphere-logging-system&quot;&#125;,&quot;spec&quot;:&#123;&quot;es&quot;:&#123;&quot;generateID&quot;:true,&quot;host&quot;:&quot;elasticsearch-logging-data.kubesphere-logging-system.svc&quot;,&quot;logstashFormat&quot;:true,&quot;logstashPrefix&quot;:&quot;ks-logstash-log&quot;,&quot;port&quot;:9200,&quot;timeKey&quot;:&quot;@timestamp&quot;&#125;,&quot;matchRegex&quot;:&quot;(?:kube|service)\\.(.*)&quot;&#125;&#125;
  creationTimestamp: &quot;2022-04-15T03:51:11Z&quot;
  generation: 2
  labels:
    logging.kubesphere.io/component: logging
    logging.kubesphere.io/enabled: &quot;true&quot;
  name: es
  namespace: kubesphere-logging-system
  resourceVersion: &quot;2865406&quot;
  uid: 1a60036f-9ad0-4a3c-bab1-e077102a2724
spec:
  es:
    generateID: true
    host: 192.168.9.95
    httpPassword:
      valueFrom:
        secretKeyRef:
          key: password
          name: elasticsearch-credentials
    httpUser:
      valueFrom:
        secretKeyRef:
          key: username
          name: elasticsearch-credentials
    logstashFormat: true
    logstashPrefix: ks-logstash-log
    port: 9200
    timeKey: &#39;@timestamp&#39;
    tls:
      verify: false
  matchRegex: (?:kube|service)\.(.*)
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- 我们再看看 fluent-bit 的日志 (截取部分关键日志)</span><br><span class="line"></span><br><span class="line">- ```shell</span><br><span class="line">  [root@ks-k8s-master-0 ~]# kubectl logs  fluent-bit-j5rvq -n kubesphere-logging-system</span><br><span class="line">  </span><br><span class="line">  [2022/04/20 03:43:19] [ warn] [net] getaddrinfo(host=&#x27;elasticsearch-logging-data.kubesphere-logging-system.svc&#x27;, err=4): Domain name not found</span><br><span class="line">  </span><br><span class="line">   [2022/04/20 03:43:19] [ warn] [engine] failed to flush chunk &#x27;12-1650426197.168443930.flb&#x27;, retry in 8 seconds: task_id=1, input=tail.2 &gt; output=es.0 (out_id=0)</span><br><span class="line">  </span><br><span class="line">   [2022/04/20 03:43:23] [ warn] [net] getaddrinfo(host=&#x27;elasticsearch-logging-data.kubesphere-logging-system.svc&#x27;, err=4): Domain name not found</span><br><span class="line">  </span><br><span class="line">   [2022/04/20 03:43:23] [ warn] [engine] chunk &#x27;12-1650426192.752749410.flb&#x27; cannot be retried: task_id=4, input=tail.2 &gt; output=es.0</span><br><span class="line">  </span><br><span class="line">   [2022/04/20 03:43:23] [ warn] [net] getaddrinfo(host=&#x27;elasticsearch-logging-data.kubesphere-logging-system.svc&#x27;, err=4): Domain name not found</span><br><span class="line">  </span><br><span class="line">   [2022/04/20 03:43:23] [ warn] [engine] chunk &#x27;12-1650426187.71256663.flb&#x27; cannot be retried: task_id=0, input=tail.2 &gt; output=es.0</span><br><span class="line">  </span><br><span class="line">   [2022/04/20 03:43:24] [ info] [engine] service stopped</span><br><span class="line">  </span><br><span class="line">   [2022/04/20 03:43:24] [ info] [input:tail:tail.2] inotify_fs_remove(): inode=416649 watch_fd=1</span><br><span class="line">  </span><br><span class="line">   [2022/04/20 03:43:24] [ info] [input:tail:tail.2] inotify_fs_remove(): inode=461549 watch_fd=2</span><br><span class="line">  </span><br><span class="line">   [2022/04/20 03:43:24] [ info] [input:tail:tail.2] inotify_fs_remove(): inode=134582558 watch_fd=3</span><br><span class="line">  </span><br><span class="line">   [2022/04/20 03:43:24] [ info] [input:tail:tail.2] inotify_fs_remove(): inode=268955529 watch_fd=5</span><br><span class="line">  </span><br><span class="line">   [2022/04/20 03:43:24] [ info] [input:tail:tail.2] inotify_fs_remove(): inode=373423 watch_fd=6</span><br><span class="line">  </span><br><span class="line">   [2022/04/20 03:43:24] [ info] [input:tail:tail.2] inotify_fs_remove(): inode=373208 watch_fd=7</span><br><span class="line">  </span><br><span class="line">   [2022/04/20 03:43:24] [ info] [input:tail:tail.2] inotify_fs_remove(): inode=403716654 watch_fd=8</span><br><span class="line">  </span><br><span class="line">   [2022/04/20 03:43:24] [ info] [input:tail:tail.2] inotify_fs_remove(): inode=134583208 watch_fd=9</span><br><span class="line">  </span><br><span class="line">   [2022/04/20 03:43:24] [ info] [input:tail:tail.2] inotify_fs_remove(): inode=269010417 watch_fd=11</span><br><span class="line">  </span><br><span class="line">   [2022/04/20 03:43:24] [ info] [input:tail:tail.2] inotify_fs_remove(): inode=403995814 watch_fd=13</span><br><span class="line">  </span><br><span class="line">   [2022/04/20 03:43:24] [ info] [input:tail:tail.2] inotify_fs_remove(): inode=962171 watch_fd=14</span><br><span class="line">  </span><br><span class="line">   [2022/04/20 03:43:24] [ info] [input:tail:tail.2] inotify_fs_remove(): inode=134580575 watch_fd=16</span><br><span class="line">  </span><br><span class="line">   [2022/04/20 03:43:24] [ info] [input:tail:tail.2] inotify_fs_remove(): inode=268955289 watch_fd=17</span><br><span class="line">  </span><br><span class="line">   [2022/04/20 03:43:24] [ info] [input:tail:tail.2] inotify_fs_remove(): inode=403715964 watch_fd=18</span><br><span class="line">  </span><br><span class="line">   [2022/04/20 03:43:24] [ info] [input:tail:tail.2] inotify_fs_remove(): inode=403855647 watch_fd=19</span><br><span class="line">  </span><br><span class="line">   [2022/04/20 03:43:24] [ info] [input:tail:tail.2] inotify_fs_remove(): inode=413299 watch_fd=20</span><br><span class="line">  </span><br><span class="line">   [2022/04/20 03:43:24] [ info] [input:tail:tail.2] inotify_fs_remove(): inode=375870 watch_fd=21</span><br><span class="line">  </span><br><span class="line">   [2022/04/20 03:43:24] [ info] [input:tail:tail.2] inotify_fs_remove(): inode=134581094 watch_fd=22</span><br><span class="line">  </span><br><span class="line">   [2022/04/20 03:43:24] [ info] [input:tail:tail.2] inotify_fs_remove(): inode=268956011 watch_fd=26</span><br><span class="line">  </span><br><span class="line">   [2022/04/20 03:43:24] [ info] [input:tail:tail.2] inotify_fs_remove(): inode=373969 watch_fd=27</span><br><span class="line">  </span><br><span class="line">   [2022/04/20 03:43:24] [ info] [input:tail:tail.2] inotify_fs_remove(): inode=403792092 watch_fd=28</span><br><span class="line">  </span><br><span class="line">   [2022/04/20 03:43:24] [ info] [input:tail:tail.2] inotify_fs_remove(): inode=412431 watch_fd=29</span><br><span class="line">  </span><br><span class="line">   [2022/04/20 03:43:24] [ info] [input:tail:tail.2] inotify_fs_remove(): inode=134738124 watch_fd=30</span><br><span class="line">  </span><br><span class="line">   [2022/04/20 03:43:24] [ info] [input:tail:tail.2] inotify_fs_remove(): inode=467559 watch_fd=31</span><br><span class="line">  </span><br><span class="line">   [2022/04/20 03:43:24] [ info] [input:tail:tail.2] inotify_fs_remove(): inode=403860482 watch_fd=32</span><br><span class="line">  </span><br><span class="line">   [2022/04/20 03:43:24] [ info] [input:tail:tail.2] inotify_fs_remove(): inode=463110 watch_fd=160</span><br><span class="line">  </span><br><span class="line">   [2022/04/20 03:43:24] [ info] [input:tail:tail.2] inotify_fs_remove(): inode=135190584 watch_fd=161</span><br><span class="line">  </span><br><span class="line">   [2022/04/20 03:43:24] [ info] [input:tail:tail.2] inotify_fs_remove(): inode=134738131 watch_fd=162</span><br><span class="line">  </span><br><span class="line">   [2022/04/20 03:43:24] [ info] [input:tail:tail.2] inotify_fs_remove(): inode=134583424 watch_fd=173</span><br><span class="line">  </span><br><span class="line">   [2022/04/20 03:43:24] [ info] [input:tail:tail.2] inotify_fs_remove(): inode=134583425 watch_fd=177</span><br><span class="line">  </span><br><span class="line">   [2022/04/20 03:43:24] [ info] [input:tail:tail.2] inotify_fs_remove(): inode=466327 watch_fd=183</span><br><span class="line">  </span><br><span class="line">   [2022/04/20 03:43:24] [ info] [input:tail:tail.2] inotify_fs_remove(): inode=269514179 watch_fd=184</span><br><span class="line">  </span><br><span class="line">   [2022/04/20 03:43:24] [ info] [input:tail:tail.2] inotify_fs_remove(): inode=412659 watch_fd=186</span><br><span class="line">  </span><br><span class="line">   level=error msg=&quot;Fluent bit exited&quot; error=null</span><br><span class="line">  </span><br><span class="line">   level=info msg=backoff delay=1s</span><br><span class="line">  </span><br><span class="line">   level=info msg=&quot;backoff timer done&quot; actual=1.000475459s expected=1s</span><br><span class="line">  </span><br><span class="line">   level=info msg=&quot;Fluent bit started&quot;</span><br><span class="line">  </span><br><span class="line">   Fluent Bit v1.8.3</span><br><span class="line">  </span><br><span class="line">   * Copyright (C) 2019-2021 The Fluent Bit Authors</span><br><span class="line">  </span><br><span class="line">   * Copyright (C) 2015-2018 Treasure Data</span><br><span class="line">  </span><br><span class="line">   * Fluent Bit is a CNCF sub-project under the umbrella of Fluentd</span><br><span class="line">  </span><br><span class="line">   * https://fluentbit.io</span><br><span class="line">  </span><br><span class="line">   [2022/04/20 03:43:25] [ info] [engine] started (pid=18)</span><br><span class="line">  </span><br><span class="line">   [2022/04/20 03:43:25] [ info] [storage] version=1.1.1, initializing...</span><br><span class="line">  </span><br><span class="line">   [2022/04/20 03:43:25] [ info] [storage] in-memory</span><br><span class="line">  </span><br><span class="line">   [2022/04/20 03:43:25] [ info] [storage] normal synchronization mode, checksum disabled, max_chunks_up=128</span><br><span class="line">  </span><br><span class="line">   [2022/04/20 03:43:25] [ info] [cmetrics] version=0.1.6</span><br><span class="line">  </span><br><span class="line">   [2022/04/20 03:43:25] [ info] [input:systemd:systemd.0] seek_cursor=s=5d0022eeaf454ba8a40dde2836de2f4d;i=963... OK</span><br><span class="line">  </span><br><span class="line">   [2022/04/20 03:43:25] [ info] [input:systemd:systemd.1] seek_cursor=s=5d0022eeaf454ba8a40dde2836de2f4d;i=96c... OK</span><br><span class="line">  </span><br><span class="line">   [2022/04/20 03:43:25] [ info] [filter:kubernetes:kubernetes.4] https=1 host=kubernetes.default.svc port=443</span><br><span class="line">  </span><br><span class="line">   [2022/04/20 03:43:25] [ info] [filter:kubernetes:kubernetes.4] local POD info OK</span><br><span class="line">  </span><br><span class="line">   [2022/04/20 03:43:25] [ info] [filter:kubernetes:kubernetes.4] testing connectivity with API server...</span><br><span class="line">  </span><br><span class="line">   [2022/04/20 03:43:25] [ info] [filter:kubernetes:kubernetes.4] connectivity OK</span><br><span class="line">  </span><br><span class="line">   [2022/04/20 03:43:25] [ info] [sp] stream processor started</span><br><span class="line">  </span><br><span class="line">   [2022/04/20 03:43:25] [ info] [input:tail:tail.2] inotify_fs_add(): inode=416649 watch_fd=1 name=/var/log/containers/alertmanager-main-2_kubesphere-monitoring-system_alertmanager-1a71f1d5b1136320644f3289e4b22544620db4a0d35a1ffec52bc534d729c358.log</span><br><span class="line">  </span><br><span class="line">   [2022/04/20 03:43:25] [ info] [input:tail:tail.2] inotify_fs_add(): inode=461549 watch_fd=2 name=/var/log/containers/alertmanager-main-2_kubesphere-monitoring-system_config-reloader-bc14c53008f1e800d6240a5b912239a3d5682c6dcb719f48c69b7e8ba5892e35.log</span><br><span class="line">  </span><br><span class="line">   [2022/04/20 03:43:25] [ info] [input:tail:tail.2] inotify_fs_add(): inode=134582558 watch_fd=3 name=/var/log/containers/calico-kube-controllers-75ddb95444-8xvf4_kube-system_calico-kube-controllers-dc90044aa0ce62e61dfb0842c8f2e5aa8d021738adffca847b003a5c9621512c.log</span><br><span class="line">  </span><br><span class="line">   [2022/04/20 03:43:25] [ info] [input:tail:tail.2] inotify_fs_add(): inode=134583425 watch_fd=4 name=/var/log/containers/calico-node-pzvrj_kube-system_calico-node-f2f40fb9878e3328a4783ceb9c01eaed9edf24c85579ed87c7ffc2161779c3e2.log</span><br><span class="line">  </span><br><span class="line">   [2022/04/20 03:43:25] [ info] [input:tail:tail.2] inotify_fs_add(): inode=268955529 watch_fd=5 name=/var/log/containers/calico-node-pzvrj_kube-system_flexvol-driver-abf59d8a7af22c683dfb0776a0835c719f41ef23446e912f82901a4fd9cf166f.log</span><br><span class="line">  </span><br><span class="line">   [2022/04/20 03:43:25] [ info] [input:tail:tail.2] inotify_fs_add(): inode=373423 watch_fd=6 name=/var/log/containers/calico-node-pzvrj_kube-system_install-cni-b3d49f2e9c03e63c3863d50365d2ade01dead979c90285c526ac0029b58411cd.log</span><br><span class="line">  </span><br><span class="line">   [2022/04/20 03:43:25] [ info] [input:tail:tail.2] inotify_fs_add(): inode=373208 watch_fd=7 name=/var/log/containers/calico-node-pzvrj_kube-system_upgrade-ipam-6d4425d7ea5302511df1c278f2b113ac8fdfa0a372e07b025e0a9b45d30129ac.log</span><br><span class="line">  </span><br><span class="line">   [2022/04/20 03:43:25] [ info] [input:tail:tail.2] inotify_fs_add(): inode=403716654 watch_fd=8 name=/var/log/containers/coredns-5495dd7c88-68k9b_kube-system_coredns-879c087a4c8717d0886e6603a63e9503a406d215cfe77941cbcc1cc7c138d010.log</span><br><span class="line">  </span><br><span class="line">   [2022/04/20 03:43:25] [ info] [input:tail:tail.2] inotify_fs_add(): inode=134583208 watch_fd=9 name=/var/log/containers/coredns-5495dd7c88-z9q6j_kube-system_coredns-80cd4427410de02465b415683817a75674a95777ffc0929f93e87506b120ca59.log</span><br><span class="line">  </span><br><span class="line">   [2022/04/20 03:43:25] [ info] [input:tail:tail.2] inotify_fs_add(): inode=466327 watch_fd=10 name=/var/log/containers/ks-apiserver-574966976-snfm4_kubesphere-system_ks-apiserver-8871a0cc18cfef4663a15680761e272efeafe061ea9a898319265a145b494b18.log</span><br><span class="line">  </span><br><span class="line">   [2022/04/20 03:43:25] [ info] [input:tail:tail.2] inotify_fs_add(): inode=269010417 watch_fd=11 name=/var/log/containers/ks-console-65f4d44d88-hzw9b_kubesphere-system_ks-console-f600455c3af064c53adc8eb7e5412505c4d0e50362ab11b8e59d2e71b552b0f1.log</span><br><span class="line">  </span><br><span class="line">   [2022/04/20 03:43:25] [ info] [input:tail:tail.2] inotify_fs_add(): inode=269514179 watch_fd=12 name=/var/log/containers/ks-controller-manager-79c7dc79f5-j9fz5_kubesphere-system_ks-controller-manager-a8c35247c7cda868d3c023616026515690d2fedf2abb0f9367d1dc338103f7af.log</span><br><span class="line">  </span><br><span class="line">   [2022/04/20 03:43:25] [ info] [input:tail:tail.2] inotify_fs_add(): inode=403995814 watch_fd=13 name=/var/log/containers/ks-events-ruler-575669b4-mh2fn_kubesphere-logging-system_config-reloader-2d51bab0babdd47864ec235efdbd69d2075cc8bf72c3642449be69f68aa1f0d5.log</span><br><span class="line">  </span><br><span class="line">   [2022/04/20 03:43:25] [ info] [input:tail:tail.2] inotify_fs_add(): inode=962171 watch_fd=14 name=/var/log/containers/ks-events-ruler-575669b4-mh2fn_kubesphere-logging-system_events-ruler-da24092a12c4fc0d0aab8a02c7fc7cb1e0e82d15a924717222bdbadee7935c84.log</span><br><span class="line">  </span><br><span class="line">   [2022/04/20 03:43:25] [ info] [input:tail:tail.2] inotify_fs_add(): inode=134583424 watch_fd=15 name=/var/log/containers/kube-apiserver-ks-k8s-master-0_kube-system_kube-apiserver-b4e97a525442956fe7612d27367a184ee09d65a56464149ec913ea004db0f1ef.log</span><br><span class="line">  </span><br><span class="line">   [2022/04/20 03:43:25] [ info] [input:tail:tail.2] inotify_fs_add(): inode=134580575 watch_fd=16 name=/var/log/containers/kube-controller-manager-ks-k8s-master-0_kube-system_kube-controller-manager-a07d1c5ed4108d98de2ba322b47939d5007c9d266a4ff558d57ec87ab10b2d54.log</span><br><span class="line">  </span><br><span class="line">   [2022/04/20 03:43:25] [ info] [input:tail:tail.2] inotify_fs_add(): inode=268955289 watch_fd=17 name=/var/log/containers/kube-proxy-bc59k_kube-system_kube-proxy-79144efa6b42a0f9636132538cc4ade6665269fea5903f3e1e0be05f14376d7c.log</span><br><span class="line">  </span><br><span class="line">   [2022/04/20 03:43:25] [ info] [input:tail:tail.2] inotify_fs_add(): inode=403715964 watch_fd=18 name=/var/log/containers/kube-scheduler-ks-k8s-master-0_kube-system_kube-scheduler-1a2ffcf4000a9bb0fa526fcfa1970e69465dfe0bb4c635a4d95f50f2e27ef763.log</span><br><span class="line">  </span><br><span class="line">   [2022/04/20 03:43:25] [ info] [input:tail:tail.2] inotify_fs_add(): inode=403855647 watch_fd=19 name=/var/log/containers/minio-859cb4d777-mpsk9_kubesphere-system_minio-d76f9516fa485cd24851afccfb2c85fd74ce894ba580af98703704860e1c00ed.log</span><br><span class="line">  </span><br><span class="line">   [2022/04/20 03:43:25] [ info] [input:tail:tail.2] inotify_fs_add(): inode=413299 watch_fd=20 name=/var/log/containers/node-exporter-wwrpf_kubesphere-monitoring-system_kube-rbac-proxy-e35229db1e46e8b7b0a7d5a3cd581107102a3531b31d2e32d7e787a118c82896.log</span><br><span class="line">  </span><br><span class="line">   [2022/04/20 03:43:25] [ info] [input:tail:tail.2] inotify_fs_add(): inode=375870 watch_fd=21 name=/var/log/containers/node-exporter-wwrpf_kubesphere-monitoring-system_node-exporter-e5cc5a4cc937cf9de149dd25bd6e8441ca176bf26cb2a214dd0b47627e7d8861.log</span><br><span class="line">  </span><br><span class="line">   [2022/04/20 03:43:25] [ info] [input:tail:tail.2] inotify_fs_add(): inode=134581094 watch_fd=22 name=/var/log/containers/nodelocaldns-sp59h_kube-system_node-cache-8b5bdf5a116af255f979a4a349c168257b632d24805d5f257a642dd97b0d53a1.log</span><br><span class="line">  </span><br><span class="line">   [2022/04/20 03:43:25] [ info] [input:tail:tail.2] inotify_fs_add(): inode=463110 watch_fd=23 name=/var/log/containers/prometheus-k8s-0_kubesphere-monitoring-system_config-reloader-1378a8d9cd7a96334cb15adeafb468497ece0a9a600a3193fb80b60bc5b7e9b5.log</span><br><span class="line">  </span><br><span class="line">   [2022/04/20 03:43:25] [ info] [input:tail:tail.2] inotify_fs_add(): inode=135190584 watch_fd=24 name=/var/log/containers/prometheus-k8s-0_kubesphere-monitoring-system_prometheus-26e94cf0828cd1bd9c5da45217b7f3e654a7a41ce0dc5943375b1644d1a6a002.log</span><br><span class="line">  </span><br><span class="line">   [2022/04/20 03:43:25] [ info] [input:tail:tail.2] inotify_fs_add(): inode=134738131 watch_fd=25 name=/var/log/containers/prometheus-k8s-0_kubesphere-monitoring-system_prometheus-97de8b484747bae4aeac54ffd9b75c1ddc9582a28c768ebc9be395390bd031c3.log</span><br><span class="line">  </span><br><span class="line">   [2022/04/20 03:43:25] [ info] [input:tail:tail.2] inotify_fs_add(): inode=268956011 watch_fd=26 name=/var/log/containers/redis-ha-haproxy-868fdbddd4-kqrl5_kubesphere-system_config-init-0fb775710352218a66aec02ea2a736892c33df43dd4206e155e0bce6af4aba63.log</span><br><span class="line">  </span><br><span class="line">   [2022/04/20 03:43:25] [ info] [input:tail:tail.2] inotify_fs_add(): inode=373969 watch_fd=27 name=/var/log/containers/redis-ha-haproxy-868fdbddd4-kqrl5_kubesphere-system_haproxy-6c15749c02904875f5c1a280a42a908baa074ccffd3365f40b2692b6fe60acf5.log</span><br><span class="line">  </span><br><span class="line">   [2022/04/20 03:43:25] [ info] [input:tail:tail.2] inotify_fs_add(): inode=403792092 watch_fd=28 name=/var/log/containers/redis-ha-server-2_kubesphere-system_config-init-fa7c66040a53bef1c3c9b1844a4b25870835a6147cd83abf914ebb129a036536.log</span><br><span class="line">  </span><br><span class="line">   [2022/04/20 03:43:25] [ info] [input:tail:tail.2] inotify_fs_add(): inode=412431 watch_fd=29 name=/var/log/containers/redis-ha-server-2_kubesphere-system_redis-6b19bb18f79c55cca6022bd8caa13a33d8c57386897db47fc011fd9fbe589b8a.log</span><br><span class="line">  </span><br><span class="line">   [2022/04/20 03:43:25] [ info] [input:tail:tail.2] inotify_fs_add(): inode=134738124 watch_fd=30 name=/var/log/containers/redis-ha-server-2_kubesphere-system_sentinel-7b2cbde0a38f45b692dd1679912bb9ba4bdfc358667c32164592a0e7ab2a87a6.log</span><br><span class="line">  </span><br><span class="line">   [2022/04/20 03:43:25] [ info] [input:tail:tail.2] inotify_fs_add(): inode=467559 watch_fd=31 name=/var/log/containers/thanos-ruler-kubesphere-1_kubesphere-monitoring-system_config-reloader-28aef566c79b3cc073a67787c6ad44902c88930f069ab26cf5657aa2d1235108.log</span><br><span class="line">  </span><br><span class="line">   [2022/04/20 03:43:25] [ info] [input:tail:tail.2] inotify_fs_add(): inode=403860482 watch_fd=32 name=/var/log/containers/thanos-ruler-kubesphere-1_kubesphere-monitoring-system_thanos-ruler-24cfbc7280d54f3289c4ae70d0bb25a4964dd2f759e8bddefad3cf92070b1903.log</span><br><span class="line">  </span><br><span class="line">   [2022/04/20 03:43:25] [ info] [input:tail:tail.2] inotify_fs_add(): inode=412659 watch_fd=33 name=/var/log/containers/fluent-bit-vv8pb_kubesphere-logging-system_fluent-bit-dfd9ef652ece992d5f6b9a57c84288d19ebae1d8dcbd8618758f956e35370182.log</span><br><span class="line">  </span><br><span class="line">   [2022/04/20 03:43:30] [ warn] [engine] failed to flush chunk &#x27;18-1650426205.971801521.flb&#x27;, retry in 9 seconds: task_id=1, input=tail.2 &gt; output=es.0 (out_id=0)</span><br><span class="line">  </span><br><span class="line">   [2022/04/20 03:43:30] [ warn] [engine] failed to flush chunk &#x27;18-1650426205.162979514.flb&#x27;, retry in 6 seconds: task_id=0, input=tail.2 &gt; output=es.0 (out_id=0)</span><br><span class="line">  </span><br><span class="line">   [2022/04/20 03:43:30] [ warn] [engine] failed to flush chunk &#x27;18-1650426206.629361363.flb&#x27;, retry in 9 seconds: task_id=2, input=tail.2 &gt; output=es.0 (out_id=0)</span><br><span class="line">  </span><br><span class="line">   [2022/04/20 03:43:35] [ warn] [engine] failed to flush chunk &#x27;18-1650426210.70782057.flb&#x27;, retry in 10 seconds: task_id=3, input=tail.2 &gt; output=es.0 (out_id=0)</span><br><span class="line">  </span><br><span class="line">   [2022/04/20 03:43:36] [ warn] [engine] chunk &#x27;18-1650426205.162979514.flb&#x27; cannot be retried: task_id=0, input=tail.2 &gt; output=es.0</span><br><span class="line">  </span><br><span class="line">   [2022/04/20 03:43:39] [ warn] [engine] chunk &#x27;18-1650426206.629361363.flb&#x27; cannot be retried: task_id=2, input=tail.2 &gt; output=es.0</span><br><span class="line">  </span><br><span class="line">   [2022/04/20 03:43:39] [ warn] [engine] chunk &#x27;18-1650426205.971801521.flb&#x27; cannot be retried: task_id=1, input=tail.2 &gt; output=es.0</span><br><span class="line">  </span><br><span class="line">   [2022/04/20 03:43:40] [ warn] [engine] failed to flush chunk &#x27;18-1650426215.131578181.flb&#x27;, retry in 11 seconds: task_id=0, input=tail.2 &gt; output=es.0 (out_id=0)</span><br></pre></td></tr></table></figure>
</code></pre>
</li>
<li><p>分析日志发现 <strong>Domain name not found</strong> 这个报错已经不存在了，说明 es 地址配置变更了，但是还有其他报错我们继续分析。</p>
</li>
<li><p>我们发现现在运行的 <strong>fluent-bit</strong> 还是 5 天前创建的（好吧，可以看到这个事情已经困扰了我 5 天了），尝试使用<strong>重启大法</strong>，没准 pod 在初始创建的时候会做什么特殊操作呢。</p>
</li>
<li><p><img src="https://znotes-1258881081.cos.ap-beijing.myqcloud.com/k8s-on-kubesphere/kubesphere-daemonsets-flunet-bit.png" alt="kubesphere-daemonsets-flunet-bit"></p>
</li>
<li><p>点击<strong>更多操作</strong>，<strong>重新创建</strong>。</p>
</li>
<li><p>不知道为啥 只给我重建了一个，不过先不管了，先看日志。</p>
</li>
<li><p><img src="https://znotes-1258881081.cos.ap-beijing.myqcloud.com/k8s-on-kubesphere/kubesphere-daemonsets-flunet-bit-1.png" alt="kubesphere-daemonsets-flunet-bit-1"></p>
</li>
<li><p>重建完成后，我们看看 pod 的新启动的日志 , 发现跟刚才差不多。</p>
</li>
<li><pre><code class="yaml"> level=info msg=&quot;Fluent bit started&quot;

 Fluent Bit v1.8.3

 * Copyright (C) 2019-2021 The Fluent Bit Authors

 * Copyright (C) 2015-2018 Treasure Data

 * Fluent Bit is a CNCF sub-project under the umbrella of Fluentd

 * https://fluentbit.io

 [2022/04/20 04:07:18] [ info] [engine] started (pid=15)

 [2022/04/20 04:07:18] [ info] [storage] version=1.1.1, initializing...

 [2022/04/20 04:07:18] [ info] [storage] in-memory

 [2022/04/20 04:07:18] [ info] [storage] normal synchronization mode, checksum disabled, max_chunks_up=128

 [2022/04/20 04:07:18] [ info] [cmetrics] version=0.1.6

 [2022/04/20 04:07:18] [ info] [filter:kubernetes:kubernetes.4] https=1 host=kubernetes.default.svc port=443

 [2022/04/20 04:07:18] [ info] [filter:kubernetes:kubernetes.4] local POD info OK

 [2022/04/20 04:07:18] [ info] [filter:kubernetes:kubernetes.4] testing connectivity with API server...

 [2022/04/20 04:07:18] [ info] [filter:kubernetes:kubernetes.4] connectivity OK

 [2022/04/20 04:07:18] [ info] [sp] stream processor started

 [2022/04/20 04:07:18] [ info] [input:tail:tail.2] inotify_fs_add(): inode=438144 watch_fd=1 name=/var/log/containers/alertmanager-main-0_kubesphere-monitoring-system_alertmanager-da4bf030d6c508ccc7ae8b0d25e9a5d3f4167635b3b1e7c9132f43ca18e26759.log

 [2022/04/20 04:07:18] [ info] [input:tail:tail.2] inotify_fs_add(): inode=134775019 watch_fd=2 name=/var/log/containers/alertmanager-main-0_kubesphere-monitoring-system_config-reloader-0e9ea4d0750bec9cca7a04090fb8ead8d05101fa2fa86e36378c5305483895ad.log

 [2022/04/20 04:07:18] [ info] [input:tail:tail.2] inotify_fs_add(): inode=135308807 watch_fd=3 name=/var/log/containers/calico-node-grzs6_kube-system_calico-node-e110ff3989cef4695508721c54abe41c82b020e485a04d51ee067c3749b40ff0.log

 [2022/04/20 04:07:18] [ info] [input:tail:tail.2] inotify_fs_add(): inode=268955566 watch_fd=4 name=/var/log/containers/calico-node-grzs6_kube-system_flexvol-driver-bf0279ba75c245f871727d85546e8e135b9c1647ca3af318a13b961c9ab63fef.log

 [2022/04/20 04:07:18] [ info] [input:tail:tail.2] inotify_fs_add(): inode=373353 watch_fd=5 name=/var/log/containers/calico-node-grzs6_kube-system_install-cni-2020df6843b42253a7fe3cc71db6a8c380f76dd719985daec3217155a3b99fb9.log

 [2022/04/20 04:07:18] [ info] [input:tail:tail.2] inotify_fs_add(): inode=268955530 watch_fd=6 name=/var/log/containers/calico-node-grzs6_kube-system_upgrade-ipam-d31b5da3acd65ea3a1630576cf8a3527ce89f75a713331f0f79f173180ba2807.log

 [2022/04/20 04:07:18] [ info] [input:tail:tail.2] inotify_fs_add(): inode=134745703 watch_fd=7 name=/var/log/containers/default-http-backend-5bf68ff9b8-qmsqj_kubesphere-controls-system_default-http-backend-3024b370ba28e45f0d739157883e1c05b0450ca6dd6fac17ff86704c25e307df.log

 [2022/04/20 04:07:18] [ info] [input:tail:tail.2] inotify_fs_add(): inode=404112903 watch_fd=8 name=/var/log/containers/devops-27507060-slntp_kubesphere-devops-system_pipeline-run-gc-67341c0a99432db725e08104b44a9d3b47ab96df5622d7fa42cc03bb51772360.log

 [2022/04/20 04:07:18] [ info] [input:tail:tail.2] inotify_fs_add(): inode=404114497 watch_fd=9 name=/var/log/containers/devops-27507090-7b7n9_kubesphere-devops-system_pipeline-run-gc-23c2506ed4daa1f43fe43eb25a1b30a799afd4b1a41ead8f514197b9f0d321e1.log

 [2022/04/20 04:07:18] [ info] [input:tail:tail.2] inotify_fs_add(): inode=404114514 watch_fd=10 name=/var/log/containers/devops-27507120-bwgkg_kubesphere-devops-system_pipeline-run-gc-af8382bfca6e901ec451e15bb1fac7d89619e8c3c15e780672bb4824af823c19.log

 [2022/04/20 04:07:18] [ info] [input:tail:tail.2] inotify_fs_add(): inode=135613174 watch_fd=11 name=/var/log/containers/devops-controller-98975d478-td5xx_kubesphere-devops-system_init-config-156a981f1398223c968105b4feb24dbbcee97403844ca623159bfed4cd647e85.log

 [2022/04/20 04:07:18] [ info] [input:tail:tail.2] inotify_fs_add(): inode=135675036 watch_fd=12 name=/var/log/containers/devops-controller-98975d478-td5xx_kubesphere-devops-system_ks-devops-953f7eff3a2cef2ca441be9b57024286c1e058af6033de0a0d9453649e79fe8f.log

 [2022/04/20 04:07:18] [ info] [input:tail:tail.2] inotify_fs_add(): inode=404546115 watch_fd=13 name=/var/log/containers/devops-jenkins-5d744f66b9-cfnq5_kubesphere-devops-system_copy-default-config-8970ad7a6668683a6e73c80479b92e6cec3d8280add9983b6b911db708e2b46f.log

 [2022/04/20 04:07:18] [ info] [input:tail:tail.2] inotify_fs_add(): inode=135827943 watch_fd=14 name=/var/log/containers/devops-jenkins-5d744f66b9-cfnq5_kubesphere-devops-system_devops-jenkins-ebe951dce6b04d70e0982a50a27ea1c84c46f6fd5bb324f8d98a6d3c8d98f03d.log

 [2022/04/20 04:07:18] [ info] [input:tail:tail.2] inotify_fs_add(): inode=135304775 watch_fd=15 name=/var/log/containers/elasticsearch-logging-curator-elasticsearch-curator-275050tdf82_kubesphere-logging-system_elasticsearch-curator-150f0f2dfaf91b75c2f357d4a610c6ff435325bf7b6946d0972299d297c99aba.log

 [2022/04/20 04:07:18] [ info] [input:tail:tail.2] inotify_fs_add(): inode=2740314 watch_fd=16 name=/var/log/containers/elasticsearch-logging-curator-elasticsearch-curator-275064gfsnt_kubesphere-logging-system_elasticsearch-curator-b057cc4fa0f64009cc4e8862b105275f5180dec25ffd85aafecd3e38b3fe8607.log

 [2022/04/20 04:07:18] [ info] [input:tail:tail.2] inotify_fs_add(): inode=1448183 watch_fd=17 name=/var/log/containers/fluentbit-operator-745bf5559f-lgq9p_kubesphere-logging-system_fluentbit-operator-6e0515f3ec61269e573610598fb0fafa1f4b6c7b6c9737cc5149f4dce73f0726.log

 [2022/04/20 04:07:18] [ info] [input:tail:tail.2] inotify_fs_add(): inode=269964578 watch_fd=18 name=/var/log/containers/fluentbit-operator-745bf5559f-lgq9p_kubesphere-logging-system_setenv-160f20273aae37dead28b4ee01faaf8417e66c8679253218fa1d69f7f67d9986.log

 [2022/04/20 04:07:18] [ info] [input:tail:tail.2] inotify_fs_add(): inode=269092123 watch_fd=19 name=/var/log/containers/ks-apiserver-574966976-zlzdn_kubesphere-system_ks-apiserver-0f59c89e26d48f7e7a33434412136d6f2c6e36b3cb9a6c551b5921a9b3c648c3.log

 [2022/04/20 04:07:18] [ info] [input:tail:tail.2] inotify_fs_add(): inode=269001282 watch_fd=20 name=/var/log/containers/ks-console-65f4d44d88-6zh2n_kubesphere-system_ks-console-473625ee71e3c79256031c7e17b4c7e3cd8c01a32674dabcbc278b113759b86b.log

 [2022/04/20 04:07:18] [ info] [input:tail:tail.2] inotify_fs_add(): inode=403767194 watch_fd=21 name=/var/log/containers/ks-controller-manager-79c7dc79f5-b4887_kubesphere-system_ks-controller-manager-8c0f54653d9f6f3f5647cdf6c1491d7f3676a31ee06a61539d1ad22ac9a9f0e3.log

 [2022/04/20 04:07:18] [ info] [input:tail:tail.2] inotify_fs_add(): inode=404597475 watch_fd=22 name=/var/log/containers/ks-events-operator-5944645757-kqt65_kubesphere-logging-system_events-operator-2d6a462d820e369d58f4add588f2d8798579505db12141cd711c0df6b8adf323.log

 [2022/04/20 04:07:18] [ info] [input:tail:tail.2] inotify_fs_add(): inode=2531381 watch_fd=23 name=/var/log/containers/ks-events-ruler-575669b4-lnpxc_kubesphere-logging-system_config-reloader-135d523190a321b1c1b5164f065f10bccb803d1a9b01cfa6c59285f00175fc0e.log

 [2022/04/20 04:07:18] [ info] [input:tail:tail.2] inotify_fs_add(): inode=270078583 watch_fd=24 name=/var/log/containers/ks-events-ruler-575669b4-lnpxc_kubesphere-logging-system_events-ruler-0698fb3748bfa98dc345dfabcbd44eb456b71c36bdffb56222643a25040cd878.log

 [2022/04/20 04:07:18] [ info] [input:tail:tail.2] inotify_fs_add(): inode=134910338 watch_fd=25 name=/var/log/containers/kube-apiserver-ks-k8s-master-2_kube-system_kube-apiserver-06d36c6647da955d83f369af80185dfa57801bd6397c54b833595425abd937d1.log

 [2022/04/20 04:07:18] [ info] [input:tail:tail.2] inotify_fs_add(): inode=269993224 watch_fd=26 name=/var/log/containers/kube-auditing-operator-84857bf967-kg7bs_kubesphere-logging-system_kube-auditing-operator-086ff221b47aa055daea0bbde34869f53a266129b11c90e8123fb1d43506f46d.log

 [2022/04/20 04:07:18] [ info] [input:tail:tail.2] inotify_fs_add(): inode=373019 watch_fd=27 name=/var/log/containers/kube-controller-manager-ks-k8s-master-2_kube-system_kube-controller-manager-dc6148b02773d71cd3ae73afc259d8989fc8fa3d5497a1edc5fb6c28561e4b93.log

 [2022/04/20 04:07:18] [ info] [input:tail:tail.2] inotify_fs_add(): inode=134581155 watch_fd=28 name=/var/log/containers/kube-proxy-bzx69_kube-system_kube-proxy-d130696f10d7ea91f909720c178b90b68b553dce873030fba8e7daf8fcd1b26b.log

 [2022/04/20 04:07:18] [ info] [input:tail:tail.2] inotify_fs_add(): inode=134580882 watch_fd=29 name=/var/log/containers/kube-scheduler-ks-k8s-master-2_kube-system_kube-scheduler-7fe7efb1fbd3f599ebc530f7ca4379b02aa0bc0e8b23c269cee79bec36c6e103.log

 [2022/04/20 04:07:18] [ info] [input:tail:tail.2] inotify_fs_add(): inode=664327 watch_fd=30 name=/var/log/containers/kubectl-admin-6667774bb-mv9fm_kubesphere-controls-system_kubectl-a15f90842b782a08fe6c5f944974e2551a5995bca4116d741537b7d9b7531ef1.log

 [2022/04/20 04:07:18] [ info] [input:tail:tail.2] inotify_fs_add(): inode=135322058 watch_fd=31 name=/var/log/containers/logsidecar-injector-deploy-5fb6fdc6dd-fxsbf_kubesphere-logging-system_config-reloader-7e5fb4de2d6433568d612d3092d23b38beca28a5089106ad84a5f9b33258c3fd.log

 [2022/04/20 04:07:18] [ info] [input:tail:tail.2] inotify_fs_add(): inode=404567916 watch_fd=32 name=/var/log/containers/logsidecar-injector-deploy-5fb6fdc6dd-fxsbf_kubesphere-logging-system_logsidecar-injector-5e0181bde98c6444d5de2e9aac6ab459bbf957c09edc1ba06be473d0e24ce21f.log

 [2022/04/20 04:07:18] [ info] [input:tail:tail.2] inotify_fs_add(): inode=134969612 watch_fd=33 name=/var/log/containers/node-exporter-8tldd_kubesphere-monitoring-system_kube-rbac-proxy-c6a4a0dc8ce6ef8f6b73a940ee8473e20c08c1b85fefb679003c4a08c1889c09.log

 [2022/04/20 04:07:18] [ info] [input:tail:tail.2] inotify_fs_add(): inode=134778346 watch_fd=34 name=/var/log/containers/node-exporter-8tldd_kubesphere-monitoring-system_node-exporter-c0458098c9d6d132a765c753b3a7edc23887ecd48e457be393fa359ca731eef2.log

 [2022/04/20 04:07:18] [ info] [input:tail:tail.2] inotify_fs_add(): inode=269110037 watch_fd=35 name=/var/log/containers/notification-manager-deployment-78664576cb-2zqhb_kubesphere-monitoring-system_notification-manager-8a6449e8a99c56341b5a196251b99c95893b49ccf7b97c239e1da6b5fe899aca.log

 [2022/04/20 04:07:18] [ info] [input:tail:tail.2] inotify_fs_add(): inode=135304736 watch_fd=36 name=/var/log/containers/notification-manager-deployment-78664576cb-2zqhb_kubesphere-monitoring-system_tenant-4851fb71b6d33755ea467a0745abb4f0c7757e840d18a3ab34b7c4d5bcb61fbb.log

 [2022/04/20 04:07:18] [ info] [input:tail:tail.2] inotify_fs_add(): inode=135203266 watch_fd=37 name=/var/log/containers/notification-manager-deployment-78664576cb-qdzg8_kubesphere-monitoring-system_notification-manager-26afc727ce8fff65033c5432d74fd8da02dc297de6d6f9013eca432a6ed14a67.log

 [2022/04/20 04:07:18] [ info] [input:tail:tail.2] inotify_fs_add(): inode=404111997 watch_fd=38 name=/var/log/containers/notification-manager-deployment-78664576cb-qdzg8_kubesphere-monitoring-system_tenant-b7dec63c57fdb165777eddc9ac3f33a3bbb8d752c5508e9bd64b53f7fa7c1667.log

 [2022/04/20 04:07:18] [ info] [input:tail:tail.2] inotify_fs_add(): inode=403837581 watch_fd=39 name=/var/log/containers/notification-manager-operator-7d44854f54-5x8ml_kubesphere-monitoring-system_kube-rbac-proxy-e7e058ebc7a31bfe48f950473ce4e5945ba63117b970c4817aed6f341fc6a1c5.log

 [2022/04/20 04:07:18] [ info] [input:tail:tail.2] inotify_fs_add(): inode=269104667 watch_fd=40 name=/var/log/containers/notification-manager-operator-7d44854f54-5x8ml_kubesphere-monitoring-system_notification-manager-operator-6cbd966b72900f3e53460e0f599d6f29e2d12d81e480ae091e951f3a718e26e1.log

 [2022/04/20 04:07:18] [ info] [input:tail:tail.2] inotify_fs_add(): inode=404140622 watch_fd=41 name=/var/log/containers/openldap-0_kubesphere-system_openldap-ha-34603befcd35f87ef4f343d4774193d968eb285669c68e617a6df561976b2c90.log

 [2022/04/20 04:07:18] [ info] [input:tail:tail.2] inotify_fs_add(): inode=404112865 watch_fd=42 name=/var/log/containers/openldap-0_kubesphere-system_openldap-ha-8bb8c1a38b9a28adee5ec2b98c64c44987f3958d5f649a2c0f8572988812edba.log

 [2022/04/20 04:07:18] [ info] [input:tail:tail.2] inotify_fs_add(): inode=135305918 watch_fd=43 name=/var/log/containers/openpitrix-import-job-56b4v_kubesphere-system_import-6b9e87ef772f7e985b172f6da40a44c14e3ebede2cb726299b1260b2f254772a.log

 [2022/04/20 04:07:18] [ info] [input:tail:tail.2] inotify_fs_add(): inode=135305893 watch_fd=44 name=/var/log/containers/openpitrix-import-job-56b4v_kubesphere-system_wait-apiserver-9d2f65fc31598f6bd4a3097919149d24b0fa8b7a26e2b3892b0486a38f8264d0.log

 [2022/04/20 04:07:18] [ info] [input:tail:tail.2] inotify_fs_add(): inode=437223 watch_fd=45 name=/var/log/containers/prometheus-operator-5c5db79546-fhz5t_kubesphere-monitoring-system_kube-rbac-proxy-57f49887b2934e7989c4bdf830eb7c1f963f8ad9da453897e63545e541cfa1b1.log

 [2022/04/20 04:07:18] [ info] [input:tail:tail.2] inotify_fs_add(): inode=269001982 watch_fd=46 name=/var/log/containers/prometheus-operator-5c5db79546-fhz5t_kubesphere-monitoring-system_prometheus-operator-95c8b3de232d26e297314b8e37859c4c65dd46748467ff2bbf7d7b85df90858a.log

 [2022/04/20 04:07:18] [ info] [input:tail:tail.2] inotify_fs_add(): inode=403724186 watch_fd=47 name=/var/log/containers/redis-ha-haproxy-868fdbddd4-jhxvc_kubesphere-system_config-init-10b5cff84fe2c3e566783fea86136e3f90d1e2fc87dcebd61cff74592d454e4b.log

 [2022/04/20 04:07:18] [ info] [input:tail:tail.2] inotify_fs_add(): inode=134685563 watch_fd=48 name=/var/log/containers/redis-ha-haproxy-868fdbddd4-jhxvc_kubesphere-system_haproxy-dc89c72b1e221d94b82ee32bcb0eec43bbbade1c1dfa6ae6b8272b339c1014bf.log

 [2022/04/20 04:07:18] [ info] [input:tail:tail.2] inotify_fs_add(): inode=268975519 watch_fd=49 name=/var/log/containers/redis-ha-server-0_kubesphere-system_config-init-a24eeaae3519f7a0be9cb25a58f28676e978dbdcb155d64de83c6d2c564bcb84.log

 [2022/04/20 04:07:18] [ info] [input:tail:tail.2] inotify_fs_add(): inode=403761176 watch_fd=50 name=/var/log/containers/redis-ha-server-0_kubesphere-system_redis-1952b51c7b5bf653b3b4f308d0447fca0395267f654b42ad936f5446a8f0ba11.log

 [2022/04/20 04:07:18] [ info] [input:tail:tail.2] inotify_fs_add(): inode=403763877 watch_fd=51 name=/var/log/containers/redis-ha-server-0_kubesphere-system_sentinel-93ec7fdfd37546554e9ee20cad99fc79eb1120658f041c3ac3f8ae790ba9f3e0.log

 [2022/04/20 04:07:18] [ info] [input:tail:tail.2] inotify_fs_add(): inode=135616217 watch_fd=52 name=/var/log/containers/s2ioperator-0_kubesphere-devops-system_manager-ec0eef93d54b446690c5afb45fc20c145e8555f0efeac367b317ca3747e58a15.log

 [2022/04/20 04:07:18] [ info] [input:tail:tail.2] inotify_fs_add(): inode=268956363 watch_fd=53 name=/var/log/containers/snapshot-controller-0_kube-system_snapshot-controller-8efdaf2c22056e15431868c285909845a9a50220a8599428f13827c2a9999605.log

 [2022/04/20 04:07:18] [ info] [input:tail:tail.3] inotify_fs_add(): inode=270078314 watch_fd=1 name=/var/log/containers/kube-auditing-webhook-deploy-64cfb8c9f8-c65cb_kubesphere-logging-system_kube-auditing-webhook-2315ba3f2e910546235bebb5c2cef37419d6bbb6568f0073f94b7cc9cec5882e.log

 [2022/04/20 04:07:18] [ info] [input:tail:tail.3] inotify_fs_add(): inode=404597510 watch_fd=2 name=/var/log/containers/kube-auditing-webhook-deploy-64cfb8c9f8-j8w5d_kubesphere-logging-system_kube-auditing-webhook-27248c5f2dc6b8e16f178cb6028731bd4d752a99b558558b8cbc38ebc872996d.log

 [2022/04/20 04:07:18] [ info] [input:tail:tail.2] inotify_fs_add(): inode=404114523 watch_fd=54 name=/var/log/containers/fluent-bit-79w92_kubesphere-logging-system_fluent-bit-6fca993aec2186244af2f1632d8fcd563be88aeddf0f892fe05908712f4143e1.log

 [2022/04/20 04:07:22] [ warn] [engine] failed to flush chunk &#39;15-1650427638.306801183.flb&#39;, retry in 10 seconds: task_id=0, input=systemd.0 &gt; output=es.0 (out_id=0)

 [2022/04/20 04:07:22] [ warn] [engine] failed to flush chunk &#39;15-1650427638.921453506.flb&#39;, retry in 6 seconds: task_id=2, input=systemd.1 &gt; output=es.0 (out_id=0)

 [2022/04/20 04:07:22] [ warn] [engine] failed to flush chunk &#39;15-1650427638.395905124.flb&#39;, retry in 6 seconds: task_id=1, input=systemd.1 &gt; output=es.0 (out_id=0)

 [2022/04/20 04:07:22] [ warn] [engine] failed to flush chunk &#39;15-1650427639.998272919.flb&#39;, retry in 9 seconds: task_id=4, input=systemd.1 &gt; output=es.0 (out_id=0)

 [2022/04/20 04:07:22] [ warn] [engine] failed to flush chunk &#39;15-1650427639.430712081.flb&#39;, retry in 10 seconds: task_id=3, input=systemd.1 &gt; output=es.0 (out_id=0)

 [2022/04/20 04:07:22] [ warn] [engine] failed to flush chunk &#39;15-1650427638.433892561.flb&#39;, retry in 11 seconds: task_id=6, input=tail.2 &gt; output=es.0 (out_id=0)

 [2022/04/20 04:07:22] [ warn] [engine] failed to flush chunk &#39;15-1650427640.508747628.flb&#39;, retry in 8 seconds: task_id=5, input=systemd.1 &gt; output=es.0 (out_id=0)

 [2022/04/20 04:07:22] [ warn] [engine] failed to flush chunk &#39;15-1650427638.591363944.flb&#39;, retry in 9 seconds: task_id=7, input=tail.2 &gt; output=es.0 (out_id=0)

 [2022/04/20 04:07:27] [ warn] [engine] failed to flush chunk &#39;15-1650427642.916578491.flb&#39;, retry in 10 seconds: task_id=8, input=tail.2 &gt; output=es.0 (out_id=0)

 [2022/04/20 04:07:28] [ warn] [engine] chunk &#39;15-1650427638.921453506.flb&#39; cannot be retried: task_id=2, input=systemd.1 &gt; output=es.0

 [2022/04/20 04:07:28] [ warn] [engine] chunk &#39;15-1650427638.395905124.flb&#39; cannot be retried: task_id=1, input=systemd.1 &gt; output=es.0

 [2022/04/20 04:07:30] [ warn] [engine] chunk &#39;15-1650427640.508747628.flb&#39; cannot be retried: task_id=5, input=systemd.1 &gt; output=es.0

 [2022/04/20 04:07:31] [ warn] [engine] chunk &#39;15-1650427639.998272919.flb&#39; cannot be retried: task_id=4, input=systemd.1 &gt; output=es.0

 [2022/04/20 04:07:31] [ warn] [engine] chunk &#39;15-1650427638.591363944.flb&#39; cannot be retried: task_id=7, input=tail.2 &gt; output=es.0

 [2022/04/20 04:07:32] [ warn] [engine] failed to flush chunk &#39;15-1650427650.364418985.flb&#39;, retry in 7 seconds: task_id=2, input=tail.2 &gt; output=es.0 (out_id=0)

 [2022/04/20 04:07:32] [ warn] [engine] failed to flush chunk &#39;15-1650427647.894424287.flb&#39;, retry in 11 seconds: task_id=1, input=tail.2 &gt; output=es.0 (out_id=0)

 [2022/04/20 04:07:32] [ warn] [engine] failed to flush chunk &#39;15-1650427651.290039243.flb&#39;, retry in 11 seconds: task_id=4, input=tail.2 &gt; output=es.0 (out_id=0)

 [2022/04/20 04:07:32] [ warn] [engine] failed to flush chunk &#39;15-1650427652.113363794.flb&#39;, retry in 10 seconds: task_id=5, input=tail.2 &gt; output=es.0 (out_id=0)

 [2022/04/20 04:07:32] [ warn] [engine] chunk &#39;15-1650427638.306801183.flb&#39; cannot be retried: task_id=0, input=systemd.0 &gt; output=es.0

 [2022/04/20 04:07:32] [ warn] [engine] chunk &#39;15-1650427639.430712081.flb&#39; cannot be retried: task_id=3, input=systemd.1 &gt; output=es.0

 [2022/04/20 04:07:33] [ warn] [engine] chunk &#39;15-1650427638.433892561.flb&#39; cannot be retried: task_id=6, input=tail.2 &gt; output=es.0

 [2022/04/20 04:07:37] [ warn] [engine] chunk &#39;15-1650427642.916578491.flb&#39; cannot be retried: task_id=8, input=tail.2 &gt; output=es.0

 [2022/04/20 04:07:37] [ warn] [engine] failed to flush chunk &#39;15-1650427652.895622405.flb&#39;, retry in 10 seconds: task_id=0, input=tail.2 &gt; output=es.0 (out_id=0)

 [2022/04/20 04:07:39] [ warn] [engine] chunk &#39;15-1650427650.364418985.flb&#39; cannot be retried: task_id=2, input=tail.2 &gt; output=es.0

 [2022/04/20 04:07:42] [ warn] [engine] chunk &#39;15-1650427652.113363794.flb&#39; cannot be retried: task_id=5, input=tail.2 &gt; output=es.0

 [2022/04/20 04:07:42] [ warn] [engine] failed to flush chunk &#39;15-1650427657.894452234.flb&#39;, retry in 8 seconds: task_id=2, input=tail.2 &gt; output=es.0 (out_id=0)

 [2022/04/20 04:07:42] [ warn] [engine] failed to flush chunk &#39;15-1650427660.999669706.flb&#39;, retry in 8 seconds: task_id=3, input=tail.2 &gt; output=es.0 (out_id=0)

 [2022/04/20 04:07:43] [ warn] [engine] chunk &#39;15-1650427647.894424287.flb&#39; cannot be retried: task_id=1, input=tail.2 &gt; output=es.0

 [2022/04/20 04:07:43] [ warn] [engine] chunk &#39;15-1650427651.290039243.flb&#39; cannot be retried: task_id=4, input=tail.2 &gt; output=es.0
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">   </span><br><span class="line">3. 问题排查第三环节，检查 fluent-bit。</span><br><span class="line"></span><br><span class="line">   - 打开百度，搜索 **failed to flush chunk**。</span><br><span class="line"></span><br><span class="line">   - ![image-20220420163534855](https://znotes-1258881081.cos.ap-beijing.myqcloud.com/k8s-on-kubesphere/image-20220420163534855.png)</span><br><span class="line"></span><br><span class="line">   - 搜索出来的结果，凭直觉没啥用处，真不想说啥了，直接换人。</span><br><span class="line"></span><br><span class="line">   - 打开 **Bing**，搜索 **failed to flush chunk**。</span><br><span class="line"></span><br><span class="line">   - ![image-20220420163607854](https://znotes-1258881081.cos.ap-beijing.myqcloud.com/k8s-on-kubesphere/image-20220420163607854.png)</span><br><span class="line"></span><br><span class="line">   - 点开[第一个参考链接](https://github.com/fluent/fluent-bit/issues/3301), 看了一圈感觉就是再说需要开启一个参数 **Trace_Error On**，才能看的更清楚。</span><br><span class="line"></span><br><span class="line">   - 咱先不开启，先看看 fluentd-bit 是否跟 ES 服务器有通讯，通过 tcp 抓包可以看到是有数据推送的。</span><br><span class="line"></span><br><span class="line">   - ```shell</span><br><span class="line">     [root@glusterfs-node-0 logs]# tcpdump -i any port 9200 -s 0</span><br><span class="line">     tcpdump: verbose output suppressed, use -v or -vv for full protocol decode</span><br><span class="line">     listening on any, link-type LINUX_SLL (Linux cooked), capture size 262144 bytes</span><br><span class="line">     14:42:31.713955 IP ks-k8s-master-1.57144 &gt; glusterfs-node-0.wap-wsp: Flags [S], seq 4284553181, win 28000, options [mss 1400,sackOK,TS val 1006807002 ecr 0,nop,wscale 7], length 0</span><br><span class="line">     14:42:31.713987 IP glusterfs-node-0.wap-wsp &gt; ks-k8s-master-1.57144: Flags [S.], seq 3050954572, ack 4284553182, win 28960, options [mss 1460,sackOK,TS val 1446355813 ecr 1006807002,nop,wscale 7], length 0</span><br><span class="line">     14:42:31.714478 IP ks-k8s-master-1.57144 &gt; glusterfs-node-0.wap-wsp: Flags [.], ack 1, win 219, options [nop,nop,TS val 1006807002 ecr 1446355813], length 0</span><br><span class="line">     14:42:31.714535 IP ks-k8s-master-1.57146 &gt; glusterfs-node-0.wap-wsp: Flags [S], seq 763700519, win 28000, options [mss 1400,sackOK,TS val 1006807002 ecr 0,nop,wscale 7], length 0</span><br><span class="line">     14:42:31.714562 IP glusterfs-node-0.wap-wsp &gt; ks-k8s-master-1.57146: Flags [S.], seq 141769299, ack 763700520, win 28960, options [mss 1460,sackOK,TS val 1446355813 ecr 1006807002,nop,wscale 7], length 0</span><br><span class="line">     14:42:31.714931 IP ks-k8s-master-1.57146 &gt; glusterfs-node-0.wap-wsp: Flags [.], ack 1, win 219, options [nop,nop,TS val 1006807003 ecr 1446355813], length 0</span><br><span class="line">     14:42:31.720484 IP ks-k8s-master-1.57144 &gt; glusterfs-node-0.wap-wsp: Flags [P.], seq 1:305, ack 1, win 219, options [nop,nop,TS val 1006807008 ecr 1446355813], length 304</span><br><span class="line">     14:42:31.720511 IP glusterfs-node-0.wap-wsp &gt; ks-k8s-master-1.57144: Flags [.], ack 305, win 235, options [nop,nop,TS val 1446355819 ecr 1006807008], length 0</span><br><span class="line">     14:42:31.720882 IP ks-k8s-master-1.57146 &gt; glusterfs-node-0.wap-wsp: Flags [P.], seq 1:305, ack 1, win 219, options [nop,nop,TS val 1006807008 ecr 1446355813], length 304</span><br><span class="line">     14:42:31.720915 IP glusterfs-node-0.wap-wsp &gt; ks-k8s-master-1.57146: Flags [.], ack 305, win 235, options [nop,nop,TS val 1446355820 ecr 1006807008], length 0</span><br><span class="line">     14:42:31.721259 IP glusterfs-node-0.wap-wsp &gt; ks-k8s-master-1.57146: Flags [P.], seq 1:706, ack 305, win 235, options [nop,nop,TS val 1446355820 ecr 1006807008], length 705</span><br><span class="line">     14:42:31.721272 IP glusterfs-node-0.wap-wsp &gt; ks-k8s-master-1.57144: Flags [P.], seq 1:750, ack 305, win 235, options [nop,nop,TS val 1446355820 ecr 1006807008], length 749</span><br><span class="line">     14:42:31.721327 IP glusterfs-node-0.wap-wsp &gt; ks-k8s-master-1.57146: Flags [F.], seq 706, ack 305, win 235, options [nop,nop,TS val 1446355820 ecr 1006807008], length 0</span><br><span class="line">     14:42:31.721356 IP glusterfs-node-0.wap-wsp &gt; ks-k8s-master-1.57144: Flags [F.], seq 750, ack 305, win 235, options [nop,nop,TS val 1446355820 ecr 1006807008], length 0</span><br><span class="line">     14:42:31.721666 IP ks-k8s-master-1.57146 &gt; glusterfs-node-0.wap-wsp: Flags [.], ack 706, win 230, options [nop,nop,TS val 1006807009 ecr 1446355820], length 0</span><br><span class="line">     14:42:31.721707 IP ks-k8s-master-1.57144 &gt; glusterfs-node-0.wap-wsp: Flags [.], ack 750, win 231, options [nop,nop,TS val 1006807009 ecr 1446355820], length 0</span><br><span class="line">     14:42:31.721951 IP ks-k8s-master-1.57146 &gt; glusterfs-node-0.wap-wsp: Flags [R.], seq 305, ack 707, win 230, options [nop,nop,TS val 1006807009 ecr 1446355820], length 0</span><br><span class="line">     14:42:31.722011 IP ks-k8s-master-1.57144 &gt; glusterfs-node-0.wap-wsp: Flags [R.], seq 305, ack 751, win 231, options [nop,nop,TS val 1006807010 ecr 1446355820], length 0</span><br><span class="line">     14:42:31.846578 IP ks-k8s-master-2.34902 &gt; glusterfs-node-0.wap-wsp: Flags [S], seq 2846110148, win 28000, options [mss 1400,sackOK,TS val 1006745001 ecr 0,nop,wscale 7], length 0</span><br><span class="line">     14:42:31.846621 IP glusterfs-node-0.wap-wsp &gt; ks-k8s-master-2.34902: Flags [S.], seq 2264454988, ack 2846110149, win 28960, options [mss 1460,sackOK,TS val 1446355945 ecr 1006745001,nop,wscale 7], length 0</span><br><span class="line">     14:42:31.847064 IP ks-k8s-master-2.34902 &gt; glusterfs-node-0.wap-wsp: Flags [.], ack 1, win 219, options [nop,nop,TS val 1006745002 ecr 1446355945], length 0</span><br><span class="line">     14:42:31.851910 IP ks-k8s-master-2.34902 &gt; glusterfs-node-0.wap-wsp: Flags [P.], seq 1:305, ack 1, win 219, options [nop,nop,TS val 1006745007 ecr 1446355945], length 304</span><br><span class="line">     14:42:31.851934 IP glusterfs-node-0.wap-wsp &gt; ks-k8s-master-2.34902: Flags [.], ack 305, win 235, options [nop,nop,TS val 1446355951 ecr 1006745007], length 0</span><br><span class="line">     14:42:31.852261 IP glusterfs-node-0.wap-wsp &gt; ks-k8s-master-2.34902: Flags [P.], seq 1:334, ack 305, win 235, options [nop,nop,TS val 1446355951 ecr 1006745007], length 333</span><br><span class="line">     14:42:31.852307 IP glusterfs-node-0.wap-wsp &gt; ks-k8s-master-2.34902: Flags [F.], seq 334, ack 305, win 235, options [nop,nop,TS val 1446355951 ecr 1006745007], length 0</span><br><span class="line">     14:42:31.852575 IP ks-k8s-master-2.34902 &gt; glusterfs-node-0.wap-wsp: Flags [.], ack 334, win 228, options [nop,nop,TS val 1006745007 ecr 1446355951], length 0</span><br><span class="line">     14:42:31.852595 IP ks-k8s-master-2.34902 &gt; glusterfs-node-0.wap-wsp: Flags [R.], seq 305, ack 335, win 228, options [nop,nop,TS val 1006745007 ecr 1446355951], length 0</span><br><span class="line">     14:42:32.025492 IP ks-k8s-master-0.40940 &gt; glusterfs-node-0.wap-wsp: Flags [S], seq 2794210096, win 28000, options [mss 1400,sackOK,TS val 1006811001 ecr 0,nop,wscale 7], length 0</span><br><span class="line">     14:42:32.025534 IP glusterfs-node-0.wap-wsp &gt; ks-k8s-master-0.40940: Flags [S.], seq 3740534993, ack 2794210097, win 28960, options [mss 1460,sackOK,TS val 1446356124 ecr 1006811001,nop,wscale 7], length 0</span><br><span class="line">     14:42:32.026129 IP ks-k8s-master-0.40940 &gt; glusterfs-node-0.wap-wsp: Flags [.], ack 1, win 219, options [nop,nop,TS val 1006811002 ecr 1446356124], length 0</span><br><span class="line">     14:42:32.032593 IP ks-k8s-master-0.40940 &gt; glusterfs-node-0.wap-wsp: Flags [P.], seq 1:305, ack 1, win 219, options [nop,nop,TS val 1006811008 ecr 1446356124], length 304</span><br><span class="line">     14:42:32.032615 IP glusterfs-node-0.wap-wsp &gt; ks-k8s-master-0.40940: Flags [.], ack 305, win 235, options [nop,nop,TS val 1446356131 ecr 1006811008], length 0</span><br><span class="line">     14:42:32.033329 IP glusterfs-node-0.wap-wsp &gt; ks-k8s-master-0.40940: Flags [P.], seq 1:386, ack 305, win 235, options [nop,nop,TS val 1446356132 ecr 1006811008], length 385</span><br><span class="line">     14:42:32.033396 IP glusterfs-node-0.wap-wsp &gt; ks-k8s-master-0.40940: Flags [F.], seq 386, ack 305, win 235, options [nop,nop,TS val 1446356132 ecr 1006811008], length 0</span><br><span class="line">     14:42:32.033643 IP ks-k8s-master-0.40940 &gt; glusterfs-node-0.wap-wsp: Flags [.], ack 386, win 228, options [nop,nop,TS val 1006811010 ecr 1446356132], length 0</span><br><span class="line">     14:42:32.033718 IP ks-k8s-master-0.40940 &gt; glusterfs-node-0.wap-wsp: Flags [R.], seq 305, ack 387, win 228, options [nop,nop,TS val 1006811010 ecr 1446356132], length 0</span><br><span class="line">     14:42:33.025645 IP ks-k8s-master-0.40970 &gt; glusterfs-node-0.wap-wsp: Flags [S], seq 556017134, win 28000, options [mss 1400,sackOK,TS val 1006812001 ecr 0,nop,wscale 7], length 0</span><br><span class="line">     14:42:33.025700 IP glusterfs-node-0.wap-wsp &gt; ks-k8s-master-0.40970: Flags [S.], seq 3957625474, ack 556017135, win 28960, options [mss 1460,sackOK,TS val 1446357124 ecr 1006812001,nop,wscale 7], length 0</span><br><span class="line">     14:42:33.026255 IP ks-k8s-master-0.40970 &gt; glusterfs-node-0.wap-wsp: Flags [.], ack 1, win 219, options [nop,nop,TS val 1006812002 ecr 1446357124], length 0</span><br><span class="line">     14:42:33.031462 IP ks-k8s-master-0.40970 &gt; glusterfs-node-0.wap-wsp: Flags [P.], seq 1:305, ack 1, win 219, options [nop,nop,TS val 1006812007 ecr 1446357124], length 304</span><br><span class="line">     14:42:33.031493 IP glusterfs-node-0.wap-wsp &gt; ks-k8s-master-0.40970: Flags [.], ack 305, win 235, options [nop,nop,TS val 1446357130 ecr 1006812007], length 0</span><br><span class="line">     14:42:33.032411 IP glusterfs-node-0.wap-wsp &gt; ks-k8s-master-0.40970: Flags [P.], seq 1:676, ack 305, win 235, options [nop,nop,TS val 1446357131 ecr 1006812007], length 675</span><br><span class="line">     14:42:33.032547 IP glusterfs-node-0.wap-wsp &gt; ks-k8s-master-0.40970: Flags [F.], seq 676, ack 305, win 235, options [nop,nop,TS val 1446357131 ecr 1006812007], length 0</span><br><span class="line">     14:42:33.032789 IP ks-k8s-master-0.40970 &gt; glusterfs-node-0.wap-wsp: Flags [.], ack 676, win 230, options [nop,nop,TS val 1006812009 ecr 1446357131], length 0</span><br><span class="line">     14:42:33.032906 IP ks-k8s-master-0.40970 &gt; glusterfs-node-0.wap-wsp: Flags [R.], seq 305, ack 677, win 230, options [nop,nop,TS val 1006812009 ecr 1446357131], length 0</span><br><span class="line">     ^C</span><br><span class="line">     45 packets captured</span><br><span class="line">     45 packets received by filter</span><br><span class="line">     0 packets dropped by kernel</span><br></pre></td></tr></table></figure>
</code></pre>
</li>
<li><p>查看 es 集群中的 index 是否创建 , 结果发现索引并没有创建。</p>
</li>
<li><pre><code class="shell">[root@glusterfs-node-0 logs]# curl -ulstack:&#39;P@88w0rd&#39; 192.168.9.95:9200/_cat/indices?v
health status index            uuid                   pri rep docs.count docs.deleted store.size pri.store.size
green  open   .geoip_databases jOKPAu5-S3yv0rZdZx4ufw   1   1         40           38    107.2mb         69.3mb
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- 那为啥没索引呢，默认日志是看不出来的，只能开启 elasticsearch 日志的 debug 模式了</span><br><span class="line"></span><br><span class="line">- ```shell</span><br><span class="line">  [root@glusterfs-node-0 logs]# curl -ulstack:&#x27;P@88w0rd&#x27; -H &quot;Content-Type: application/json&quot; -X PUT  192.168.9.95:9200/_cluster/settings -d &#x27;&#123;&quot;transient&quot; : &#123;&quot;logger._root&quot;:&quot;DEBUG&quot;&#125; &#125;&#x27;</span><br></pre></td></tr></table></figure>
</code></pre>
</li>
<li><p>开启以后日志就丰富了很多，我们找找有用的信息。</p>
</li>
<li><pre><code class="yaml">[2022-04-20T15:23:25,633][DEBUG][r.suppressed             ] [es-node-0] path: /bad-request, params: &#123;&#125;
java.lang.IllegalArgumentException: invalid version format: &lt;8a&gt;-»&gt;¸Â×YÄÌ^Y^^HR·&lt;84&gt;ºÞ^@ÊËD!Ô^SÄÜA&lt;9c&gt;EÛº^@&gt;^S^B^S^C^S^AÀ,À0^@&lt;9f&gt;Ì©Ì¨ÌªÀ+À/^@&lt;9e&gt;À$À(^@KÀ#À&#39;^@GÀ

[2022-04-20T15:23:25,630][DEBUG][r.suppressed             ] [es-node-0] path: /bad-request, params: &#123;&#125;
java.lang.IllegalArgumentException: text is empty (possibly HTTP/0.9)

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- **DEBUG** 级别的日志也就能看到这些了，再上个更狠的 TRACE 级别的，要是还不行就去开启 **Fluent-bit** 的参数。</span><br><span class="line"></span><br><span class="line">- ```shell</span><br><span class="line">  [root@glusterfs-node-0 logs]# curl -ulstack:&#x27;P@88w0rd&#x27; -H &quot;Content-Type: application/json&quot; -X PUT  192.168.9.95:9200/_cluster/settings -d &#x27;&#123;&quot;transient&quot; : &#123;&quot;logger._root&quot;:&quot;TRACE&quot;&#125; &#125;&#x27;</span><br></pre></td></tr></table></figure>
</code></pre>
</li>
<li><p>分析日志，发现还是没有实质性的错误说明，也只是看到了错误的信息哪来的。</p>
</li>
<li><pre><code class="yaml">[2022-04-20T16:50:18,577][TRACE][o.e.h.HttpTracer         ] [es-node-0] [40714][null][GET][/bad-request] received request from [Netty4HttpChannel&#123;localAddress=/192.168.9.95:9200, remoteAddress=/192.168.9.93:34784&#125;]
java.lang.IllegalArgumentException: invalid version format: ¸Ñ^AÐ^E1&lt;8b&gt;HU^R0&lt;88&gt;^[)¶ËQT=&lt;87&gt;&quot;&#125;Þ¥AËÉ³ZY^@&gt;^S^B^S^C^S^AÀ,À0^@&lt;9f&gt;Ì©Ì¨ÌªÀ+À/^@&lt;9e&gt;À$À(^@KÀ#À&#39;^@GÀ

[2022-04-20T16:50:18,549][TRACE][o.e.h.HttpTracer         ] [es-node-0] [40713][null][GET][/bad-request] received request from [Netty4HttpChannel&#123;localAddress=/192.168.9.95:9200, remoteAddress=/192.168.9.92:49734&#125;]
java.lang.IllegalArgumentException: text is empty (possibly HTTP/0.9)

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- 先把 ElasticSearch 的日志级别改回默认的 INFO，我们回去研究 **Fluent-bit**。</span><br><span class="line"></span><br><span class="line">- ```shell</span><br><span class="line">  [root@glusterfs-node-0 logs]# curl -ulstack:&#x27;P@88w0rd&#x27; -H &quot;Content-Type: application/json&quot; -X PUT  192.168.9.95:9200/_cluster/settings -d &#x27;&#123;&quot;transient&quot; : &#123;&quot;logger._root&quot;:&quot;INFO&quot;&#125; &#125;&#x27;</span><br></pre></td></tr></table></figure>
</code></pre>
</li>
<li><p>返回 KubeSphere 的论坛，继续以关键字<strong>外部 es</strong> 搜索，发现一篇跟 fluent bit 有关的文档 ,<a target="_blank" rel="noopener" href="https://kubesphere.com.cn/forum/d/5961-fluent-bit-0-es">安装 日志插件后， fluent bit 启动失败，查询日志一直是 0， 外部 es 也没有创建索引</a></p>
</li>
<li><p><img src="https://znotes-1258881081.cos.ap-beijing.myqcloud.com/k8s-on-kubesphere/elasticsearch-error-2.png" alt="elasticsearch-error-2"></p>
</li>
<li><p>该文中的 fluent 的报错信息跟我的不一样，先不管了，先看看他的配置跟我是否一样，文中解决方案跳转到了<a target="_blank" rel="noopener" href="https://github.com/kubesphere/kubesphere/issues/4425">Github</a>。</p>
</li>
<li><p><img src="https://znotes-1258881081.cos.ap-beijing.myqcloud.com/k8s-on-kubesphere/image-20220420173658602.png" alt="image-20220420173658602"></p>
</li>
<li><p><img src="https://znotes-1258881081.cos.ap-beijing.myqcloud.com/k8s-on-kubesphere/image-20220420173919350.png" alt="image-20220420173919350"></p>
</li>
<li><p>先看看我们有几个 inputs。</p>
</li>
<li><pre><code class="shell">[root@ks-k8s-master-0 ~]# kubectl get inputs -n kubesphere-logging-system 
NAME            AGE
docker          5d5h
kubelet         5d5h
tail            5d5h
tail-auditing   5d5h
tail-events     5d5h
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- 先看看我们现在的 **tail** 配置。</span><br><span class="line"></span><br><span class="line">- ```shell</span><br><span class="line">  [root@ks-k8s-master-0 ~]# kubectl get inputs -n kubesphere-logging-system tail -o yaml</span><br><span class="line">  apiVersion: logging.kubesphere.io/v1alpha2</span><br><span class="line">  kind: Input</span><br><span class="line">  metadata:</span><br><span class="line">    annotations:</span><br><span class="line">      kubectl.kubernetes.io/last-applied-configuration: |</span><br><span class="line">        &#123;&quot;apiVersion&quot;:&quot;logging.kubesphere.io/v1alpha2&quot;,&quot;kind&quot;:&quot;Input&quot;,&quot;metadata&quot;:&#123;&quot;annotations&quot;:&#123;&#125;,&quot;labels&quot;:&#123;&quot;logging.kubesphere.io/component&quot;:&quot;logging&quot;,&quot;logging.kubesphere.io/enabled&quot;:&quot;true&quot;&#125;,&quot;name&quot;:&quot;tail&quot;,&quot;namespace&quot;:&quot;kubesphere-logging-system&quot;&#125;,&quot;spec&quot;:&#123;&quot;tail&quot;:&#123;&quot;db&quot;:&quot;/fluent-bit/tail/pos.db&quot;,&quot;dbSync&quot;:&quot;Normal&quot;,&quot;excludePath&quot;:&quot;/var/log/containers/*_kubesphere-logging-system_events-exporter*.log,/var/log/containers/kube-auditing-webhook*_kubesphere-logging-system_kube-auditing-webhook*.log&quot;,&quot;memBufLimit&quot;:&quot;5MB&quot;,&quot;parser&quot;:&quot;docker&quot;,&quot;path&quot;:&quot;/var/log/containers/*.log&quot;,&quot;refreshIntervalSeconds&quot;:10,&quot;skipLongLines&quot;:true,&quot;tag&quot;:&quot;kube.*&quot;&#125;&#125;&#125;</span><br><span class="line">    creationTimestamp: &quot;2022-04-15T03:51:11Z&quot;</span><br><span class="line">    generation: 1</span><br><span class="line">    labels:</span><br><span class="line">      logging.kubesphere.io/component: logging</span><br><span class="line">      logging.kubesphere.io/enabled: &quot;true&quot;</span><br><span class="line">    name: tail</span><br><span class="line">    namespace: kubesphere-logging-system</span><br><span class="line">    resourceVersion: &quot;1503222&quot;</span><br><span class="line">    uid: fdf165ed-5a03-42ef-bb0b-6f625b194a3f</span><br><span class="line">  spec:</span><br><span class="line">    tail:</span><br><span class="line">      db: /fluent-bit/tail/pos.db</span><br><span class="line">      dbSync: Normal</span><br><span class="line">      excludePath: /var/log/containers/*_kubesphere-logging-system_events-exporter*.log,/var/log/containers/kube-auditing-webhook*_kubesphere-logging-system_kube-auditing-webhook*.log</span><br><span class="line">      memBufLimit: 5MB</span><br><span class="line">      parser: docker</span><br><span class="line">      path: /var/log/containers/*.log</span><br><span class="line">      refreshIntervalSeconds: 10</span><br><span class="line">      skipLongLines: true</span><br><span class="line">      tag: kube.*</span><br></pre></td></tr></table></figure>
</code></pre>
</li>
<li><p>看现在的配置，跟 github 上的对比，发现配置存在无需调整。</p>
</li>
<li><p>再看看我们现在的 <strong>filter-auditing</strong> 配置。</p>
</li>
<li><pre><code class="shell">[root@ks-k8s-master-0 ~]# kubectl get  filters -n kubesphere-logging-system filter-auditing -o yaml
apiVersion: logging.kubesphere.io/v1alpha2
kind: Filter
metadata:
  annotations:
    kubectl.kubernetes.io/last-applied-configuration: |
      &#123;&quot;apiVersion&quot;:&quot;logging.kubesphere.io/v1alpha2&quot;,&quot;kind&quot;:&quot;Filter&quot;,&quot;metadata&quot;:&#123;&quot;annotations&quot;:&#123;&#125;,&quot;labels&quot;:&#123;&quot;logging.kubesphere.io/component&quot;:&quot;auditing&quot;,&quot;logging.kubesphere.io/enabled&quot;:&quot;true&quot;&#125;,&quot;name&quot;:&quot;filter-auditing&quot;,&quot;namespace&quot;:&quot;kubesphere-logging-system&quot;&#125;,&quot;spec&quot;:&#123;&quot;filters&quot;:[&#123;&quot;parser&quot;:&#123;&quot;keyName&quot;:&quot;log&quot;,&quot;parser&quot;:&quot;json&quot;&#125;&#125;,&#123;&quot;modify&quot;:&#123;&quot;conditions&quot;:[&#123;&quot;keyDoesNotExist&quot;:&#123;&quot;AuditID&quot;:&quot;&quot;&#125;&#125;],&quot;rules&quot;:[&#123;&quot;add&quot;:&#123;&quot;ignore&quot;:&quot;true&quot;&#125;&#125;]&#125;&#125;,&#123;&quot;grep&quot;:&#123;&quot;exclude&quot;:&quot;ignore true&quot;&#125;&#125;],&quot;match&quot;:&quot;kube_auditing&quot;&#125;&#125;
  creationTimestamp: &quot;2022-04-15T03:51:23Z&quot;
  generation: 1
  labels:
    logging.kubesphere.io/component: auditing
    logging.kubesphere.io/enabled: &quot;true&quot;
  name: filter-auditing
  namespace: kubesphere-logging-system
  resourceVersion: &quot;1503307&quot;
  uid: f0e88853-dc14-41f9-bcbf-f1a49fd121cf
spec:
  filters:
  - parser:
      keyName: log
      parser: json
  - modify:
      conditions:
      - keyDoesNotExist:
          AuditID: &quot;&quot;
      rules:
      - add:
          ignore: &quot;true&quot;
  - grep:
      exclude: ignore true
  match: kube_auditing
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">   - 看现在的配置，跟 Github 上的对比，发现配置存在无需调整。</span><br><span class="line"></span><br><span class="line">   - 又无路可走了。。。清醒一下脑袋，进入下一环节。</span><br><span class="line"></span><br><span class="line">4. 问题排查第四环节，再探 Fluent-bit。</span><br><span class="line"></span><br><span class="line">   - 没其他思路了，把 Fluent-bit 的 Trace 开开吧。</span><br><span class="line"></span><br><span class="line">   - 找到我们的 fluent-bit-config 的 ConfigMap。</span><br><span class="line"></span><br><span class="line">   - ```shell</span><br><span class="line">     [root@ks-k8s-master-0 ~]# kubectl get secrets fluent-bit-config -n kubesphere-logging-system -o yaml</span><br><span class="line">     apiVersion: v1</span><br><span class="line">     data:</span><br><span class="line">       fluent-bit.conf: W1NlcnZpY2VdCiAgICBQYXJzZXJzX0ZpbGUgICAgcGFyc2Vycy5jb25mCltJbnB1dF0KICAgIE5hbWUgICAgc3lzdGVtZAogICAgUGF0aCAgICAvdmFyL2xvZy9qb3VybmFsCiAgICBEQiAgICAvZmx1ZW50LWJpdC90YWlsL2RvY2tlci5kYgogICAgREIuU3luYyAgICBOb3JtYWwKICAgIFRhZyAgICBzZXJ2aWNlLmRvY2tlcgogICAgU3lzdGVtZF9GaWx0ZXIgICAgX1NZU1RFTURfVU5JVD1kb2NrZXIuc2VydmljZQpbSW5wdXRdCiAgICBOYW1lICAgIHN5c3RlbWQKICAgIFBhdGggICAgL3Zhci9sb2cvam91cm5hbAogICAgREIgICAgL2ZsdWVudC1iaXQvdGFpbC9rdWJlbGV0LmRiCiAgICBEQi5TeW5jICAgIE5vcm1hbAogICAgVGFnICAgIHNlcnZpY2Uua3ViZWxldAogICAgU3lzdGVtZF9GaWx0ZXIgICAgX1NZU1RFTURfVU5JVD1rdWJlbGV0LnNlcnZpY2UKW0lucHV0XQogICAgTmFtZSAgICB0YWlsCiAgICBQYXRoICAgIC92YXIvbG9nL2NvbnRhaW5lcnMvKi5sb2cKICAgIEV4Y2x1ZGVfUGF0aCAgICAvdmFyL2xvZy9jb250YWluZXJzLypfa3ViZXNwaGVyZS1sb2dnaW5nLXN5c3RlbV9ldmVudHMtZXhwb3J0ZXIqLmxvZywvdmFyL2xvZy9jb250YWluZXJzL2t1YmUtYXVkaXRpbmctd2ViaG9vaypfa3ViZXNwaGVyZS1sb2dnaW5nLXN5c3RlbV9rdWJlLWF1ZGl0aW5nLXdlYmhvb2sqLmxvZwogICAgUmVmcmVzaF9JbnRlcnZhbCAgICAxMAogICAgU2tpcF9Mb25nX0xpbmVzICAgIHRydWUKICAgIERCICAgIC9mbHVlbnQtYml0L3RhaWwvcG9zLmRiCiAgICBEQi5TeW5jICAgIE5vcm1hbAogICAgTWVtX0J1Zl9MaW1pdCAgICA1TUIKICAgIFBhcnNlciAgICBkb2NrZXIKICAgIFRhZyAgICBrdWJlLioKW0lucHV0XQogICAgTmFtZSAgICB0YWlsCiAgICBQYXRoICAgIC92YXIvbG9nL2NvbnRhaW5lcnMva3ViZS1hdWRpdGluZy13ZWJob29rKl9rdWJlc3BoZXJlLWxvZ2dpbmctc3lzdGVtX2t1YmUtYXVkaXRpbmctd2ViaG9vayoubG9nCiAgICBSZWZyZXNoX0ludGVydmFsICAgIDEwCiAgICBTa2lwX0xvbmdfTGluZXMgICAgdHJ1ZQogICAgREIgICAgL2ZsdWVudC1iaXQvdGFpbC9wb3MtYXVkaXRpbmcuZGIKICAgIERCLlN5bmMgICAgTm9ybWFsCiAgICBNZW1fQnVmX0xpbWl0ICAgIDVNQgogICAgUGFyc2VyICAgIGRvY2tlcgogICAgVGFnICAgIGt1YmVfYXVkaXRpbmcKW0lucHV0XQogICAgTmFtZSAgICB0YWlsCiAgICBQYXRoICAgIC92YXIvbG9nL2NvbnRhaW5lcnMvKl9rdWJlc3BoZXJlLWxvZ2dpbmctc3lzdGVtX2V2ZW50cy1leHBvcnRlcioubG9nCiAgICBSZWZyZXNoX0ludGVydmFsICAgIDEwCiAgICBTa2lwX0xvbmdfTGluZXMgICAgdHJ1ZQogICAgREIgICAgL2ZsdWVudC1iaXQvdGFpbC9wb3MtZXZlbnRzLmRiCiAgICBEQi5TeW5jICAgIE5vcm1hbAogICAgTWVtX0J1Zl9MaW1pdCAgICA1TUIKICAgIFBhcnNlciAgICBkb2NrZXIKICAgIFRhZyAgICBrdWJlX2V2ZW50cwpbRmlsdGVyXQogICAgTmFtZSAgICBwYXJzZXIKICAgIE1hdGNoICAgIGt1YmVfYXVkaXRpbmcKICAgIEtleV9OYW1lICAgIGxvZwogICAgUGFyc2VyICAgIGpzb24KW0ZpbHRlcl0KICAgIE5hbWUgICAgbW9kaWZ5CiAgICBNYXRjaCAgICBrdWJlX2F1ZGl0aW5nCiAgICBDb25kaXRpb24gICAgS2V5X2RvZXNfbm90X2V4aXN0ICAgIEF1ZGl0SUQgICAgCiAgICBBZGQgICAgaWdub3JlICAgIHRydWUKW0ZpbHRlcl0KICAgIE5hbWUgICAgZ3JlcAogICAgTWF0Y2ggICAga3ViZV9hdWRpdGluZwogICAgRXhjbHVkZSAgICBpZ25vcmUgdHJ1ZQpbRmlsdGVyXQogICAgTmFtZSAgICBwYXJzZXIKICAgIE1hdGNoICAgIGt1YmVfZXZlbnRzCiAgICBLZXlfTmFtZSAgICBsb2cKICAgIFBhcnNlciAgICBqc29uCltGaWx0ZXJdCiAgICBOYW1lICAgIGt1YmVybmV0ZXMKICAgIE1hdGNoICAgIGt1YmUuKgogICAgS3ViZV9VUkwgICAgaHR0cHM6Ly9rdWJlcm5ldGVzLmRlZmF1bHQuc3ZjOjQ0MwogICAgS3ViZV9DQV9GaWxlICAgIC92YXIvcnVuL3NlY3JldHMva3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9jYS5jcnQKICAgIEt1YmVfVG9rZW5fRmlsZSAgICAvdmFyL3J1bi9zZWNyZXRzL2t1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvdG9rZW4KICAgIExhYmVscyAgICBmYWxzZQogICAgQW5ub3RhdGlvbnMgICAgZmFsc2UKW0ZpbHRlcl0KICAgIE5hbWUgICAgbmVzdAogICAgTWF0Y2ggICAga3ViZS4qCiAgICBPcGVyYXRpb24gICAgbGlmdAogICAgTmVzdGVkX3VuZGVyICAgIGt1YmVybmV0ZXMKICAgIEFkZF9wcmVmaXggICAga3ViZXJuZXRlc18KW0ZpbHRlcl0KICAgIE5hbWUgICAgbW9kaWZ5CiAgICBNYXRjaCAgICBrdWJlLioKICAgIFJlbW92ZSAgICBzdHJlYW0KICAgIFJlbW92ZSAgICBrdWJlcm5ldGVzX3BvZF9pZAogICAgUmVtb3ZlICAgIGt1YmVybmV0ZXNfaG9zdAogICAgUmVtb3ZlICAgIGt1YmVybmV0ZXNfY29udGFpbmVyX2hhc2gKW0ZpbHRlcl0KICAgIE5hbWUgICAgbmVzdAogICAgTWF0Y2ggICAga3ViZS4qCiAgICBPcGVyYXRpb24gICAgbmVzdAogICAgV2lsZGNhcmQgICAga3ViZXJuZXRlc18qCiAgICBOZXN0X3VuZGVyICAgIGt1YmVybmV0ZXMKICAgIFJlbW92ZV9wcmVmaXggICAga3ViZXJuZXRlc18KW0ZpbHRlcl0KICAgIE5hbWUgICAgbHVhCiAgICBNYXRjaCAgICBzZXJ2aWNlLioKICAgIHNjcmlwdCAgICAvZmx1ZW50LWJpdC9jb25maWcvc3lzdGVtZC5sdWEKICAgIGNhbGwgICAgYWRkX3RpbWUKICAgIHRpbWVfYXNfdGFibGUgICAgdHJ1ZQpbT3V0cHV0XQogICAgTmFtZSAgICBlcwogICAgTWF0Y2hfUmVnZXggICAgKD86a3ViZXxzZXJ2aWNlKVwuKC4qKQogICAgSG9zdCAgICAxOTIuMTY4LjkuOTUKICAgIFBvcnQgICAgOTIwMAogICAgSFRUUF9Vc2VyICAgIGxzdGFjawogICAgSFRUUF9QYXNzd2QgICAgUEA4OHcwcmQKICAgIExvZ3N0YXNoX0Zvcm1hdCAgICB0cnVlCiAgICBMb2dzdGFzaF9QcmVmaXggICAga3MtbG9nc3Rhc2gtbG9nCiAgICBUaW1lX0tleSAgICBAdGltZXN0YW1wCiAgICBHZW5lcmF0ZV9JRCAgICB0cnVlCiAgICB0bHMgICAgT24KICAgIHRscy52ZXJpZnkgICAgZmFsc2UKW091dHB1dF0KICAgIE5hbWUgICAgZXMKICAgIE1hdGNoICAgIGt1YmVfYXVkaXRpbmcKICAgIEhvc3QgICAgZWxhc3RpY3NlYXJjaC1sb2dnaW5nLWRhdGEua3ViZXNwaGVyZS1sb2dnaW5nLXN5c3RlbS5zdmMKICAgIFBvcnQgICAgOTIwMAogICAgSFRUUF9Vc2VyICAgIGxzdGFjawogICAgSFRUUF9QYXNzd2QgICAgUEA4OHcwcmQKICAgIExvZ3N0YXNoX0Zvcm1hdCAgICB0cnVlCiAgICBMb2dzdGFzaF9QcmVmaXggICAga3MtbG9nc3Rhc2gtYXVkaXRpbmcKICAgIEdlbmVyYXRlX0lEICAgIHRydWUKICAgIHRscyAgICBPbgogICAgdGxzLnZlcmlmeSAgICBmYWxzZQpbT3V0cHV0XQogICAgTmFtZSAgICBlcwogICAgTWF0Y2ggICAga3ViZV9ldmVudHMKICAgIEhvc3QgICAgZWxhc3RpY3NlYXJjaC1sb2dnaW5nLWRhdGEua3ViZXNwaGVyZS1sb2dnaW5nLXN5c3RlbS5zdmMKICAgIFBvcnQgICAgOTIwMAogICAgSFRUUF9Vc2VyICAgIGxzdGFjawogICAgSFRUUF9QYXNzd2QgICAgUEA4OHcwcmQKICAgIExvZ3N0YXNoX0Zvcm1hdCAgICB0cnVlCiAgICBMb2dzdGFzaF9QcmVmaXggICAga3MtbG9nc3Rhc2gtZXZlbnRzCiAgICBHZW5lcmF0ZV9JRCAgICB0cnVlCiAgICB0bHMgICAgT24KICAgIHRscy52ZXJpZnkgICAgZmFsc2UK</span><br><span class="line">       parsers.conf: &quot;&quot;</span><br><span class="line">       systemd.lua: ZnVuY3Rpb24gYWRkX3RpbWUodGFnLCB0aW1lc3RhbXAsIHJlY29yZCkKICBuZXdfcmVjb3JkID0ge30KICB0aW1lU3RyID0gb3MuZGF0ZSgiISp0IiwgdGltZXN0YW1wWyJzZWMiXSkKICB0ID0gc3RyaW5nLmZvcm1hdCgiJTRkLSUwMmQtJTAyZFQlMDJkOiUwMmQ6JTAyZC4lc1oiLAoJCXRpbWVTdHJbInllYXIiXSwgdGltZVN0clsibW9udGgiXSwgdGltZVN0clsiZGF5Il0sCgkJdGltZVN0clsiaG91ciJdLCB0aW1lU3RyWyJtaW4iXSwgdGltZVN0clsic2VjIl0sCgkJdGltZXN0YW1wWyJuc2VjIl0pCiAga3ViZXJuZXRlcyA9IHt9CiAga3ViZXJuZXRlc1sicG9kX25hbWUiXSA9IHJlY29yZFsiX0hPU1ROQU1FIl0KICBrdWJlcm5ldGVzWyJjb250YWluZXJfbmFtZSJdID0gcmVjb3JkWyJTWVNMT0dfSURFTlRJRklFUiJdCiAga3ViZXJuZXRlc1sibmFtZXNwYWNlX25hbWUiXSA9ICJrdWJlLXN5c3RlbSIKICBuZXdfcmVjb3JkWyJ0aW1lIl0gPSB0CiAgbmV3X3JlY29yZFsibG9nIl0gPSByZWNvcmRbIk1FU1NBR0UiXQogIG5ld19yZWNvcmRbImt1YmVybmV0ZXMiXSA9IGt1YmVybmV0ZXMKICByZXR1cm4gMSwgdGltZXN0YW1wLCBuZXdfcmVjb3JkCmVuZA==</span><br><span class="line">     kind: Secret</span><br><span class="line">     metadata:</span><br><span class="line">       creationTimestamp: &quot;2022-04-15T03:49:33Z&quot;</span><br><span class="line">       name: fluent-bit-config</span><br><span class="line">       namespace: kubesphere-logging-system</span><br><span class="line">       ownerReferences:</span><br><span class="line">       - apiVersion: logging.kubesphere.io/v1alpha2</span><br><span class="line">         blockOwnerDeletion: true</span><br><span class="line">         controller: true</span><br><span class="line">         kind: FluentBitConfig</span><br><span class="line">         name: fluent-bit-config</span><br><span class="line">         uid: 8637b012-ed24-404f-b1bb-6404b0a18537</span><br><span class="line">       resourceVersion: &quot;2865407&quot;</span><br><span class="line">       uid: 66b56299-fb2c-435a-ae83-f21904656863</span><br><span class="line">     type: Opaque</span><br></pre></td></tr></table></figure>
</code></pre>
</li>
<li><p>居然没有明文，居然是加密的，这看个鬼啊。。。</p>
</li>
<li><p>不过，好在我们知道 k8s 里的好多字典都是 base64 加密的，而 base64 又是可以反解密的。我们解开试试。</p>
</li>
<li><p>先把 base64 加密过的字符串复制下来，新建一个文件 <strong>fluent-bit-config</strong></p>
</li>
<li><pre><code class="yaml">[root@ks-k8s-master-0 ~]# vi fluent-bit-config
写入以下内容

W1NlcnZpY2VdCiAgICBQYXJzZXJzX0ZpbGUgICAgcGFyc2Vycy5jb25mCltJbnB1dF0KICAgIE5hbWUgICAgc3lzdGVtZAogICAgUGF0aCAgICAvdmFyL2xvZy9qb3VybmFsCiAgICBEQiAgICAvZmx1ZW50LWJpdC90YWlsL2RvY2tlci5kYgogICAgREIuU3luYyAgICBOb3JtYWwKICAgIFRhZyAgICBzZXJ2aWNlLmRvY2tlcgogICAgU3lzdGVtZF9GaWx0ZXIgICAgX1NZU1RFTURfVU5JVD1kb2NrZXIuc2VydmljZQpbSW5wdXRdCiAgICBOYW1lICAgIHN5c3RlbWQKICAgIFBhdGggICAgL3Zhci9sb2cvam91cm5hbAogICAgREIgICAgL2ZsdWVudC1iaXQvdGFpbC9rdWJlbGV0LmRiCiAgICBEQi5TeW5jICAgIE5vcm1hbAogICAgVGFnICAgIHNlcnZpY2Uua3ViZWxldAogICAgU3lzdGVtZF9GaWx0ZXIgICAgX1NZU1RFTURfVU5JVD1rdWJlbGV0LnNlcnZpY2UKW0lucHV0XQogICAgTmFtZSAgICB0YWlsCiAgICBQYXRoICAgIC92YXIvbG9nL2NvbnRhaW5lcnMvKi5sb2cKICAgIEV4Y2x1ZGVfUGF0aCAgICAvdmFyL2xvZy9jb250YWluZXJzLypfa3ViZXNwaGVyZS1sb2dnaW5nLXN5c3RlbV9ldmVudHMtZXhwb3J0ZXIqLmxvZywvdmFyL2xvZy9jb250YWluZXJzL2t1YmUtYXVkaXRpbmctd2ViaG9vaypfa3ViZXNwaGVyZS1sb2dnaW5nLXN5c3RlbV9rdWJlLWF1ZGl0aW5nLXdlYmhvb2sqLmxvZwogICAgUmVmcmVzaF9JbnRlcnZhbCAgICAxMAogICAgU2tpcF9Mb25nX0xpbmVzICAgIHRydWUKICAgIERCICAgIC9mbHVlbnQtYml0L3RhaWwvcG9zLmRiCiAgICBEQi5TeW5jICAgIE5vcm1hbAogICAgTWVtX0J1Zl9MaW1pdCAgICA1TUIKICAgIFBhcnNlciAgICBkb2NrZXIKICAgIFRhZyAgICBrdWJlLioKW0lucHV0XQogICAgTmFtZSAgICB0YWlsCiAgICBQYXRoICAgIC92YXIvbG9nL2NvbnRhaW5lcnMva3ViZS1hdWRpdGluZy13ZWJob29rKl9rdWJlc3BoZXJlLWxvZ2dpbmctc3lzdGVtX2t1YmUtYXVkaXRpbmctd2ViaG9vayoubG9nCiAgICBSZWZyZXNoX0ludGVydmFsICAgIDEwCiAgICBTa2lwX0xvbmdfTGluZXMgICAgdHJ1ZQogICAgREIgICAgL2ZsdWVudC1iaXQvdGFpbC9wb3MtYXVkaXRpbmcuZGIKICAgIERCLlN5bmMgICAgTm9ybWFsCiAgICBNZW1fQnVmX0xpbWl0ICAgIDVNQgogICAgUGFyc2VyICAgIGRvY2tlcgogICAgVGFnICAgIGt1YmVfYXVkaXRpbmcKW0lucHV0XQogICAgTmFtZSAgICB0YWlsCiAgICBQYXRoICAgIC92YXIvbG9nL2NvbnRhaW5lcnMvKl9rdWJlc3BoZXJlLWxvZ2dpbmctc3lzdGVtX2V2ZW50cy1leHBvcnRlcioubG9nCiAgICBSZWZyZXNoX0ludGVydmFsICAgIDEwCiAgICBTa2lwX0xvbmdfTGluZXMgICAgdHJ1ZQogICAgREIgICAgL2ZsdWVudC1iaXQvdGFpbC9wb3MtZXZlbnRzLmRiCiAgICBEQi5TeW5jICAgIE5vcm1hbAogICAgTWVtX0J1Zl9MaW1pdCAgICA1TUIKICAgIFBhcnNlciAgICBkb2NrZXIKICAgIFRhZyAgICBrdWJlX2V2ZW50cwpbRmlsdGVyXQogICAgTmFtZSAgICBwYXJzZXIKICAgIE1hdGNoICAgIGt1YmVfYXVkaXRpbmcKICAgIEtleV9OYW1lICAgIGxvZwogICAgUGFyc2VyICAgIGpzb24KW0ZpbHRlcl0KICAgIE5hbWUgICAgbW9kaWZ5CiAgICBNYXRjaCAgICBrdWJlX2F1ZGl0aW5nCiAgICBDb25kaXRpb24gICAgS2V5X2RvZXNfbm90X2V4aXN0ICAgIEF1ZGl0SUQgICAgCiAgICBBZGQgICAgaWdub3JlICAgIHRydWUKW0ZpbHRlcl0KICAgIE5hbWUgICAgZ3JlcAogICAgTWF0Y2ggICAga3ViZV9hdWRpdGluZwogICAgRXhjbHVkZSAgICBpZ25vcmUgdHJ1ZQpbRmlsdGVyXQogICAgTmFtZSAgICBwYXJzZXIKICAgIE1hdGNoICAgIGt1YmVfZXZlbnRzCiAgICBLZXlfTmFtZSAgICBsb2cKICAgIFBhcnNlciAgICBqc29uCltGaWx0ZXJdCiAgICBOYW1lICAgIGt1YmVybmV0ZXMKICAgIE1hdGNoICAgIGt1YmUuKgogICAgS3ViZV9VUkwgICAgaHR0cHM6Ly9rdWJlcm5ldGVzLmRlZmF1bHQuc3ZjOjQ0MwogICAgS3ViZV9DQV9GaWxlICAgIC92YXIvcnVuL3NlY3JldHMva3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9jYS5jcnQKICAgIEt1YmVfVG9rZW5fRmlsZSAgICAvdmFyL3J1bi9zZWNyZXRzL2t1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvdG9rZW4KICAgIExhYmVscyAgICBmYWxzZQogICAgQW5ub3RhdGlvbnMgICAgZmFsc2UKW0ZpbHRlcl0KICAgIE5hbWUgICAgbmVzdAogICAgTWF0Y2ggICAga3ViZS4qCiAgICBPcGVyYXRpb24gICAgbGlmdAogICAgTmVzdGVkX3VuZGVyICAgIGt1YmVybmV0ZXMKICAgIEFkZF9wcmVmaXggICAga3ViZXJuZXRlc18KW0ZpbHRlcl0KICAgIE5hbWUgICAgbW9kaWZ5CiAgICBNYXRjaCAgICBrdWJlLioKICAgIFJlbW92ZSAgICBzdHJlYW0KICAgIFJlbW92ZSAgICBrdWJlcm5ldGVzX3BvZF9pZAogICAgUmVtb3ZlICAgIGt1YmVybmV0ZXNfaG9zdAogICAgUmVtb3ZlICAgIGt1YmVybmV0ZXNfY29udGFpbmVyX2hhc2gKW0ZpbHRlcl0KICAgIE5hbWUgICAgbmVzdAogICAgTWF0Y2ggICAga3ViZS4qCiAgICBPcGVyYXRpb24gICAgbmVzdAogICAgV2lsZGNhcmQgICAga3ViZXJuZXRlc18qCiAgICBOZXN0X3VuZGVyICAgIGt1YmVybmV0ZXMKICAgIFJlbW92ZV9wcmVmaXggICAga3ViZXJuZXRlc18KW0ZpbHRlcl0KICAgIE5hbWUgICAgbHVhCiAgICBNYXRjaCAgICBzZXJ2aWNlLioKICAgIHNjcmlwdCAgICAvZmx1ZW50LWJpdC9jb25maWcvc3lzdGVtZC5sdWEKICAgIGNhbGwgICAgYWRkX3RpbWUKICAgIHRpbWVfYXNfdGFibGUgICAgdHJ1ZQpbT3V0cHV0XQogICAgTmFtZSAgICBlcwogICAgTWF0Y2hfUmVnZXggICAgKD86a3ViZXxzZXJ2aWNlKVwuKC4qKQogICAgSG9zdCAgICAxOTIuMTY4LjkuOTUKICAgIFBvcnQgICAgOTIwMAogICAgSFRUUF9Vc2VyICAgIGxzdGFjawogICAgSFRUUF9QYXNzd2QgICAgUEA4OHcwcmQKICAgIExvZ3N0YXNoX0Zvcm1hdCAgICB0cnVlCiAgICBMb2dzdGFzaF9QcmVmaXggICAga3MtbG9nc3Rhc2gtbG9nCiAgICBUaW1lX0tleSAgICBAdGltZXN0YW1wCiAgICBHZW5lcmF0ZV9JRCAgICB0cnVlCiAgICB0bHMgICAgT24KICAgIHRscy52ZXJpZnkgICAgZmFsc2UKW091dHB1dF0KICAgIE5hbWUgICAgZXMKICAgIE1hdGNoICAgIGt1YmVfYXVkaXRpbmcKICAgIEhvc3QgICAgZWxhc3RpY3NlYXJjaC1sb2dnaW5nLWRhdGEua3ViZXNwaGVyZS1sb2dnaW5nLXN5c3RlbS5zdmMKICAgIFBvcnQgICAgOTIwMAogICAgSFRUUF9Vc2VyICAgIGxzdGFjawogICAgSFRUUF9QYXNzd2QgICAgUEA4OHcwcmQKICAgIExvZ3N0YXNoX0Zvcm1hdCAgICB0cnVlCiAgICBMb2dzdGFzaF9QcmVmaXggICAga3MtbG9nc3Rhc2gtYXVkaXRpbmcKICAgIEdlbmVyYXRlX0lEICAgIHRydWUKICAgIHRscyAgICBPbgogICAgdGxzLnZlcmlmeSAgICBmYWxzZQpbT3V0cHV0XQogICAgTmFtZSAgICBlcwogICAgTWF0Y2ggICAga3ViZV9ldmVudHMKICAgIEhvc3QgICAgZWxhc3RpY3NlYXJjaC1sb2dnaW5nLWRhdGEua3ViZXNwaGVyZS1sb2dnaW5nLXN5c3RlbS5zdmMKICAgIFBvcnQgICAgOTIwMAogICAgSFRUUF9Vc2VyICAgIGxzdGFjawogICAgSFRUUF9QYXNzd2QgICAgUEA4OHcwcmQKICAgIExvZ3N0YXNoX0Zvcm1hdCAgICB0cnVlCiAgICBMb2dzdGFzaF9QcmVmaXggICAga3MtbG9nc3Rhc2gtZXZlbnRzCiAgICBHZW5lcmF0ZV9JRCAgICB0cnVlCiAgICB0bHMgICAgT24KICAgIHRscy52ZXJpZnkgICAgZmFsc2UK
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- 执行下面的命令将解密后的文件输出到 **fluent-bit-config.conf**。</span><br><span class="line"></span><br><span class="line">- ```shell</span><br><span class="line">  [root@ks-k8s-master-0 ~]# base64 -d fluent-bit-config &gt; fluent-bit-config.conf</span><br></pre></td></tr></table></figure>
</code></pre>
</li>
<li><p>看看输出的文件都有啥。</p>
</li>
<li><pre><code class="yaml">[root@ks-k8s-master-0 ~]# cat fluent-bit-config.conf 
[Service]
    Parsers_File    parsers.conf
[Input]
    Name    systemd
    Path    /var/log/journal
    DB    /fluent-bit/tail/docker.db
    DB.Sync    Normal
    Tag    service.docker
    Systemd_Filter    _SYSTEMD_UNIT=docker.service
[Input]
    Name    systemd
    Path    /var/log/journal
    DB    /fluent-bit/tail/kubelet.db
    DB.Sync    Normal
    Tag    service.kubelet
    Systemd_Filter    _SYSTEMD_UNIT=kubelet.service
[Input]
    Name    tail
    Path    /var/log/containers/*.log
    Exclude_Path    /var/log/containers/*_kubesphere-logging-system_events-exporter*.log,/var/log/containers/kube-auditing-webhook*_kubesphere-logging-system_kube-auditing-webhook*.log
    Refresh_Interval    10
    Skip_Long_Lines    true
    DB    /fluent-bit/tail/pos.db
    DB.Sync    Normal
    Mem_Buf_Limit    5MB
    Parser    docker
    Tag    kube.*
[Input]
    Name    tail
    Path    /var/log/containers/kube-auditing-webhook*_kubesphere-logging-system_kube-auditing-webhook*.log
    Refresh_Interval    10
    Skip_Long_Lines    true
    DB    /fluent-bit/tail/pos-auditing.db
    DB.Sync    Normal
    Mem_Buf_Limit    5MB
    Parser    docker
    Tag    kube_auditing
[Input]
    Name    tail
    Path    /var/log/containers/*_kubesphere-logging-system_events-exporter*.log
    Refresh_Interval    10
    Skip_Long_Lines    true
    DB    /fluent-bit/tail/pos-events.db
    DB.Sync    Normal
    Mem_Buf_Limit    5MB
    Parser    docker
    Tag    kube_events
[Filter]
    Name    parser
    Match    kube_auditing
    Key_Name    log
    Parser    json
[Filter]
    Name    modify
    Match    kube_auditing
    Condition    Key_does_not_exist    AuditID    
    Add    ignore    true
[Filter]
    Name    grep
    Match    kube_auditing
    Exclude    ignore true
[Filter]
    Name    parser
    Match    kube_events
    Key_Name    log
    Parser    json
[Filter]
    Name    kubernetes
    Match    kube.*
    Kube_URL    https://kubernetes.default.svc:443
    Kube_CA_File    /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
    Kube_Token_File    /var/run/secrets/kubernetes.io/serviceaccount/token
    Labels    false
    Annotations    false
[Filter]
    Name    nest
    Match    kube.*
    Operation    lift
    Nested_under    kubernetes
    Add_prefix    kubernetes_
[Filter]
    Name    modify
    Match    kube.*
    Remove    stream
    Remove    kubernetes_pod_id
    Remove    kubernetes_host
    Remove    kubernetes_container_hash
[Filter]
    Name    nest
    Match    kube.*
    Operation    nest
    Wildcard    kubernetes_*
    Nest_under    kubernetes
    Remove_prefix    kubernetes_
[Filter]
    Name    lua
    Match    service.*
    script    /fluent-bit/config/systemd.lua
    call    add_time
    time_as_table    true
[Output]
    Name    es
    Match_Regex    (?:kube|service)\.(.*)
    Host    192.168.9.95
    Port    9200
    HTTP_User    lstack
    HTTP_Passwd    P@88w0rd
    Logstash_Format    true
    Logstash_Prefix    ks-logstash-log
    Time_Key    @timestamp
    Generate_ID    true
    tls    On
    tls.verify    false
[Output]
    Name    es
    Match    kube_auditing
    Host    elasticsearch-logging-data.kubesphere-logging-system.svc
    Port    9200
    HTTP_User    lstack
    HTTP_Passwd    P@88w0rd
    Logstash_Format    true
    Logstash_Prefix    ks-logstash-auditing
    Generate_ID    true
    tls    On
    tls.verify    false
[Output]
    Name    es
    Match    kube_events
    Host    elasticsearch-logging-data.kubesphere-logging-system.svc
    Port    9200
    HTTP_User    lstack
    HTTP_Passwd    P@88w0rd
    Logstash_Format    true
    Logstash_Prefix    ks-logstash-events
    Generate_ID    true
    tls    On
    tls.verify    false
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- 细节我们先不深究 (其实我也不知道啥意思)，我们直奔我们的目标，找到**[Output] Name 为 es** 且标有 **Match_Regex** 的配置，添加 **Trace_Error     On**。</span><br><span class="line"></span><br><span class="line">- 效果如下：</span><br><span class="line"></span><br><span class="line">- ```yaml</span><br><span class="line">  [Output]</span><br><span class="line">      Name    es</span><br><span class="line">      Match_Regex    (?:kube|service)\.(.*)</span><br><span class="line">      Host    192.168.9.95</span><br><span class="line">      Port    9200</span><br><span class="line">      HTTP_User    lstack</span><br><span class="line">      HTTP_Passwd    P@88w0rd</span><br><span class="line">      Logstash_Format    true</span><br><span class="line">      Logstash_Prefix    ks-logstash-log</span><br><span class="line">      Time_Key    @timestamp</span><br><span class="line">      Generate_ID    true</span><br><span class="line">      tls    On</span><br><span class="line">      tls.verify    false</span><br><span class="line">      Trace_Error     On</span><br></pre></td></tr></table></figure>
</code></pre>
</li>
<li><p>保存文件并退出，再将该文件中的内容进行 base64 编码。</p>
</li>
<li><pre><code class="shell">[root@ks-k8s-master-0 ~]# base64 -w 0 fluent-bit-config.conf 
W1NlcnZpY2VdCiAgICBQYXJzZXJzX0ZpbGUgICAgcGFyc2Vycy5jb25mCltJbnB1dF0KICAgIE5hbWUgICAgc3lzdGVtZAogICAgUGF0aCAgICAvdmFyL2xvZy9qb3VybmFsCiAgICBEQiAgICAvZmx1ZW50LWJpdC90YWlsL2RvY2tlci5kYgogICAgREIuU3luYyAgICBOb3JtYWwKICAgIFRhZyAgICBzZXJ2aWNlLmRvY2tlcgogICAgU3lzdGVtZF9GaWx0ZXIgICAgX1NZU1RFTURfVU5JVD1kb2NrZXIuc2VydmljZQpbSW5wdXRdCiAgICBOYW1lICAgIHN5c3RlbWQKICAgIFBhdGggICAgL3Zhci9sb2cvam91cm5hbAogICAgREIgICAgL2ZsdWVudC1iaXQvdGFpbC9rdWJlbGV0LmRiCiAgICBEQi5TeW5jICAgIE5vcm1hbAogICAgVGFnICAgIHNlcnZpY2Uua3ViZWxldAogICAgU3lzdGVtZF9GaWx0ZXIgICAgX1NZU1RFTURfVU5JVD1rdWJlbGV0LnNlcnZpY2UKW0lucHV0XQogICAgTmFtZSAgICB0YWlsCiAgICBQYXRoICAgIC92YXIvbG9nL2NvbnRhaW5lcnMvKi5sb2cKICAgIEV4Y2x1ZGVfUGF0aCAgICAvdmFyL2xvZy9jb250YWluZXJzLypfa3ViZXNwaGVyZS1sb2dnaW5nLXN5c3RlbV9ldmVudHMtZXhwb3J0ZXIqLmxvZywvdmFyL2xvZy9jb250YWluZXJzL2t1YmUtYXVkaXRpbmctd2ViaG9vaypfa3ViZXNwaGVyZS1sb2dnaW5nLXN5c3RlbV9rdWJlLWF1ZGl0aW5nLXdlYmhvb2sqLmxvZwogICAgUmVmcmVzaF9JbnRlcnZhbCAgICAxMAogICAgU2tpcF9Mb25nX0xpbmVzICAgIHRydWUKICAgIERCICAgIC9mbHVlbnQtYml0L3RhaWwvcG9zLmRiCiAgICBEQi5TeW5jICAgIE5vcm1hbAogICAgTWVtX0J1Zl9MaW1pdCAgICA1TUIKICAgIFBhcnNlciAgICBkb2NrZXIKICAgIFRhZyAgICBrdWJlLioKW0lucHV0XQogICAgTmFtZSAgICB0YWlsCiAgICBQYXRoICAgIC92YXIvbG9nL2NvbnRhaW5lcnMva3ViZS1hdWRpdGluZy13ZWJob29rKl9rdWJlc3BoZXJlLWxvZ2dpbmctc3lzdGVtX2t1YmUtYXVkaXRpbmctd2ViaG9vayoubG9nCiAgICBSZWZyZXNoX0ludGVydmFsICAgIDEwCiAgICBTa2lwX0xvbmdfTGluZXMgICAgdHJ1ZQogICAgREIgICAgL2ZsdWVudC1iaXQvdGFpbC9wb3MtYXVkaXRpbmcuZGIKICAgIERCLlN5bmMgICAgTm9ybWFsCiAgICBNZW1fQnVmX0xpbWl0ICAgIDVNQgogICAgUGFyc2VyICAgIGRvY2tlcgogICAgVGFnICAgIGt1YmVfYXVkaXRpbmcKW0lucHV0XQogICAgTmFtZSAgICB0YWlsCiAgICBQYXRoICAgIC92YXIvbG9nL2NvbnRhaW5lcnMvKl9rdWJlc3BoZXJlLWxvZ2dpbmctc3lzdGVtX2V2ZW50cy1leHBvcnRlcioubG9nCiAgICBSZWZyZXNoX0ludGVydmFsICAgIDEwCiAgICBTa2lwX0xvbmdfTGluZXMgICAgdHJ1ZQogICAgREIgICAgL2ZsdWVudC1iaXQvdGFpbC9wb3MtZXZlbnRzLmRiCiAgICBEQi5TeW5jICAgIE5vcm1hbAogICAgTWVtX0J1Zl9MaW1pdCAgICA1TUIKICAgIFBhcnNlciAgICBkb2NrZXIKICAgIFRhZyAgICBrdWJlX2V2ZW50cwpbRmlsdGVyXQogICAgTmFtZSAgICBwYXJzZXIKICAgIE1hdGNoICAgIGt1YmVfYXVkaXRpbmcKICAgIEtleV9OYW1lICAgIGxvZwogICAgUGFyc2VyICAgIGpzb24KW0ZpbHRlcl0KICAgIE5hbWUgICAgbW9kaWZ5CiAgICBNYXRjaCAgICBrdWJlX2F1ZGl0aW5nCiAgICBDb25kaXRpb24gICAgS2V5X2RvZXNfbm90X2V4aXN0ICAgIEF1ZGl0SUQgICAgCiAgICBBZGQgICAgaWdub3JlICAgIHRydWUKW0ZpbHRlcl0KICAgIE5hbWUgICAgZ3JlcAogICAgTWF0Y2ggICAga3ViZV9hdWRpdGluZwogICAgRXhjbHVkZSAgICBpZ25vcmUgdHJ1ZQpbRmlsdGVyXQogICAgTmFtZSAgICBwYXJzZXIKICAgIE1hdGNoICAgIGt1YmVfZXZlbnRzCiAgICBLZXlfTmFtZSAgICBsb2cKICAgIFBhcnNlciAgICBqc29uCltGaWx0ZXJdCiAgICBOYW1lICAgIGt1YmVybmV0ZXMKICAgIE1hdGNoICAgIGt1YmUuKgogICAgS3ViZV9VUkwgICAgaHR0cHM6Ly9rdWJlcm5ldGVzLmRlZmF1bHQuc3ZjOjQ0MwogICAgS3ViZV9DQV9GaWxlICAgIC92YXIvcnVuL3NlY3JldHMva3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9jYS5jcnQKICAgIEt1YmVfVG9rZW5fRmlsZSAgICAvdmFyL3J1bi9zZWNyZXRzL2t1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvdG9rZW4KICAgIExhYmVscyAgICBmYWxzZQogICAgQW5ub3RhdGlvbnMgICAgZmFsc2UKW0ZpbHRlcl0KICAgIE5hbWUgICAgbmVzdAogICAgTWF0Y2ggICAga3ViZS4qCiAgICBPcGVyYXRpb24gICAgbGlmdAogICAgTmVzdGVkX3VuZGVyICAgIGt1YmVybmV0ZXMKICAgIEFkZF9wcmVmaXggICAga3ViZXJuZXRlc18KW0ZpbHRlcl0KICAgIE5hbWUgICAgbW9kaWZ5CiAgICBNYXRjaCAgICBrdWJlLioKICAgIFJlbW92ZSAgICBzdHJlYW0KICAgIFJlbW92ZSAgICBrdWJlcm5ldGVzX3BvZF9pZAogICAgUmVtb3ZlICAgIGt1YmVybmV0ZXNfaG9zdAogICAgUmVtb3ZlICAgIGt1YmVybmV0ZXNfY29udGFpbmVyX2hhc2gKW0ZpbHRlcl0KICAgIE5hbWUgICAgbmVzdAogICAgTWF0Y2ggICAga3ViZS4qCiAgICBPcGVyYXRpb24gICAgbmVzdAogICAgV2lsZGNhcmQgICAga3ViZXJuZXRlc18qCiAgICBOZXN0X3VuZGVyICAgIGt1YmVybmV0ZXMKICAgIFJlbW92ZV9wcmVmaXggICAga3ViZXJuZXRlc18KW0ZpbHRlcl0KICAgIE5hbWUgICAgbHVhCiAgICBNYXRjaCAgICBzZXJ2aWNlLioKICAgIHNjcmlwdCAgICAvZmx1ZW50LWJpdC9jb25maWcvc3lzdGVtZC5sdWEKICAgIGNhbGwgICAgYWRkX3RpbWUKICAgIHRpbWVfYXNfdGFibGUgICAgdHJ1ZQpbT3V0cHV0XQogICAgTmFtZSAgICBlcwogICAgTWF0Y2hfUmVnZXggICAgKD86a3ViZXxzZXJ2aWNlKVwuKC4qKQogICAgSG9zdCAgICAxOTIuMTY4LjkuOTUKICAgIFBvcnQgICAgOTIwMAogICAgSFRUUF9Vc2VyICAgIGxzdGFjawogICAgSFRUUF9QYXNzd2QgICAgUEA4OHcwcmQKICAgIExvZ3N0YXNoX0Zvcm1hdCAgICB0cnVlCiAgICBMb2dzdGFzaF9QcmVmaXggICAga3MtbG9nc3Rhc2gtbG9nCiAgICBUaW1lX0tleSAgICBAdGltZXN0YW1wCiAgICBHZW5lcmF0ZV9JRCAgICB0cnVlCiAgICB0bHMgICAgT24KICAgIHRscy52ZXJpZnkgICAgZmFsc2UKICAgIFRyYWNlX0Vycm9yICAgICBPbgpbT3V0cHV0XQogICAgTmFtZSAgICBlcwogICAgTWF0Y2ggICAga3ViZV9hdWRpdGluZwogICAgSG9zdCAgICBlbGFzdGljc2VhcmNoLWxvZ2dpbmctZGF0YS5rdWJlc3BoZXJlLWxvZ2dpbmctc3lzdGVtLnN2YwogICAgUG9ydCAgICA5MjAwCiAgICBIVFRQX1VzZXIgICAgbHN0YWNrCiAgICBIVFRQX1Bhc3N3ZCAgICBQQDg4dzByZAogICAgTG9nc3Rhc2hfRm9ybWF0ICAgIHRydWUKICAgIExvZ3N0YXNoX1ByZWZpeCAgICBrcy1sb2dzdGFzaC1hdWRpdGluZwogICAgR2VuZXJhdGVfSUQgICAgdHJ1ZQogICAgdGxzICAgIE9uCiAgICB0bHMudmVyaWZ5ICAgIGZhbHNlCltPdXRwdXRdCiAgICBOYW1lICAgIGVzCiAgICBNYXRjaCAgICBrdWJlX2V2ZW50cwogICAgSG9zdCAgICBlbGFzdGljc2VhcmNoLWxvZ2dpbmctZGF0YS5rdWJlc3BoZXJlLWxvZ2dpbmctc3lzdGVtLnN2YwogICAgUG9ydCAgICA5MjAwCiAgICBIVFRQX1VzZXIgICAgbHN0YWNrCiAgICBIVFRQX1Bhc3N3ZCAgICBQQDg4dzByZAogICAgTG9nc3Rhc2hfRm9ybWF0ICAgIHRydWUKICAgIExvZ3N0YXNoX1ByZWZpeCAgICBrcy1sb2dzdGFzaC1ldmVudHMKICAgIEdlbmVyYXRlX0lEICAgIHRydWUKICAgIHRscyAgICBPbgogICAgdGxzLnZlcmlmeSAgICBmYWxzZQo=
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- 先把输出结果复制下来。</span><br><span class="line"></span><br><span class="line">- 再来修改我们的 Fluent-bit 的配置文件的 secrets，修改 **fluent-bit.conf** 的值。</span><br><span class="line"></span><br><span class="line">- ```shell</span><br><span class="line">  k8s-master-0 ~]# kubectl kubectl edit secrets fluent-bit-config -n kubesphere-logging-system</span><br><span class="line">  secret/fluent-bit-config edited</span><br></pre></td></tr></table></figure>
</code></pre>
</li>
<li><p>然后我又崩溃了，修改完的配置又改回原来的样子了，看样子又是使用了 <strong>fluent-operator</strong> 不能直接修改 conf 文件，唉。。。</p>
</li>
<li><p>先折回 Output 的配置，把 <strong>es-auditing</strong> 和 <strong>es-events</strong> 的配置先改对了。</p>
</li>
<li><p>备份 <strong>es-auditing</strong> 和 <strong>es-events</strong> 的 Output 配置。</p>
</li>
<li><p>&#96;&#96;&#96;shell</p>
</li>
</ul>
</li>
</ol>
<p>  [root@ks-k8s-master-0 ~]#  kubectl get outputs -n kubesphere-logging-system es-auditing -o yaml &gt; es-auditing.output.yaml<br>     [root@ks-k8s-master-0 ~]#  kubectl get outputs -n kubesphere-logging-system es-events -o yaml &gt; es-events.output.yaml<br>     <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"> </span><br><span class="line"> - 先看看 **es-auditing** 的现状。</span><br><span class="line"></span><br><span class="line"> - ```shell</span><br><span class="line">[root@ks-k8s-master-0 ~]# kubectl get outputs -n kubesphere-logging-system es-auditing -o yaml</span><br><span class="line">   apiVersion: logging.kubesphere.io/v1alpha2</span><br><span class="line">   kind: Output</span><br><span class="line">   metadata:</span><br><span class="line">     annotations:</span><br><span class="line">       kubectl.kubernetes.io/last-applied-configuration: |</span><br><span class="line">         &#123;&quot;apiVersion&quot;:&quot;logging.kubesphere.io/v1alpha2&quot;,&quot;kind&quot;:&quot;Output&quot;,&quot;metadata&quot;:&#123;&quot;annotations&quot;:&#123;&#125;,&quot;labels&quot;:&#123;&quot;logging.kubesphere.io/component&quot;:&quot;auditing&quot;,&quot;logging.kubesphere.io/enabled&quot;:&quot;true&quot;&#125;,&quot;name&quot;:&quot;es-auditing&quot;,&quot;namespace&quot;:&quot;kubesphere-logging-system&quot;&#125;,&quot;spec&quot;:&#123;&quot;es&quot;:&#123;&quot;generateID&quot;:true,&quot;host&quot;:&quot;elasticsearch-logging-data.kubesphere-logging-system.svc&quot;,&quot;httpPassword&quot;:&#123;&quot;valueFrom&quot;:&#123;&quot;secretKeyRef&quot;:&#123;&quot;key&quot;:&quot;password&quot;,&quot;name&quot;:&quot;elasticsearch-credentials&quot;&#125;&#125;&#125;,&quot;httpUser&quot;:&#123;&quot;valueFrom&quot;:&#123;&quot;secretKeyRef&quot;:&#123;&quot;key&quot;:&quot;username&quot;,&quot;name&quot;:&quot;elasticsearch-credentials&quot;&#125;&#125;&#125;,&quot;logstashFormat&quot;:true,&quot;logstashPrefix&quot;:&quot;ks-logstash-auditing&quot;,&quot;port&quot;:9200,&quot;tls&quot;:&#123;&quot;verify&quot;:false&#125;&#125;,&quot;match&quot;:&quot;kube_auditing&quot;&#125;&#125;</span><br><span class="line">     creationTimestamp: &quot;2022-04-15T03:51:23Z&quot;</span><br><span class="line">     generation: 3</span><br><span class="line">     labels:</span><br><span class="line">       logging.kubesphere.io/component: auditing</span><br><span class="line">       logging.kubesphere.io/enabled: &quot;true&quot;</span><br><span class="line">     name: es-auditing</span><br><span class="line">     namespace: kubesphere-logging-system</span><br><span class="line">     resourceVersion: &quot;1537731&quot;</span><br><span class="line">     uid: 42e31e0d-d641-48c0-8423-165a505b8124</span><br><span class="line">   spec:</span><br><span class="line">     es:</span><br><span class="line">       generateID: true</span><br><span class="line">       host: elasticsearch-logging-data.kubesphere-logging-system.svc</span><br><span class="line">       httpPassword:</span><br><span class="line">         valueFrom:</span><br><span class="line">           secretKeyRef:</span><br><span class="line">             key: password</span><br><span class="line">             name: elasticsearch-credentials</span><br><span class="line">       httpUser:</span><br><span class="line">         valueFrom:</span><br><span class="line">           secretKeyRef:</span><br><span class="line">             key: username</span><br><span class="line">             name: elasticsearch-credentials</span><br><span class="line">       logstashFormat: true</span><br><span class="line">       logstashPrefix: ks-logstash-auditing</span><br><span class="line">       port: 9200</span><br><span class="line">       tls:</span><br><span class="line">         verify: false</span><br><span class="line">     match: kube_auditing</span><br></pre></td></tr></table></figure></p>
<ul>
<li><p>分析上面的文件，发现只需要修改 <strong>host</strong> 地址就可以了，其他的都不需要，这可比上面修改 <strong>es</strong> 的配置舒服多了。</p>
</li>
<li><p>修改 <strong>es-auditing</strong> 的配置。</p>
</li>
<li><pre><code class="shell">  [root@ks-k8s-master-0 ~]# kubectl edit outputs -n kubesphere-logging-system es-auditing 
output.logging.kubesphere.io/es-auditing edited
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"> </span><br><span class="line"> - 修改后 , 再次查看，发现资源定义的内容如下：</span><br><span class="line"></span><br><span class="line"> - ```shell</span><br><span class="line">[root@ks-k8s-master-0 ~]# kubectl get outputs -n kubesphere-logging-system es-auditing -o yaml</span><br><span class="line">   </span><br><span class="line">   apiVersion: logging.kubesphere.io/v1alpha2</span><br><span class="line">kind: Output</span><br><span class="line">   metadata:</span><br><span class="line">     annotations:</span><br><span class="line">       kubectl.kubernetes.io/last-applied-configuration: |</span><br><span class="line">         &#123;&quot;apiVersion&quot;:&quot;logging.kubesphere.io/v1alpha2&quot;,&quot;kind&quot;:&quot;Output&quot;,&quot;metadata&quot;:&#123;&quot;annotations&quot;:&#123;&#125;,&quot;labels&quot;:&#123;&quot;logging.kubesphere.io/component&quot;:&quot;auditing&quot;,&quot;logging.kubesphere.io/enabled&quot;:&quot;true&quot;&#125;,&quot;name&quot;:&quot;es-auditing&quot;,&quot;namespace&quot;:&quot;kubesphere-logging-system&quot;&#125;,&quot;spec&quot;:&#123;&quot;es&quot;:&#123;&quot;generateID&quot;:true,&quot;host&quot;:&quot;elasticsearch-logging-data.kubesphere-logging-system.svc&quot;,&quot;httpPassword&quot;:&#123;&quot;valueFrom&quot;:&#123;&quot;secretKeyRef&quot;:&#123;&quot;key&quot;:&quot;password&quot;,&quot;name&quot;:&quot;elasticsearch-credentials&quot;&#125;&#125;&#125;,&quot;httpUser&quot;:&#123;&quot;valueFrom&quot;:&#123;&quot;secretKeyRef&quot;:&#123;&quot;key&quot;:&quot;username&quot;,&quot;name&quot;:&quot;elasticsearch-credentials&quot;&#125;&#125;&#125;,&quot;logstashFormat&quot;:true,&quot;logstashPrefix&quot;:&quot;ks-logstash-auditing&quot;,&quot;port&quot;:9200,&quot;tls&quot;:&#123;&quot;verify&quot;:false&#125;&#125;,&quot;match&quot;:&quot;kube_auditing&quot;&#125;&#125;</span><br><span class="line">     creationTimestamp: &quot;2022-04-15T03:51:23Z&quot;</span><br><span class="line">     generation: 4</span><br><span class="line">     labels:</span><br><span class="line">       logging.kubesphere.io/component: auditing</span><br><span class="line">       logging.kubesphere.io/enabled: &quot;true&quot;</span><br><span class="line">     name: es-auditing</span><br><span class="line">     namespace: kubesphere-logging-system</span><br><span class="line">     resourceVersion: &quot;3183473&quot;</span><br><span class="line">     uid: 42e31e0d-d641-48c0-8423-165a505b8124</span><br><span class="line">   spec:</span><br><span class="line">     es:</span><br><span class="line">       generateID: true</span><br><span class="line">       host: 192.168.9.95</span><br><span class="line">       httpPassword:</span><br><span class="line">         valueFrom:</span><br><span class="line">           secretKeyRef:</span><br><span class="line">             key: password</span><br><span class="line">             name: elasticsearch-credentials</span><br><span class="line">       httpUser:</span><br><span class="line">         valueFrom:</span><br><span class="line">           secretKeyRef:</span><br><span class="line">             key: username</span><br><span class="line">             name: elasticsearch-credentials</span><br><span class="line">       logstashFormat: true</span><br><span class="line">       logstashPrefix: ks-logstash-auditing</span><br><span class="line">       port: 9200</span><br><span class="line">       tls:</span><br><span class="line">         verify: false</span><br><span class="line">     match: kube_auditing</span><br></pre></td></tr></table></figure>
</code></pre>
</li>
<li><p>接下来修改 <strong>es-events</strong> 的配置，先看看 <strong>es-events</strong> 的现状。</p>
</li>
<li><p>&#96;&#96;&#96;shell<br>  [root@ks-k8s-master-0 ~]#  kubectl get outputs -n kubesphere-logging-system es-events -o yaml</p>
<p>apiVersion: logging.kubesphere.io&#x2F;v1alpha2</p>
</li>
</ul>
<p>  kind: Output<br>     metadata:<br>       annotations:<br>         kubectl.kubernetes.io&#x2F;last-applied-configuration: |<br>           {“apiVersion”:”logging.kubesphere.io&#x2F;v1alpha2”,”kind”:”Output”,”metadata”:{“annotations”:{},”labels”:{“logging.kubesphere.io&#x2F;component”:”events”,”logging.kubesphere.io&#x2F;enabled”:”true”},”name”:”es-events”,”namespace”:”kubesphere-logging-system”},”spec”:{“es”:{“generateID”:true,”host”:”elasticsearch-logging-data.kubesphere-logging-system.svc”,”httpPassword”:{“valueFrom”:{“secretKeyRef”:{“key”:”password”,”name”:”elasticsearch-credentials”}}},”httpUser”:{“valueFrom”:{“secretKeyRef”:{“key”:”username”,”name”:”elasticsearch-credentials”}}},”logstashFormat”:true,”logstashPrefix”:”ks-logstash-events”,”port”:9200,”tls”:{“verify”:false}},”match”:”kube_events”}}<br>       creationTimestamp: “2022-04-15T03:51:42Z”<br>       generation: 3<br>       labels:<br>         logging.kubesphere.io&#x2F;component: events<br>         logging.kubesphere.io&#x2F;enabled: “true”<br>       name: es-events<br>       namespace: kubesphere-logging-system<br>       resourceVersion: “1537778”<br>       uid: 02127aef-c69f-4578-b92a-8ecf73685240<br>     spec:<br>       es:<br>         generateID: true<br>         host: elasticsearch-logging-data.kubesphere-logging-system.svc<br>         httpPassword:<br>           valueFrom:<br>             secretKeyRef:<br>               key: password<br>               name: elasticsearch-credentials<br>         httpUser:<br>           valueFrom:<br>             secretKeyRef:<br>               key: username<br>               name: elasticsearch-credentials<br>         logstashFormat: true<br>         logstashPrefix: ks-logstash-events<br>         port: 9200<br>         tls:<br>           verify: false<br>       match: kube_events<br>     <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> </span><br><span class="line"> - 分析上面的文件，发现一样只需要修改 **host** 地址就可以。</span><br><span class="line"></span><br><span class="line"> - 修改 **es-auditing** 的配置。</span><br><span class="line"></span><br><span class="line"> - ```shell</span><br><span class="line">[root@ks-k8s-master-0 ~]#  kubectl edit outputs -n kubesphere-logging-system es-events</span><br><span class="line">   output.logging.kubesphere.io/es-events edited</span><br></pre></td></tr></table></figure></p>
<ul>
<li><p>修改后 , 再次查看，发现资源定义的内容如下：</p>
</li>
<li><p>&#96;&#96;&#96;shell<br>  [root@ks-k8s-master-0 ~]#  kubectl get outputs -n kubesphere-logging-system es-events -o yaml</p>
<p>apiVersion: logging.kubesphere.io&#x2F;v1alpha2</p>
</li>
</ul>
<p>  kind: Output<br>     metadata:<br>       annotations:<br>         kubectl.kubernetes.io&#x2F;last-applied-configuration: |<br>           {“apiVersion”:”logging.kubesphere.io&#x2F;v1alpha2”,”kind”:”Output”,”metadata”:{“annotations”:{},”labels”:{“logging.kubesphere.io&#x2F;component”:”events”,”logging.kubesphere.io&#x2F;enabled”:”true”},”name”:”es-events”,”namespace”:”kubesphere-logging-system”},”spec”:{“es”:{“generateID”:true,”host”:”elasticsearch-logging-data.kubesphere-logging-system.svc”,”httpPassword”:{“valueFrom”:{“secretKeyRef”:{“key”:”password”,”name”:”elasticsearch-credentials”}}},”httpUser”:{“valueFrom”:{“secretKeyRef”:{“key”:”username”,”name”:”elasticsearch-credentials”}}},”logstashFormat”:true,”logstashPrefix”:”ks-logstash-events”,”port”:9200,”tls”:{“verify”:false}},”match”:”kube_events”}}<br>       creationTimestamp: “2022-04-15T03:51:42Z”<br>       generation: 4<br>       labels:<br>         logging.kubesphere.io&#x2F;component: events<br>         logging.kubesphere.io&#x2F;enabled: “true”<br>       name: es-events<br>       namespace: kubesphere-logging-system<br>       resourceVersion: “3184391”<br>       uid: 02127aef-c69f-4578-b92a-8ecf73685240<br>     spec:<br>       es:<br>         generateID: true<br>         host: 192.168.9.95<br>         httpPassword:<br>           valueFrom:<br>             secretKeyRef:<br>               key: password<br>               name: elasticsearch-credentials<br>         httpUser:<br>           valueFrom:<br>             secretKeyRef:<br>               key: username<br>               name: elasticsearch-credentials<br>         logstashFormat: true<br>         logstashPrefix: ks-logstash-events<br>         port: 9200<br>         tls:<br>           verify: false<br>       match: kube_events<br>     <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br></pre></td><td class="code"><pre><span class="line"> </span><br><span class="line"> - 我们再次重建 Fluent-bit，看看是否有奇迹。</span><br><span class="line"></span><br><span class="line"> - 其中一个 pod 重启后的日志如下。</span><br><span class="line"></span><br><span class="line"> - ```yaml</span><br><span class="line">容器日志</span><br><span class="line">   </span><br><span class="line">    level=info msg=&quot;Fluent bit started&quot;</span><br><span class="line"></span><br><span class="line">    Fluent Bit v1.8.3</span><br><span class="line"></span><br><span class="line">    * Copyright (C) 2019-2021 The Fluent Bit Authors</span><br><span class="line"></span><br><span class="line">    * Copyright (C) 2015-2018 Treasure Data</span><br><span class="line"></span><br><span class="line">    * Fluent Bit is a CNCF sub-project under the umbrella of Fluentd</span><br><span class="line"></span><br><span class="line">    * https://fluentbit.io</span><br><span class="line"></span><br><span class="line">    [2022/04/21 08:02:30] [ info] [engine] started (pid=16)</span><br><span class="line"></span><br><span class="line">    [2022/04/21 08:02:30] [ info] [storage] version=1.1.1, initializing...</span><br><span class="line"></span><br><span class="line">    [2022/04/21 08:02:30] [ info] [storage] in-memory</span><br><span class="line"></span><br><span class="line">    [2022/04/21 08:02:30] [ info] [storage] normal synchronization mode, checksum disabled, max_chunks_up=128</span><br><span class="line"></span><br><span class="line">    [2022/04/21 08:02:30] [ info] [cmetrics] version=0.1.6</span><br><span class="line"></span><br><span class="line">    [2022/04/21 08:02:30] [ info] [filter:kubernetes:kubernetes.4] https=1 host=kubernetes.default.svc port=443</span><br><span class="line"></span><br><span class="line">    [2022/04/21 08:02:30] [ info] [filter:kubernetes:kubernetes.4] local POD info OK</span><br><span class="line"></span><br><span class="line">    [2022/04/21 08:02:30] [ info] [filter:kubernetes:kubernetes.4] testing connectivity with API server...</span><br><span class="line"></span><br><span class="line">    [2022/04/21 08:02:30] [ info] [filter:kubernetes:kubernetes.4] connectivity OK</span><br><span class="line"></span><br><span class="line">    [2022/04/21 08:02:30] [ info] [sp] stream processor started</span><br><span class="line"></span><br><span class="line">    [2022/04/21 08:02:30] [ info] [input:tail:tail.2] inotify_fs_add(): inode=416649 watch_fd=1 name=/var/log/containers/alertmanager-main-2_kubesphere-monitoring-system_alertmanager-1a71f1d5b1136320644f3289e4b22544620db4a0d35a1ffec52bc534d729c358.log</span><br><span class="line"></span><br><span class="line">    [2022/04/21 08:02:30] [ info] [input:tail:tail.2] inotify_fs_add(): inode=461549 watch_fd=2 name=/var/log/containers/alertmanager-main-2_kubesphere-monitoring-system_config-reloader-bc14c53008f1e800d6240a5b912239a3d5682c6dcb719f48c69b7e8ba5892e35.log</span><br><span class="line"></span><br><span class="line">    [2022/04/21 08:02:30] [ info] [input:tail:tail.2] inotify_fs_add(): inode=134582558 watch_fd=3 name=/var/log/containers/calico-kube-controllers-75ddb95444-8xvf4_kube-system_calico-kube-controllers-dc90044aa0ce62e61dfb0842c8f2e5aa8d021738adffca847b003a5c9621512c.log</span><br><span class="line"></span><br><span class="line">    [2022/04/21 08:02:30] [ info] [input:tail:tail.2] inotify_fs_add(): inode=268955529 watch_fd=4 name=/var/log/containers/calico-node-pzvrj_kube-system_flexvol-driver-abf59d8a7af22c683dfb0776a0835c719f41ef23446e912f82901a4fd9cf166f.log</span><br><span class="line"></span><br><span class="line">    [2022/04/21 08:02:30] [ info] [input:tail:tail.2] inotify_fs_add(): inode=373423 watch_fd=5 name=/var/log/containers/calico-node-pzvrj_kube-system_install-cni-b3d49f2e9c03e63c3863d50365d2ade01dead979c90285c526ac0029b58411cd.log</span><br><span class="line"></span><br><span class="line">    [2022/04/21 08:02:30] [ info] [input:tail:tail.2] inotify_fs_add(): inode=373208 watch_fd=6 name=/var/log/containers/calico-node-pzvrj_kube-system_upgrade-ipam-6d4425d7ea5302511df1c278f2b113ac8fdfa0a372e07b025e0a9b45d30129ac.log</span><br><span class="line"></span><br><span class="line">    [2022/04/21 08:02:30] [ info] [input:tail:tail.2] inotify_fs_add(): inode=403716654 watch_fd=7 name=/var/log/containers/coredns-5495dd7c88-68k9b_kube-system_coredns-879c087a4c8717d0886e6603a63e9503a406d215cfe77941cbcc1cc7c138d010.log</span><br><span class="line"></span><br><span class="line">    [2022/04/21 08:02:30] [ info] [input:tail:tail.2] inotify_fs_add(): inode=134583208 watch_fd=8 name=/var/log/containers/coredns-5495dd7c88-z9q6j_kube-system_coredns-80cd4427410de02465b415683817a75674a95777ffc0929f93e87506b120ca59.log</span><br><span class="line"></span><br><span class="line">    [2022/04/21 08:02:30] [ info] [input:tail:tail.2] inotify_fs_add(): inode=466327 watch_fd=9 name=/var/log/containers/ks-apiserver-574966976-snfm4_kubesphere-system_ks-apiserver-8871a0cc18cfef4663a15680761e272efeafe061ea9a898319265a145b494b18.log</span><br><span class="line"></span><br><span class="line">    [2022/04/21 08:02:30] [ info] [input:tail:tail.2] inotify_fs_add(): inode=269010417 watch_fd=10 name=/var/log/containers/ks-console-65f4d44d88-hzw9b_kubesphere-system_ks-console-f600455c3af064c53adc8eb7e5412505c4d0e50362ab11b8e59d2e71b552b0f1.log</span><br><span class="line"></span><br><span class="line">    [2022/04/21 08:02:30] [ info] [input:tail:tail.2] inotify_fs_add(): inode=269514179 watch_fd=11 name=/var/log/containers/ks-controller-manager-79c7dc79f5-j9fz5_kubesphere-system_ks-controller-manager-a8c35247c7cda868d3c023616026515690d2fedf2abb0f9367d1dc338103f7af.log</span><br><span class="line"></span><br><span class="line">    [2022/04/21 08:02:30] [ info] [input:tail:tail.2] inotify_fs_add(): inode=403995814 watch_fd=12 name=/var/log/containers/ks-events-ruler-575669b4-mh2fn_kubesphere-logging-system_config-reloader-2d51bab0babdd47864ec235efdbd69d2075cc8bf72c3642449be69f68aa1f0d5.log</span><br><span class="line"></span><br><span class="line">    [2022/04/21 08:02:30] [ info] [input:tail:tail.2] inotify_fs_add(): inode=962171 watch_fd=13 name=/var/log/containers/ks-events-ruler-575669b4-mh2fn_kubesphere-logging-system_events-ruler-da24092a12c4fc0d0aab8a02c7fc7cb1e0e82d15a924717222bdbadee7935c84.log</span><br><span class="line"></span><br><span class="line">    [2022/04/21 08:02:30] [ info] [input:tail:tail.2] inotify_fs_add(): inode=134580590 watch_fd=14 name=/var/log/containers/kube-apiserver-ks-k8s-master-0_kube-system_kube-apiserver-b4e97a525442956fe7612d27367a184ee09d65a56464149ec913ea004db0f1ef.log</span><br><span class="line"></span><br><span class="line">    [2022/04/21 08:02:30] [ info] [input:tail:tail.2] inotify_fs_add(): inode=134580575 watch_fd=15 name=/var/log/containers/kube-controller-manager-ks-k8s-master-0_kube-system_kube-controller-manager-a07d1c5ed4108d98de2ba322b47939d5007c9d266a4ff558d57ec87ab10b2d54.log</span><br><span class="line"></span><br><span class="line">    [2022/04/21 08:02:30] [ info] [input:tail:tail.2] inotify_fs_add(): inode=268955289 watch_fd=16 name=/var/log/containers/kube-proxy-bc59k_kube-system_kube-proxy-79144efa6b42a0f9636132538cc4ade6665269fea5903f3e1e0be05f14376d7c.log</span><br><span class="line"></span><br><span class="line">    [2022/04/21 08:02:30] [ info] [input:tail:tail.2] inotify_fs_add(): inode=403715964 watch_fd=17 name=/var/log/containers/kube-scheduler-ks-k8s-master-0_kube-system_kube-scheduler-1a2ffcf4000a9bb0fa526fcfa1970e69465dfe0bb4c635a4d95f50f2e27ef763.log</span><br><span class="line"></span><br><span class="line">    [2022/04/21 08:02:30] [ info] [input:tail:tail.2] inotify_fs_add(): inode=403855647 watch_fd=18 name=/var/log/containers/minio-859cb4d777-mpsk9_kubesphere-system_minio-d76f9516fa485cd24851afccfb2c85fd74ce894ba580af98703704860e1c00ed.log</span><br><span class="line"></span><br><span class="line">    [2022/04/21 08:02:30] [ info] [input:tail:tail.2] inotify_fs_add(): inode=413299 watch_fd=19 name=/var/log/containers/node-exporter-wwrpf_kubesphere-monitoring-system_kube-rbac-proxy-e35229db1e46e8b7b0a7d5a3cd581107102a3531b31d2e32d7e787a118c82896.log</span><br><span class="line"></span><br><span class="line">    [2022/04/21 08:02:30] [ info] [input:tail:tail.2] inotify_fs_add(): inode=375870 watch_fd=20 name=/var/log/containers/node-exporter-wwrpf_kubesphere-monitoring-system_node-exporter-e5cc5a4cc937cf9de149dd25bd6e8441ca176bf26cb2a214dd0b47627e7d8861.log</span><br><span class="line"></span><br><span class="line">    [2022/04/21 08:02:30] [ info] [input:tail:tail.2] inotify_fs_add(): inode=134581094 watch_fd=21 name=/var/log/containers/nodelocaldns-sp59h_kube-system_node-cache-8b5bdf5a116af255f979a4a349c168257b632d24805d5f257a642dd97b0d53a1.log</span><br><span class="line"></span><br><span class="line">    [2022/04/21 08:02:30] [ info] [input:tail:tail.2] inotify_fs_add(): inode=463110 watch_fd=22 name=/var/log/containers/prometheus-k8s-0_kubesphere-monitoring-system_config-reloader-1378a8d9cd7a96334cb15adeafb468497ece0a9a600a3193fb80b60bc5b7e9b5.log</span><br><span class="line"></span><br><span class="line">    [2022/04/21 08:02:30] [ info] [input:tail:tail.2] inotify_fs_add(): inode=135190584 watch_fd=23 name=/var/log/containers/prometheus-k8s-0_kubesphere-monitoring-system_prometheus-26e94cf0828cd1bd9c5da45217b7f3e654a7a41ce0dc5943375b1644d1a6a002.log</span><br><span class="line"></span><br><span class="line">    [2022/04/21 08:02:30] [ info] [input:tail:tail.2] inotify_fs_add(): inode=134738131 watch_fd=24 name=/var/log/containers/prometheus-k8s-0_kubesphere-monitoring-system_prometheus-97de8b484747bae4aeac54ffd9b75c1ddc9582a28c768ebc9be395390bd031c3.log</span><br><span class="line"></span><br><span class="line">    [2022/04/21 08:02:30] [ info] [input:tail:tail.2] inotify_fs_add(): inode=268956011 watch_fd=25 name=/var/log/containers/redis-ha-haproxy-868fdbddd4-kqrl5_kubesphere-system_config-init-0fb775710352218a66aec02ea2a736892c33df43dd4206e155e0bce6af4aba63.log</span><br><span class="line"></span><br><span class="line">    [2022/04/21 08:02:30] [ info] [input:tail:tail.2] inotify_fs_add(): inode=373969 watch_fd=26 name=/var/log/containers/redis-ha-haproxy-868fdbddd4-kqrl5_kubesphere-system_haproxy-6c15749c02904875f5c1a280a42a908baa074ccffd3365f40b2692b6fe60acf5.log</span><br><span class="line"></span><br><span class="line">    [2022/04/21 08:02:30] [ info] [input:tail:tail.2] inotify_fs_add(): inode=403792092 watch_fd=27 name=/var/log/containers/redis-ha-server-2_kubesphere-system_config-init-fa7c66040a53bef1c3c9b1844a4b25870835a6147cd83abf914ebb129a036536.log</span><br><span class="line"></span><br><span class="line">    [2022/04/21 08:02:30] [ info] [input:tail:tail.2] inotify_fs_add(): inode=412431 watch_fd=28 name=/var/log/containers/redis-ha-server-2_kubesphere-system_redis-6b19bb18f79c55cca6022bd8caa13a33d8c57386897db47fc011fd9fbe589b8a.log</span><br><span class="line"></span><br><span class="line">    [2022/04/21 08:02:30] [ info] [input:tail:tail.2] inotify_fs_add(): inode=134738124 watch_fd=29 name=/var/log/containers/redis-ha-server-2_kubesphere-system_sentinel-7b2cbde0a38f45b692dd1679912bb9ba4bdfc358667c32164592a0e7ab2a87a6.log</span><br><span class="line"></span><br><span class="line">    [2022/04/21 08:02:30] [ info] [input:tail:tail.2] inotify_fs_add(): inode=467559 watch_fd=30 name=/var/log/containers/thanos-ruler-kubesphere-1_kubesphere-monitoring-system_config-reloader-28aef566c79b3cc073a67787c6ad44902c88930f069ab26cf5657aa2d1235108.log</span><br><span class="line"></span><br><span class="line">    [2022/04/21 08:02:30] [ info] [input:tail:tail.2] inotify_fs_add(): inode=403860482 watch_fd=31 name=/var/log/containers/thanos-ruler-kubesphere-1_kubesphere-monitoring-system_thanos-ruler-24cfbc7280d54f3289c4ae70d0bb25a4964dd2f759e8bddefad3cf92070b1903.log</span><br><span class="line"></span><br><span class="line">    [2022/04/21 08:02:30] [ info] [input:tail:tail.2] inotify_fs_add(): inode=134583426 watch_fd=32 name=/var/log/containers/calico-node-pzvrj_kube-system_calico-node-f2f40fb9878e3328a4783ceb9c01eaed9edf24c85579ed87c7ffc2161779c3e2.log</span><br><span class="line"></span><br><span class="line">    [2022/04/21 08:02:30] [ info] [input:tail:tail.2] inotify_fs_add(): inode=984530 watch_fd=33 name=/var/log/containers/fluent-bit-97khn_kubesphere-logging-system_fluent-bit-9cb8370106aed1e55ca9b9304662301a3ab4cbe6f543616cb5d1eec39d6f7b25.log</span><br><span class="line"></span><br><span class="line">    [2022/04/21 08:02:34] [ warn] [engine] failed to flush chunk &#x27;16-1650528150.277308324.flb&#x27;, retry in 8 seconds: task_id=0, input=systemd.0 &gt; output=es.0 (out_id=0)</span><br><span class="line"></span><br><span class="line">    [2022/04/21 08:02:34] [ warn] [engine] failed to flush chunk &#x27;16-1650528150.357492295.flb&#x27;, retry in 9 seconds: task_id=2, input=tail.2 &gt; output=es.0 (out_id=0)</span><br><span class="line"></span><br><span class="line">    [2022/04/21 08:02:34] [ warn] [engine] failed to flush chunk &#x27;16-1650528150.296176788.flb&#x27;, retry in 6 seconds: task_id=1, input=systemd.1 &gt; output=es.0 (out_id=0)</span><br><span class="line"></span><br><span class="line">    [2022/04/21 08:02:34] [ warn] [engine] failed to flush chunk &#x27;16-1650528150.386272778.flb&#x27;, retry in 7 seconds: task_id=3, input=tail.2 &gt; output=es.0 (out_id=0)</span><br><span class="line"></span><br><span class="line">    [2022/04/21 08:02:39] [ warn] [engine] failed to flush chunk &#x27;16-1650528158.305010058.flb&#x27;, retry in 10 seconds: task_id=4, input=systemd.1 &gt; output=es.0 (out_id=0)</span><br><span class="line"></span><br><span class="line">    [2022/04/21 08:02:39] [ warn] [engine] failed to flush chunk &#x27;16-1650528154.329523292.flb&#x27;, retry in 6 seconds: task_id=5, input=tail.2 &gt; output=es.0 (out_id=0)</span><br><span class="line"></span><br><span class="line">    [2022/04/21 08:02:39] [ warn] [engine] failed to flush chunk &#x27;16-1650528154.753657988.flb&#x27;, retry in 9 seconds: task_id=6, input=tail.2 &gt; output=es.0 (out_id=0)</span><br><span class="line"></span><br><span class="line">    [2022/04/21 08:02:39] [ warn] [engine] failed to flush chunk &#x27;16-1650528155.347169912.flb&#x27;, retry in 7 seconds: task_id=7, input=tail.2 &gt; output=es.0 (out_id=0)</span><br><span class="line"></span><br><span class="line">    [2022/04/21 08:02:40] [ warn] [engine] chunk &#x27;16-1650528150.296176788.flb&#x27; cannot be retried: task_id=1, input=systemd.1 &gt; output=es.0</span><br><span class="line"></span><br><span class="line">    [2022/04/21 08:02:41] [ warn] [engine] chunk &#x27;16-1650528150.386272778.flb&#x27; cannot be retried: task_id=3, input=tail.2 &gt; output=es.0</span><br><span class="line"></span><br><span class="line">    [2022/04/21 08:02:42] [ warn] [engine] chunk &#x27;16-1650528150.277308324.flb&#x27; cannot be retried: task_id=0, input=systemd.0 &gt; output=es.0</span><br><span class="line"></span><br><span class="line">    [2022/04/21 08:02:43] [ warn] [engine] chunk &#x27;16-1650528150.357492295.flb&#x27; cannot be retried: task_id=2, input=tail.2 &gt; output=es.0</span><br><span class="line"></span><br><span class="line">    [2022/04/21 08:02:44] [ warn] [engine] failed to flush chunk &#x27;16-1650528159.328332342.flb&#x27;, retry in 7 seconds: task_id=0, input=tail.2 &gt; output=es.0 (out_id=0)</span><br><span class="line"></span><br><span class="line">    [2022/04/21 08:02:45] [ warn] [engine] chunk &#x27;16-1650528154.329523292.flb&#x27; cannot be retried: task_id=5, input=tail.2 &gt; output=es.0</span><br><span class="line"></span><br><span class="line">    [2022/04/21 08:02:46] [ warn] [engine] chunk &#x27;16-1650528155.347169912.flb&#x27; cannot be retried: task_id=7, input=tail.2 &gt; output=es.0</span><br><span class="line"></span><br><span class="line">    [2022/04/21 08:02:48] [ warn] [engine] chunk &#x27;16-1650528154.753657988.flb&#x27; cannot be retried: task_id=6, input=tail.2 &gt; output=es.0</span><br><span class="line"></span><br><span class="line">    [2022/04/21 08:02:49] [ warn] [engine] chunk &#x27;16-1650528158.305010058.flb&#x27; cannot be retried: task_id=4, input=systemd.1 &gt; output=es.0</span><br><span class="line"></span><br><span class="line">    [2022/04/21 08:02:49] [ warn] [engine] failed to flush chunk &#x27;16-1650528168.802004767.flb&#x27;, retry in 6 seconds: task_id=1, input=systemd.1 &gt; output=es.0 (out_id=0)</span><br><span class="line"></span><br><span class="line">    [2022/04/21 08:02:49] [ warn] [engine] failed to flush chunk &#x27;16-1650528164.324962334.flb&#x27;, retry in 6 seconds: task_id=2, input=tail.2 &gt; output=es.0 (out_id=0)</span><br><span class="line"></span><br><span class="line">    [2022/04/21 08:02:51] [ warn] [engine] chunk &#x27;16-1650528159.328332342.flb&#x27; cannot be retried: task_id=0, input=tail.2 &gt; output=es.0</span><br><span class="line"></span><br><span class="line">    [2022/04/21 08:02:54] [ warn] [engine] failed to flush chunk &#x27;16-1650528169.329511724.flb&#x27;, retry in 8 seconds: task_id=0, input=tail.2 &gt; output=es.0 (out_id=0)</span><br><span class="line"></span><br><span class="line">    [2022/04/21 08:02:55] [ warn] [engine] chunk &#x27;16-1650528168.802004767.flb&#x27; cannot be retried: task_id=1, input=systemd.1 &gt; output=es.0</span><br><span class="line"></span><br><span class="line">    [2022/04/21 08:02:55] [ warn] [engine] chunk &#x27;16-1650528164.324962334.flb&#x27; cannot be retried: task_id=2, input=tail.2 &gt; output=es.0</span><br><span class="line"></span><br><span class="line">    [2022/04/21 08:02:59] [ warn] [engine] failed to flush chunk &#x27;16-1650528179.232206869.flb&#x27;, retry in 8 seconds: task_id=1, input=systemd.1 &gt; output=es.0 (out_id=0)</span><br><span class="line"></span><br><span class="line">    [2022/04/21 08:02:59] [ warn] [engine] failed to flush chunk &#x27;16-1650528174.324611868.flb&#x27;, retry in 8 seconds: task_id=2, input=tail.2 &gt; output=es.0 (out_id=0)</span><br><span class="line"></span><br><span class="line">    [2022/04/21 08:02:59] [ warn] [engine] failed to flush chunk &#x27;16-1650528174.430818290.flb&#x27;, retry in 7 seconds: task_id=3, input=tail.2 &gt; output=es.0 (out_id=0)</span><br><span class="line"></span><br><span class="line">    [2022/04/21 08:03:02] [ warn] [engine] chunk &#x27;16-1650528169.329511724.flb&#x27; cannot be retried: task_id=0, input=tail.2 &gt; output=es.0</span><br><span class="line"></span><br><span class="line">    [2022/04/21 08:03:04] [ warn] [engine] failed to flush chunk &#x27;16-1650528179.322293412.flb&#x27;, retry in 7 seconds: task_id=0, input=tail.2 &gt; output=es.0 (out_id=0)</span><br><span class="line"></span><br></pre></td></tr></table></figure></p>
<ul>
<li><p>操作了一圈，又回到了原点，还是想办法开 Fluent-bit 的 Trace 日志吧，既然 Oupt 模板里没有对应参数，那么还是去底层解决吧。</p>
</li>
<li><p>首先我们要知道 KubeSphere 里部署的 Fluent-bit 采用了 <strong>fluent-operator</strong>，operator 里又专门定义了 Output 的类别的资源去对应 Fluent-bit 配置文件中的 output 章节。</p>
</li>
<li><p>那我们就去找到 fluent-operator 的官方网站，看看源码里<a target="_blank" rel="noopener" href="https://github.com/fluent/fluent-operator/blob/master/charts/fluent-operator/crds/fluentbit.fluent.io_clusteroutputs.yaml">crds 中对于 output 资源如何定义的</a>（这里面就涉及 operator 的知识了，这个技能请自己 get 吧，细节我目前也不懂，所以也讲不出来）</p>
</li>
<li><p>打开资源定义文件后，在里面搜索关键词 <strong>traceError</strong>，注意一定是在 <strong>es</strong> 章节里的。</p>
</li>
<li><p><img src="https://znotes-1258881081.cos.ap-beijing.myqcloud.com/k8s-on-kubesphere/image-20220422085824266.png" alt="image-20220422085824266"></p>
</li>
<li><p>有两个相关字段 <strong>traceError</strong> 和 <strong>traceOutput</strong>，这里看说明感觉 <strong>traceOutput</strong> 会更猛，但是前面有人说了开启 <strong>traceError</strong>，那咱就先试试 <strong>traceError</strong>，不行再来搞 <strong>traceOutput</strong>。</p>
</li>
<li><p>来吧，接着修改 es 的 output 文件 , 主要是在现有的配置文件中加入 <strong>traceError: true</strong>。</p>
</li>
<li><pre><code class="shell">  [root@ks-k8s-master-0 ~]# kubectl edit outputs -n kubesphere-logging-system es
output.logging.kubesphere.io/es edited
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line"> </span><br><span class="line"> - 再用 base64 解码 secrets，看看配置文件是否有变化，这次我们换个简单的方式**一把输出**。</span><br><span class="line"></span><br><span class="line">   &gt; 你是不是要怼我了，既然有这么优雅的方式，之前为啥不用，呵呵，之前我也不会，是在前面搜索解决办法时无意中 Get 到的，[出处在这](https://banzaicloud.com/docs/one-eye/logging-operator/operation/troubleshooting/fluentbit/))。</span><br><span class="line"></span><br><span class="line"> - ```shell</span><br><span class="line">[root@ks-k8s-master-0 ~]# kubectl get secret -n kubesphere-logging-system fluent-bit-config -o jsonpath=&quot;&#123;.data[&#x27;fluent-bit\.conf&#x27;]&#125;&quot; | base64 --decode</span><br><span class="line">   [Service]</span><br><span class="line">       Parsers_File    parsers.conf</span><br><span class="line">   [Input]</span><br><span class="line">       Name    systemd</span><br><span class="line">       Path    /var/log/journal</span><br><span class="line">       DB    /fluent-bit/tail/docker.db</span><br><span class="line">       DB.Sync    Normal</span><br><span class="line">       Tag    service.docker</span><br><span class="line">       Systemd_Filter    _SYSTEMD_UNIT=docker.service</span><br><span class="line">   [Input]</span><br><span class="line">       Name    systemd</span><br><span class="line">       Path    /var/log/journal</span><br><span class="line">       DB    /fluent-bit/tail/kubelet.db</span><br><span class="line">       DB.Sync    Normal</span><br><span class="line">       Tag    service.kubelet</span><br><span class="line">       Systemd_Filter    _SYSTEMD_UNIT=kubelet.service</span><br><span class="line">   [Input]</span><br><span class="line">       Name    tail</span><br><span class="line">       Path    /var/log/containers/*.log</span><br><span class="line">       Exclude_Path    /var/log/containers/*_kubesphere-logging-system_events-exporter*.log,/var/log/containers/kube-auditing-webhook*_kubesphere-logging-system_kube-auditing-webhook*.log</span><br><span class="line">       Refresh_Interval    10</span><br><span class="line">       Skip_Long_Lines    true</span><br><span class="line">       DB    /fluent-bit/tail/pos.db</span><br><span class="line">       DB.Sync    Normal</span><br><span class="line">       Mem_Buf_Limit    50MB</span><br><span class="line">       Parser    docker</span><br><span class="line">       Tag    kube.*</span><br><span class="line">   [Input]</span><br><span class="line">       Name    tail</span><br><span class="line">       Path    /var/log/containers/kube-auditing-webhook*_kubesphere-logging-system_kube-auditing-webhook*.log</span><br><span class="line">       Refresh_Interval    10</span><br><span class="line">       Skip_Long_Lines    true</span><br><span class="line">       DB    /fluent-bit/tail/pos-auditing.db</span><br><span class="line">       DB.Sync    Normal</span><br><span class="line">       Mem_Buf_Limit    50MB</span><br><span class="line">       Parser    docker</span><br><span class="line">       Tag    kube_auditing</span><br><span class="line">   [Input]</span><br><span class="line">       Name    tail</span><br><span class="line">       Path    /var/log/containers/*_kubesphere-logging-system_events-exporter*.log</span><br><span class="line">       Refresh_Interval    10</span><br><span class="line">       Skip_Long_Lines    true</span><br><span class="line">       DB    /fluent-bit/tail/pos-events.db</span><br><span class="line">       DB.Sync    Normal</span><br><span class="line">       Mem_Buf_Limit    50MB</span><br><span class="line">       Parser    docker</span><br><span class="line">       Tag    kube_events</span><br><span class="line">   [Filter]</span><br><span class="line">       Name    parser</span><br><span class="line">       Match    kube_auditing</span><br><span class="line">       Key_Name    log</span><br><span class="line">       Parser    json</span><br><span class="line">   [Filter]</span><br><span class="line">       Name    modify</span><br><span class="line">       Match    kube_auditing</span><br><span class="line">       Condition    Key_does_not_exist    AuditID    </span><br><span class="line">       Add    ignore    true</span><br><span class="line">   [Filter]</span><br><span class="line">       Name    grep</span><br><span class="line">       Match    kube_auditing</span><br><span class="line">       Exclude    ignore true</span><br><span class="line">   [Filter]</span><br><span class="line">       Name    parser</span><br><span class="line">       Match    kube_events</span><br><span class="line">       Key_Name    log</span><br><span class="line">       Parser    json</span><br><span class="line">   [Filter]</span><br><span class="line">       Name    kubernetes</span><br><span class="line">       Match    kube.*</span><br><span class="line">       Kube_URL    https://kubernetes.default.svc:443</span><br><span class="line">       Kube_CA_File    /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span><br><span class="line">       Kube_Token_File    /var/run/secrets/kubernetes.io/serviceaccount/token</span><br><span class="line">       Labels    false</span><br><span class="line">       Annotations    false</span><br><span class="line">   [Filter]</span><br><span class="line">       Name    nest</span><br><span class="line">       Match    kube.*</span><br><span class="line">       Operation    lift</span><br><span class="line">       Nested_under    kubernetes</span><br><span class="line">       Add_prefix    kubernetes_</span><br><span class="line">   [Filter]</span><br><span class="line">       Name    modify</span><br><span class="line">       Match    kube.*</span><br><span class="line">       Remove    stream</span><br><span class="line">       Remove    kubernetes_pod_id</span><br><span class="line">       Remove    kubernetes_host</span><br><span class="line">       Remove    kubernetes_container_hash</span><br><span class="line">   [Filter]</span><br><span class="line">       Name    nest</span><br><span class="line">       Match    kube.*</span><br><span class="line">       Operation    nest</span><br><span class="line">       Wildcard    kubernetes_*</span><br><span class="line">       Nest_under    kubernetes</span><br><span class="line">       Remove_prefix    kubernetes_</span><br><span class="line">   [Filter]</span><br><span class="line">       Name    lua</span><br><span class="line">       Match    service.*</span><br><span class="line">       script    /fluent-bit/config/systemd.lua</span><br><span class="line">       call    add_time</span><br><span class="line">       time_as_table    true</span><br><span class="line">   [Output]</span><br><span class="line">       Name    es</span><br><span class="line">       Match_Regex    (?:kube|service)\.(.*)</span><br><span class="line">       Host    192.168.9.95</span><br><span class="line">       Port    9200</span><br><span class="line">       HTTP_User    lstack</span><br><span class="line">       HTTP_Passwd    P@88w0rd</span><br><span class="line">       Logstash_Format    true</span><br><span class="line">       Logstash_Prefix    ks-logstash-log</span><br><span class="line">       Time_Key    @timestamp</span><br><span class="line">       Generate_ID    true</span><br><span class="line">       Trace_Error    true</span><br><span class="line">       tls    On</span><br><span class="line">       tls.verify    false</span><br><span class="line">   [Output]</span><br><span class="line">       Name    es</span><br><span class="line">       Match    kube_auditing</span><br><span class="line">       Host    192.168.9.95</span><br><span class="line">       Port    9200</span><br><span class="line">       HTTP_User    lstack</span><br><span class="line">       HTTP_Passwd    P@88w0rd</span><br><span class="line">       Logstash_Format    true</span><br><span class="line">       Logstash_Prefix    ks-logstash-auditing</span><br><span class="line">       Generate_ID    true</span><br><span class="line">       Trace_Error    true</span><br><span class="line">       tls    On</span><br><span class="line">       tls.verify    false</span><br><span class="line">   [Output]</span><br><span class="line">       Name    es</span><br><span class="line">       Match    kube_events</span><br><span class="line">       Host    192.168.9.95</span><br><span class="line">       Port    9200</span><br><span class="line">       HTTP_User    lstack</span><br><span class="line">       HTTP_Passwd    P@88w0rd</span><br><span class="line">       Logstash_Format    true</span><br><span class="line">       Logstash_Prefix    ks-logstash-events</span><br><span class="line">       Generate_ID    true</span><br><span class="line">       Trace_Error    true</span><br><span class="line">       tls    On</span><br><span class="line">       tls.verify    false</span><br></pre></td></tr></table></figure>
</code></pre>
</li>
<li><p>可以看到配置文件里已经存在了 <strong>Trace_Error    true</strong>，但是是否有效果、有变化呢？我们需要重建 <strong>Fluent-bit</strong> 的守护进程来看看。</p>
</li>
<li><p>登录控制台，<strong>集群管理</strong>-&gt;<strong>应用负载</strong>-&gt;<strong>工作负载</strong>-&gt;<strong>守护进程集</strong>，找到 <strong>fluent-bit</strong>，点击<strong>重新创建</strong>。</p>
</li>
<li><p><img src="https://znotes-1258881081.cos.ap-beijing.myqcloud.com/k8s-on-kubesphere/kubesphere-daemonsets-flunet-bit-2.png" alt="kubesphere-daemonsets-flunet-bit-2"></p>
</li>
<li><p>然后点击 <strong>fluent-bit</strong>，进入详情页面，可以看到有一个 pod 重建了（至于为什么其他的没变，咱先不说）。</p>
</li>
<li><p><img src="https://znotes-1258881081.cos.ap-beijing.myqcloud.com/k8s-on-kubesphere/kubesphere-daemonsets-flunet-bit-3.png" alt="kubesphere-daemonsets-flunet-bit-3"></p>
</li>
<li><p>进入新创建的 pod，咱看看日志输出有变化么！！！</p>
</li>
<li><p>&#96;&#96;&#96;yaml<br>   [2022&#x2F;04&#x2F;22 01:16:35] [ warn] [engine] failed to flush chunk ‘15-1650590190.748640950.flb’, retry in 6 seconds: task_id&#x3D;0, input&#x3D;systemd.0 &gt; output&#x3D;es.0 (out_id&#x3D;0)</p>
<p> [2022&#x2F;04&#x2F;22 01:16:35] [ warn] [engine] failed to flush chunk ‘15-1650590190.792218570.flb’, retry in 6 seconds: task_id&#x3D;1, input&#x3D;systemd.1 &gt; output&#x3D;es.0 (out_id&#x3D;0)</p>
<p> [2022&#x2F;04&#x2F;22 01:16:35] [ warn] [engine] failed to flush chunk ‘15-1650590191.359045217.flb’, retry in 7 seconds: task_id&#x3D;2, input&#x3D;systemd.1 &gt; output&#x3D;es.0 (out_id&#x3D;0)</p>
<p> [2022&#x2F;04&#x2F;22 01:16:35] [ warn] [engine] failed to flush chunk ‘15-1650590191.862711494.flb’, retry in 8 seconds: task_id&#x3D;3, input&#x3D;systemd.1 &gt; output&#x3D;es.0 (out_id&#x3D;0)</p>
<p> [2022&#x2F;04&#x2F;22 01:16:35] [ warn] [engine] failed to flush chunk ‘15-1650590192.369644921.flb’, retry in 11 seconds: task_id&#x3D;4, input&#x3D;systemd.1 &gt; output&#x3D;es.0 (out_id&#x3D;0)</p>
<p> [2022&#x2F;04&#x2F;22 01:16:35] [ warn] [engine] failed to flush chunk ‘15-1650590192.873445035.flb’, retry in 7 seconds: task_id&#x3D;5, input&#x3D;systemd.1 &gt; output&#x3D;es.0 (out_id&#x3D;0)</p>
<p> [2022&#x2F;04&#x2F;22 01:16:35] [ warn] [engine] failed to flush chunk ‘15-1650590193.381872747.flb’, retry in 8 seconds: task_id&#x3D;6, input&#x3D;systemd.1 &gt; output&#x3D;es.0 (out_id&#x3D;0)</p>
<p> [2022&#x2F;04&#x2F;22 01:16:35] [ warn] [engine] failed to flush chunk ‘15-1650590193.897774507.flb’, retry in 9 seconds: task_id&#x3D;7, input&#x3D;systemd.1 &gt; output&#x3D;es.0 (out_id&#x3D;0)</p>
<p> [2022&#x2F;04&#x2F;22 01:16:35] [ warn] [engine] failed to flush chunk ‘15-1650590190.874190363.flb’, retry in 11 seconds: task_id&#x3D;8, input&#x3D;tail.2 &gt; output&#x3D;es.0 (out_id&#x3D;0)</p>
<p> [2022&#x2F;04&#x2F;22 01:16:35] [ warn] [engine] failed to flush chunk ‘15-1650590190.980708345.flb’, retry in 8 seconds: task_id&#x3D;9, input&#x3D;tail.2 &gt; output&#x3D;es.0 (out_id&#x3D;0)</p>
<p> [2022&#x2F;04&#x2F;22 01:16:35] [ warn] [engine] failed to flush chunk ‘15-1650590194.547452615.flb’, retry in 9 seconds: task_id&#x3D;10, input&#x3D;tail.2 &gt; output&#x3D;es.0 (out_id&#x3D;0)</p>
<p> [2022&#x2F;04&#x2F;22 01:16:40] [ warn] [engine] failed to flush chunk ‘15-1650590195.289567444.flb’, retry in 11 seconds: task_id&#x3D;11, input&#x3D;systemd.1 &gt; output&#x3D;es.0 (out_id&#x3D;0)</p>
<p> [2022&#x2F;04&#x2F;22 01:16:40] [ warn] [engine] failed to flush chunk ‘15-1650590195.158774254.flb’, retry in 8 seconds: task_id&#x3D;12, input&#x3D;tail.2 &gt; output&#x3D;es.0 (out_id&#x3D;0)</p>
<p> [2022&#x2F;04&#x2F;22 01:16:41] [ warn] [engine] chunk ‘15-1650590190.748640950.flb’ cannot be retried: task_id&#x3D;0, input&#x3D;systemd.0 &gt; output&#x3D;es.0</p>
<p> [2022&#x2F;04&#x2F;22 01:16:41] [ warn] [engine] chunk ‘15-1650590190.792218570.flb’ cannot be retried: task_id&#x3D;1, input&#x3D;systemd.1 &gt; output&#x3D;es.0</p>
<p> [2022&#x2F;04&#x2F;22 01:16:42] [ warn] [engine] chunk ‘15-1650590191.359045217.flb’ cannot be retried: task_id&#x3D;2, input&#x3D;systemd.1 &gt; output&#x3D;es.0</p>
<p> [2022&#x2F;04&#x2F;22 01:16:42] [ warn] [engine] chunk ‘15-1650590192.873445035.flb’ cannot be retried: task_id&#x3D;5, input&#x3D;systemd.1 &gt; output&#x3D;es.0</p>
<p> [2022&#x2F;04&#x2F;22 01:16:43] [ warn] [engine] chunk ‘15-1650590191.862711494.flb’ cannot be retried: task_id&#x3D;3, input&#x3D;systemd.1 &gt; output&#x3D;es.0</p>
<p> [2022&#x2F;04&#x2F;22 01:16:43] [ warn] [engine] chunk ‘15-1650590193.381872747.flb’ cannot be retried: task_id&#x3D;6, input&#x3D;systemd.1 &gt; output&#x3D;es.0</p>
<p> [2022&#x2F;04&#x2F;22 01:16:43] [ warn] [engine] chunk ‘15-1650590190.980708345.flb’ cannot be retried: task_id&#x3D;9, input&#x3D;tail.2 &gt; output&#x3D;es.0</p>
<p> [2022&#x2F;04&#x2F;22 01:16:44] [ warn] [engine] chunk ‘15-1650590193.897774507.flb’ cannot be retried: task_id&#x3D;7, input&#x3D;systemd.1 &gt; output&#x3D;es.0</p>
<p> [2022&#x2F;04&#x2F;22 01:16:44] [ warn] [engine] chunk ‘15-1650590194.547452615.flb’ cannot be retried: task_id&#x3D;10, input&#x3D;tail.2 &gt; output&#x3D;es.0</p>
</li>
</ul>
  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">   </span><br><span class="line">   - 然而并没有什么 x 用，还是只有这些简单的输出，**说好的详细日志呢！！！**</span><br><span class="line"></span><br><span class="line">   - 既然 **traceError** 不行，那我们再去看看 **traceOutput**，细节不说了，总之配置完以后没啥变化。此时，我己经是**彻底崩溃**了，各种尝试都堵死了，到现在居然还没看到具体为啥。</span><br><span class="line"></span><br><span class="line">     &gt; **你们看文档这么点内容以为事情刚发生？？？实际上已经过去 3 天了！！！从这个事就能看出来，我其实很笨的）**</span><br><span class="line"></span><br><span class="line">   - 深度怀疑前面的两个参数，虽然配置上了，但是并没有生效，但是我有没有证据。暂时没有其他处理思路了。</span><br><span class="line"></span><br><span class="line">   - 放弃自查了，去各种群里问一圈，看看有没有现成的可以吃，然后我发现没朋友的可悲了，问了一圈居然没人搭理我，唉！！！</span><br><span class="line"></span><br><span class="line">5. 放弃后的第一次站起，继续搞起。</span><br><span class="line"></span><br><span class="line">   - 既然群里没找到答案，继续自力更生吧。</span><br><span class="line"></span><br><span class="line">   - 分析一波现状。</span><br><span class="line"></span><br><span class="line">   - Fluent-bit 日志报错关键词 **failed to flush chunk**，ElasticSearch 日志报错关键词 **java.lang.IllegalArgumentException: invalid version format** 和 **java.lang.IllegalArgumentException: text is empty**。</span><br><span class="line"></span><br><span class="line">   - ```yaml</span><br><span class="line">     [2022-04-22T09:57:10,374][DEBUG][r.suppressed             ] [es-node-0] path: /bad-request, params: &#123;&#125;</span><br><span class="line">     java.lang.IllegalArgumentException: invalid version format: C1®Þ\_¾L6Q&gt;À,À0©Ì¨ÌªÀ+À/$À(KÀ#À&#x27;GÀ</span><br><span class="line">             at io.netty.handler.codec.http.HttpVersion.&lt;init&gt;(HttpVersion.java:116) ~[netty-codec-http-4.1.66.Final.jar:4.1.66.Final]</span><br><span class="line">  </span><br><span class="line">     [2022-04-22T09:55:06,379][DEBUG][r.suppressed             ] [es-node-0] path: /bad-request, params: &#123;&#125;</span><br><span class="line">     java.lang.IllegalArgumentException: text is empty (possibly HTTP/0.9)</span><br><span class="line">             at io.netty.handler.codec.http.HttpVersion.valueOf(HttpVersion.java:65) ~[netty-codec-http-4.1.66.Final.jar:4.1.66.Final]</span><br></pre></td></tr></table></figure>

<ul>
<li><p>Fluent-bit 报错 <strong>failed to flush chunk</strong> 说明连接 elasticsearch 失败。</p>
</li>
<li><p>ElasticSearch 端的两个报错，说明 Fluent-bit 连接请求过来了，但是因为某种原因导致了 ElasticSearch 报错了。看报错应该是传递过来的数据不被 ElasticSearch 认可，也就是 <strong>invalid version format</strong> 和 <strong>text is empty</strong>。</p>
</li>
<li><p>我之前在两边开 <strong>Trace</strong>，也是为了找到 Fluent-bit 传递了啥，ElasticSeach 到底收了啥，但是两端都没有详细结果。</p>
</li>
<li><p>排查到现在我一直是在 es 采用 <strong>https</strong>协议并配置了认证的场景中测试的，我感觉这个问题可能出在 https 认证上，为了验证我的想法，我们将 es 改为 http 的协议，并取消认证。</p>
</li>
</ul>
<ol start="6">
<li><p>将 es 改为 http 协议，验证一下 KubeSphere 日志系统是否正常。</p>
<ul>
<li><p>将 kubesphere 的日志系统停用，删除 Fluent-bit 的相关配置项</p>
</li>
<li><p><strong>平台管理</strong>-&gt;<strong>集群管理</strong>-&gt;<strong>CRD</strong>, 搜索 <strong>ClusterConfiguration</strong>，编辑 <strong>ks-installer</strong>, 按下面的修改后，点击确定。</p>
</li>
<li><pre><code class="yaml">auditing:
  enabled: false

events:
  enabled: false

logging:
  containerruntime: docker
  enabled: false
  logsidecar:
    enabled: true
    replicas: 2
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- 打开工具箱中的 kubectl 工具，执行下面的命令观察执行过程，等待任务完成，细节不说了，上面都有。</span><br><span class="line"></span><br><span class="line">- ```shell</span><br><span class="line">  / # kubectl logs -n kubesphere-system $(kubectl get pod -n kubesphere-system -l app=ks-install -o jsonpath=&#x27;&#123;.items[0].metadata.name&#125;&#x27;) -f</span><br></pre></td></tr></table></figure>
</code></pre>
</li>
<li><p>执行完了，我们看看 KubeSphere 有啥变化，我预期的是跟这几个日志组件有关的服务配置都应该删除了才对。</p>
</li>
<li><p>但是，事与愿违，好像什么都没发生，之前的几个主角还在呢。至于为什么，暂时不要问我啊，我也不知道。。。</p>
</li>
<li><p><img src="https://znotes-1258881081.cos.ap-beijing.myqcloud.com/k8s-on-kubesphere/kubesphere-daemonsets-flunet-bit-4-0619543.png" alt="kubesphere-daemonsets-flunet-bit-4"></p>
</li>
<li><p><img src="https://znotes-1258881081.cos.ap-beijing.myqcloud.com/k8s-on-kubesphere/kubesphere-daemonsets-flunet-bit-5.png" alt="kubesphere-daemonsets-flunet-bit-5"></p>
</li>
<li><p><img src="https://znotes-1258881081.cos.ap-beijing.myqcloud.com/k8s-on-kubesphere/kubesphere-daemonsets-flunet-bit-6.png" alt="kubesphere-daemonsets-flunet-bit-6"></p>
</li>
<li><p><img src="https://znotes-1258881081.cos.ap-beijing.myqcloud.com/k8s-on-kubesphere/kubesphere-daemonsets-flunet-bit-7.png" alt="kubesphere-daemonsets-flunet-bit-7"></p>
</li>
<li><p><strong>工具箱</strong>中的容器日志查询也都在呢，只是报错不一样了，这个问题据说要重启 ks-apiserver 解决，暂时咱不管他。</p>
</li>
<li><p><img src="https://znotes-1258881081.cos.ap-beijing.myqcloud.com/k8s-on-kubesphere/kubesphere-daemonsets-flunet-bit-8.png" alt="kubesphere-daemonsets-flunet-bit-8"></p>
</li>
<li><p>没办法了，为了实验的准确性我只能强制赶你们走了，手动的把 Fluent-bit 的 operator 和守护进程集删掉，直接界面执行操作，比较简单，不截图了。</p>
</li>
<li><p>再把 <strong>CRD</strong> 中的 <strong>Output</strong> 和 <strong>Input</strong> 资源也删掉。</p>
</li>
<li><p><img src="https://znotes-1258881081.cos.ap-beijing.myqcloud.com/k8s-on-kubesphere/kubesphere-crd-delete-1.png" alt="kubesphere-crd-delete-1"></p>
</li>
<li><p><img src="https://znotes-1258881081.cos.ap-beijing.myqcloud.com/k8s-on-kubesphere/kubesphere-crd-delete-2.png" alt="kubesphere-crd-delete-2"></p>
</li>
<li><p><img src="https://znotes-1258881081.cos.ap-beijing.myqcloud.com/k8s-on-kubesphere/kubesphere-crd-delete-3.png" alt="kubesphere-crd-delete-3"></p>
</li>
<li><p><img src="https://znotes-1258881081.cos.ap-beijing.myqcloud.com/k8s-on-kubesphere/kubesphere-crd-delete-4.png" alt="kubesphere-crd-delete-4"></p>
</li>
<li><p>执行完上面的删除操作以后，我们会发现界面开始有了一些变化（也不排除是早期的操作延时导致的，先不深究了，可能以后也不会原因深究）。</p>
</li>
<li><p><img src="https://znotes-1258881081.cos.ap-beijing.myqcloud.com/k8s-on-kubesphere/kubesphere-crd-delete-5.png" alt="kubesphere-crd-delete-5"></p>
</li>
<li><p><img src="https://znotes-1258881081.cos.ap-beijing.myqcloud.com/k8s-on-kubesphere/kubesphere-crd-delete-6.png" alt="kubesphere-crd-delete-6"></p>
</li>
<li><p>其实，测试验证的环境不删也就不删了，改改配置也是可以的，只是突然强迫症犯了，必须干掉。</p>
</li>
<li><p>确认全部删除后，我们开始重装 ElasticSearch。</p>
</li>
<li><p>利用 ansible 重新配置 elasticsearch（仅限于测试验证环境，有数据的生产环境就不要瞎搞了）。</p>
</li>
<li><pre><code class="shell"># 利用 ansible 卸载旧的 elasticsearch 并删除数据
[root@zdevops-master ~]# cd /data/ansible/ansible-zdevops/inventories/dev
[root@zdevops-master dev]# source /opt/ansible2.8/bin/activate
(ansible2.8) [root@zdevops-master dev]# ansible es -m shell -a &#39;systemctl stop elasticsearch&#39;
(ansible2.8) [root@zdevops-master dev]# ansible es -m shell -a &#39;yum remove -y elasticsearch&#39;
(ansible2.8) [root@zdevops-master dev]# ansible es -m file -a &#39;path=/data/elasticsearch state=absent&#39;
(ansible2.8) [root@zdevops-master dev]# ansible es -m file -a &#39;path=/etc/elasticsearch state=absent&#39;

# 利用 ansible-playbook 安装 http 模式的 elasticsearch，注意-e 重新定义变量 elasticsearch_xpack_security_enabled 的值为 false

(ansible2.8) [root@zdevops-master dev]# ansible-playbook -e elasticsearch_xpack_security_enabled=false ../../playbooks/deploy-elasticsearch.yaml 
/opt/ansible2.8/lib/python2.7/site-packages/ansible/parsing/vault/__init__.py:44: CryptographyDeprecationWarning: Python 2 is no longer supported by the Python core team. Support for it is now deprecated in cryptography, and will be removed in the next release.
  from cryptography.exceptions import InvalidSignature

PLAY [安装配置 ElasticSearch.] ********************************************************************************

TASK [01-配置 yum 源-配置 elasticsearch 软件源 .] *********************************************************************
ok: [es-node-1]
ok: [es-node-0]
ok: [es-node-2]

TASK [02-安装 elasticsearch.] *******************************************************************************
changed: [es-node-2]
changed: [es-node-1]
changed: [es-node-0]

TASK [03-创建 elasticsearch 配置文件 .] ***************************************************************************
changed: [es-node-0]
changed: [es-node-2]
changed: [es-node-1]

TASK [04-创建 elasticsearch 数据文件目录 .] *************************************************************************
changed: [es-node-0]
changed: [es-node-2]
changed: [es-node-1]

PLAY [安装配置 ElasticSearch SSL 认证 .] **************************************************************************

TASK [01-生成 ElasticSearch Instance 文件用来配置 ssl 证书 .] ***********************************************************
skipping: [es-node-0]

TASK [02-生成证书 .] ******************************************************************************************
skipping: [es-node-0]

TASK [03-安装基本工具包 .] ***************************************************************************************
skipping: [es-node-0] =&gt; (item=[]) 

TASK [04-解压 cert 文件 .] **************************************************************************************
skipping: [es-node-0]

TASK [05-从服务器获取 cert 配置文件 .] ********************************************************************************
skipping: [es-node-0] =&gt; (item=es-node-0) 
skipping: [es-node-0] =&gt; (item=es-node-1) 
skipping: [es-node-0] =&gt; (item=es-node-2) 

PLAY [认证配置 .] *********************************************************************************************

TASK [01-创建 elasticsearch cert 目录 .] ************************************************************************
skipping: [es-node-0]
skipping: [es-node-1]
skipping: [es-node-2]

TASK [02-同步 cert 文件 .] **************************************************************************************
skipping: [es-node-0]
skipping: [es-node-1]
skipping: [es-node-2]

TASK [03-生成 keystore 文件 .] **********************************************************************************
skipping: [es-node-0]
skipping: [es-node-1]
skipping: [es-node-2]

TASK [04-添加配置项到 keystore 文件 .] ******************************************************************************
skipping: [es-node-0]
skipping: [es-node-1]
skipping: [es-node-2]

TASK [05-创建用户并指定 superuser 权限 .] ****************************************************************************
skipping: [es-node-0]
skipping: [es-node-1]
skipping: [es-node-2]

PLAY [终极配置 .] *********************************************************************************************

TASK [01-启动并设置开机自动启动 elasticsearch 服务 .] ********************************************************************
changed: [es-node-1]
changed: [es-node-2]
changed: [es-node-0]

PLAY RECAP ***********************************************************************************************
es-node-0                  : ok=5    changed=4    unreachable=0    failed=0    skipped=10   rescued=0    ignored=0   
es-node-1                  : ok=5    changed=4    unreachable=0    failed=0    skipped=5    rescued=0    ignored=0   
es-node-2                  : ok=5    changed=4    unreachable=0    failed=0    skipped=5    rescued=0    ignored=0   
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- 查看 ElasticSearch 集群初始分片信息。</span><br><span class="line"></span><br><span class="line">- ```shell</span><br><span class="line">  [root@glusterfs-node-0 ~]# curl  192.168.9.97:9200/_cat/indices?v</span><br><span class="line">  health status index            uuid                   pri rep docs.count docs.deleted store.size pri.store.size</span><br><span class="line">  green  open   .geoip_databases DUibpJGVR66YyMiMxiUYpw   1   1          8            0     14.1mb            7mb</span><br></pre></td></tr></table></figure>
</code></pre>
</li>
<li><p><strong>平台管理</strong>-&gt;<strong>集群管理</strong>-&gt;<strong>CRD</strong>, 搜索 <strong>ClusterConfiguration</strong>，编辑 <strong>ks-installer</strong>, 按下面的修改后，点击确定。</p>
</li>
<li><pre><code class="yaml">auditing:
  enabled: true
es:
  basicAuth:
    enabled: false
    password: &#39;&#39;
    username: &#39;&#39;
  elkPrefix: logstash
  externalElasticsearchHost: 192.168.9.95
  externalElasticsearchPort: 9200
  logMaxAge: 7
events:
  enabled: true

logging:
  containerruntime: docker
  enabled: true
  logsidecar:
    enabled: true
    replicas: 2
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- 打开工具箱中的 kubectl 工具，执行下面的命令观察执行过程，等待任务完成，细节不说了，上面都有。</span><br><span class="line"></span><br><span class="line">- ```shell</span><br><span class="line">  / # kubectl logs -n kubesphere-system $(kubectl get pod -n kubesphere-system -l app=ks-install -o jsonpath=&#x27;&#123;.items[0].metadata.name&#125;&#x27;) -f</span><br></pre></td></tr></table></figure>
</code></pre>
</li>
<li><p>执行完以后，正常的话我们之前操作的资源应该都回归了，<strong>Output</strong>、<strong>Input</strong>、<strong>Fluent-bit</strong>，<strong>工具箱里的工具</strong>不截图了自己看一下吧。</p>
</li>
<li><p>但是我们会发现 <strong>Fluent-bit</strong> 的 pod 中还有如下报错。</p>
</li>
<li><pre><code class="yaml">[2022/04/22 15:20:20] [ warn] [net] getaddrinfo(host=&#39;elasticsearch-logging-data.kubesphere-logging-system.svc&#39;, err=4): Domain name not found

[2022/04/22 15:20:20] [ warn] [net] getaddrinfo(host=&#39;elasticsearch-logging-data.kubesphere-logging-system.svc&#39;, err=4): Domain name not found
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- 看到这个知道怎么搞了吧？不知道？？？去上面翻翻。</span><br><span class="line"></span><br><span class="line">- 依次修改 **Output** 中的 **es**、**es-auditing**、**es-events**，改后如下：</span><br><span class="line"></span><br><span class="line">- ```yaml</span><br><span class="line">  apiVersion: logging.kubesphere.io/v1alpha2</span><br><span class="line">  kind: Output</span><br><span class="line">  metadata:</span><br><span class="line">    annotations:</span><br><span class="line">      kubectl.kubernetes.io/last-applied-configuration: &gt;</span><br><span class="line">        &#123;&quot;apiVersion&quot;:&quot;logging.kubesphere.io/v1alpha2&quot;,&quot;kind&quot;:&quot;Output&quot;,&quot;metadata&quot;:&#123;&quot;annotations&quot;:&#123;&#125;,&quot;labels&quot;:&#123;&quot;logging.kubesphere.io/component&quot;:&quot;logging&quot;,&quot;logging.kubesphere.io/enabled&quot;:&quot;true&quot;&#125;,&quot;name&quot;:&quot;es&quot;,&quot;namespace&quot;:&quot;kubesphere-logging-system&quot;&#125;,&quot;spec&quot;:&#123;&quot;es&quot;:&#123;&quot;generateID&quot;:true,&quot;host&quot;:&quot;elasticsearch-logging-data.kubesphere-logging-system.svc&quot;,&quot;logstashFormat&quot;:true,&quot;logstashPrefix&quot;:&quot;ks-logstash-log&quot;,&quot;port&quot;:9200,&quot;timeKey&quot;:&quot;@timestamp&quot;&#125;,&quot;matchRegex&quot;:&quot;(?:kube|service)\\.(.*)&quot;&#125;&#125;</span><br><span class="line">    labels:</span><br><span class="line">      logging.kubesphere.io/component: logging</span><br><span class="line">      logging.kubesphere.io/enabled: &#x27;true&#x27;</span><br><span class="line">    name: es</span><br><span class="line">    namespace: kubesphere-logging-system</span><br><span class="line">  spec:</span><br><span class="line">    es:</span><br><span class="line">      generateID: true</span><br><span class="line">      host: 192.168.9.95</span><br><span class="line">      logstashFormat: true</span><br><span class="line">      logstashPrefix: ks-logstash-log</span><br><span class="line">      port: 9200</span><br><span class="line">      timeKey: &#x27;@timestamp&#x27;</span><br><span class="line">    matchRegex: &#x27;(?:kube|service)\.(.*)&#x27;</span><br></pre></td></tr></table></figure>
</code></pre>
</li>
<li><pre><code class="yaml">apiVersion: logging.kubesphere.io/v1alpha2
kind: Output
metadata:
  annotations:
    kubectl.kubernetes.io/last-applied-configuration: &gt;
      &#123;&quot;apiVersion&quot;:&quot;logging.kubesphere.io/v1alpha2&quot;,&quot;kind&quot;:&quot;Output&quot;,&quot;metadata&quot;:&#123;&quot;annotations&quot;:&#123;&#125;,&quot;labels&quot;:&#123;&quot;logging.kubesphere.io/component&quot;:&quot;auditing&quot;,&quot;logging.kubesphere.io/enabled&quot;:&quot;true&quot;&#125;,&quot;name&quot;:&quot;es-auditing&quot;,&quot;namespace&quot;:&quot;kubesphere-logging-system&quot;&#125;,&quot;spec&quot;:&#123;&quot;es&quot;:&#123;&quot;generateID&quot;:true,&quot;host&quot;:&quot;elasticsearch-logging-data.kubesphere-logging-system.svc&quot;,&quot;logstashFormat&quot;:true,&quot;logstashPrefix&quot;:&quot;ks-logstash-auditing&quot;,&quot;port&quot;:9200&#125;,&quot;match&quot;:&quot;kube_auditing&quot;&#125;&#125;
  labels:
    logging.kubesphere.io/component: auditing
    logging.kubesphere.io/enabled: &#39;true&#39;
  name: es-auditing
  namespace: kubesphere-logging-system
spec:
  es:
    generateID: true
    host: 192.168.9.95
    logstashFormat: true
    logstashPrefix: ks-logstash-auditing
    port: 9200
  match: kube_auditing
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- ```yaml</span><br><span class="line">  apiVersion: logging.kubesphere.io/v1alpha2</span><br><span class="line">  kind: Output</span><br><span class="line">  metadata:</span><br><span class="line">    annotations:</span><br><span class="line">      kubectl.kubernetes.io/last-applied-configuration: &gt;</span><br><span class="line">        &#123;&quot;apiVersion&quot;:&quot;logging.kubesphere.io/v1alpha2&quot;,&quot;kind&quot;:&quot;Output&quot;,&quot;metadata&quot;:&#123;&quot;annotations&quot;:&#123;&#125;,&quot;labels&quot;:&#123;&quot;logging.kubesphere.io/component&quot;:&quot;events&quot;,&quot;logging.kubesphere.io/enabled&quot;:&quot;true&quot;&#125;,&quot;name&quot;:&quot;es-events&quot;,&quot;namespace&quot;:&quot;kubesphere-logging-system&quot;&#125;,&quot;spec&quot;:&#123;&quot;es&quot;:&#123;&quot;generateID&quot;:true,&quot;host&quot;:&quot;elasticsearch-logging-data.kubesphere-logging-system.svc&quot;,&quot;logstashFormat&quot;:true,&quot;logstashPrefix&quot;:&quot;ks-logstash-events&quot;,&quot;port&quot;:9200&#125;,&quot;match&quot;:&quot;kube_events&quot;&#125;&#125;</span><br><span class="line">    labels:</span><br><span class="line">      logging.kubesphere.io/component: events</span><br><span class="line">      logging.kubesphere.io/enabled: &#x27;true&#x27;</span><br><span class="line">    name: es-events</span><br><span class="line">    namespace: kubesphere-logging-system</span><br><span class="line">  spec:</span><br><span class="line">    es:</span><br><span class="line">      generateID: true</span><br><span class="line">      host: 192.168.9.95</span><br><span class="line">      logstashFormat: true</span><br><span class="line">      logstashPrefix: ks-logstash-events</span><br><span class="line">      port: 9200</span><br><span class="line">    match: kube_events</span><br></pre></td></tr></table></figure>
</code></pre>
</li>
<li><p>再去查看 Fluent-bit 容器的日志，你会发现 Fluent-bit 内部发现了配置文件的变化，并重启了 <strong>Fluent Bit</strong> 服务，且容器并没有重建。</p>
</li>
<li><pre><code class="yaml"> [2022/04/22 15:27:04] [engine] caught signal (SIGTERM)

 [2022/04/22 15:27:04] [ info] [input] pausing systemd.0

 [2022/04/22 15:27:04] [ info] [input] pausing systemd.1

 [2022/04/22 15:27:04] [ info] [input] pausing tail.2

 [2022/04/22 15:27:04] [ info] [input] pausing tail.3

 [2022/04/22 15:27:04] [ info] [input] pausing tail.4

 level=info msg=&quot;Config file changed, stopping Fluent Bit&quot;

 level=info msg=&quot;Killed Fluent Bit&quot;

 level=info msg=&quot;Config file changed, stopped Fluent Bit&quot;

 level=info msg=&quot;Config file changed, stopping Fluent Bit&quot;

 [2022/04/22 15:27:04] [ warn] [engine] service will stop in 5 seconds

 level=info msg=&quot;Killed Fluent Bit&quot;

 level=info msg=&quot;Config file changed, stopped Fluent Bit&quot;

 level=info msg=&quot;Config file changed, stopping Fluent Bit&quot;

 level=info msg=&quot;Killed Fluent Bit&quot;

 level=info msg=&quot;Config file changed, stopped Fluent Bit&quot;

 [2022/04/22 15:27:09] [ info] [engine] service stopped

 [2022/04/22 15:27:09] [ info] [input:tail:tail.2] inotify_fs_remove(): inode=416649 watch_fd=1

 [2022/04/22 15:27:09] [ info] [input:tail:tail.2] inotify_fs_remove(): inode=461549 watch_fd=2

 [2022/04/22 15:27:09] [ info] [input:tail:tail.2] inotify_fs_remove(): inode=134582558 watch_fd=3

 [2022/04/22 15:27:09] [ info] [input:tail:tail.2] inotify_fs_remove(): inode=134581715 watch_fd=4

 [2022/04/22 15:27:09] [ info] [input:tail:tail.2] inotify_fs_remove(): inode=268955529 watch_fd=5

 [2022/04/22 15:27:09] [ info] [input:tail:tail.2] inotify_fs_remove(): inode=373423 watch_fd=6

 [2022/04/22 15:27:09] [ info] [input:tail:tail.2] inotify_fs_remove(): inode=373208 watch_fd=7

 [2022/04/22 15:27:09] [ info] [input:tail:tail.2] inotify_fs_remove(): inode=403716654 watch_fd=8

 [2022/04/22 15:27:09] [ info] [input:tail:tail.2] inotify_fs_remove(): inode=134583208 watch_fd=9

 [2022/04/22 15:27:09] [ info] [input:tail:tail.2] inotify_fs_remove(): inode=134583458 watch_fd=10

 [2022/04/22 15:27:09] [ info] [input:tail:tail.2] inotify_fs_remove(): inode=269010417 watch_fd=11

 [2022/04/22 15:27:09] [ info] [input:tail:tail.2] inotify_fs_remove(): inode=269628719 watch_fd=12

 [2022/04/22 15:27:09] [ info] [input:tail:tail.2] inotify_fs_remove(): inode=403995814 watch_fd=13

 [2022/04/22 15:27:09] [ info] [input:tail:tail.2] inotify_fs_remove(): inode=962171 watch_fd=14

 [2022/04/22 15:27:09] [ info] [input:tail:tail.2] inotify_fs_remove(): inode=134583441 watch_fd=15

 [2022/04/22 15:27:09] [ info] [input:tail:tail.2] inotify_fs_remove(): inode=134580575 watch_fd=16

 [2022/04/22 15:27:09] [ info] [input:tail:tail.2] inotify_fs_remove(): inode=268955289 watch_fd=17

 [2022/04/22 15:27:09] [ info] [input:tail:tail.2] inotify_fs_remove(): inode=403715964 watch_fd=18

 [2022/04/22 15:27:09] [ info] [input:tail:tail.2] inotify_fs_remove(): inode=403855647 watch_fd=19

 [2022/04/22 15:27:09] [ info] [input:tail:tail.2] inotify_fs_remove(): inode=413299 watch_fd=20

 [2022/04/22 15:27:09] [ info] [input:tail:tail.2] inotify_fs_remove(): inode=375870 watch_fd=21

 [2022/04/22 15:27:09] [ info] [input:tail:tail.2] inotify_fs_remove(): inode=134581094 watch_fd=22

 [2022/04/22 15:27:09] [ info] [input:tail:tail.2] inotify_fs_remove(): inode=463110 watch_fd=23

 [2022/04/22 15:27:09] [ info] [input:tail:tail.2] inotify_fs_remove(): inode=135190584 watch_fd=24

 [2022/04/22 15:27:09] [ info] [input:tail:tail.2] inotify_fs_remove(): inode=134738131 watch_fd=25

 [2022/04/22 15:27:09] [ info] [input:tail:tail.2] inotify_fs_remove(): inode=268956011 watch_fd=26

 [2022/04/22 15:27:09] [ info] [input:tail:tail.2] inotify_fs_remove(): inode=373969 watch_fd=27

 [2022/04/22 15:27:09] [ info] [input:tail:tail.2] inotify_fs_remove(): inode=403792092 watch_fd=28

 [2022/04/22 15:27:09] [ info] [input:tail:tail.2] inotify_fs_remove(): inode=412431 watch_fd=29

 [2022/04/22 15:27:09] [ info] [input:tail:tail.2] inotify_fs_remove(): inode=134738124 watch_fd=30

 [2022/04/22 15:27:09] [ info] [input:tail:tail.2] inotify_fs_remove(): inode=467559 watch_fd=31

 [2022/04/22 15:27:09] [ info] [input:tail:tail.2] inotify_fs_remove(): inode=403860482 watch_fd=32

 [2022/04/22 15:27:09] [ info] [input:tail:tail.2] inotify_fs_remove(): inode=997586 watch_fd=33

 level=error msg=&quot;Fluent bit exited&quot; error=null

 level=info msg=backoff delay=1s

 level=info msg=&quot;backoff timer done&quot; actual=1.00029973s expected=1s

 level=info msg=&quot;Fluent bit started&quot;

 Fluent Bit v1.8.3

 * Copyright (C) 2019-2021 The Fluent Bit Authors

 * Copyright (C) 2015-2018 Treasure Data

 * Fluent Bit is a CNCF sub-project under the umbrella of Fluentd

 * https://fluentbit.io

 [2022/04/22 15:27:10] [ info] [engine] started (pid=30)

 [2022/04/22 15:27:10] [ info] [storage] version=1.1.1, initializing...

 [2022/04/22 15:27:10] [ info] [storage] in-memory

 [2022/04/22 15:27:10] [ info] [storage] normal synchronization mode, checksum disabled, max_chunks_up=128

 [2022/04/22 15:27:10] [ info] [cmetrics] version=0.1.6

 [2022/04/22 15:27:10] [ info] [input:systemd:systemd.0] seek_cursor=s=5d0022eeaf454ba8a40dde2836de2f4d;i=b56... OK

 [2022/04/22 15:27:10] [ info] [input:systemd:systemd.1] seek_cursor=s=5d0022eeaf454ba8a40dde2836de2f4d;i=b5b... OK

 [2022/04/22 15:27:10] [ info] [filter:kubernetes:kubernetes.4] https=1 host=kubernetes.default.svc port=443

 [2022/04/22 15:27:10] [ info] [filter:kubernetes:kubernetes.4] local POD info OK

 [2022/04/22 15:27:10] [ info] [filter:kubernetes:kubernetes.4] testing connectivity with API server...

 [2022/04/22 15:27:10] [ info] [filter:kubernetes:kubernetes.4] connectivity OK

 [2022/04/22 15:27:10] [ info] [sp] stream processor started

 [2022/04/22 15:27:10] [ info] [input:tail:tail.2] inotify_fs_add(): inode=416649 watch_fd=1 name=/var/log/containers/alertmanager-main-2_kubesphere-monitoring-system_alertmanager-1a71f1d5b1136320644f3289e4b22544620db4a0d35a1ffec52bc534d729c358.log

 [2022/04/22 15:27:10] [ info] [input:tail:tail.2] inotify_fs_add(): inode=461549 watch_fd=2 name=/var/log/containers/alertmanager-main-2_kubesphere-monitoring-system_config-reloader-bc14c53008f1e800d6240a5b912239a3d5682c6dcb719f48c69b7e8ba5892e35.log

 [2022/04/22 15:27:10] [ info] [input:tail:tail.2] inotify_fs_add(): inode=134582558 watch_fd=3 name=/var/log/containers/calico-kube-controllers-75ddb95444-8xvf4_kube-system_calico-kube-controllers-dc90044aa0ce62e61dfb0842c8f2e5aa8d021738adffca847b003a5c9621512c.log

 [2022/04/22 15:27:10] [ info] [input:tail:tail.2] inotify_fs_add(): inode=268955529 watch_fd=4 name=/var/log/containers/calico-node-pzvrj_kube-system_flexvol-driver-abf59d8a7af22c683dfb0776a0835c719f41ef23446e912f82901a4fd9cf166f.log

 [2022/04/22 15:27:10] [ info] [input:tail:tail.2] inotify_fs_add(): inode=373423 watch_fd=5 name=/var/log/containers/calico-node-pzvrj_kube-system_install-cni-b3d49f2e9c03e63c3863d50365d2ade01dead979c90285c526ac0029b58411cd.log

 [2022/04/22 15:27:10] [ info] [input:tail:tail.2] inotify_fs_add(): inode=373208 watch_fd=6 name=/var/log/containers/calico-node-pzvrj_kube-system_upgrade-ipam-6d4425d7ea5302511df1c278f2b113ac8fdfa0a372e07b025e0a9b45d30129ac.log

 [2022/04/22 15:27:10] [ info] [input:tail:tail.2] inotify_fs_add(): inode=403716654 watch_fd=7 name=/var/log/containers/coredns-5495dd7c88-68k9b_kube-system_coredns-879c087a4c8717d0886e6603a63e9503a406d215cfe77941cbcc1cc7c138d010.log

 [2022/04/22 15:27:10] [ info] [input:tail:tail.2] inotify_fs_add(): inode=134583208 watch_fd=8 name=/var/log/containers/coredns-5495dd7c88-z9q6j_kube-system_coredns-80cd4427410de02465b415683817a75674a95777ffc0929f93e87506b120ca59.log

 [2022/04/22 15:27:10] [ info] [input:tail:tail.2] inotify_fs_add(): inode=134583458 watch_fd=9 name=/var/log/containers/ks-apiserver-5c68568694-w8xs6_kubesphere-system_ks-apiserver-b76c824251f298a17d7594eea392602cea7291e1b3e35ae35cefb4607e6e4cdf.log

 [2022/04/22 15:27:10] [ info] [input:tail:tail.2] inotify_fs_add(): inode=269010417 watch_fd=10 name=/var/log/containers/ks-console-65f4d44d88-hzw9b_kubesphere-system_ks-console-f600455c3af064c53adc8eb7e5412505c4d0e50362ab11b8e59d2e71b552b0f1.log

 [2022/04/22 15:27:10] [ info] [input:tail:tail.2] inotify_fs_add(): inode=269628719 watch_fd=11 name=/var/log/containers/ks-controller-manager-bf6b9bfb5-xfts6_kubesphere-system_ks-controller-manager-9c24833ae6bce8c0ff956db38b40d9acf0224ec364c317ebcefc7802d4d97855.log

 [2022/04/22 15:27:10] [ info] [input:tail:tail.2] inotify_fs_add(): inode=403995814 watch_fd=12 name=/var/log/containers/ks-events-ruler-575669b4-mh2fn_kubesphere-logging-system_config-reloader-2d51bab0babdd47864ec235efdbd69d2075cc8bf72c3642449be69f68aa1f0d5.log

 [2022/04/22 15:27:10] [ info] [input:tail:tail.2] inotify_fs_add(): inode=962171 watch_fd=13 name=/var/log/containers/ks-events-ruler-575669b4-mh2fn_kubesphere-logging-system_events-ruler-da24092a12c4fc0d0aab8a02c7fc7cb1e0e82d15a924717222bdbadee7935c84.log

 [2022/04/22 15:27:10] [ info] [input:tail:tail.2] inotify_fs_add(): inode=134580575 watch_fd=14 name=/var/log/containers/kube-controller-manager-ks-k8s-master-0_kube-system_kube-controller-manager-a07d1c5ed4108d98de2ba322b47939d5007c9d266a4ff558d57ec87ab10b2d54.log

 [2022/04/22 15:27:10] [ info] [input:tail:tail.2] inotify_fs_add(): inode=268955289 watch_fd=15 name=/var/log/containers/kube-proxy-bc59k_kube-system_kube-proxy-79144efa6b42a0f9636132538cc4ade6665269fea5903f3e1e0be05f14376d7c.log

 [2022/04/22 15:27:10] [ info] [input:tail:tail.2] inotify_fs_add(): inode=403715964 watch_fd=16 name=/var/log/containers/kube-scheduler-ks-k8s-master-0_kube-system_kube-scheduler-1a2ffcf4000a9bb0fa526fcfa1970e69465dfe0bb4c635a4d95f50f2e27ef763.log

 [2022/04/22 15:27:10] [ info] [input:tail:tail.2] inotify_fs_add(): inode=403855647 watch_fd=17 name=/var/log/containers/minio-859cb4d777-mpsk9_kubesphere-system_minio-d76f9516fa485cd24851afccfb2c85fd74ce894ba580af98703704860e1c00ed.log

 [2022/04/22 15:27:10] [ info] [input:tail:tail.2] inotify_fs_add(): inode=413299 watch_fd=18 name=/var/log/containers/node-exporter-wwrpf_kubesphere-monitoring-system_kube-rbac-proxy-e35229db1e46e8b7b0a7d5a3cd581107102a3531b31d2e32d7e787a118c82896.log

 [2022/04/22 15:27:10] [ info] [input:tail:tail.2] inotify_fs_add(): inode=375870 watch_fd=19 name=/var/log/containers/node-exporter-wwrpf_kubesphere-monitoring-system_node-exporter-e5cc5a4cc937cf9de149dd25bd6e8441ca176bf26cb2a214dd0b47627e7d8861.log

 [2022/04/22 15:27:10] [ info] [input:tail:tail.2] inotify_fs_add(): inode=134581094 watch_fd=20 name=/var/log/containers/nodelocaldns-sp59h_kube-system_node-cache-8b5bdf5a116af255f979a4a349c168257b632d24805d5f257a642dd97b0d53a1.log

 [2022/04/22 15:27:10] [ info] [input:tail:tail.2] inotify_fs_add(): inode=463110 watch_fd=21 name=/var/log/containers/prometheus-k8s-0_kubesphere-monitoring-system_config-reloader-1378a8d9cd7a96334cb15adeafb468497ece0a9a600a3193fb80b60bc5b7e9b5.log

 [2022/04/22 15:27:10] [ info] [input:tail:tail.2] inotify_fs_add(): inode=135190584 watch_fd=22 name=/var/log/containers/prometheus-k8s-0_kubesphere-monitoring-system_prometheus-26e94cf0828cd1bd9c5da45217b7f3e654a7a41ce0dc5943375b1644d1a6a002.log

 [2022/04/22 15:27:10] [ info] [input:tail:tail.2] inotify_fs_add(): inode=134738131 watch_fd=23 name=/var/log/containers/prometheus-k8s-0_kubesphere-monitoring-system_prometheus-97de8b484747bae4aeac54ffd9b75c1ddc9582a28c768ebc9be395390bd031c3.log

 [2022/04/22 15:27:10] [ info] [input:tail:tail.2] inotify_fs_add(): inode=268956011 watch_fd=24 name=/var/log/containers/redis-ha-haproxy-868fdbddd4-kqrl5_kubesphere-system_config-init-0fb775710352218a66aec02ea2a736892c33df43dd4206e155e0bce6af4aba63.log

 [2022/04/22 15:27:10] [ info] [input:tail:tail.2] inotify_fs_add(): inode=373969 watch_fd=25 name=/var/log/containers/redis-ha-haproxy-868fdbddd4-kqrl5_kubesphere-system_haproxy-6c15749c02904875f5c1a280a42a908baa074ccffd3365f40b2692b6fe60acf5.log

 [2022/04/22 15:27:10] [ info] [input:tail:tail.2] inotify_fs_add(): inode=403792092 watch_fd=26 name=/var/log/containers/redis-ha-server-2_kubesphere-system_config-init-fa7c66040a53bef1c3c9b1844a4b25870835a6147cd83abf914ebb129a036536.log

 [2022/04/22 15:27:10] [ info] [input:tail:tail.2] inotify_fs_add(): inode=412431 watch_fd=27 name=/var/log/containers/redis-ha-server-2_kubesphere-system_redis-6b19bb18f79c55c

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- ![kubesphere-daemonsets-flunet-bit-9](https://znotes-1258881081.cos.ap-beijing.myqcloud.com/k8s-on-kubesphere/kubesphere-daemonsets-flunet-bit-9.png)</span><br><span class="line"></span><br><span class="line">- 分析日志发现，Fluent-bit 端没有错误信息了，再去 ElasticSearch 中查看索引。</span><br><span class="line"></span><br><span class="line">- **她来了她真的来了**, 真 xxx 不容易。</span><br><span class="line"></span><br><span class="line">- ```yaml</span><br><span class="line">  [root@glusterfs-node-0 ~]# curl  192.168.9.97:9200/_cat/indices?v</span><br><span class="line">  health status index                           uuid                   pri rep docs.count docs.deleted store.size pri.store.size</span><br><span class="line">  green  open   .geoip_databases                DUibpJGVR66YyMiMxiUYpw   1   1         40            0     75.8mb         37.9mb</span><br><span class="line">  green  open   ks-logstash-log-2022.04.22      sG7rEJ2OT-27Kv6k0kq-CQ   1   1        486            0        1mb        529.7kb</span><br><span class="line">  green  open   ks-logstash-auditing-2022.04.22 x52Q_uEZRZ-yNYXPRmyWLg   1   1          1            0     37.4kb         18.7kb</span><br><span class="line">  green  open   ks-logstash-events-2022.04.22   AafsMv0bRd-xz_Uj_HlOag   1   1         10            0    149.5kb         74.6kb</span><br></pre></td></tr></table></figure>
</code></pre>
</li>
<li><p>再回来看看我们 KubeSphere 工具箱中的几个分析工具是否正常了？</p>
</li>
<li><p><img src="https://znotes-1258881081.cos.ap-beijing.myqcloud.com/k8s-on-kubesphere/kubesphere-toolbox.png" alt="kubesphere-toolbox"></p>
</li>
<li><p><img src="https://znotes-1258881081.cos.ap-beijing.myqcloud.com/k8s-on-kubesphere/kubesphere-toolbox-analysis-tools-container.png" alt="kubesphere-toolbox-analysis-tools-container"></p>
</li>
<li><p><img src="https://znotes-1258881081.cos.ap-beijing.myqcloud.com/k8s-on-kubesphere/kubesphere-toolbox-analysis-tools-audit.png" alt="kubesphere-toolbox-analysis-tools-audit"></p>
</li>
<li><p><img src="https://znotes-1258881081.cos.ap-beijing.myqcloud.com/k8s-on-kubesphere/kubesphere-toolbox-analysis-tools-event.png" alt="kubesphere-toolbox-analysis-tools-event"></p>
</li>
<li><p>三个查询工具还是有异常弹窗，不慌！这个问题如何处理，我也是心中有数的。</p>
</li>
<li><p>这几天可不是白混的，论坛文档没少看，来打开 kubesphere 官方论坛，需要找到两篇文档结合来处理。</p>
</li>
<li><p>打开<a target="_blank" rel="noopener" href="https://kubesphere.com.cn/forum/d/2450-kuspheredial-tcp-lookup-http-on-109601053-no-such-host/4">在使用 kusphere 的操作审计功能时，总有弹窗提示：dial tcp: lookup http on 10.96.0.10:53: no such host</a>，找到修改配置文件的命令（其实吧你改界面也行）</p>
</li>
<li><p><img src="https://znotes-1258881081.cos.ap-beijing.myqcloud.com/k8s-on-kubesphere/image-20220422235234281.png" alt="image-20220422235234281"></p>
</li>
<li><p>先来看看文档中的配置现状</p>
</li>
<li><pre><code class="shell">[root@ks-k8s-master-0 ~]# kubectl get configmap kubesphere-config -n kubesphere-system -o yaml
apiVersion: v1
data:
  kubesphere.yaml: |
    authentication:
      authenticateRateLimiterMaxTries: 10
      authenticateRateLimiterDuration: 10m0s
      loginHistoryRetentionPeriod: 168h
      maximumClockSkew: 10s
      multipleLogin: True
      kubectlImage: kubesphere/kubectl:v1.21.0
      jwtSecret: &quot;1xh3ldfKpJSzSmFCbi2HXXbw5dn4o4kv&quot;
      oauthOptions:
        clients:
        - name: kubesphere
          secret: kubesphere
          redirectURIs:
          - &#39;*&#39;

    ldap:
      host: openldap.kubesphere-system.svc:389
      managerDN: cn=admin,dc=kubesphere,dc=io
      managerPassword: admin
      userSearchBase: ou=Users,dc=kubesphere,dc=io
      groupSearchBase: ou=Groups,dc=kubesphere,dc=io

    redis:
      host: redis.kubesphere-system.svc
      port: 6379
      password: KUBESPHERE_REDIS_PASSWORD
      db: 0

    s3:
      endpoint: http://minio.kubesphere-system.svc:9000
      region: us-east-1
      disableSSL: True
      forcePathStyle: True
      accessKeyID: openpitrixminioaccesskey
      secretAccessKey: openpitrixminiosecretkey
      bucket: s2i-binaries

    network:
      ippoolType: none
    devops:
      host: http://devops-jenkins.kubesphere-devops-system.svc/
      username: admin
      password: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJlbWFpbCI6ImFkbWluQGt1YmVzcGhlcmUuaW8iLCJ1c2VybmFtZSI6ImFkbWluIiwidG9rZW5fdHlwZSI6InN0YXRpY190b2tlbiJ9.DVnt9FY7UNu2Mvshh_46UMKhZG7_X7NPC-ClQ68ynB0
      maxConnections: 100
      endpoint: http://devops-apiserver.kubesphere-devops-system:9090
    openpitrix:
      s3:
        endpoint: http://minio.kubesphere-system.svc:9000
        region: us-east-1
        disableSSL: True
        forcePathStyle: True
        accessKeyID: openpitrixminioaccesskey
        secretAccessKey: openpitrixminiosecretkey
        bucket: app-store
    monitoring:
      endpoint: http://prometheus-operated.kubesphere-monitoring-system.svc:9090
      enableGPUMonitoring: false
    gpu:
      kinds:
      - resourceName: nvidia.com/gpu
        resourceType: GPU
        default: True
    notification:
      endpoint: http://notification-manager-svc.kubesphere-monitoring-system.svc:19093
    logging:
      host: http://elasticsearch-logging-data.kubesphere-logging-system.svc:9200
      indexPrefix: ks-logstash-log
    events:
      host: http://elasticsearch-logging-data.kubesphere-logging-system.svc:9200
      indexPrefix: ks-logstash-events
    auditing:
      enable: true
      webhookURL: https://kube-auditing-webhook-svc.kubesphere-logging-system.svc:6443/audit/webhook/event
      host: http://elasticsearch-logging-data.kubesphere-logging-system.svc:9200
      indexPrefix: ks-logstash-auditing

    alerting:
      prometheusEndpoint: http://prometheus-operated.kubesphere-monitoring-system.svc:9090
      thanosRulerEndpoint: http://thanos-ruler-operated.kubesphere-monitoring-system.svc:10902
      thanosRuleResourceLabels: thanosruler=thanos-ruler,role=thanos-alerting-rules

    gateway:
      watchesPath: /var/helm-charts/watches.yaml
      repository: kubesphere/nginx-ingress-controller
      tag: v0.48.1
      namespace: kubesphere-controls-system
kind: ConfigMap
metadata:
  annotations:
    kubectl.kubernetes.io/last-applied-configuration: |
      &#123;&quot;apiVersion&quot;:&quot;v1&quot;,&quot;data&quot;:&#123;&quot;kubesphere.yaml&quot;:&quot;authentication:\n  authenticateRateLimiterMaxTries: 10\n  authenticateRateLimiterDuration: 10m0s\n  loginHistoryRetentionPeriod: 168h\n  maximumClockSkew: 10s\n  multipleLogin: True\n  kubectlImage: kubesphere/kubectl:v1.21.0\n  jwtSecret: \&quot;1xh3ldfKpJSzSmFCbi2HXXbw5dn4o4kv\&quot;\n  oauthOptions:\n    clients:\n    - name: kubesphere\n      secret: kubesphere\n      redirectURIs:\n      - &#39;*&#39;\n\nldap:\n  host: openldap.kubesphere-system.svc:389\n  managerDN: cn=admin,dc=kubesphere,dc=io\n  managerPassword: admin\n  userSearchBase: ou=Users,dc=kubesphere,dc=io\n  groupSearchBase: ou=Groups,dc=kubesphere,dc=io\n\nredis:\n  host: redis.kubesphere-system.svc\n  port: 6379\n  password: KUBESPHERE_REDIS_PASSWORD\n  db: 0\n\n\ns3:\n  endpoint: http://minio.kubesphere-system.svc:9000\n  region: us-east-1\n  disableSSL: True\n  forcePathStyle: True\n  accessKeyID: openpitrixminioaccesskey\n  secretAccessKey: openpitrixminiosecretkey\n  bucket: s2i-binaries\n\nnetwork:\n  ippoolType: none\ndevops:\n  host: http://devops-jenkins.kubesphere-devops-system.svc/\n  username: admin\n  password: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJlbWFpbCI6ImFkbWluQGt1YmVzcGhlcmUuaW8iLCJ1c2VybmFtZSI6ImFkbWluIiwidG9rZW5fdHlwZSI6InN0YXRpY190b2tlbiJ9.DVnt9FY7UNu2Mvshh_46UMKhZG7_X7NPC-ClQ68ynB0\n  maxConnections: 100\n  endpoint: http://devops-apiserver.kubesphere-devops-system:9090\nopenpitrix:\n  s3:\n    endpoint: http://minio.kubesphere-system.svc:9000\n    region: us-east-1\n    disableSSL: True\n    forcePathStyle: True\n    accessKeyID: openpitrixminioaccesskey\n    secretAccessKey: openpitrixminiosecretkey\n    bucket: app-store\nmonitoring:\n  endpoint: http://prometheus-operated.kubesphere-monitoring-system.svc:9090\n  enableGPUMonitoring: false\ngpu:\n  kinds:\n  - resourceName: nvidia.com/gpu\n    resourceType: GPU\n    default: True\nnotification:\n  endpoint: http://notification-manager-svc.kubesphere-monitoring-system.svc:19093\nlogging:\n  host: http://elasticsearch-logging-data.kubesphere-logging-system.svc:9200\n  indexPrefix: ks-logstash-log\nevents:\n  host: http://elasticsearch-logging-data.kubesphere-logging-system.svc:9200\n  indexPrefix: ks-logstash-events\nauditing:\n  enable: true\n  webhookURL: https://kube-auditing-webhook-svc.kubesphere-logging-system.svc:6443/audit/webhook/event\n  host: http://elasticsearch-logging-data.kubesphere-logging-system.svc:9200\n  indexPrefix: ks-logstash-auditing\n\nalerting:\n  prometheusEndpoint: http://prometheus-operated.kubesphere-monitoring-system.svc:9090\n  thanosRulerEndpoint: http://thanos-ruler-operated.kubesphere-monitoring-system.svc:10902\n  thanosRuleResourceLabels: thanosruler=thanos-ruler,role=thanos-alerting-rules\n\n\ngateway:\n  watchesPath: /var/helm-charts/watches.yaml\n  repository: kubesphere/nginx-ingress-controller\n  tag: v0.48.1\n  namespace: kubesphere-controls-system\n&quot;&#125;,&quot;kind&quot;:&quot;ConfigMap&quot;,&quot;metadata&quot;:&#123;&quot;annotations&quot;:&#123;&#125;,&quot;name&quot;:&quot;kubesphere-config&quot;,&quot;namespace&quot;:&quot;kubesphere-system&quot;&#125;&#125;
  creationTimestamp: &quot;2022-04-09T14:42:47Z&quot;
  name: kubesphere-config
  namespace: kubesphere-system
  resourceVersion: &quot;3541275&quot;
  uid: 2d45c34b-bc9d-43bd-a3d3-37b294393531
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- 知道重点是啥了吧，把它 **http://elasticsearch-logging-data.kubesphere-logging-system.svc:9200** 全改成实际的 **ElasticSearch** 的地址</span><br><span class="line"></span><br><span class="line">- ```shell</span><br><span class="line">  [root@ks-k8s-master-0 ~]# kubectl edit configmap kubesphere-config -n kubesphere-system</span><br><span class="line">  configmap/kubesphere-config edited</span><br><span class="line">  </span><br><span class="line">  # 可以在编辑模式使用 %s/elasticsearch-logging-data.kubesphere-logging-system.svc/192.168.9.95/g 批量替换</span><br><span class="line">  </span><br><span class="line">  # 实际修改内容如下</span><br><span class="line">  logging:</span><br><span class="line">    host: http://192.168.9.95:9200</span><br><span class="line">    indexPrefix: ks-logstash-log</span><br><span class="line">  events:</span><br><span class="line">    host: http://192.168.9.95:9200</span><br><span class="line">    indexPrefix: ks-logstash-events</span><br><span class="line">  auditing:</span><br><span class="line">    enable: true</span><br><span class="line">    webhookURL: https://kube-auditing-webhook-svc.kubesphere-logging-system.svc:6443/audit/webhook/event</span><br><span class="line">    host: http://192.168.9.95:9200</span><br><span class="line">    indexPrefix: ks-logstash-auditing</span><br></pre></td></tr></table></figure>
</code></pre>
</li>
<li><p>改完以后我发现，好像没啥变化，报错依旧。不过此时我也是不慌的。</p>
</li>
<li><p>继续打开第二篇文档，<a target="_blank" rel="noopener" href="https://kubesphere.com.cn/forum/d/6614-es">使用外部 es 的问题</a>, 重点在图片上，红色字体的描述，这里提到了需要重启 ks-apiserver 才可以。</p>
</li>
<li><p><img src="https://znotes-1258881081.cos.ap-beijing.myqcloud.com/k8s-on-kubesphere/image-20220423001514866.png" alt="image-20220423001514866"></p>
</li>
<li><p>我们再看看 ks-apiserver 的配置，确定也挂载了 kubesphere-config。</p>
</li>
<li><p><img src="https://znotes-1258881081.cos.ap-beijing.myqcloud.com/k8s-on-kubesphere/kubesphere-ks-apiserver-2.png" alt="kubesphere-ks-apiserver-2"></p>
</li>
<li><p>我来重启一下 ks-apiserver 控制台，验证一下真伪。</p>
</li>
<li><p>控制台，<strong>集群管理</strong>-&gt;<strong>应用负载</strong>-&gt;<strong>工作负载</strong>-&gt;<strong>部署</strong>-&gt;<strong>ks-apiserver</strong>, 重启。</p>
</li>
<li><p><img src="https://znotes-1258881081.cos.ap-beijing.myqcloud.com/k8s-on-kubesphere/kubesphere-ks-apiserver-0.png" alt="kubesphere-ks-apiserver-0"></p>
</li>
<li><p><img src="https://znotes-1258881081.cos.ap-beijing.myqcloud.com/k8s-on-kubesphere/kubesphere-ks-apiserver-1.png" alt="kubesphere-ks-apiserver-1"></p>
</li>
<li><p>重启的时候，右上角会有报错，不用管它。全部重启完以后我们再看看工具箱中的几个日志分析工具。</p>
</li>
<li><p><img src="https://znotes-1258881081.cos.ap-beijing.myqcloud.com/k8s-on-kubesphere/kubesphere-toolbox-analysis-tools-containe-1.png" alt="kubesphere-toolbox-analysis-tools-containe-1"></p>
</li>
<li><p>输入一个关键词，查询一下看看具体效果，而且从搜索框中还可以看到 kubesphere 日志系统支持的查询粒度。</p>
</li>
<li><p><img src="https://znotes-1258881081.cos.ap-beijing.myqcloud.com/k8s-on-kubesphere/kubesphere-toolbox-analysis-tools-container-2.png" alt="kubesphere-toolbox-analysis-tools-container-2"></p>
</li>
<li><p>接下来在看看审计和事件功能。</p>
</li>
<li><p><img src="https://znotes-1258881081.cos.ap-beijing.myqcloud.com/k8s-on-kubesphere/kubesphere-toolbox-analysis-tools-event-1.png" alt="kubesphere-toolbox-analysis-tools-event-1"></p>
</li>
<li><p><img src="https://znotes-1258881081.cos.ap-beijing.myqcloud.com/k8s-on-kubesphere/kubesphere-toolbox-analysis-tools-audit-1.png" alt="kubesphere-toolbox-analysis-tools-audit-1"></p>
</li>
<li><p>至此，KubeSphere 日志系统对接外部基于 Http 协议的 ElasticSearch 集群算是彻底完成了，该有的都有了，至于后面的使用效果，那只能线上持续观测了。</p>
</li>
<li><p>但是你们以为这就完了，打完收工么，想啥呢，还有一个大坑没填呢，HTTPS 的 ElasticSearch 还没搞定呢，继续搞它。</p>
</li>
</ul>
</li>
<li><p>继续我们的 ElasticSearch 的 HTTPS 配置之旅。</p>
<ul>
<li><p>通过上面的过程我们应该可以断定，KubeSphere 部署的 fluent-bit 对接 http 协议的 ES 是没有任何问题的，那问题就是出在 https 协议上。我们换个思路，先跑掉 Kubesphere 不说，先去看看原生的 Fluent-bit 对接 https 协议的 es 有啥套路。</p>
</li>
<li><p>搜索关键词 <strong>fluent-bit https elasticsearch</strong>。</p>
</li>
<li><p>各种搜索引擎都尝试过，都是大同小异，无非就是关掉 tls 验证，有的文档还提到了加上 ca 的配置。并没有解决问题的思路和方案（<strong>此时我还没有醒悟</strong>，我一开始方向就错了，后面细说），也就懒得截图了。</p>
</li>
<li><p>上面的关键词不行，我又换了一个思路 <strong>fluent-bit x-pack elasticsearch</strong>，毕竟我们的安全验证是启用了 x-pack 插件。</p>
</li>
<li><p>哈哈哈哈，别说我还真找到一篇有意义并帮我最终解决问题的文档，那就是<a target="_blank" rel="noopener" href="https://vqiu.cn/efk-kube/">它</a></p>
</li>
<li><p><img src="https://znotes-1258881081.cos.ap-beijing.myqcloud.com/k8s-on-kubesphere/image-20220428110517048.png" alt="image-20220428110517048"></p>
</li>
<li><p>此文档介绍的都是在 k8s 安装 es，但是这个不重要，配置文件都是有参考意义的，看看他的配置文件：</p>
</li>
<li><p><img src="https://znotes-1258881081.cos.ap-beijing.myqcloud.com/k8s-on-kubesphere/image-20220428110847858.png" alt="image-20220428110847858"></p>
</li>
<li><p>看到这个配置文件，我突然灵光一闪，这个配置里没有 tls 什么事啊。此时，我才幡然醒悟，其实我要的并不是 https 并不是 tls，我要的其实就是个 <strong>http 协议加上用户名和密码验证</strong>，这才是我真正的需求。</p>
</li>
<li><p>我一开始就走错了路，被 <strong>ClusterConfiguration</strong> 中的这个参数 <strong>externalElasticsearchProtocol: https</strong> 给坑了，此时我已经忘记从哪里看到的文档需要配置这个参数了，我是一个不记仇的人，我就不找后账了。</p>
</li>
<li><p>思路有了，来我们验证一波。</p>
</li>
<li><p>先 <strong>ClusterConfiguration</strong>-&gt;<strong>ks-installer</strong>, 编辑 YAML。确保配置文件中 es 的配置如下，如果存在 <strong>externalElasticsearchProtocol: https</strong> 一定要干掉它。</p>
</li>
<li><pre><code class="yaml">es:
  basicAuth:
    enabled: false
    password: P@88w0rd
    username: lstack
  elkPrefix: logstash
  externalElasticsearchHost: 192.168.9.95
  externalElasticsearchPort: 9200
  logMaxAge: 7
</code></pre>
</li>
<li><p>修改完成后，点击<strong>确定</strong>，等待后台重新配置完成。</p>
</li>
<li><p>再去查看 <strong>Output</strong> 的几个配置文件，<strong>es</strong>、<strong>es-auditing</strong>、<strong>es-events</strong> 具体如下</p>
</li>
<li><pre><code class="yaml">apiVersion: logging.kubesphere.io/v1alpha2
kind: Output
metadata:
  annotations:
    kubectl.kubernetes.io/last-applied-configuration: &gt;
      &#123;&quot;apiVersion&quot;:&quot;logging.kubesphere.io/v1alpha2&quot;,&quot;kind&quot;:&quot;Output&quot;,&quot;metadata&quot;:&#123;&quot;annotations&quot;:&#123;&#125;,&quot;labels&quot;:&#123;&quot;logging.kubesphere.io/component&quot;:&quot;logging&quot;,&quot;logging.kubesphere.io/enabled&quot;:&quot;true&quot;&#125;,&quot;name&quot;:&quot;es&quot;,&quot;namespace&quot;:&quot;kubesphere-logging-system&quot;&#125;,&quot;spec&quot;:&#123;&quot;es&quot;:&#123;&quot;generateID&quot;:true,&quot;host&quot;:&quot;elasticsearch-logging-data.kubesphere-logging-system.svc&quot;,&quot;logstashFormat&quot;:true,&quot;logstashPrefix&quot;:&quot;ks-logstash-log&quot;,&quot;port&quot;:9200,&quot;timeKey&quot;:&quot;@timestamp&quot;&#125;,&quot;matchRegex&quot;:&quot;(?:kube|service)\\.(.*)&quot;&#125;&#125;
  labels:
    logging.kubesphere.io/component: logging
    logging.kubesphere.io/enabled: &#39;true&#39;
  name: es
  namespace: kubesphere-logging-system
spec:
  es:
    generateID: true
    host: 192.168.9.95
    httpPassword:
      valueFrom:
        secretKeyRef:
          key: password
          name: elasticsearch-credentials
    httpUser:
      valueFrom:
        secretKeyRef:
          key: username
          name: elasticsearch-credentials
    logstashFormat: true
    logstashPrefix: ks-logstash-log
    port: 9200
    timeKey: &#39;@timestamp&#39;
  matchRegex: &#39;(?:kube|service)\.(.*)&#39;

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- ```yaml</span><br><span class="line">  apiVersion: logging.kubesphere.io/v1alpha2</span><br><span class="line">  kind: Output</span><br><span class="line">  metadata:</span><br><span class="line">    annotations:</span><br><span class="line">      kubectl.kubernetes.io/last-applied-configuration: &gt;</span><br><span class="line">        &#123;&quot;apiVersion&quot;:&quot;logging.kubesphere.io/v1alpha2&quot;,&quot;kind&quot;:&quot;Output&quot;,&quot;metadata&quot;:&#123;&quot;annotations&quot;:&#123;&#125;,&quot;labels&quot;:&#123;&quot;logging.kubesphere.io/component&quot;:&quot;auditing&quot;,&quot;logging.kubesphere.io/enabled&quot;:&quot;true&quot;&#125;,&quot;name&quot;:&quot;es-auditing&quot;,&quot;namespace&quot;:&quot;kubesphere-logging-system&quot;&#125;,&quot;spec&quot;:&#123;&quot;es&quot;:&#123;&quot;generateID&quot;:true,&quot;host&quot;:&quot;elasticsearch-logging-data.kubesphere-logging-system.svc&quot;,&quot;logstashFormat&quot;:true,&quot;logstashPrefix&quot;:&quot;ks-logstash-auditing&quot;,&quot;port&quot;:9200,&quot;tls&quot;:&#123;&quot;verify&quot;:false&#125;&#125;,&quot;match&quot;:&quot;kube_auditing&quot;&#125;&#125;</span><br><span class="line">    labels:</span><br><span class="line">      logging.kubesphere.io/component: auditing</span><br><span class="line">      logging.kubesphere.io/enabled: &#x27;true&#x27;</span><br><span class="line">    name: es-auditing</span><br><span class="line">    namespace: kubesphere-logging-system</span><br><span class="line">  spec:</span><br><span class="line">    es:</span><br><span class="line">      generateID: true</span><br><span class="line">      host: 192.168.9.95</span><br><span class="line">      httpPassword:</span><br><span class="line">        valueFrom:</span><br><span class="line">          secretKeyRef:</span><br><span class="line">            key: password</span><br><span class="line">            name: elasticsearch-credentials</span><br><span class="line">      httpUser:</span><br><span class="line">        valueFrom:</span><br><span class="line">          secretKeyRef:</span><br><span class="line">            key: username</span><br><span class="line">            name: elasticsearch-credentials</span><br><span class="line">      logstashFormat: true</span><br><span class="line">      logstashPrefix: ks-logstash-log</span><br><span class="line">      port: 9200</span><br><span class="line">    match: kube_auditing</span><br></pre></td></tr></table></figure>
</code></pre>
</li>
<li><pre><code class="yaml">apiVersion: logging.kubesphere.io/v1alpha2
kind: Output
metadata:
  annotations:
    kubectl.kubernetes.io/last-applied-configuration: &gt;
      &#123;&quot;apiVersion&quot;:&quot;logging.kubesphere.io/v1alpha2&quot;,&quot;kind&quot;:&quot;Output&quot;,&quot;metadata&quot;:&#123;&quot;annotations&quot;:&#123;&#125;,&quot;labels&quot;:&#123;&quot;logging.kubesphere.io/component&quot;:&quot;events&quot;,&quot;logging.kubesphere.io/enabled&quot;:&quot;true&quot;&#125;,&quot;name&quot;:&quot;es-events&quot;,&quot;namespace&quot;:&quot;kubesphere-logging-system&quot;&#125;,&quot;spec&quot;:&#123;&quot;es&quot;:&#123;&quot;generateID&quot;:true,&quot;host&quot;:&quot;elasticsearch-logging-data.kubesphere-logging-system.svc&quot;,&quot;logstashFormat&quot;:true,&quot;logstashPrefix&quot;:&quot;ks-logstash-events&quot;,&quot;port&quot;:9200,&quot;tls&quot;:&#123;&quot;verify&quot;:false&#125;&#125;,&quot;match&quot;:&quot;kube_events&quot;&#125;&#125;
  labels:
    logging.kubesphere.io/component: events
    logging.kubesphere.io/enabled: &#39;true&#39;
  name: es-events
  namespace: kubesphere-logging-system
spec:
  es:
    generateID: true
    host: 192.168.9.95
    httpPassword:
      valueFrom:
        secretKeyRef:
          key: password
          name: elasticsearch-credentials
    httpUser:
      valueFrom:
        secretKeyRef:
          key: username
          name: elasticsearch-credentials
    logstashFormat: true
    logstashPrefix: ks-logstash-log
    port: 9200
  match: kube_events
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- Output 配置文件修改完成后，查看 fluent-bit 的容器 log，看看是否正常输出日志到 es 了，在日志输出里可以发现，修改配置文件之前，还是有大量的报错，修改配置文件后 fluent-bit 监测到配置文件发生变化，自动重启了服务，启动后，没有报错，说明日志可以正常输出 es。</span><br><span class="line"></span><br><span class="line">- ```shell</span><br><span class="line">  [root@ks-k8s-master-0 ~]# kubectl logs  fluent-bit-xq2jb -n kubesphere-logging-system</span><br><span class="line">  </span><br><span class="line">  [2022/04/28 02:58:19] [ warn] [engine] failed to flush chunk &#x27;39-1651114694.735704833.flb&#x27;, retry in 9 seconds: task_id=4, input=tail.2 &gt; output=es.0 (out_id=0)</span><br><span class="line">  </span><br><span class="line">   [2022/04/28 02:58:19] [ warn] [engine] failed to flush chunk &#x27;39-1651114695.509379382.flb&#x27;, retry in 10 seconds: task_id=5, input=tail.2 &gt; output=es.0 (out_id=0)</span><br><span class="line">  </span><br><span class="line">   [2022/04/28 02:58:20] [ warn] [engine] chunk &#x27;39-1651114693.743740772.flb&#x27; cannot be retried: task_id=2, input=tail.2 &gt; output=es.0</span><br><span class="line">  </span><br><span class="line">   level=info msg=&quot;Config file changed, stopping Fluent Bit&quot;</span><br><span class="line">  </span><br><span class="line">   level=info msg=&quot;Killed Fluent Bit&quot;</span><br><span class="line">  </span><br><span class="line">   level=info msg=&quot;Config file changed, stopped Fluent Bit&quot;</span><br><span class="line">  </span><br><span class="line">   level=info msg=&quot;Config file changed, stopping Fluent Bit&quot;</span><br><span class="line">  </span><br><span class="line">   level=info msg=&quot;Killed Fluent Bit&quot;</span><br><span class="line">  </span><br><span class="line">   level=info msg=&quot;Config file changed, stopped Fluent Bit&quot;</span><br><span class="line">  </span><br><span class="line">   [2022/04/28 02:58:20] [engine] caught signal (SIGTERM)</span><br><span class="line">  </span><br><span class="line">   [2022/04/28 02:58:20] [ info] [input] pausing systemd.0</span><br><span class="line">  </span><br><span class="line">   [2022/04/28 02:58:20] [ info] [input] pausing systemd.1</span><br><span class="line">  </span><br><span class="line">   [2022/04/28 02:58:20] [ info] [input] pausing tail.2</span><br><span class="line">  </span><br><span class="line">   [2022/04/28 02:58:20] [ info] [input] pausing tail.3</span><br><span class="line">  </span><br><span class="line">   [2022/04/28 02:58:20] [ info] [input] pausing tail.4</span><br><span class="line">  </span><br><span class="line">   [2022/04/28 02:58:20] [ warn] [engine] service will stop in 5 seconds</span><br><span class="line">  </span><br><span class="line">   [2022/04/28 02:58:20] [ warn] [engine] failed to flush chunk &#x27;39-1651114699.328367642.flb&#x27;, retry in 6 seconds: task_id=0, input=tail.2 &gt; output=es.0 (out_id=0)</span><br><span class="line">  </span><br><span class="line">   [2022/04/28 02:58:23] [ warn] [engine] chunk &#x27;39-1651114689.327129623.flb&#x27; cannot be retried: task_id=1, input=tail.2 &gt; output=es.0</span><br><span class="line">  </span><br><span class="line">   [2022/04/28 02:58:25] [ info] [engine] service stopped</span><br><span class="line">  </span><br><span class="line">   [2022/04/28 02:58:25] [ info] [input:tail:tail.2] inotify_fs_remove(): inode=416649 watch_fd=1</span><br><span class="line">  </span><br><span class="line">   [2022/04/28 02:58:25] [ info] [input:tail:tail.2] inotify_fs_remove(): inode=461549 watch_fd=2</span><br><span class="line">  </span><br><span class="line">   [2022/04/28 02:58:25] [ info] [input:tail:tail.2] inotify_fs_remove(): inode=134582558 watch_fd=3</span><br><span class="line">  </span><br><span class="line">   [2022/04/28 02:58:25] [ info] [input:tail:tail.2] inotify_fs_remove(): inode=134581715 watch_fd=4</span><br><span class="line">  </span><br><span class="line">   [2022/04/28 02:58:25] [ info] [input:tail:tail.2] inotify_fs_remove(): inode=268955529 watch_fd=5</span><br><span class="line">  </span><br><span class="line">   [2022/04/28 02:58:25] [ info] [input:tail:tail.2] inotify_fs_remove(): inode=373423 watch_fd=6</span><br><span class="line">  </span><br><span class="line">   [2022/04/28 02:58:25] [ info] [input:tail:tail.2] inotify_fs_remove(): inode=373208 watch_fd=7</span><br><span class="line">  </span><br><span class="line">   [2022/04/28 02:58:25] [ info] [input:tail:tail.2] inotify_fs_remove(): inode=403716654 watch_fd=8</span><br><span class="line">  </span><br><span class="line">   [2022/04/28 02:58:25] [ info] [input:tail:tail.2] inotify_fs_remove(): inode=134583208 watch_fd=9</span><br><span class="line">  </span><br><span class="line">   [2022/04/28 02:58:25] [ info] [input:tail:tail.2] inotify_fs_remove(): inode=997310 watch_fd=10</span><br><span class="line">  </span><br><span class="line">   [2022/04/28 02:58:25] [ info] [input:tail:tail.2] inotify_fs_remove(): inode=269010417 watch_fd=11</span><br><span class="line">  </span><br><span class="line">   [2022/04/28 02:58:25] [ info] [input:tail:tail.2] inotify_fs_remove(): inode=984532 watch_fd=12</span><br><span class="line">  </span><br><span class="line">   [2022/04/28 02:58:25] [ info] [input:tail:tail.2] inotify_fs_remove(): inode=403995814 watch_fd=13</span><br><span class="line">  </span><br><span class="line">   [2022/04/28 02:58:25] [ info] [input:tail:tail.2] inotify_fs_remove(): inode=962171 watch_fd=14</span><br><span class="line">  </span><br><span class="line">   [2022/04/28 02:58:25] [ info] [input:tail:tail.2] inotify_fs_remove(): inode=134583424 watch_fd=15</span><br><span class="line">  </span><br><span class="line">   [2022/04/28 02:58:25] [ info] [input:tail:tail.2] inotify_fs_remove(): inode=134580575 watch_fd=16</span><br><span class="line">  </span><br><span class="line">   [2022/04/28 02:58:25] [ info] [input:tail:tail.2] inotify_fs_remove(): inode=268955289 watch_fd=17</span><br><span class="line">  </span><br><span class="line">   [2022/04/28 02:58:25] [ info] [input:tail:tail.2] inotify_fs_remove(): inode=403715964 watch_fd=18</span><br><span class="line">  </span><br><span class="line">   [2022/04/28 02:58:25] [ info] [input:tail:tail.2] inotify_fs_remove(): inode=403855647 watch_fd=19</span><br><span class="line">  </span><br><span class="line">   [2022/04/28 02:58:25] [ info] [input:tail:tail.2] inotify_fs_remove(): inode=413299 watch_fd=20</span><br><span class="line">  </span><br><span class="line">   [2022/04/28 02:58:25] [ info] [input:tail:tail.2] inotify_fs_remove(): inode=375870 watch_fd=21</span><br><span class="line">  </span><br><span class="line">   [2022/04/28 02:58:25] [ info] [input:tail:tail.2] inotify_fs_remove(): inode=134581094 watch_fd=22</span><br><span class="line">  </span><br><span class="line">   [2022/04/28 02:58:25] [ info] [input:tail:tail.2] inotify_fs_remove(): inode=463110 watch_fd=23</span><br><span class="line">  </span><br><span class="line">   [2022/04/28 02:58:25] [ info] [input:tail:tail.2] inotify_fs_remove(): inode=135190584 watch_fd=24</span><br><span class="line">  </span><br><span class="line">   [2022/04/28 02:58:25] [ info] [input:tail:tail.2] inotify_fs_remove(): inode=134738131 watch_fd=25</span><br><span class="line">  </span><br><span class="line">   [2022/04/28 02:58:25] [ info] [input:tail:tail.2] inotify_fs_remove(): inode=268956011 watch_fd=26</span><br><span class="line">  </span><br><span class="line">   [2022/04/28 02:58:25] [ info] [input:tail:tail.2] inotify_fs_remove(): inode=373969 watch_fd=27</span><br><span class="line">  </span><br><span class="line">   [2022/04/28 02:58:25] [ info] [input:tail:tail.2] inotify_fs_remove(): inode=403792092 watch_fd=28</span><br><span class="line">  </span><br><span class="line">   [2022/04/28 02:58:25] [ info] [input:tail:tail.2] inotify_fs_remove(): inode=412431 watch_fd=29</span><br><span class="line">  </span><br><span class="line">   [2022/04/28 02:58:25] [ info] [input:tail:tail.2] inotify_fs_remove(): inode=134738124 watch_fd=30</span><br><span class="line">  </span><br><span class="line">   [2022/04/28 02:58:25] [ info] [input:tail:tail.2] inotify_fs_remove(): inode=467559 watch_fd=31</span><br><span class="line">  </span><br><span class="line">   [2022/04/28 02:58:25] [ info] [input:tail:tail.2] inotify_fs_remove(): inode=403860482 watch_fd=32</span><br><span class="line">  </span><br><span class="line">   [2022/04/28 02:58:25] [ info] [input:tail:tail.2] inotify_fs_remove(): inode=997586 watch_fd=33</span><br><span class="line">  </span><br><span class="line">   level=error msg=&quot;Fluent bit exited&quot; error=null</span><br><span class="line">  </span><br><span class="line">   level=info msg=backoff delay=1s</span><br><span class="line">  </span><br><span class="line">   level=info msg=&quot;backoff timer done&quot; actual=1.000167488s expected=1s</span><br><span class="line">  </span><br><span class="line">   level=info msg=&quot;Fluent bit started&quot;</span><br><span class="line">  </span><br><span class="line">   Fluent Bit v1.8.3</span><br><span class="line">  </span><br><span class="line">   * Copyright (C) 2019-2021 The Fluent Bit Authors</span><br><span class="line">  </span><br><span class="line">   * Copyright (C) 2015-2018 Treasure Data</span><br><span class="line">  </span><br><span class="line">   * Fluent Bit is a CNCF sub-project under the umbrella of Fluentd</span><br><span class="line">  </span><br><span class="line">   * https://fluentbit.io</span><br><span class="line">  </span><br><span class="line">   [2022/04/28 02:58:26] [ info] [engine] started (pid=42)</span><br><span class="line">  </span><br><span class="line">   [2022/04/28 02:58:26] [ info] [storage] version=1.1.1, initializing...</span><br><span class="line">  </span><br><span class="line">   [2022/04/28 02:58:26] [ info] [storage] in-memory</span><br><span class="line">  </span><br><span class="line">   [2022/04/28 02:58:26] [ info] [storage] normal synchronization mode, checksum disabled, max_chunks_up=128</span><br><span class="line">  </span><br><span class="line">   [2022/04/28 02:58:26] [ info] [cmetrics] version=0.1.6</span><br><span class="line">  </span><br><span class="line">   [2022/04/28 02:58:26] [ info] [input:systemd:systemd.0] seek_cursor=s=5d0022eeaf454ba8a40dde2836de2f4d;i=e3f... OK</span><br><span class="line">  </span><br><span class="line">   [2022/04/28 02:58:26] [ info] [input:systemd:systemd.1] seek_cursor=s=5d0022eeaf454ba8a40dde2836de2f4d;i=e47... OK</span><br><span class="line">  </span><br><span class="line">   [2022/04/28 02:58:26] [ info] [filter:kubernetes:kubernetes.4] https=1 host=kubernetes.default.svc port=443</span><br><span class="line">  </span><br><span class="line">   [2022/04/28 02:58:26] [ info] [filter:kubernetes:kubernetes.4] local POD info OK</span><br><span class="line">  </span><br><span class="line">   [2022/04/28 02:58:26] [ info] [filter:kubernetes:kubernetes.4] testing connectivity with API server...</span><br><span class="line">  </span><br><span class="line">   [2022/04/28 02:58:26] [ info] [filter:kubernetes:kubernetes.4] connectivity OK</span><br><span class="line">  </span><br><span class="line">   [2022/04/28 02:58:26] [ info] [sp] stream processor started</span><br><span class="line">  </span><br><span class="line">   [2022/04/28 02:58:26] [ info] [input:tail:tail.2] inotify_fs_add(): inode=416649 watch_fd=1 name=/var/log/containers/alertmanager-main-2_kubesphere-monitoring-system_alertmanager-1a71f1d5b1136320644f3289e4b22544620db4a0d35a1ffec52bc534d729c358.log</span><br><span class="line">  </span><br><span class="line">   [2022/04/28 02:58:26] [ info] [input:tail:tail.2] inotify_fs_add(): inode=461549 watch_fd=2 name=/var/log/containers/alertmanager-main-2_kubesphere-monitoring-system_config-reloader-bc14c53008f1e800d6240a5b912239a3d5682c6dcb719f48c69b7e8ba5892e35.log</span><br><span class="line">  </span><br><span class="line">   [2022/04/28 02:58:26] [ info] [input:tail:tail.2] inotify_fs_add(): inode=134582558 watch_fd=3 name=/var/log/containers/calico-kube-controllers-75ddb95444-8xvf4_kube-system_calico-kube-controllers-dc90044aa0ce62e61dfb0842c8f2e5aa8d021738adffca847b003a5c9621512c.log</span><br><span class="line">  </span><br><span class="line">   [2022/04/28 02:58:26] [ info] [input:tail:tail.2] inotify_fs_add(): inode=134581715 watch_fd=4 name=/var/log/containers/calico-node-pzvrj_kube-system_calico-node-f2f40fb9878e3328a4783ceb9c01eaed9edf24c85579ed87c7ffc2161779c3e2.log</span><br><span class="line">  </span><br><span class="line">   [2022/04/28 02:58:26] [ info] [input:tail:tail.2] inotify_fs_add(): inode=268955529 watch_fd=5 name=/var/log/containers/calico-node-pzvrj_kube-system_flexvol-driver-abf59d8a7af22c683dfb0776a0835c719f41ef23446e912f82901a4fd9cf166f.log</span><br><span class="line">  </span><br><span class="line">   [2022/04/28 02:58:26] [ info] [input:tail:tail.2] inotify_fs_add(): inode=373423 watch_fd=6 name=/var/log/containers/calico-node-pzvrj_kube-system_install-cni-b3d49f2e9c03e63c3863d50365d2ade01dead979c90285c526ac0029b58411cd.log</span><br><span class="line">  </span><br><span class="line">   [2022/04/28 02:58:26] [ info] [input:tail:tail.2] inotify_fs_add(): inode=373208 watch_fd=7 name=/var/log/containers/calico-node-pzvrj_kube-system_upgrade-ipam-6d4425d7ea5302511df1c278f2b113ac8fdfa0a372e07b025e0a9b45d30129ac.log</span><br><span class="line">  </span><br><span class="line">   [2022/04/28 02:58:26] [ info] [input:tail:tail.2] inotify_fs_add(): inode=403716654 watch_fd=8 name=/var/log/containers/coredns-5495dd7c88-68k9b_kube-system_coredns-879c087a4c8717d0886e6603a63e9503a406d215cfe77941cbcc1cc7c138d010.log</span><br><span class="line">  </span><br><span class="line">   [2022/04/28 02:58:26] [ info] [input:tail:tail.2] inotify_fs_add(): inode=134583208 watch_fd=9 name=/var/log/containers/coredns-5495dd7c88-z9q6j_kube-system_coredns-80cd4427410de02465b415683817a75674a95777ffc0929f93e87506b120ca59.log</span><br><span class="line">  </span><br><span class="line">   [2022/04/28 02:58:26] [ info] [input:tail:tail.2] inotify_fs_add(): inode=997310 watch_fd=10 name=/var/log/containers/ks-apiserver-6554c5ddb4-tzvmf_kubesphere-system_ks-apiserver-9536d87a3fa484f71c1a22a8eb489ce67e5a072a4d3f2d38796220f192a32b4f.log</span><br><span class="line">  </span><br><span class="line">   [2022/04/28 02:58:26] [ info] [input:tail:tail.2] inotify_fs_add(): inode=269010417 watch_fd=11 name=/var/log/containers/ks-console-65f4d44d88-hzw9b_kubesphere-system_ks-console-f600455c3af064c53adc8eb7e5412505c4d0e50362ab11b8e59d2e71b552b0f1.log</span><br><span class="line">  </span><br><span class="line">   [2022/04/28 02:58:26] [ info] [input:tail:tail.2] inotify_fs_add(): inode=984532 watch_fd=12 name=/var/log/containers/ks-controller-manager-b575b54ff-8tx8m_kubesphere-system_ks-controller-manager-d11c9db1fc376410555fc4ac7de2fa46bb2aa963c2bcbd407fab46d017caf788.log</span><br><span class="line">  </span><br><span class="line">   [2022/04/28 02:58:26] [ info] [input:tail:tail.2] inotify_fs_add(): inode=403995814 watch_fd=13 name=/var/log/containers/ks-events-ruler-575669b4-mh2fn_kubesphere-logging-system_config-reloader-2d51bab0babdd47864ec235efdbd69d2075cc8bf72c3642449be69f68aa1f0d5.log</span><br><span class="line">  </span><br><span class="line">   [2022/04/28 02:58:26] [ info] [input:tail:tail.2] inotify_fs_add(): inode=962171 watch_fd=14 name=/var/log/containers/ks-events-ruler-575669b4-mh2fn_kubesphere-logging-system_events-ruler-da24092a12c4fc0d0aab8a02c7fc7cb1e0e82d15a924717222bdbadee7935c84.log</span><br><span class="line">  </span><br><span class="line">   [2022/04/28 02:58:26] [ info] [input:tail:tail.2] inotify_fs_add(): inode=134583424 watch_fd=15 name=/var/log/containers/kube-apiserver-ks-k8s-master-0_kube-system_kube-apiserver-b4e97a525442956fe7612d27367a184ee09d65a56464149ec913ea004db0f1ef.log</span><br></pre></td></tr></table></figure>
</code></pre>
</li>
<li><p>再看看 es 里是否有索引了。</p>
</li>
<li><pre><code class="shell">[root@glusterfs-node-0 ~]# curl -ulstack:&#39;P@88w0rd&#39; 192.168.9.95:9200/_cat/indices?v
health status index                      uuid                   pri rep docs.count docs.deleted store.size pri.store.size
green  open   .geoip_databases           VFDw1lkoQYiWeX-u7bMC1Q   1   1         40            0     75.5mb         37.7mb
green  open   ks-logstash-log-2022.04.28 eu6citkMQ4aHpsHnLhj7IQ   1   1        407            0    394.6kb        164.4kb
</code></pre>
</li>
<li><p>注意啊，此时工具箱里的分析工具还是会报错的。按着上面的操作方法，重启一下 ks-apiserver 就可以解决并看到相应的结果。</p>
</li>
</ul>
</li>
<li><p>至此，ElasticSearch 采用 http 协议不开启认证和开启认证两种方式的对接全部实现了，本文其实没有介绍 ElasticSearch 采用 HTTPS 协议的方式，后续如果真有需求再补充。</p>
</li>
</ol>
<h2 id="5-技术关键点梳理"><a href="#5-技术关键点梳理" class="headerlink" title="5. 技术关键点梳理"></a>5. 技术关键点梳理</h2><h3 id="01-技术关键点（留坑，待补充）"><a href="#01-技术关键点（留坑，待补充）" class="headerlink" title="01 技术关键点（留坑，待补充）"></a>01 技术关键点（留坑，待补充）</h3><ol>
<li>fluentbit-operator<ul>
<li>Input</li>
<li>Output</li>
</ul>
</li>
<li>ClusterConfiguration 的技术细节</li>
<li>ks-installer 的技术细节</li>
<li>ElasticSearch 的优化配置</li>
</ol>
<h2 id="6-总结"><a href="#6-总结" class="headerlink" title="6. 总结"></a>6. 总结</h2><p>本文详细讲解了 ElasticSearch 基于 http 协议启用认证和不启用认证两种方式的集群安装部署过程，同时在 KubeSphere 中开启了可插拔的日志组件，并演示了与两种模式下的 ElasticSearch 集群对接以及对接过程中的遇坑、填坑的过程。本文的配置经验可直接用于生产环境。到此为止，我们 KubeSphere 和 Kubernetes 的安装配置和初始化已经全部完成，下一章开始，我们将开启利用 KubeSphere 在 Kubernetes 上安装配置各种常用服务的实践之旅。</p>
<blockquote>
<p><strong>参考文档</strong></p>
</blockquote>
<ul>
<li>太多了，大部分都在文中直接链接了</li>
<li><a target="_blank" rel="noopener" href="https://github.com/fluent/fluent-operator/tree/master/charts/fluent-operator/crds">fluent-operator 官网</a></li>
<li><a target="_blank" rel="noopener" href="https://ptran32.github.io/2020-08-12-send-k8s-logs-with-fluentbit/">https://ptran32.github.io/2020-08-12-send-k8s-logs-with-fluentbit/</a></li>
<li><a target="_blank" rel="noopener" href="https://banzaicloud.com/docs/one-eye/logging-operator/operation/troubleshooting/fluentbit/">https://banzaicloud.com/docs/one-eye/logging-operator/operation/troubleshooting/fluentbit/</a></li>
</ul>
<blockquote>
<p><strong>Get 文档</strong></p>
</blockquote>
<ul>
<li>Github <a target="_blank" rel="noopener" href="https://github.com/devops/z-notes">https://github.com/devops/z-notes</a></li>
<li>Gitee <a target="_blank" rel="noopener" href="https://gitee.com/zdevops/z-notes">https://gitee.com/zdevops/z-notes</a></li>
</ul>
<blockquote>
<p><strong>Get 代码</strong></p>
</blockquote>
<ul>
<li>Github <a target="_blank" rel="noopener" href="https://github.com/devops/ansible-zdevops">https://github.com/devops/ansible-zdevops</a></li>
<li>Gitee <a target="_blank" rel="noopener" href="https://gitee.com/zdevops/ansible-zdevops">https://gitee.com/zdevops/ansible-zdevops</a></li>
</ul>
<blockquote>
<p><strong>B 站</strong></p>
</blockquote>
<ul>
<li><a target="_blank" rel="noopener" href="https://space.bilibili.com/1039301316">老 Z 手记</a> <a target="_blank" rel="noopener" href="https://space.bilibili.com/1039301316">https://space.bilibili.com/1039301316</a></li>
</ul>
<blockquote>
<p><strong>版权声明</strong> </p>
</blockquote>
<ul>
<li>所有内容均属于原创，整理不易，感谢收藏，转载请标明出处。</li>
</ul>
<blockquote>
<p>About Me</p>
</blockquote>
<ul>
<li>昵称：老 Z</li>
<li>坐标：山东济南</li>
<li>职业：运维架构师 &#x2F; 高级运维工程师 &#x3D;<strong>运维</strong></li>
<li>微信：zdevops</li>
<li>关注的领域：云计算 &#x2F; 云原生技术运维，自动化运维</li>
<li>技能标签：OpenStack、Ansible、K8S、Python、Go、CNCF</li>
</ul>

    </article>
    <!-- license -->
    
        <div class="license-wrapper">
            <p>原文作者：<a href="https://lhhxs.github.io">Arcticsea</a>
            <p>原文链接：<a href="https://lhhxs.github.io/2023/09/22/%E8%BF%90%E7%BB%B4/k8s-on-kubesphere/04-%E5%9F%BA%E4%BA%8EKubeSphere%E7%8E%A9%E8%BD%ACk8s-Elasticsearch%E5%AE%89%E8%A3%85%E6%89%8B%E8%AE%B0/">https://lhhxs.github.io/2023/09/22/%E8%BF%90%E7%BB%B4/k8s-on-kubesphere/04-%E5%9F%BA%E4%BA%8EKubeSphere%E7%8E%A9%E8%BD%ACk8s-Elasticsearch%E5%AE%89%E8%A3%85%E6%89%8B%E8%AE%B0/</a>
            <p>发表日期：<a href="https://lhhxs.github.io/2023/09/22/%E8%BF%90%E7%BB%B4/k8s-on-kubesphere/04-%E5%9F%BA%E4%BA%8EKubeSphere%E7%8E%A9%E8%BD%ACk8s-Elasticsearch%E5%AE%89%E8%A3%85%E6%89%8B%E8%AE%B0/">September 22nd 2023, 9:38:09 am</a>
            <p>更新日期：<a href="https://lhhxs.github.io/2023/09/22/%E8%BF%90%E7%BB%B4/k8s-on-kubesphere/04-%E5%9F%BA%E4%BA%8EKubeSphere%E7%8E%A9%E8%BD%ACk8s-Elasticsearch%E5%AE%89%E8%A3%85%E6%89%8B%E8%AE%B0/">September 22nd 2023, 9:42:26 am</a>
            <p>版权声明：本文采用<a rel="license noopener" target="_blank" href="http://creativecommons.org/licenses/by-nc/4.0/">知识共享署名-非商业性使用 4.0 国际许可协议</a>进行许可</p>
        </div>
    
    <!-- paginator -->
    <ul class="post-paginator">
        <li class="next">
            
                <div class="nextSlogan">Next Post</div>
                <a href="/2023/09/22/%E8%BF%90%E7%BB%B4/k8s-on-kubesphere/05-%E5%9F%BA%E4%BA%8EKubeSphere%E7%8E%A9%E8%BD%ACk8s-%E5%BC%80%E5%90%AFetcd%E7%9B%91%E6%8E%A7/" title="k8s-开启etcd监控">
                    <div class="nextTitle">k8s-开启etcd监控</div>
                </a>
            
        </li>
        <li class="previous">
            
                <div class="prevSlogan">Previous Post</div>
                <a href="/2023/09/22/%E8%BF%90%E7%BB%B4/k8s-on-kubesphere/03-%E5%9F%BA%E4%BA%8EKubeSphere%E7%8E%A9%E8%BD%ACk8s-GlusterFS%E5%AE%89%E8%A3%85%E6%89%8B%E8%AE%B0/" title="k8s-GlusterFS安装手记">
                    <div class="prevTitle">k8s-GlusterFS安装手记</div>
                </a>
            
        </li>
    </ul>
    <!-- comment -->
    
        <div class="post-comment">
            <!-- 来必力 City 版安装代码 -->


            

            

            

            <!-- utteranc评论 -->


            <!-- partial('_partial/comment/changyan') -->
            <!--PC版-->


            
            

            

        </div>
    
    <!-- timeliness note -->
    <!-- idea from: https://hexo.fluid-dev.com/posts/hexo-injector/#%E6%96%87%E7%AB%A0%E6%97%B6%E6%95%88%E6%80%A7%E6%8F%90%E7%A4%BA -->
    
    <!-- Mathjax -->
    
</main>

                <!-- profile -->
                
            </div>
            <footer class="footer footer-unloaded">
    <!-- social  -->
    
        <div class="social">
            
    
        
            
                <a href="mailto:lhhxs@163.com" class="iconfont-archer email" title=email ></a>
            
        
    
        
            
                <a href="//github.com/lhhxs" class="iconfont-archer github" target="_blank" title=github></a>
            
        
    
        
            
                <span class="iconfont-archer wechat" title=wechat>
                    
                    <img class="profile-qr" src="/assets/example_qr.png" />
                </span>
            
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
            
                <a href="/atom.xml" class="iconfont-archer rss" target="_blank" title=rss></a>
            
        
    


        </div>
    
    <!-- powered by Hexo  -->
    <div class="copyright">
        <span id="hexo-power">Powered by <a href="https://hexo.io/" target="_blank">Hexo</a></span><span class="iconfont-archer power">&#xe635;</span><span id="theme-info">theme <a href="https://github.com/fi3ework/hexo-theme-archer" target="_blank">Archer</a></span>
    </div>
    <!-- website approve for Chinese user -->
    
    <!-- 不蒜子  -->
    
        <div class="busuanzi-container">
            
             
                <span id="busuanzi_container_site_pv">PV: <span id="busuanzi_value_site_pv"></span> :)</span>
            
        </div>
    	
</footer>

        </div>
        <!-- toc -->
        
            <div class="toc-wrapper toc-wrapper-loding" style=







    top:50vh;

>
                <div class="toc-catalog">
                    <span class="iconfont-archer catalog-icon">&#xe613;</span><span>CATALOG</span>
                </div>
                <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E-KubeSphere-%E7%8E%A9%E8%BD%AC-k8s-ElasticSearch-%E5%AE%89%E8%A3%85%E6%89%8B%E8%AE%B0"><span class="toc-number">1.</span> <span class="toc-text">基于 KubeSphere 玩转 k8s-ElasticSearch 安装手记</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E6%9C%AC%E6%96%87%E7%AE%80%E4%BB%8B"><span class="toc-number">1.1.</span> <span class="toc-text">1. 本文简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-Ansible-%E9%85%8D%E7%BD%AE"><span class="toc-number">1.2.</span> <span class="toc-text">2. Ansible 配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#01-%E5%A2%9E%E5%8A%A0-hosts-%E9%85%8D%E7%BD%AE"><span class="toc-number">1.2.1.</span> <span class="toc-text">01. 增加 hosts 配置</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-ElasticSearch-%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE"><span class="toc-number">1.3.</span> <span class="toc-text">3. ElasticSearch 安装配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#01-%E5%88%9D%E5%A7%8B%E5%8C%96%E9%85%8D%E7%BD%AE"><span class="toc-number">1.3.1.</span> <span class="toc-text">01. 初始化配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#02-ElasticSearch-%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE-%E6%89%8B%E5%B7%A5%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE"><span class="toc-number">1.3.2.</span> <span class="toc-text">02. ElasticSearch 安装配置-手工安装配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#03-ElasticSearch-%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE-Ansible-%E8%87%AA%E5%8A%A8%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE"><span class="toc-number">1.3.3.</span> <span class="toc-text">03. ElasticSearch 安装配置-Ansible 自动安装配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#04-ElasticSearch-%E5%B8%B8%E7%94%A8%E8%BF%90%E7%BB%B4%E5%91%BD%E4%BB%A4"><span class="toc-number">1.3.4.</span> <span class="toc-text">04. ElasticSearch 常用运维命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#05-ElasticSearch-%E8%B0%83%E4%BC%98"><span class="toc-number">1.3.5.</span> <span class="toc-text">05. ElasticSearch 调优</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-KubeSphere-%E9%85%8D%E7%BD%AE"><span class="toc-number">1.4.</span> <span class="toc-text">4. KubeSphere 配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#01-%E5%BC%80%E5%90%AF-KubeSphere-%E6%97%A5%E5%BF%97%E7%B3%BB%E7%BB%9F%E5%8F%AF%E6%8F%92%E6%8B%94%E7%BB%84%E4%BB%B6"><span class="toc-number">1.4.1.</span> <span class="toc-text">01. 开启 KubeSphere 日志系统可插拔组件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#02-%E5%A4%96%E9%83%A8-ElasticSearch-%E9%85%8D%E7%BD%AE%E5%A4%B1%E8%B4%A5%E7%9A%84%E8%A7%A3%E5%86%B3%E8%BF%87%E7%A8%8B"><span class="toc-number">1.4.2.</span> <span class="toc-text">02. 外部 ElasticSearch 配置失败的解决过程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E6%8A%80%E6%9C%AF%E5%85%B3%E9%94%AE%E7%82%B9%E6%A2%B3%E7%90%86"><span class="toc-number">1.5.</span> <span class="toc-text">5. 技术关键点梳理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#01-%E6%8A%80%E6%9C%AF%E5%85%B3%E9%94%AE%E7%82%B9%EF%BC%88%E7%95%99%E5%9D%91%EF%BC%8C%E5%BE%85%E8%A1%A5%E5%85%85%EF%BC%89"><span class="toc-number">1.5.1.</span> <span class="toc-text">01 技术关键点（留坑，待补充）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-%E6%80%BB%E7%BB%93"><span class="toc-number">1.6.</span> <span class="toc-text">6. 总结</span></a></li></ol></li></ol>
            </div>
        
        <!-- sidebar -->
        <div class="sidebar sidebar-hide">
    <ul class="sidebar-tabs sidebar-tabs-active-0">
        <li class="sidebar-tab-archives"><span class="iconfont-archer">&#xe67d;</span><span class="tab-name">Archive</span></li>
        <li class="sidebar-tab-tags"><span class="iconfont-archer">&#xe61b;</span><span class="tab-name">Tag</span></li>
        <li class="sidebar-tab-categories"><span class="iconfont-archer">&#xe666;</span><span class="tab-name">Cate</span></li>
    </ul>
    <div class="sidebar-content sidebar-content-show-archive">
        <div class="sidebar-panel-archives">
    <!-- 在 ejs 中将 archive 按照时间排序 -->
    
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
    
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
    
    
    
    
    <div class="total-and-search">
        <div class="total-archive">
        Total : 46
        </div>
        <!-- search  -->
        
    </div>
    
    <div class="post-archive">
    
        
            
            
            <div class="archive-year"> 2023 </div>
            <ul class="year-list">
            
        
        <li class="archive-post-item">
            <span class="archive-post-date">09/22</span>
            <a class="archive-post-title" href="/2023/09/22/%E8%BF%90%E7%BB%B4/k8s-prod-practices/01-%E5%9F%BA%E4%BA%8EKubeSphere%E7%9A%84Kubernetes%E7%94%9F%E4%BA%A7%E5%AE%9E%E8%B7%B5%E4%B9%8B%E8%B7%AF-%E8%B5%B7%E6%AD%A5%E7%AF%87/">Kubernetes生产实践之路-起步篇</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">09/22</span>
            <a class="archive-post-title" href="/2023/09/22/JAVA%E5%AD%A6%E4%B9%A0/Activiti7%E5%B7%A5%E4%BD%9C%E6%B5%81/">Activiti7工作流</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">09/22</span>
            <a class="archive-post-title" href="/2023/09/22/%E8%BF%90%E7%BB%B4/k8s-on-kubesphere/14-%E5%9F%BA%E4%BA%8EKubeSphere%E7%8E%A9%E8%BD%ACk8s-60%E5%88%86%E9%92%9FRook%E5%AE%9E%E6%88%98%E5%85%A5%E9%97%A8/">k8s｜60 分钟 Rook 实战入门</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">09/22</span>
            <a class="archive-post-title" href="/2023/09/22/%E8%BF%90%E7%BB%B4/k8s-on-kubesphere/13-%E5%9F%BA%E4%BA%8EKubeSphere%E7%8E%A9%E8%BD%ACk8s-KubeSphere3.3%E7%A6%BB%E7%BA%BF%E5%AE%89%E8%A3%85%E6%89%8B%E8%AE%B0/">k8s-KubeSphere3.3 离线安装手记</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">09/22</span>
            <a class="archive-post-title" href="/2023/09/22/JAVA%E5%AD%A6%E4%B9%A0/Canal%E6%9E%81%E7%AE%80%E5%85%A5%E9%97%A8/">Canal极简入门</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">09/22</span>
            <a class="archive-post-title" href="/2023/09/22/%E8%BF%90%E7%BB%B4/k8s-on-kubesphere/12-%E5%9F%BA%E4%BA%8EKubeSphere%E7%8E%A9%E8%BD%ACk8s-Nacos%E5%AE%89%E8%A3%85%E6%89%8B%E8%AE%B0/">k8s-Nacos 安装手记</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">09/22</span>
            <a class="archive-post-title" href="/2023/09/22/JAVA%E5%AD%A6%E4%B9%A0/%E8%8B%A5%E4%BE%9D(ruoyi-cloud)%E8%84%9A%E6%89%8B%E6%9E%B6%E8%A7%A3%E8%AF%BB/">若依(ruoyi-cloud)脚手架解读</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">09/22</span>
            <a class="archive-post-title" href="/2023/09/22/%E8%BF%90%E7%BB%B4/k8s-on-kubesphere/11-%E5%9F%BA%E4%BA%8EKubeSphere%E7%8E%A9%E8%BD%ACk8s-Redis%E5%AE%89%E8%A3%85%E6%89%8B%E8%AE%B0/">k8s-Redis 安装手记</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">09/22</span>
            <a class="archive-post-title" href="/2023/09/22/%E8%BF%90%E7%BB%B4/k8s-on-kubesphere/10-%E5%9F%BA%E4%BA%8EKubeSphere%E7%8E%A9%E8%BD%ACk8s-Harbor%E5%AE%89%E8%A3%85%E6%89%8B%E8%AE%B0/">k8s-Harbor 安装手记</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">09/22</span>
            <a class="archive-post-title" href="/2023/09/22/%E8%BF%90%E7%BB%B4/k8s-on-kubesphere/09-%E5%9F%BA%E4%BA%8EKubeSphere%E7%8E%A9%E8%BD%ACk8s-%E5%A4%96%E9%83%A8Ceph%E9%9B%86%E7%BE%A4%E5%AF%B9%E6%8E%A5%E6%89%8B%E8%AE%B0/">k8s-Ceph 之 Ceph-deploy 安装手记</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">09/22</span>
            <a class="archive-post-title" href="/2023/09/22/%E8%BF%90%E7%BB%B4/k8s-on-kubesphere/08-%E5%9F%BA%E4%BA%8EKubeSphere%E7%8E%A9%E8%BD%ACk8s-Ceph%E5%AE%89%E8%A3%85%E6%89%8B%E8%AE%B0/">k8s-Ceph 安装手记</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">09/22</span>
            <a class="archive-post-title" href="/2023/09/22/%E8%BF%90%E7%BB%B4/k8s-on-kubesphere/07-%E5%9F%BA%E4%BA%8EKubeSphere%E7%8E%A9%E8%BD%ACk8s-GlusterFS%E6%89%A9%E5%AE%B9%E6%89%8B%E8%AE%B0/">k8s-GlusterFS 扩容手记</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">09/22</span>
            <a class="archive-post-title" href="/2023/09/22/%E8%BF%90%E7%BB%B4/k8s-on-kubesphere/06-%E5%9F%BA%E4%BA%8EKubeSphere%E7%8E%A9%E8%BD%ACk8s-MySQL%E5%AE%89%E8%A3%85%E6%89%8B%E8%AE%B0/">k8s-MySQL 安装手记</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">09/22</span>
            <a class="archive-post-title" href="/2023/09/22/%E8%BF%90%E7%BB%B4/k8s-on-kubesphere/05-%E5%9F%BA%E4%BA%8EKubeSphere%E7%8E%A9%E8%BD%ACk8s-%E5%BC%80%E5%90%AFetcd%E7%9B%91%E6%8E%A7/">k8s-开启etcd监控</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">09/22</span>
            <a class="archive-post-title" href="/2023/09/22/%E8%BF%90%E7%BB%B4/k8s-on-kubesphere/04-%E5%9F%BA%E4%BA%8EKubeSphere%E7%8E%A9%E8%BD%ACk8s-Elasticsearch%E5%AE%89%E8%A3%85%E6%89%8B%E8%AE%B0/">k8s-ElasticSearch 安装手记</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">09/22</span>
            <a class="archive-post-title" href="/2023/09/22/%E8%BF%90%E7%BB%B4/k8s-on-kubesphere/03-%E5%9F%BA%E4%BA%8EKubeSphere%E7%8E%A9%E8%BD%ACk8s-GlusterFS%E5%AE%89%E8%A3%85%E6%89%8B%E8%AE%B0/">k8s-GlusterFS安装手记</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">09/22</span>
            <a class="archive-post-title" href="/2023/09/22/%E8%BF%90%E7%BB%B4/k8s-on-kubesphere/02-%E5%9F%BA%E4%BA%8EKubeSphere%E7%8E%A9%E8%BD%ACk8s-KubeSphere%E5%88%9D%E5%A7%8B%E5%8C%96%E6%89%8B%E8%AE%B0/">k8s-KubeSphere 初始化手记</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">09/22</span>
            <a class="archive-post-title" href="/2023/09/22/%E8%BF%90%E7%BB%B4/k8s-on-kubesphere/01-%E5%9F%BA%E4%BA%8EKubeSphere%E7%8E%A9%E8%BD%ACk8s-KubeSphere%E5%AE%89%E8%A3%85%E6%89%8B%E8%AE%B0/">k8s-KubeSphere 安装手记</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">09/22</span>
            <a class="archive-post-title" href="/2023/09/22/%E8%BF%90%E7%BB%B4/k8s/01-k8s-1.24%E5%AE%89%E8%A3%85%E6%89%8B%E8%AE%B0/">Kubernetes v1.24 安装手记</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">09/22</span>
            <a class="archive-post-title" href="/2023/09/22/JAVA%E5%AD%A6%E4%B9%A0/JWT%E5%AE%9E%E6%88%98%E5%BA%94%E7%94%A8%E4%B8%8E%E9%81%BF%E5%9D%91%E6%8C%87%E5%8D%97/">JWT实战应用与避坑指南</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">09/22</span>
            <a class="archive-post-title" href="/2023/09/22/JAVA%E5%AD%A6%E4%B9%A0/Spring-boot-starter%E5%90%AF%E5%8A%A8%E5%99%A8%E5%AE%9A%E5%88%B6/">Spring-boot-starter启动器定制</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">09/19</span>
            <a class="archive-post-title" href="/2023/09/19/%E7%BC%96%E7%A8%8B%E5%AD%A6%E4%B9%A0/%E6%B5%AA%E9%A3%9Eyes%E8%A7%86%E9%A2%91%E6%89%80%E6%9C%89%E8%AF%BE%E4%BB%B6/">浪飞yes视频所有课件</a>
        </li>
    
        
            
            
                
                </ul>
            
            <div class="archive-year"> 2022 </div>
            <ul class="year-list">
            
        
        <li class="archive-post-item">
            <span class="archive-post-date">12/29</span>
            <a class="archive-post-title" href="/2022/12/29/%E7%BC%96%E7%A8%8B%E5%AD%A6%E4%B9%A0/vsftp%E8%99%9A%E6%8B%9F%E7%94%A8%E6%88%B7%E9%85%8D%E7%BD%AE/">vsftp虚拟用户配置</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">09/29</span>
            <a class="archive-post-title" href="/2022/09/29/writeup/%E5%AE%89%E6%81%928%E6%9C%88%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94%E9%A2%98%E7%9B%AE%E5%9B%9E%E9%A1%BE/">安恒8月应急响应题目回顾</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">09/17</span>
            <a class="archive-post-title" href="/2022/09/17/%E7%BC%96%E7%A8%8B%E5%AD%A6%E4%B9%A0/%E5%9C%A8%E7%BA%BF%E8%A1%A8%E5%8D%95%E6%94%B6%E9%9B%86%E7%B3%BB%E7%BB%9FTduck%EF%BC%88docker%E7%AF%87%EF%BC%89/">在线表单收集系统Tduck（docker篇）</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">09/10</span>
            <a class="archive-post-title" href="/2022/09/10/writeup/2022%E9%B9%8F%E5%9F%8E%E6%9D%AFweb/">2022鹏城杯web</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">09/09</span>
            <a class="archive-post-title" href="/2022/09/09/WEB/Burp%20Collaborator-%E5%B8%A6%E5%A4%96%E6%8A%80%E6%9C%AF%E5%B7%A5%E5%85%B7/">Burp Collaborator-带外技术工具</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">09/09</span>
            <a class="archive-post-title" href="/2022/09/09/writeup/%E8%AE%B08%E6%9C%88%E6%9F%90%E6%AC%A1AWD/">记8月某次AWD</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">09/09</span>
            <a class="archive-post-title" href="/2022/09/09/WEB/PHP%E4%BC%AA%E5%8D%8F%E8%AE%AE%E5%B0%8F%E6%80%BB%E7%BB%93/">PHP伪协议小总结</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">09/09</span>
            <a class="archive-post-title" href="/2022/09/09/%E4%BF%A1%E6%81%AF%E6%B3%84%E9%9C%B2/CTF%E4%B8%AD%E7%9A%84%E4%BF%A1%E6%81%AF%E6%B3%84%E9%9C%B2/">CTF中的信息泄露</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">09/09</span>
            <a class="archive-post-title" href="/2022/09/09/ctf%E7%BA%BF%E4%B8%8BAWD%E6%94%BB%E9%98%B2%E8%B5%9B%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/CTF%E7%BA%BF%E4%B8%8B%E9%98%B2%E5%BE%A1%E6%88%98%20%E2%80%94%20%E8%AE%A9%E4%BD%A0%E7%9A%84%E9%9D%B6%E6%9C%BA%E5%8F%98%E6%88%90%E2%80%9C%E9%93%9C%E5%A2%99%E9%93%81%E5%A3%81%E2%80%9D/">CTF线下防御战 — 让你的靶机变成“铜墙铁壁”</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">09/09</span>
            <a class="archive-post-title" href="/2022/09/09/ctf%E7%BA%BF%E4%B8%8BAWD%E6%94%BB%E9%98%B2%E8%B5%9B%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/CTF%E7%BA%BF%E4%B8%8BAWD%E6%94%BB%E9%98%B2%E6%AD%A5%E9%AA%A4%E6%80%BB%E7%BB%93/">CTF线下AWD攻防步骤总结</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">09/09</span>
            <a class="archive-post-title" href="/2022/09/09/ctf%E7%BA%BF%E4%B8%8BAWD%E6%94%BB%E9%98%B2%E8%B5%9B%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/CTF%E7%BA%BF%E4%B8%8BAWD%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/">CTF AWD模式下简单的CMS代码审计</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">09/07</span>
            <a class="archive-post-title" href="/2022/09/07/ctf%E7%BA%BF%E4%B8%8BAWD%E6%94%BB%E9%98%B2%E8%B5%9B%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/ctf%E7%BA%BF%E4%B8%8BAWD%E6%94%BB%E9%98%B2%E8%B5%9B%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">ctf线下AWD攻防赛学习笔记</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">08/07</span>
            <a class="archive-post-title" href="/2022/08/07/hello-world/">Hello World</a>
        </li>
    
        
            
            
                
                </ul>
            
            <div class="archive-year"> Invalid date </div>
            <ul class="year-list">
            
        
        <li class="archive-post-item">
            <span class="archive-post-date">Invalid date</span>
            <a class="archive-post-title" href="/2022/09/09/WEB/%E5%89%8D%E5%8F%B0%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/">前台反序列化代码审计</a>
        </li>
    
        
            
            
                
                </ul>
            
            <div class="archive-year"> Invalid date </div>
            <ul class="year-list">
            
        
        <li class="archive-post-item">
            <span class="archive-post-date">Invalid date</span>
            <a class="archive-post-title" href="/2022/09/10/writeup/2021%20CISCN%20%E5%86%B3%E8%B5%9B%E6%9D%82%E8%AE%B0/">2021 CISCN 决赛杂记</a>
        </li>
    
        
            
            
                
                </ul>
            
            <div class="archive-year"> Invalid date </div>
            <ul class="year-list">
            
        
        <li class="archive-post-item">
            <span class="archive-post-date">Invalid date</span>
            <a class="archive-post-title" href="/2022/09/09/writeup/%5BBalsn%20CTF%202022%5D2linenodejs/">Balsn CTF 2022 inenodejs</a>
        </li>
    
        
            
            
                
                </ul>
            
            <div class="archive-year"> Invalid date </div>
            <ul class="year-list">
            
        
        <li class="archive-post-item">
            <span class="archive-post-date">Invalid date</span>
            <a class="archive-post-title" href="/2022/11/29/%E7%BC%96%E7%A8%8B%E5%AD%A6%E4%B9%A0/JDK%208u351%E5%AE%89%E8%A3%85/">JAVA JDK 8安装</a>
        </li>
    
        
            
            
                
                </ul>
            
            <div class="archive-year"> 2022 </div>
            <ul class="year-list">
            
        
        <li class="archive-post-item">
            <span class="archive-post-date">08/07</span>
            <a class="archive-post-title" href="/2022/08/07/hexo%E6%8F%90%E7%A4%BAcommand%20not%20found%E8%A7%A3%E5%86%B3/">hexo提示command not found解决</a>
        </li>
    
        
            
            
                
                </ul>
            
            <div class="archive-year"> Invalid date </div>
            <ul class="year-list">
            
        
        <li class="archive-post-item">
            <span class="archive-post-date">Invalid date</span>
            <a class="archive-post-title" href="/2023/09/22/JAVA%E5%AD%A6%E4%B9%A0/Activiti%E6%95%B0%E6%8D%AE%E5%BA%93%E7%BB%93%E6%9E%84/">Activiti数据库结构</a>
        </li>
    
        
            
            
                
                </ul>
            
            <div class="archive-year"> Invalid date </div>
            <ul class="year-list">
            
        
        <li class="archive-post-item">
            <span class="archive-post-date">Invalid date</span>
            <a class="archive-post-title" href="/2023/09/22/JAVA%E5%AD%A6%E4%B9%A0/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E4%B8%8ESeata%E8%90%BD%E5%9C%B0/">分布式事务与Seata落地</a>
        </li>
    
        
            
            
                
                </ul>
            
            <div class="archive-year"> Invalid date </div>
            <ul class="year-list">
            
        
        <li class="archive-post-item">
            <span class="archive-post-date">Invalid date</span>
            <a class="archive-post-title" href="/2023/09/22/%E8%BF%90%E7%BB%B4/z-notes-%E6%A8%A1%E6%9D%BF/">z-notes-模板</a>
        </li>
    
        
            
            
                
                </ul>
            
            <div class="archive-year"> Invalid date </div>
            <ul class="year-list">
            
        
        <li class="archive-post-item">
            <span class="archive-post-date">Invalid date</span>
            <a class="archive-post-title" href="/2023/09/22/%E8%BF%90%E7%BB%B4/k8s-prod-practices/02-%E5%9F%BA%E4%BA%8EKubeSphere%E7%9A%84Kubernetes%E7%94%9F%E4%BA%A7%E5%AE%9E%E8%B7%B5%E4%B9%8B%E8%B7%AF-%E6%8C%81%E4%B9%85%E5%8C%96%E5%AD%98%E5%82%A8%E4%B9%8BGlusterFS/">持久化存储之GlusterFS</a>
        </li>
    
        
            
            
                
                </ul>
            
            <div class="archive-year"> Invalid date </div>
            <ul class="year-list">
            
        
        <li class="archive-post-item">
            <span class="archive-post-date">Invalid date</span>
            <a class="archive-post-title" href="/2023/09/22/%E8%BF%90%E7%BB%B4/k8s-prod-practices/04-%E5%9F%BA%E4%BA%8EKubeSphere%E7%9A%84Kubernetes%E7%94%9F%E4%BA%A7%E5%AE%9E%E8%B7%B5%E4%B9%8B%E8%B7%AF-SpingCloud%E4%B8%9A%E5%8A%A1%E6%A8%A1%E5%9D%97%E7%9A%84DevOps%E5%AE%9E%E6%88%98/">DevOps 系统</a>
        </li>
    
        
            
            
                
                </ul>
            
            <div class="archive-year"> Invalid date </div>
            <ul class="year-list">
            
        
        <li class="archive-post-item">
            <span class="archive-post-date">Invalid date</span>
            <a class="archive-post-title" href="/2023/09/22/%E8%BF%90%E7%BB%B4/k8s-prod-practices/03-%E5%9F%BA%E4%BA%8EKubeSphere%E7%9A%84Kubernetes%E7%94%9F%E4%BA%A7%E5%AE%9E%E8%B7%B5%E4%B9%8B%E8%B7%AF-SpingCloud%E6%9E%B6%E6%9E%84%E4%B8%AD%E9%97%B4%E4%BB%B6%E7%9A%84%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2/">SpingCloud架构中间件的安装部署</a>
        </li>
    
    </div>
</div>

        <div class="sidebar-panel-tags">
    <div class="sidebar-tags-name">
        
            <span class="sidebar-tag-name" data-tags="intro">
                <span class="iconfont-archer">&#xe606;</span>
                intro
            </span>
        
            <span class="sidebar-tag-name" data-tags="CTF">
                <span class="iconfont-archer">&#xe606;</span>
                CTF
            </span>
        
            <span class="sidebar-tag-name" data-tags="AWD">
                <span class="iconfont-archer">&#xe606;</span>
                AWD
            </span>
        
            <span class="sidebar-tag-name" data-tags="攻防">
                <span class="iconfont-archer">&#xe606;</span>
                攻防
            </span>
        
            <span class="sidebar-tag-name" data-tags="信息泄露">
                <span class="iconfont-archer">&#xe606;</span>
                信息泄露
            </span>
        
            <span class="sidebar-tag-name" data-tags="web">
                <span class="iconfont-archer">&#xe606;</span>
                web
            </span>
        
            <span class="sidebar-tag-name" data-tags="lfi">
                <span class="iconfont-archer">&#xe606;</span>
                lfi
            </span>
        
            <span class="sidebar-tag-name" data-tags="burpsuite">
                <span class="iconfont-archer">&#xe606;</span>
                burpsuite
            </span>
        
            <span class="sidebar-tag-name" data-tags="java反序列化">
                <span class="iconfont-archer">&#xe606;</span>
                java反序列化
            </span>
        
            <span class="sidebar-tag-name" data-tags="代码审计">
                <span class="iconfont-archer">&#xe606;</span>
                代码审计
            </span>
        
            <span class="sidebar-tag-name" data-tags="PHP反序列化">
                <span class="iconfont-archer">&#xe606;</span>
                PHP反序列化
            </span>
        
            <span class="sidebar-tag-name" data-tags="WEB">
                <span class="iconfont-archer">&#xe606;</span>
                WEB
            </span>
        
            <span class="sidebar-tag-name" data-tags="RCE">
                <span class="iconfont-archer">&#xe606;</span>
                RCE
            </span>
        
            <span class="sidebar-tag-name" data-tags="tduck">
                <span class="iconfont-archer">&#xe606;</span>
                tduck
            </span>
        
            <span class="sidebar-tag-name" data-tags="docker">
                <span class="iconfont-archer">&#xe606;</span>
                docker
            </span>
        
            <span class="sidebar-tag-name" data-tags="java">
                <span class="iconfont-archer">&#xe606;</span>
                java
            </span>
        
            <span class="sidebar-tag-name" data-tags="nodejs">
                <span class="iconfont-archer">&#xe606;</span>
                nodejs
            </span>
        
            <span class="sidebar-tag-name" data-tags="JDK">
                <span class="iconfont-archer">&#xe606;</span>
                JDK
            </span>
        
            <span class="sidebar-tag-name" data-tags="流量分析">
                <span class="iconfont-archer">&#xe606;</span>
                流量分析
            </span>
        
            <span class="sidebar-tag-name" data-tags="wireshark">
                <span class="iconfont-archer">&#xe606;</span>
                wireshark
            </span>
        
            <span class="sidebar-tag-name" data-tags="FTP">
                <span class="iconfont-archer">&#xe606;</span>
                FTP
            </span>
        
            <span class="sidebar-tag-name" data-tags="springboot">
                <span class="iconfont-archer">&#xe606;</span>
                springboot
            </span>
        
            <span class="sidebar-tag-name" data-tags="k8s">
                <span class="iconfont-archer">&#xe606;</span>
                k8s
            </span>
        
            <span class="sidebar-tag-name" data-tags="kubesphere">
                <span class="iconfont-archer">&#xe606;</span>
                kubesphere
            </span>
        
    </div>
    <div class="iconfont-archer sidebar-tags-empty">&#xe678;</div>
    <div class="tag-load-fail" style="display: none; color: #ccc; font-size: 0.6rem;">
        缺失模块，请参考主题文档进行安装配置：https://github.com/fi3ework/hexo-theme-archer#%E5%AE%89%E8%A3%85%E4%B8%BB%E9%A2%98
    </div> 
    <div class="sidebar-tags-list"></div>
</div>

        <div class="sidebar-panel-categories">
    <div class="sidebar-categories-name">
    
        <span class="sidebar-category-name" data-categories="WEB">
            <span class="iconfont-archer">&#xe60a;</span>
            WEB
        </span>
    
        <span class="sidebar-category-name" data-categories="AWD">
            <span class="iconfont-archer">&#xe60a;</span>
            AWD
        </span>
    
        <span class="sidebar-category-name" data-categories="writeup">
            <span class="iconfont-archer">&#xe60a;</span>
            writeup
        </span>
    
        <span class="sidebar-category-name" data-categories="信息泄露">
            <span class="iconfont-archer">&#xe60a;</span>
            信息泄露
        </span>
    
        <span class="sidebar-category-name" data-categories="code">
            <span class="iconfont-archer">&#xe60a;</span>
            code
        </span>
    
        <span class="sidebar-category-name" data-categories="java">
            <span class="iconfont-archer">&#xe60a;</span>
            java
        </span>
    
        <span class="sidebar-category-name" data-categories="运维">
            <span class="iconfont-archer">&#xe60a;</span>
            运维
        </span>
    
    </div>
    <div class="iconfont-archer sidebar-categories-empty">&#xe678;</div>
    <div class="sidebar-categories-list"></div>
</div>

    </div>
</div>

        <!-- site-meta -->
        <script>
    var siteMetaRoot = "/"
    if (siteMetaRoot === "undefined") {
        siteMetaRoot = '/'
    }
    var siteMeta = {
        url: "https://lhhxs.github.io",
        root: siteMetaRoot,
        author: "Arcticsea"
    }
</script>

        <!-- import experimental options here -->
        <!-- Custom Font -->


        <!-- main func -->
        <script src="/scripts/main.js?v=20211217"></script>
        <!-- dark mode -->
        <script src="/scripts/dark.js?v=20211217"></script>
        <!-- fancybox -->
        <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" defer></script>
        <!-- algolia -->
        
        <!-- busuanzi -->
        
            <script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script>
        
        <!-- CNZZ -->
        
        <!-- async load share.js -->
        
            <script src="/scripts/share.js?v=20211217" async></script>
        
        <!-- mermaid -->
        
            <script src='https://cdn.jsdelivr.net/npm/mermaid@8.11.0/dist/mermaid.min.js'></script>
            <script>
                if (window.mermaid) {
                    mermaid.initialize({theme: 'dark'});
                }
            </script>
        
    </body>
</html>
